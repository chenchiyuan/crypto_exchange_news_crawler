{% extends "ddps_z/base.html" %}
{% load static %}

{% block title %}{{ symbol }} - DDPS-Z åˆ†æ{% endblock %}

{% block extra_css %}
<style>
    .indicator-card {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
    }
    .indicator-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .indicator-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .chart-container {
        position: relative;
        height: 500px;
        width: 100%;
    }
    .zscore-chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
    #kline-chart, #zscore-chart {
        width: 100%;
        height: 100%;
    }
    .signal-badge {
        font-size: 1.1rem;
        padding: 8px 16px;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .band-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-top: 10px;
    }
    .band-legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }
    .band-color {
        width: 20px;
        height: 3px;
    }
    .refresh-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 5;
    }
    /* ğŸ†• æƒ¯æ€§ HUD é¢æ¿æ ·å¼ */
    .inertia-hud {
        position: absolute;
        top: 60px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        font-size: 0.85rem;
        z-index: 10;
        min-width: 180px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .hud-section {
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    .hud-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .hud-title {
        font-weight: bold;
        color: #495057;
        margin-bottom: 5px;
    }
    .hud-row {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
    }
    .hud-row span:last-child {
        font-family: monospace;
    }
    .status-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    .status-protected { background: #d4edda; color: #155724; }
    .status-decaying { background: #fff3cd; color: #856404; }
    .status-signal { background: #f8d7da; color: #721c24; }

    /* ğŸ†• ä¹°å…¥ä¿¡å·Cardæ ·å¼ (è¿­ä»£011) */
    .buy-signal-card {
        position: fixed;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        min-width: 320px;
        max-width: 400px;
        border: 2px solid #28a745;
    }
    .buy-signal-card .card-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px 6px 0 0;
    }
    .buy-signal-card .card-title {
        font-weight: bold;
        font-size: 0.95rem;
    }
    .buy-signal-card .card-body {
        padding: 15px;
    }
    .buy-signal-card .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    .buy-signal-card .btn-close:hover {
        opacity: 1;
    }
    .signal-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    .signal-info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .signal-info-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .signal-info-value {
        font-weight: bold;
        font-family: monospace;
    }
    .strategies-section {
        margin-top: 10px;
    }
    .strategies-title {
        font-weight: bold;
        color: #28a745;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    .strategy-item {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 8px;
        border-left: 3px solid #28a745;
    }
    .strategy-item:last-child {
        margin-bottom: 0;
    }
    .strategy-name {
        font-weight: bold;
        color: #28a745;
        font-size: 0.9rem;
    }
    .strategy-reason {
        color: #666;
        font-size: 0.85rem;
        margin-top: 5px;
        line-height: 1.4;
    }
    .buy-signal-card.fixed {
        border-color: #0d6efd;
    }
    .buy-signal-card.fixed .card-header {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
    }

    /* ğŸ†• æ“ä½œæ—¥å¿—æ ·å¼ (è¿­ä»£012) */
    .trade-events-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .trade-event-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
    }
    .trade-event-item:last-child {
        border-bottom: none;
    }
    .trade-event-item:hover {
        background: #f8f9fa;
    }
    .event-type-badge {
        width: 50px;
        text-align: center;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-right: 15px;
    }
    .event-type-buy {
        background: #d4edda;
        color: #155724;
    }
    .event-type-sell {
        background: #f8d7da;
        color: #721c24;
    }
    .event-info {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .event-info-item {
        display: flex;
        flex-direction: column;
    }
    .event-info-label {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .event-info-value {
        font-family: monospace;
        font-weight: 500;
    }
    .profit-positive {
        color: #28a745;
    }
    .profit-negative {
        color: #dc3545;
    }
    /* è®¢å•çŠ¶æ€æ ·å¼ */
    .order-status-holding {
        color: #0d6efd;
    }
    .order-status-sold {
        color: #6c757d;
    }

    /* ğŸ†• å›¾ä¾‹å®¹å™¨æ ·å¼ */
    .chart-legend-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
        margin-top: 15px;
        padding: 15px;
        background: rgba(248, 249, 250, 0.9);
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .legend-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .legend-title {
        font-weight: bold;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 5px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 3px;
    }
    .legend-items {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #495057;
    }
    .legend-line {
        width: 30px;
        border-radius: 1px;
        position: relative;
    }
    .legend-line-dashed {
        width: 30px;
        height: 0;
        border-top: 2px dashed;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'ddps_z:dashboard' %}">åˆçº¦åˆ—è¡¨</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ symbol }}</li>
            </ol>
        </nav>
        <h2 class="mb-2">{{ symbol }} <span class="badge bg-primary" id="interval-badge">4h</span></h2>
        <p class="text-muted">åŠ¨æ€åç¦»æ¦‚ç‡ç©ºé—´ (Z-Score) åˆ†æ</p>
    </div>
</div>

<!-- Interval Selector -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div>
                <span class="text-muted me-2">å‘¨æœŸ:</span>
                <div class="btn-group" role="group" aria-label="å‘¨æœŸé€‰æ‹©">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-interval="1h">1å°æ—¶</button>
                    <button type="button" class="btn btn-outline-primary btn-sm active" data-interval="4h">4å°æ—¶</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-interval="1d">1å¤©</button>
                </div>
            </div>
            <div>
                <span class="text-muted me-2">æ—¶é—´èŒƒå›´:</span>
                <div class="btn-group" role="group" aria-label="æ—¶é—´èŒƒå›´é€‰æ‹©">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="1w">1å‘¨</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="1m">1æœˆ</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="3m">3æœˆ</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="6m">6æœˆ</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="1y">1å¹´</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm active" data-range="2025">2025</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="all">å…¨éƒ¨</button>
                </div>
            </div>
            <!-- ğŸ†• ä¹°å…¥ç‚¹ç­–ç•¥ç­›é€‰ (è¿­ä»£011) -->
            <div>
                <span class="text-muted me-2">ä¹°å…¥ç‚¹:</span>
                <div class="btn-group" role="group" aria-label="ä¹°å…¥ç‚¹ç­–ç•¥ç­›é€‰">
                    <button type="button" class="btn btn-outline-success btn-sm active" data-buy-filter="all">å…¨éƒ¨</button>
                    <button type="button" class="btn btn-outline-success btn-sm" data-buy-filter="strategy_1">ç­–ç•¥1</button>
                    <button type="button" class="btn btn-outline-success btn-sm" data-buy-filter="strategy_2">ç­–ç•¥2</button>
                </div>
            </div>
            <div class="ms-auto">
                <span class="badge bg-light text-dark" id="data-info">
                    <i class="bi bi-info-circle"></i> åŠ è½½ä¸­...
                </span>
            </div>
        </div>
    </div>
</div>

<!-- DDPS Indicators Section -->
<div class="row mb-4" id="indicators-section">
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="current-price">-</div>
            <div class="indicator-label">å½“å‰ä»·æ ¼</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="ema-value">-</div>
            <div class="indicator-label">EMA(25)</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="deviation-value">-</div>
            <div class="indicator-label">åç¦»ç‡</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="zscore-value">-</div>
            <div class="indicator-label">Z-Score</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="percentile-value">-</div>
            <div class="indicator-label">ç™¾åˆ†ä½</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card indicator-card">
            <div class="indicator-value" id="zone-value">-</div>
            <div class="indicator-label">å½“å‰åŒºé—´</div>
        </div>
    </div>
</div>

<!-- ğŸ†• è®¢å•ç»Ÿè®¡é¢æ¿ (è¿­ä»£012) -->
<div class="row mb-4" id="order-statistics-section">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart-fill"></i> ç­–ç•¥è¡¨ç°ç»Ÿè®¡
            </div>
            <div class="card-body py-2">
                <div class="row text-center g-2">
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">æ€»è®¢å•</small>
                        <span class="fw-bold fs-5" id="stat-total-orders">-</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">å·²å–å‡º</small>
                        <span class="fw-bold fs-5" id="stat-sold-orders">-</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">æŒä»“ä¸­</small>
                        <span class="fw-bold fs-5" id="stat-holding-orders">-</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">èƒœç‡</small>
                        <span class="fw-bold fs-5" id="stat-win-rate">-</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">æ€»æ”¶ç›Š</small>
                        <span class="fw-bold fs-5" id="stat-total-profit">-</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <small class="text-muted d-block">æµ®åŠ¨ç›ˆäº</small>
                        <span class="fw-bold fs-5" id="stat-floating-profit">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Signal Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="mb-1">ä¿¡å·è¯„ä¼°</h5>
                    <p class="text-muted mb-0" id="signal-description">æ­£åœ¨åŠ è½½...</p>
                </div>
                <div>
                    <span class="badge signal-badge bg-secondary" id="signal-badge">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- K-Line Chart with Probability Bands -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Kçº¿å›¾ä¸æ¦‚ç‡å¸¦</span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" id="reset-zoom-btn">
                        <i class="bi bi-zoom-out"></i> é‡ç½®ç¼©æ”¾
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-chart-btn">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
            <div class="card-body position-relative">
                <div class="loading-overlay" id="chart-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                </div>
                <!-- ğŸ†• æƒ¯æ€§ HUD é¢æ¿ (TASK-010-013) -->
                <div class="inertia-hud" id="inertia-hud" style="display: none;">
                    <div class="hud-section">
                        <div class="hud-title">é™æ€é˜ˆå€¼</div>
                        <div class="hud-row">
                            <span>P95:</span>
                            <span id="hud-p95">-</span>
                        </div>
                        <div class="hud-row">
                            <span>P5:</span>
                            <span id="hud-p5">-</span>
                        </div>
                    </div>
                    <div class="hud-section">
                        <div class="hud-title">æƒ¯æ€§é¢„æµ‹ (T+<span id="hud-t-adj">5</span>)</div>
                        <div class="hud-row">
                            <span>Upper:</span>
                            <span id="hud-fan-upper">-</span>
                        </div>
                        <div class="hud-row">
                            <span>Mid:</span>
                            <span id="hud-fan-mid">-</span>
                        </div>
                        <div class="hud-row">
                            <span>Lower:</span>
                            <span id="hud-fan-lower">-</span>
                        </div>
                    </div>
                    <div class="hud-section">
                        <div class="hud-row">
                            <span>çŠ¶æ€:</span>
                            <span class="status-badge" id="hud-state-badge">-</span>
                        </div>
                        <div class="hud-row">
                            <span>ADX:</span>
                            <span id="hud-adx">-</span>
                        </div>
                        <div class="hud-row">
                            <span>Î²:</span>
                            <span id="hud-beta">-</span>
                        </div>
                    </div>
                    <!-- ğŸ†• Î²å®è§‚å‘¨æœŸ (è¿­ä»£018) -->
                    <div class="hud-section">
                        <div class="hud-title">å®è§‚å‘¨æœŸ</div>
                        <div class="hud-row">
                            <span>å‘¨æœŸ:</span>
                            <span class="status-badge" id="hud-cycle-phase">-</span>
                        </div>
                        <div class="hud-row">
                            <span>æŒç»­:</span>
                            <span id="hud-cycle-duration">-</span>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                    <small>
                        <strong>æ“ä½œæç¤ºï¼š</strong>
                        é¼ æ ‡æ»šè½®ç¼©æ”¾ | æŒ‰ä½æ‹–åŠ¨æŸ¥çœ‹å†å²æ•°æ® | åŒå‡»é‡ç½®è§†å›¾
                    </small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div class="chart-container">
                    <div id="kline-chart"></div>
                </div>
                <!-- å›¾ä¾‹è¯´æ˜ -->
                <div class="chart-legend-container">
                    <!-- æ¦‚ç‡å¸¦å›¾ä¾‹ -->
                    <div class="legend-section">
                        <div class="legend-title">æ¦‚ç‡å¸¦ï¼ˆé™æ€é˜ˆå€¼ï¼‰</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(220, 53, 69, 0.6); height: 2px;"></div>
                                <span>P5 (5%åˆ†ä½ - æåº¦è¶…å–)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(253, 126, 20, 0.6); height: 2px;"></div>
                                <span>P10 (10%åˆ†ä½ - è¶…å–)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(108, 117, 125, 0.6); height: 2px;"></div>
                                <span>P50 (ä¸­æ€§)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(40, 167, 69, 0.6); height: 2px;"></div>
                                <span>P90 (90%åˆ†ä½ - è¶…ä¹°)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(25, 135, 84, 0.6); height: 2px;"></div>
                                <span>P95 (95%åˆ†ä½ - æåº¦è¶…ä¹°)</span>
                            </div>
                        </div>
                    </div>

                    <!-- EMAå›¾ä¾‹ -->
                    <div class="legend-section">
                        <div class="legend-title">è¶‹åŠ¿æŒ‡æ ‡</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-line" style="background: #ffc107; height: 3px;"></div>
                                <span>EMA(25) - è¶‹åŠ¿å‡çº¿</span>
                            </div>
                        </div>
                    </div>

                    <!-- æƒ¯æ€§é¢„æµ‹ä¸­è½´ -->
                    <div class="legend-section">
                        <div class="legend-title">æƒ¯æ€§é¢„æµ‹</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(40, 167, 69, 0.7); height: 3px;"></div>
                                <span>è¶‹åŠ¿æƒ¯æ€§é¢„æµ‹çº¿ï¼ˆä¸Šæ¶¨ç»¿è‰²/ä¸‹è·Œçº¢è‰²ï¼‰</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Z-Score Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">Z-Score æ—¶åºå›¾</div>
            <div class="card-body">
                <div class="zscore-chart-container">
                    <div id="zscore-chart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ†• æ“ä½œæ—¥å¿—é¢æ¿ (è¿­ä»£012) -->
<div class="row mb-4" id="trade-events-section">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-text"></i> æ“ä½œæ—¥å¿—</span>
                <div class="btn-group btn-group-sm" role="group" aria-label="æ—¥å¿—ç­›é€‰">
                    <button type="button" class="btn btn-outline-secondary active" data-event-filter="all">å…¨éƒ¨</button>
                    <button type="button" class="btn btn-outline-success" data-event-filter="buy">ä¹°å…¥</button>
                    <button type="button" class="btn btn-outline-danger" data-event-filter="sell">å–å‡º</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="trade-events-container" id="tradeEventsContainer">
                    <div class="text-center text-muted py-3">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ†• ä¹°å…¥ä¿¡å·æ‚¬æµ®Card (è¿­ä»£011) -->
<div id="buySignalCard" class="buy-signal-card" style="display: none;">
    <div class="card-header">
        <span class="card-title">ğŸ“Š ä¹°å…¥ä¿¡å·è¯¦æƒ…</span>
        <button type="button" class="btn-close btn-close-sm" id="closeBuySignalCardBtn"></button>
    </div>
    <div class="card-body">
        <div class="signal-info-row">
            <span class="signal-info-label">ğŸ• è§¦å‘æ—¶é—´:</span>
            <span class="signal-info-value" id="signalTime">-</span>
        </div>
        <div class="signal-info-row">
            <span class="signal-info-label">ğŸ’° ä¹°å…¥ä»·æ ¼:</span>
            <span class="signal-info-value" id="signalPrice">-</span>
        </div>
        <div class="strategies-section">
            <div class="strategies-title">âœ… è§¦å‘ç­–ç•¥:</div>
            <div id="strategiesList"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DDPS-Z Detail Page JavaScript - Using TradingView Lightweight Charts
    const DDPSDetail = {
        // Configuration
        config: {
            symbol: '{{ symbol }}',
            apiBaseUrl: '/ddps-z/api',
            currentInterval: '4h',
            currentRange: '2025',
            loadingMore: false,
            // åŠ¨æ€åŠ è½½é˜ˆå€¼ï¼šå½“å¯è§èŒƒå›´çš„èµ·å§‹ä½ç½®æ¥è¿‘å·²åŠ è½½æ•°æ®çš„èµ·å§‹ä½ç½®æ—¶è§¦å‘åŠ è½½
            loadThreshold: 50,
            // ğŸ†• ä¹°å…¥ç‚¹ç­›é€‰é…ç½® (è¿­ä»£011)
            currentBuyFilter: 'all',
            // ğŸ†• æ“ä½œæ—¥å¿—ç­›é€‰é…ç½® (è¿­ä»£012)
            currentEventFilter: 'all'
        },

        // State
        state: {
            klineChart: null,
            zscoreChart: null,
            chartData: null,
            meta: null,
            // Series references
            candleSeries: null,
            emaSeries: null,
            bandSeries: {},
            zscoreSeries: null,
            // ğŸ†• æ‰‡é¢ä¸­è½´ Series (ç®€åŒ–æ˜¾ç¤ºï¼Œåªä¿ç•™ä¸­è½´çº¿)
            fanMidSeries: null,
            // ğŸ†• æ‰‡é¢Kçº¿æ•°æ®ï¼ˆç”¨äºhoveræ˜¾ç¤ºï¼‰
            fanKlineData: null,
            // å·²åŠ è½½çš„æ•°æ®æ—¶é—´èŒƒå›´
            loadedStartTime: null,
            loadedEndTime: null,
            // ğŸ†• ä¹°å…¥ä¿¡å·ç›¸å…³çŠ¶æ€ (è¿­ä»£011)
            buySignalsData: [],
            buySignalCardFixed: false,
            // ğŸ†• è®¢å•è¿½è¸ªç›¸å…³çŠ¶æ€ (è¿­ä»£012)
            ordersData: [],
            orderStatistics: null,
            tradeEventsData: [],
            // ğŸ†• Î²å®è§‚å‘¨æœŸçŠ¶æ€ (è¿­ä»£018)
            currentCycle: null
        },

        // Initialize
        init: function() {
            this.bindEvents();
            this.loadData();
            // Handle window resize
            window.addEventListener('resize', () => this.handleResize());
        },

        // Handle window resize
        handleResize: function() {
            const klineContainer = document.getElementById('kline-chart');
            const zscoreContainer = document.getElementById('zscore-chart');

            if (this.state.klineChart && klineContainer) {
                this.state.klineChart.applyOptions({
                    width: klineContainer.clientWidth,
                    height: klineContainer.clientHeight
                });
            }
            if (this.state.zscoreChart && zscoreContainer) {
                this.state.zscoreChart.applyOptions({
                    width: zscoreContainer.clientWidth,
                    height: zscoreContainer.clientHeight
                });
            }
        },

        // Bind event listeners
        bindEvents: function() {
            // Interval buttons
            document.querySelectorAll('[data-interval]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-interval]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.config.currentInterval = e.target.dataset.interval;
                    document.getElementById('interval-badge').textContent = this.config.currentInterval;
                    this.loadData();
                });
            });

            // Time range buttons
            document.querySelectorAll('[data-range]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.config.currentRange = e.target.dataset.range;
                    this.loadData();
                });
            });

            // Refresh button
            document.getElementById('refresh-chart-btn').addEventListener('click', () => {
                this.loadData();
            });

            // Reset zoom button
            document.getElementById('reset-zoom-btn').addEventListener('click', () => {
                if (this.state.klineChart) {
                    this.state.klineChart.timeScale().fitContent();
                }
                if (this.state.zscoreChart) {
                    this.state.zscoreChart.timeScale().fitContent();
                }
            });

            // ğŸ†• ä¹°å…¥ç‚¹ç­›é€‰æŒ‰é’® (è¿­ä»£011)
            document.querySelectorAll('[data-buy-filter]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-buy-filter]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.config.currentBuyFilter = e.target.dataset.buyFilter;
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('buySignalFilter', this.config.currentBuyFilter);
                    // é‡æ–°æ¸²æŸ“æ ‡è®°
                    this.renderBuySignalMarkers();
                });
            });

            // ğŸ†• ä¹°å…¥ä¿¡å·Cardå…³é—­æŒ‰é’® (è¿­ä»£011)
            document.getElementById('closeBuySignalCardBtn').addEventListener('click', () => {
                this.closeBuySignalCard();
            });

            // ğŸ†• ESCé”®å…³é—­Card (è¿­ä»£011)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeBuySignalCard();
                }
            });

            // ğŸ†• ä»localStorageæ¢å¤ç­›é€‰çŠ¶æ€ (è¿­ä»£011)
            const savedFilter = localStorage.getItem('buySignalFilter') || 'all';
            this.config.currentBuyFilter = savedFilter;
            document.querySelectorAll('[data-buy-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.buyFilter === savedFilter);
            });

            // ğŸ†• æ“ä½œæ—¥å¿—ç­›é€‰æŒ‰é’® (è¿­ä»£012)
            document.querySelectorAll('[data-event-filter]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-event-filter]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.config.currentEventFilter = e.target.dataset.eventFilter;
                    // é‡æ–°æ¸²æŸ“æ“ä½œæ—¥å¿—
                    this.renderTradeEvents();
                });
            });
        },

        // Load all data
        loadData: function() {
            this.showChartLoading(true);
            this.state.loadedStartTime = null;
            this.state.loadedEndTime = null;

            // Load DDPS calculation data
            Promise.all([
                this.loadDDPSData(),
                this.loadChartData()
            ]).then(() => {
                this.showChartLoading(false);
            }).catch(error => {
                console.error('Error loading data:', error);
                this.showChartLoading(false);
                this.showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        },

        // Load DDPS indicators
        loadDDPSData: function() {
            const url = `${this.config.apiBaseUrl}/calculate/?symbol=${this.config.symbol}&interval=${this.config.currentInterval}`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.updateIndicators(data.data);
                    } else {
                        this.showError(data.error || 'è®¡ç®—å¤±è´¥');
                    }
                });
        },

        // Load chart data
        loadChartData: function(loadMore = false, endTime = null) {
            let url = `${this.config.apiBaseUrl}/chart/?symbol=${this.config.symbol}&interval=${this.config.currentInterval}`;

            if (loadMore && endTime) {
                // åŠ è½½æ›´æ—©çš„æ•°æ®
                url += `&end_time=${endTime}&limit=500`;
            } else {
                // åˆå§‹åŠ è½½ï¼Œä½¿ç”¨æ—¶é—´èŒƒå›´
                url += `&range=${this.config.currentRange}&limit=2000`;
            }

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.chart) {
                        if (loadMore) {
                            // è¿½åŠ æ›´æ—©çš„æ•°æ®
                            this.appendHistoricalData(data.chart, data.meta);
                        } else {
                            // åˆå§‹åŠ è½½
                            this.state.chartData = data.chart;
                            this.state.meta = data.meta;
                            this.updateDataInfo(data.meta);
                            this.renderKlineChart(data.chart, data.meta);
                            this.renderZscoreChart(data.chart);
                            this.setupDynamicLoading();

                            // ğŸ†• åŠ è½½è®¢å•æ•°æ® (è¿­ä»£012)
                            if (data.chart.orders) {
                                this.state.ordersData = data.chart.orders;
                            }
                            if (data.chart.order_statistics) {
                                this.state.orderStatistics = data.chart.order_statistics;
                                this.renderStatisticsPanel();
                            }
                            if (data.chart.trade_events) {
                                this.state.tradeEventsData = data.chart.trade_events;
                                this.renderTradeEvents();
                            }

                            // ğŸ†• åŠ è½½Î²å®è§‚å‘¨æœŸæ•°æ® (è¿­ä»£018)
                            if (data.chart.current_cycle) {
                                this.state.currentCycle = data.chart.current_cycle;
                            }
                        }
                    } else {
                        if (!loadMore) {
                            this.showError(data.error || 'åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥');
                        }
                    }
                });
        },

        // è®¾ç½®åŠ¨æ€åŠ è½½ç›‘å¬
        setupDynamicLoading: function() {
            if (!this.state.klineChart) return;

            const timeScale = this.state.klineChart.timeScale();

            // ç›‘å¬å¯è§èŒƒå›´å˜åŒ–
            timeScale.subscribeVisibleLogicalRangeChange((logicalRange) => {
                if (!logicalRange || this.config.loadingMore) return;

                // æ£€æŸ¥æ˜¯å¦æ¥è¿‘å·¦è¾¹ç•Œï¼ˆæ›´æ—©çš„æ•°æ®ï¼‰
                if (logicalRange.from <= this.config.loadThreshold && this.state.meta && this.state.meta.has_more) {
                    this.loadMoreHistoricalData();
                }
            });
        },

        // åŠ è½½æ›´å¤šå†å²æ•°æ®
        loadMoreHistoricalData: function() {
            if (this.config.loadingMore || !this.state.loadedStartTime) return;
            if (!this.state.meta || !this.state.meta.has_more) return;

            this.config.loadingMore = true;
            this.updateDataInfo(this.state.meta, true);

            // åŠ è½½å½“å‰æœ€æ—©æ•°æ®ä¹‹å‰çš„æ•°æ®
            this.loadChartData(true, this.state.loadedStartTime)
                .finally(() => {
                    this.config.loadingMore = false;
                    this.updateDataInfo(this.state.meta);
                });
        },

        // è¿½åŠ å†å²æ•°æ®åˆ°å›¾è¡¨
        appendHistoricalData: function(newData, meta) {
            if (!newData.candles || newData.candles.length === 0) {
                this.state.meta.has_more = false;
                return;
            }

            // è½¬æ¢å¹¶è¿½åŠ Kçº¿æ•°æ®
            const newCandles = newData.candles.map(c => ({
                time: Math.floor(c.t / 1000),
                open: c.o,
                high: c.h,
                low: c.l,
                close: c.c
            }));

            // è·å–ç°æœ‰æ•°æ®å¹¶åˆå¹¶
            if (this.state.candleSeries) {
                // ä½¿ç”¨setDataé‡æ–°è®¾ç½®åˆå¹¶åçš„æ•°æ®
                const existingData = this.state.chartData.candles.map(c => ({
                    time: Math.floor(c.t / 1000),
                    open: c.o,
                    high: c.h,
                    low: c.l,
                    close: c.c
                }));

                // è¿‡æ»¤é‡å¤æ•°æ®å¹¶åˆå¹¶
                const existingTimes = new Set(existingData.map(d => d.time));
                const uniqueNewCandles = newCandles.filter(c => !existingTimes.has(c.time));
                const mergedCandles = [...uniqueNewCandles, ...existingData].sort((a, b) => a.time - b.time);

                this.state.candleSeries.setData(mergedCandles);

                // æ›´æ–°çŠ¶æ€
                this.state.chartData.candles = [...newData.candles, ...this.state.chartData.candles];
            }

            // æ›´æ–°EMAæ•°æ®
            if (this.state.emaSeries && newData.ema) {
                const newEma = newData.ema.map(e => ({
                    time: Math.floor(e.t / 1000),
                    value: e.y
                }));

                const existingEma = this.state.chartData.ema.map(e => ({
                    time: Math.floor(e.t / 1000),
                    value: e.y
                }));

                const existingEmaTimes = new Set(existingEma.map(d => d.time));
                const uniqueNewEma = newEma.filter(e => !existingEmaTimes.has(e.time));
                const mergedEma = [...uniqueNewEma, ...existingEma].sort((a, b) => a.time - b.time);

                this.state.emaSeries.setData(mergedEma);
                this.state.chartData.ema = [...newData.ema, ...this.state.chartData.ema];
            }

            // æ›´æ–°æ¦‚ç‡å¸¦æ•°æ®
            if (newData.bands) {
                ['p5', 'p10', 'p50', 'p90', 'p95'].forEach(key => {
                    if (this.state.bandSeries[key] && newData.bands[key]) {
                        const newBand = newData.bands[key].map(b => ({
                            time: Math.floor(b.t / 1000),
                            value: b.y
                        }));

                        const existingBand = (this.state.chartData.bands[key] || []).map(b => ({
                            time: Math.floor(b.t / 1000),
                            value: b.y
                        }));

                        const existingBandTimes = new Set(existingBand.map(d => d.time));
                        const uniqueNewBand = newBand.filter(b => !existingBandTimes.has(b.time));
                        const mergedBand = [...uniqueNewBand, ...existingBand].sort((a, b) => a.time - b.time);

                        this.state.bandSeries[key].setData(mergedBand);

                        if (!this.state.chartData.bands) this.state.chartData.bands = {};
                        this.state.chartData.bands[key] = [...newData.bands[key], ...(this.state.chartData.bands[key] || [])];
                    }
                });
            }

            // æ›´æ–°Z-Scoreæ•°æ®
            if (this.state.zscoreSeries && newData.zscore) {
                const newZscore = newData.zscore.map(z => ({
                    time: Math.floor(z.t / 1000),
                    value: z.y
                }));

                const existingZscore = this.state.chartData.zscore.map(z => ({
                    time: Math.floor(z.t / 1000),
                    value: z.y
                }));

                const existingZscoreTimes = new Set(existingZscore.map(d => d.time));
                const uniqueNewZscore = newZscore.filter(z => !existingZscoreTimes.has(z.time));
                const mergedZscore = [...uniqueNewZscore, ...existingZscore].sort((a, b) => a.time - b.time);

                this.state.zscoreSeries.setData(mergedZscore);
                this.state.chartData.zscore = [...newData.zscore, ...this.state.chartData.zscore];
            }

            // æ›´æ–°å…ƒä¿¡æ¯
            this.state.meta = meta;
            if (newData.candles.length > 0) {
                this.state.loadedStartTime = newData.candles[0].t;
            }
        },

        // æ›´æ–°æ•°æ®ä¿¡æ¯æ˜¾ç¤º
        updateDataInfo: function(meta, loading = false) {
            const infoEl = document.getElementById('data-info');
            if (!infoEl || !meta) return;

            if (loading) {
                infoEl.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> åŠ è½½æ›´å¤šæ•°æ®...';
                return;
            }

            const total = meta.total_available || 0;
            const returned = meta.returned || 0;
            const hasMore = meta.has_more ? 'å¯åŠ è½½æ›´å¤š' : 'å·²åŠ è½½å…¨éƒ¨';

            infoEl.innerHTML = `<i class="bi bi-bar-chart"></i> æ˜¾ç¤º ${returned}/${total} æ ¹Kçº¿ (${hasMore})`;
        },

        // Update indicator displays
        updateIndicators: function(data) {
            document.getElementById('current-price').textContent = this.formatPrice(data.current_price);
            document.getElementById('ema-value').textContent = this.formatPrice(data.current_ema);
            document.getElementById('deviation-value').textContent = this.formatPercent(data.current_deviation);
            document.getElementById('zscore-value').textContent = data.zscore.toFixed(2);
            document.getElementById('percentile-value').textContent = data.percentile.toFixed(1) + '%';

            // Zone with color
            const zoneEl = document.getElementById('zone-value');
            zoneEl.textContent = data.zone_label;
            zoneEl.className = 'indicator-value ' + this.getZoneClass(data.zone);

            // Signal - API returns signal_type instead of type
            const signal = data.signal;
            const signalBadge = document.getElementById('signal-badge');
            const signalDesc = document.getElementById('signal-description');

            signalDesc.textContent = signal.description;
            signalBadge.textContent = this.getSignalLabel(signal.signal_type, signal.strength);
            signalBadge.className = 'badge signal-badge ' + this.getSignalClass(signal.signal_type, signal.strength);
        },

        // Render K-line chart with probability bands using Lightweight Charts
        renderKlineChart: function(data, meta) {
            const container = document.getElementById('kline-chart');

            // Destroy existing chart
            if (this.state.klineChart) {
                this.state.klineChart.remove();
                this.state.klineChart = null;
            }

            // Create chart
            this.state.klineChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { type: 'solid', color: '#ffffff' },
                    textColor: '#333'
                },
                grid: {
                    vertLines: { color: 'rgba(197, 203, 206, 0.3)' },
                    horzLines: { color: 'rgba(197, 203, 206, 0.3)' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: 'rgba(197, 203, 206, 1)'
                },
                timeScale: {
                    borderColor: 'rgba(197, 203, 206, 1)',
                    timeVisible: true,
                    secondsVisible: false
                },
                handleScroll: {
                    vertTouchDrag: false
                }
            });

            // Convert candle data format: {t, o, h, l, c, v} -> {time, open, high, low, close}
            const candleData = data.candles.map(c => ({
                time: Math.floor(c.t / 1000),  // Convert ms to seconds
                open: c.o,
                high: c.h,
                low: c.l,
                close: c.c
            }));

            // è®°å½•å·²åŠ è½½æ•°æ®çš„æ—¶é—´èŒƒå›´
            if (candleData.length > 0) {
                this.state.loadedStartTime = data.candles[0].t;
                this.state.loadedEndTime = data.candles[data.candles.length - 1].t;
            }

            // Add probability bands first (so they appear behind candlesticks)
            if (data.bands) {
                const bandColors = {
                    'p5': 'rgba(220, 53, 69, 0.4)',
                    'p10': 'rgba(253, 126, 20, 0.4)',
                    'p50': 'rgba(108, 117, 125, 0.4)',
                    'p90': 'rgba(40, 167, 69, 0.4)',
                    'p95': 'rgba(25, 135, 84, 0.4)'
                };

                // Add bands in order
                ['p5', 'p10', 'p50', 'p90', 'p95'].forEach(key => {
                    if (data.bands[key]) {
                        const bandData = data.bands[key].map(b => ({
                            time: Math.floor(b.t / 1000),
                            value: b.y
                        }));

                        this.state.bandSeries[key] = this.state.klineChart.addLineSeries({
                                color: bandColors[key],
                                lineWidth: 1,
                                lineStyle: LightweightCharts.LineStyle.Dotted,
                                priceLineVisible: false,
                                lastValueVisible: false,
                                crosshairMarkerVisible: false
                        });
                        this.state.bandSeries[key].setData(bandData);
                    }
                });
            }

            // Add candlestick series
            this.state.candleSeries = this.state.klineChart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350'
            });
            this.state.candleSeries.setData(candleData);

            // Add EMA line
            if (data.ema && data.ema.length > 0) {
                const emaData = data.ema.map(e => ({
                    time: Math.floor(e.t / 1000),
                    value: e.y
                }));

                this.state.emaSeries = this.state.klineChart.addLineSeries({
                        color: '#ffc107',
                        lineWidth: 2,
                        priceLineVisible: false,
                        lastValueVisible: true,
                        crosshairMarkerVisible: true
                });
                this.state.emaSeries.setData(emaData);
            }

            // ğŸ†• æ¸²æŸ“æ‰‡é¢ (TASK-010-011)
            if (data.fan) {
                this.renderFanSeries(this.state.klineChart, data.fan);

                // ğŸ†• è®¢é˜…Crosshairäº‹ä»¶ï¼ˆhoveræ˜¾ç¤ºï¼‰
                this.subscribeChartCrosshair();

                // ğŸ†• åˆå§‹æ˜¾ç¤ºæœ€æ–°Kçº¿çš„æ•°æ®
                if (this.state.fanKlineData && this.state.fanKlineData.length > 0) {
                    const latestData = this.state.fanKlineData[this.state.fanKlineData.length - 1];
                    this.updateHUD(latestData);
                }
            }

            // ğŸ†• æ¸²æŸ“ä¹°å…¥ä¿¡å·æ ‡è®° (è¿­ä»£011)
            if (data.buy_signals) {
                this.state.buySignalsData = data.buy_signals;
                this.renderBuySignalMarkers();
                // è®¢é˜…ä¹°å…¥ä¿¡å·ç›¸å…³çš„äº¤äº’äº‹ä»¶
                this.subscribeBuySignalEvents();
            }

            // Fit content to show all data
            this.state.klineChart.timeScale().fitContent();
        },

        // Render Z-Score time series chart using Lightweight Charts
        renderZscoreChart: function(data) {
            const container = document.getElementById('zscore-chart');

            // Destroy existing chart
            if (this.state.zscoreChart) {
                this.state.zscoreChart.remove();
                this.state.zscoreChart = null;
            }

            // Create chart
            this.state.zscoreChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { type: 'solid', color: '#ffffff' },
                    textColor: '#333'
                },
                grid: {
                    vertLines: { color: 'rgba(197, 203, 206, 0.3)' },
                    horzLines: { color: 'rgba(197, 203, 206, 0.3)' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: 'rgba(197, 203, 206, 1)'
                },
                timeScale: {
                    borderColor: 'rgba(197, 203, 206, 1)',
                    timeVisible: true,
                    secondsVisible: false
                },
                handleScroll: {
                    vertTouchDrag: false
                }
            });

            // Convert zscore data format
            const zscoreData = data.zscore.map(z => ({
                time: Math.floor(z.t / 1000),
                value: z.y
            }));

            // Add Z-Score line series with area fill
            this.state.zscoreSeries = this.state.zscoreChart.addAreaSeries({
                    lineColor: '#6f42c1',
                    topColor: 'rgba(111, 66, 193, 0.4)',
                    bottomColor: 'rgba(111, 66, 193, 0.0)',
                    lineWidth: 2,
                    priceLineVisible: false,
                    lastValueVisible: true
            });
            this.state.zscoreSeries.setData(zscoreData);

            // Add horizontal threshold lines using price lines
            const thresholds = [
                { price: 1.64, color: 'rgba(25, 135, 84, 0.6)', title: '95%' },
                { price: 1.28, color: 'rgba(40, 167, 69, 0.5)', title: '90%' },
                { price: 0, color: 'rgba(108, 117, 125, 0.5)', title: '50%' },
                { price: -1.28, color: 'rgba(253, 126, 20, 0.5)', title: '10%' },
                { price: -1.64, color: 'rgba(220, 53, 69, 0.6)', title: '5%' }
            ];

            thresholds.forEach(th => {
                this.state.zscoreSeries.createPriceLine({
                    price: th.price,
                    color: th.color,
                    lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: th.title
                });
            });

            // Fit content to show all data
            this.state.zscoreChart.timeScale().fitContent();
        },

        // Helper functions
        showChartLoading: function(show) {
            document.getElementById('chart-loading').style.display = show ? 'flex' : 'none';
        },

        showError: function(message) {
            alert(message);
        },

        formatPrice: function(price) {
            if (price === null || price === undefined) return '-';
            return parseFloat(price).toFixed(4);
        },

        formatPercent: function(value) {
            if (value === null || value === undefined) return '-';
            return (value * 100).toFixed(2) + '%';
        },

        getZoneClass: function(zone) {
            const classes = {
                'extreme_oversold': 'zone-extreme-oversold',
                'oversold': 'zone-oversold',
                'neutral': 'zone-neutral',
                'overbought': 'zone-overbought',
                'extreme_overbought': 'zone-extreme-overbought'
            };
            return classes[zone] || '';
        },

        getSignalLabel: function(signalType, strength) {
            if (strength === 'none' || signalType === 'neutral') return 'æ— ä¿¡å·';
            const typeLabels = {
                'oversold': 'è¶…å–',
                'overbought': 'è¶…ä¹°',
                'neutral': 'ä¸­æ€§'
            };
            const strengthLabels = {
                'strong': 'å¼º',
                'weak': 'å¼±'
            };
            return (strengthLabels[strength] || '') + (typeLabels[signalType] || '');
        },

        getSignalClass: function(signalType, strength) {
            if (strength === 'none' || signalType === 'neutral') return 'bg-secondary';
            if (signalType === 'oversold') {
                return strength === 'strong' ? 'bg-danger' : 'bg-warning';
            }
            if (signalType === 'overbought') {
                return strength === 'strong' ? 'bg-success' : 'bg-info';
            }
            return 'bg-secondary';
        },

        // ============================================================
        // ğŸ†• æƒ¯æ€§æ‰‡é¢æ¸²æŸ“ (TASK-010-011, TASK-010-012)
        // ============================================================

        renderFanSeries: function(chart, fanData) {
            // Bug-013ä¿®å¤ï¼šæ”¯æŒå†å²æ‰‡é¢çº¿æ¡æ¸²æŸ“
            // ç®€åŒ–æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºä¸­è½´çº¿ï¼Œä¸æ˜¾ç¤ºä¸Šä¸‹è¾¹ç•Œ
            if (!fanData || !fanData.lines) {
                return;
            }

            const { mid } = fanData.lines;
            if (!mid || mid.length === 0) {
                return;
            }

            // ğŸ†• ä¿å­˜Kçº¿æ•°æ®ç”¨äºhoveræ˜¾ç¤º
            this.state.fanKlineData = fanData.kline_data || null;

            const isUpTrend = fanData.direction === 'up';
            const color = isUpTrend ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)';

            // æ¸…é™¤æ—§çš„æ‰‡é¢ series
            this.clearFanSeries();

            // ä¸­è½´çº¿ (å®çº¿) - åªæ˜¾ç¤ºä¸­è½´ï¼Œä¸æ˜¾ç¤ºä¸Šä¸‹è¾¹ç•Œ
            this.state.fanMidSeries = chart.addLineSeries({
                color: color,
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Solid,
                priceLineVisible: false,
                lastValueVisible: true,
                crosshairMarkerVisible: true,
            });

            // è½¬æ¢æ•°æ®æ ¼å¼ä¸º LightweightCharts éœ€è¦çš„æ ¼å¼
            const midData = mid.map(p => ({
                time: Math.floor(p.t / 1000),
                value: p.y
            }));

            this.state.fanMidSeries.setData(midData);
        },

        clearFanSeries: function() {
            // ç®€åŒ–ï¼šåªæ¸…ç†ä¸­è½´çº¿series
            if (this.state.fanMidSeries && this.state.klineChart) {
                this.state.klineChart.removeSeries(this.state.fanMidSeries);
                this.state.fanMidSeries = null;
            }
        },

        updateFanColor: function(direction) {
            // ç®€åŒ–ï¼šåªæ›´æ–°ä¸­è½´çº¿é¢œè‰²
            if (!this.state.fanMidSeries) return;

            const isUpTrend = direction === 'up';
            const color = isUpTrend ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)';

            this.state.fanMidSeries.applyOptions({ color: color });
        },

        // ============================================================
        // ğŸ†• HUD é¢æ¿æ›´æ–° (TASK-010-013, TASK-010-014)
        // ============================================================

        updateHUD: function(klineData) {
            const hud = document.getElementById('inertia-hud');

            if (!klineData) {
                hud.style.display = 'none';
                return;
            }

            hud.style.display = 'block';

            // æ›´æ–°é™æ€é˜ˆå€¼
            if (klineData.p95 !== null && klineData.p95 !== undefined) {
                document.getElementById('hud-p95').textContent = this.formatPrice(klineData.p95);
            } else {
                document.getElementById('hud-p95').textContent = 'N/A';
            }

            if (klineData.p5 !== null && klineData.p5 !== undefined) {
                document.getElementById('hud-p5').textContent = this.formatPrice(klineData.p5);
            } else {
                document.getElementById('hud-p5').textContent = 'N/A';
            }

            // æ›´æ–°æƒ¯æ€§é¢„æµ‹
            if (klineData.t_adj !== null && klineData.t_adj !== undefined) {
                document.getElementById('hud-t-adj').textContent = klineData.t_adj.toFixed(1);
            } else {
                document.getElementById('hud-t-adj').textContent = 'N/A';
            }

            if (klineData.fan_upper !== null && klineData.fan_upper !== undefined) {
                document.getElementById('hud-fan-upper').textContent = this.formatPrice(klineData.fan_upper);
            } else {
                document.getElementById('hud-fan-upper').textContent = 'N/A';
            }

            if (klineData.fan_mid !== null && klineData.fan_mid !== undefined) {
                document.getElementById('hud-fan-mid').textContent = this.formatPrice(klineData.fan_mid);
            } else {
                document.getElementById('hud-fan-mid').textContent = 'N/A';
            }

            if (klineData.fan_lower !== null && klineData.fan_lower !== undefined) {
                document.getElementById('hud-fan-lower').textContent = this.formatPrice(klineData.fan_lower);
            } else {
                document.getElementById('hud-fan-lower').textContent = 'N/A';
            }

            // æ›´æ–°çŠ¶æ€
            const badge = document.getElementById('hud-state-badge');
            const state = klineData.state || 'æ•°æ®ä¸è¶³';
            badge.textContent = state;

            // æ ¹æ®çŠ¶æ€è®¾ç½®badgeæ ·å¼
            if (state === 'æƒ¯æ€§ä¿æŠ¤ä¸­') {
                badge.className = 'status-badge status-protected';
            } else if (state === 'æƒ¯æ€§è¡°å‡') {
                badge.className = 'status-badge status-decaying';
            } else if (state === 'ä¿¡å·è§¦å‘') {
                badge.className = 'status-badge status-signal';
            } else {
                badge.className = 'status-badge';
            }

            // æ›´æ–° ADX å’Œ Î²
            if (klineData.adx !== null && klineData.adx !== undefined) {
                document.getElementById('hud-adx').textContent = klineData.adx.toFixed(1);
            } else {
                document.getElementById('hud-adx').textContent = 'N/A';
            }

            if (klineData.beta !== null && klineData.beta !== undefined) {
                document.getElementById('hud-beta').textContent = (klineData.beta * 100).toFixed(3) + '%';
            } else {
                document.getElementById('hud-beta').textContent = 'N/A';
            }

            // ğŸ†• æ›´æ–°å®è§‚å‘¨æœŸ (è¿­ä»£018)
            this.updateCycleHUD(klineData);
        },

        // ğŸ†• æ›´æ–°å®è§‚å‘¨æœŸæ˜¾ç¤º (è¿­ä»£018)
        updateCycleHUD: function(klineData) {
            const phaseBadge = document.getElementById('hud-cycle-phase');
            const durationSpan = document.getElementById('hud-cycle-duration');

            // å‘¨æœŸçŠ¶æ€æ ‡ç­¾æ˜ å°„
            const phaseLabels = {
                'consolidation': 'éœ‡è¡',
                'bull_warning': 'ä¸Šæ¶¨é¢„è­¦',
                'bull_strong': 'å¼ºåŠ¿ä¸Šæ¶¨',
                'bear_warning': 'ä¸‹è·Œé¢„è­¦',
                'bear_strong': 'å¼ºåŠ¿ä¸‹è·Œ'
            };

            // å‘¨æœŸçŠ¶æ€é¢œè‰²æ˜ å°„ (Bootstrap ç±»)
            const phaseColors = {
                'consolidation': 'secondary',
                'bull_warning': 'warning',
                'bull_strong': 'success',
                'bear_warning': 'warning',
                'bear_strong': 'danger'
            };

            // æ›´æ–°å‘¨æœŸçŠ¶æ€
            const cyclePhase = klineData.cycle_phase || 'consolidation';
            const phaseLabel = phaseLabels[cyclePhase] || 'éœ‡è¡';
            const phaseColor = phaseColors[cyclePhase] || 'secondary';

            phaseBadge.textContent = phaseLabel;
            phaseBadge.className = 'status-badge bg-' + phaseColor;

            // æ›´æ–°æŒç»­æ—¶é—´ï¼ˆä» current_cycle è·å–ï¼Œå¦‚æœå¯ç”¨ï¼‰
            if (this.state.currentCycle) {
                const cc = this.state.currentCycle;
                if (cc.duration_bars > 0) {
                    const hours = cc.duration_hours;
                    let durationText = cc.duration_bars + 'æ ¹Kçº¿';
                    if (hours >= 24) {
                        durationText += ' (' + (hours / 24).toFixed(1) + 'å¤©)';
                    } else if (hours > 0) {
                        durationText += ' (' + hours.toFixed(1) + 'å°æ—¶)';
                    }
                    durationSpan.textContent = durationText;
                } else {
                    durationSpan.textContent = '-';
                }
            } else {
                durationSpan.textContent = '-';
            }
        },

        // ğŸ†• æ ¹æ®æ—¶é—´æˆ³æŸ¥æ‰¾Kçº¿æ•°æ®
        findKlineDataByTime: function(timeSeconds) {
            if (!this.state.fanKlineData || this.state.fanKlineData.length === 0) {
                return null;
            }

            // è½¬æ¢ä¸ºæ¯«ç§’
            const timeMs = timeSeconds * 1000;

            // åœ¨kline_dataä¸­æŸ¥æ‰¾åŒ¹é…çš„æ—¶é—´æˆ³
            return this.state.fanKlineData.find(data => data.t === timeMs) || null;
        },

        // ğŸ†• è®¢é˜…å›¾è¡¨Crosshairäº‹ä»¶ï¼ˆhoveræ˜¾ç¤ºï¼‰
        subscribeChartCrosshair: function() {
            if (!this.state.klineChart) {
                return;
            }

            const self = this;

            this.state.klineChart.subscribeCrosshairMove(function(param) {
                if (!param || !param.time) {
                    // é¼ æ ‡ç¦»å¼€å›¾è¡¨æ—¶ï¼Œæ˜¾ç¤ºæœ€æ–°æ•°æ®
                    if (self.state.fanKlineData && self.state.fanKlineData.length > 0) {
                        const latestData = self.state.fanKlineData[self.state.fanKlineData.length - 1];
                        self.updateHUD(latestData);
                    }
                    return;
                }

                // æ ¹æ®æ—¶é—´æŸ¥æ‰¾å¯¹åº”çš„Kçº¿æ•°æ®
                const klineData = self.findKlineDataByTime(param.time);
                if (klineData) {
                    self.updateHUD(klineData);
                }
            });
        },

        // ============================================================
        // ğŸ†• ä¹°å…¥ä¿¡å·åŠŸèƒ½ (è¿­ä»£011)
        // ============================================================

        // æ¸²æŸ“ä¹°å…¥ä¿¡å·æ ‡è®°ï¼ˆåŒ…å«å–å‡ºç‚¹ï¼‰
        renderBuySignalMarkers: function() {
            // ğŸ†• è¿­ä»£012: ä½¿ç”¨ç»Ÿä¸€çš„ renderSellMarkers æ–¹æ³•æ¸²æŸ“ä¹°å…¥å’Œå–å‡ºæ ‡è®°
            this.renderSellMarkers();
        },

        // è®¢é˜…ä¹°å…¥ä¿¡å·ç›¸å…³çš„äº¤äº’äº‹ä»¶
        subscribeBuySignalEvents: function() {
            if (!this.state.klineChart) {
                return;
            }

            const self = this;

            // ç‚¹å‡»äº‹ä»¶ - å›ºå®šæ˜¾ç¤ºCard
            this.state.klineChart.subscribeClick(function(param) {
                if (!param || !param.time) {
                    self.closeBuySignalCard();
                    return;
                }

                // æŸ¥æ‰¾æ˜¯å¦ç‚¹å‡»åœ¨ä¹°å…¥ç‚¹ä¸Š
                const signal = self.findBuySignalByTime(param.time);
                if (signal && self.hasTriggeredStrategies(signal)) {
                    self.showBuySignalCard(signal, param.point, true);
                } else {
                    self.closeBuySignalCard();
                }
            });
        },

        // æ ¹æ®æ—¶é—´æˆ³æŸ¥æ‰¾ä¹°å…¥ä¿¡å·
        findBuySignalByTime: function(timeSeconds) {
            if (!this.state.buySignalsData || this.state.buySignalsData.length === 0) {
                return null;
            }

            // è½¬æ¢ä¸ºæ¯«ç§’
            const timeMs = timeSeconds * 1000;

            // åœ¨ä¹°å…¥ä¿¡å·ä¸­æŸ¥æ‰¾åŒ¹é…çš„æ—¶é—´æˆ³ï¼ˆå…è®¸1ç§’è¯¯å·®ï¼‰
            return this.state.buySignalsData.find(signal =>
                Math.abs(signal.timestamp - timeMs) < 1000
            ) || null;
        },

        // æ£€æŸ¥ä¿¡å·æ˜¯å¦æœ‰è§¦å‘çš„ç­–ç•¥
        hasTriggeredStrategies: function(signal) {
            if (!signal || !signal.strategies) return false;
            return signal.strategies.some(s => s.triggered);
        },

        // æ˜¾ç¤ºä¹°å…¥ä¿¡å·Card
        showBuySignalCard: function(signal, point, fixed = false) {
            const card = document.getElementById('buySignalCard');

            // æ ¼å¼åŒ–æ—¶é—´
            const date = new Date(signal.timestamp);
            document.getElementById('signalTime').textContent = this.formatDateTime(date);

            // æ ¼å¼åŒ–ä»·æ ¼
            document.getElementById('signalPrice').textContent = '$' + this.formatPriceWithCommas(signal.buy_price);

            // ğŸ†• è¿­ä»£012: æŸ¥æ‰¾å¯¹åº”è®¢å•ï¼Œæ˜¾ç¤ºè®¢å•çŠ¶æ€å’Œç›ˆäº
            const order = this.findOrderByBuyTime(signal.timestamp);
            let orderInfoHtml = '';
            if (order) {
                const isHolding = order.status === 'holding';
                const statusText = isHolding ? 'æŒä»“ä¸­' : 'å·²å–å‡º';
                const statusClass = isHolding ? 'order-status-holding' : 'order-status-sold';

                orderInfoHtml = `
                    <div class="signal-info-row">
                        <span class="signal-info-label">ğŸ“¦ è®¢å•çŠ¶æ€:</span>
                        <span class="signal-info-value ${statusClass}">${statusText}</span>
                    </div>
                `;

                if (isHolding && order.floating_profit_usdt !== null && order.floating_profit_usdt !== undefined) {
                    // æŒä»“ä¸­æ˜¾ç¤ºæµ®åŠ¨ç›ˆäº
                    const floatingProfit = parseFloat(order.floating_profit_usdt);
                    const floatingRate = order.floating_profit_rate ? parseFloat(order.floating_profit_rate) : null;
                    const profitClass = floatingProfit >= 0 ? 'profit-positive' : 'profit-negative';
                    const profitSign = floatingProfit >= 0 ? '+' : '';
                    orderInfoHtml += `
                        <div class="signal-info-row">
                            <span class="signal-info-label">ğŸ“ˆ æµ®åŠ¨ç›ˆäº:</span>
                            <span class="signal-info-value ${profitClass}">${profitSign}${floatingProfit.toFixed(2)} U</span>
                        </div>
                    `;
                    if (floatingRate !== null) {
                        orderInfoHtml += `
                            <div class="signal-info-row">
                                <span class="signal-info-label">ğŸ“Š æµ®åŠ¨æ”¶ç›Šç‡:</span>
                                <span class="signal-info-value ${profitClass}">${profitSign}${floatingRate.toFixed(2)}%</span>
                            </div>
                        `;
                    }
                } else if (!isHolding) {
                    // å·²å–å‡ºæ˜¾ç¤ºå®é™…ç›ˆäº
                    if (order.sell_price) {
                        orderInfoHtml += `
                            <div class="signal-info-row">
                                <span class="signal-info-label">ğŸ’° å–å‡ºä»·æ ¼:</span>
                                <span class="signal-info-value">$${this.formatPriceWithCommas(order.sell_price)}</span>
                            </div>
                        `;
                    }
                    if (order.profit_usdt !== null && order.profit_usdt !== undefined) {
                        const profit = parseFloat(order.profit_usdt);
                        const profitRate = order.profit_rate ? parseFloat(order.profit_rate) : null;
                        const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                        const profitSign = profit >= 0 ? '+' : '';
                        orderInfoHtml += `
                            <div class="signal-info-row">
                                <span class="signal-info-label">ğŸ’µ å®é™…ç›ˆäº:</span>
                                <span class="signal-info-value ${profitClass}">${profitSign}${profit.toFixed(2)} U</span>
                            </div>
                        `;
                        if (profitRate !== null) {
                            orderInfoHtml += `
                                <div class="signal-info-row">
                                    <span class="signal-info-label">ğŸ“Š æ”¶ç›Šç‡:</span>
                                    <span class="signal-info-value ${profitClass}">${profitSign}${profitRate.toFixed(2)}%</span>
                                </div>
                            `;
                        }
                    }
                    if (order.holding_periods) {
                        orderInfoHtml += `
                            <div class="signal-info-row">
                                <span class="signal-info-label">â±ï¸ æŒä»“å‘¨æœŸ:</span>
                                <span class="signal-info-value">${order.holding_periods} æ ¹Kçº¿</span>
                            </div>
                        `;
                    }
                }
            }

            // æ¸²æŸ“ç­–ç•¥åˆ—è¡¨
            const triggeredStrategies = signal.strategies.filter(s => s.triggered);
            const strategiesHtml = triggeredStrategies.map(s => `
                <div class="strategy-item">
                    <div class="strategy-name">${s.name}</div>
                    <div class="strategy-reason">${s.reason || 'è§¦å‘'}</div>
                </div>
            `).join('');

            // ğŸ†• è¿­ä»£012: åœ¨ç­–ç•¥åˆ—è¡¨å‰æ’å…¥è®¢å•ä¿¡æ¯
            document.getElementById('strategiesList').innerHTML = orderInfoHtml + strategiesHtml;

            // è®¡ç®—ä½ç½®
            const chartContainer = document.getElementById('kline-chart');
            const chartRect = chartContainer.getBoundingClientRect();

            let left = chartRect.left + point.x + 20;
            let top = chartRect.top + point.y - 100;

            // è¾¹ç•Œæ£€æµ‹
            const cardWidth = 350;
            const cardHeight = 250;

            if (left + cardWidth > window.innerWidth) {
                left = chartRect.left + point.x - cardWidth - 20;
            }
            if (top < 0) {
                top = 20;
            }
            if (top + cardHeight > window.innerHeight) {
                top = window.innerHeight - cardHeight - 20;
            }

            card.style.left = left + 'px';
            card.style.top = top + 'px';
            card.style.display = 'block';

            // å›ºå®šæ¨¡å¼
            if (fixed) {
                card.classList.add('fixed');
                this.state.buySignalCardFixed = true;
            } else {
                card.classList.remove('fixed');
            }
        },

        // å…³é—­ä¹°å…¥ä¿¡å·Card
        closeBuySignalCard: function() {
            const card = document.getElementById('buySignalCard');
            card.style.display = 'none';
            card.classList.remove('fixed');
            this.state.buySignalCardFixed = false;
        },

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        formatDateTime: function(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        },

        // æ ¼å¼åŒ–ä»·æ ¼ï¼ˆå¸¦åƒåˆ†ä½ï¼‰
        formatPriceWithCommas: function(price) {
            if (price === null || price === undefined) return '-';
            return parseFloat(price).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        },

        // ============================================================
        // ğŸ†• è®¢å•è¿½è¸ªåŠŸèƒ½ (è¿­ä»£012)
        // ============================================================

        // æ¸²æŸ“ç»Ÿè®¡é¢æ¿
        renderStatisticsPanel: function() {
            const stats = this.state.orderStatistics;
            if (!stats) {
                return;
            }

            // æ€»è®¢å•
            document.getElementById('stat-total-orders').textContent = stats.total_orders || 0;

            // å·²å–å‡º
            document.getElementById('stat-sold-orders').textContent = stats.sold_orders || 0;

            // æŒä»“ä¸­
            document.getElementById('stat-holding-orders').textContent = stats.holding_orders || 0;

            // èƒœç‡
            const winRateEl = document.getElementById('stat-win-rate');
            if (stats.win_rate !== null && stats.win_rate !== undefined) {
                winRateEl.textContent = stats.win_rate.toFixed(1) + '%';
                winRateEl.className = 'fw-bold fs-5 ' + (stats.win_rate >= 50 ? 'profit-positive' : 'profit-negative');
            } else {
                winRateEl.textContent = '-';
                winRateEl.className = 'fw-bold fs-5';
            }

            // æ€»æ”¶ç›Š
            const totalProfitEl = document.getElementById('stat-total-profit');
            if (stats.total_profit !== null && stats.total_profit !== undefined) {
                const profit = parseFloat(stats.total_profit);
                totalProfitEl.textContent = (profit >= 0 ? '+' : '') + profit.toFixed(2) + ' U';
                totalProfitEl.className = 'fw-bold fs-5 ' + (profit >= 0 ? 'profit-positive' : 'profit-negative');
            } else {
                totalProfitEl.textContent = '-';
                totalProfitEl.className = 'fw-bold fs-5';
            }

            // æµ®åŠ¨ç›ˆäº
            const floatingProfitEl = document.getElementById('stat-floating-profit');
            if (stats.floating_profit !== null && stats.floating_profit !== undefined) {
                const floatingProfit = parseFloat(stats.floating_profit);
                floatingProfitEl.textContent = (floatingProfit >= 0 ? '+' : '') + floatingProfit.toFixed(2) + ' U';
                floatingProfitEl.className = 'fw-bold fs-5 ' + (floatingProfit >= 0 ? 'profit-positive' : 'profit-negative');
            } else {
                floatingProfitEl.textContent = '-';
                floatingProfitEl.className = 'fw-bold fs-5';
            }
        },

        // æ¸²æŸ“å–å‡ºç‚¹æ ‡è®°ï¼ˆä¸ä¹°å…¥æ ‡è®°åˆå¹¶ï¼‰
        renderSellMarkers: function() {
            if (!this.state.candleSeries) {
                return;
            }

            // æ£€æŸ¥ setMarkers æ–¹æ³•æ˜¯å¦å¯ç”¨
            if (typeof this.state.candleSeries.setMarkers !== 'function') {
                console.warn('[è®¢å•è¿½è¸ª] setMarkersæ–¹æ³•ä¸å¯ç”¨');
                return;
            }

            const filter = this.config.currentBuyFilter;
            let markers = [];

            // ä¹°å…¥æ ‡è®°
            if (this.state.buySignalsData) {
                const filteredSignals = this.state.buySignalsData.filter(signal => {
                    if (filter === 'all') {
                        return signal.strategies.some(s => s.triggered);
                    }
                    return signal.strategies.some(s => s.id === filter && s.triggered);
                });

                const buyMarkers = filteredSignals.map(signal => ({
                    time: Math.floor(signal.timestamp / 1000),
                    position: 'belowBar',
                    color: '#28a745',
                    shape: 'arrowUp',
                    text: 'B',
                    size: 1
                }));
                markers = markers.concat(buyMarkers);
            }

            // å–å‡ºæ ‡è®°
            if (this.state.ordersData) {
                const sellMarkers = this.state.ordersData
                    .filter(order => order.status === 'sold' && order.sell_timestamp)
                    .map(order => ({
                        time: Math.floor(order.sell_timestamp / 1000),
                        position: 'aboveBar',
                        color: '#dc3545',
                        shape: 'arrowDown',
                        text: 'S',
                        size: 1
                    }));
                markers = markers.concat(sellMarkers);
            }

            // æŒ‰æ—¶é—´æ’åº
            markers.sort((a, b) => a.time - b.time);

            // åº”ç”¨Markersåˆ°Kçº¿å›¾
            try {
                this.state.candleSeries.setMarkers(markers);
                console.log(`[è®¢å•è¿½è¸ª] æ¸²æŸ“ ${markers.length} ä¸ªæ ‡è®°`);
            } catch (e) {
                console.error('[è®¢å•è¿½è¸ª] setMarkersè°ƒç”¨å¤±è´¥:', e);
            }
        },

        // æ¸²æŸ“æ“ä½œæ—¥å¿—
        renderTradeEvents: function() {
            const container = document.getElementById('tradeEventsContainer');
            if (!container) {
                return;
            }

            const events = this.state.tradeEventsData || [];
            const filter = this.config.currentEventFilter;

            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤äº‹ä»¶
            const filteredEvents = events.filter(event => {
                if (filter === 'all') return true;
                return event.event_type === filter;
            });

            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">æš‚æ— æ“ä½œè®°å½•</div>';
                return;
            }

            // æ¸²æŸ“äº‹ä»¶åˆ—è¡¨
            const html = filteredEvents.map(event => {
                const isBuy = event.event_type === 'buy';
                const typeClass = isBuy ? 'event-type-buy' : 'event-type-sell';
                const typeText = isBuy ? 'ä¹°å…¥' : 'å–å‡º';

                // æ ¼å¼åŒ–æ—¶é—´
                const date = new Date(event.timestamp);
                const timeStr = this.formatDateTime(date);

                // æ ¼å¼åŒ–ä»·æ ¼å’Œæ•°é‡
                const price = parseFloat(event.price).toFixed(4);
                const quantity = parseFloat(event.quantity).toFixed(6);
                const amount = parseFloat(event.amount_usdt).toFixed(2);

                // ç›ˆäºä¿¡æ¯ï¼ˆåªåœ¨å–å‡ºæ—¶æ˜¾ç¤ºï¼‰
                let profitHtml = '';
                if (!isBuy && event.profit_usdt !== null && event.profit_usdt !== undefined) {
                    const profit = parseFloat(event.profit_usdt);
                    const profitRate = event.profit_rate ? parseFloat(event.profit_rate) : null;
                    const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                    const profitSign = profit >= 0 ? '+' : '';
                    profitHtml = `
                        <div class="event-info-item">
                            <span class="event-info-label">ç›ˆäº</span>
                            <span class="event-info-value ${profitClass}">${profitSign}${profit.toFixed(2)} U</span>
                        </div>
                    `;
                    if (profitRate !== null) {
                        profitHtml += `
                            <div class="event-info-item">
                                <span class="event-info-label">æ”¶ç›Šç‡</span>
                                <span class="event-info-value ${profitClass}">${profitSign}${profitRate.toFixed(2)}%</span>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="trade-event-item">
                        <span class="event-type-badge ${typeClass}">${typeText}</span>
                        <div class="event-info">
                            <div class="event-info-item">
                                <span class="event-info-label">æ—¶é—´</span>
                                <span class="event-info-value">${timeStr}</span>
                            </div>
                            <div class="event-info-item">
                                <span class="event-info-label">ä»·æ ¼</span>
                                <span class="event-info-value">$${price}</span>
                            </div>
                            <div class="event-info-item">
                                <span class="event-info-label">æ•°é‡</span>
                                <span class="event-info-value">${quantity}</span>
                            </div>
                            <div class="event-info-item">
                                <span class="event-info-label">é‡‘é¢</span>
                                <span class="event-info-value">${amount} U</span>
                            </div>
                            ${profitHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        },

        // æ ¹æ®ä¹°å…¥æ—¶é—´æˆ³æŸ¥æ‰¾è®¢å•
        findOrderByBuyTime: function(timeMs) {
            if (!this.state.ordersData || this.state.ordersData.length === 0) {
                return null;
            }
            return this.state.ordersData.find(order =>
                Math.abs(order.buy_timestamp - timeMs) < 1000
            ) || null;
        }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        DDPSDetail.init();
    });
</script>
<style>
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}
