# Feature Specification: 合约分析详情页

**Feature Branch**: `007-contract-detail-page`
**Created**: 2025-12-12
**Status**: Draft
**Input**: User description: "Good，接下来我需要新增新功能。我需要给 /screening/daily/ 中的合约增加详情按钮，点击进入该天该合约的分析详情页（需要新设计此页面）该页面清晰展示我们分析的所有数据，并列出参与计算的k线，使用k线图展示，k线图中标记关键指标。请设计并实现此功能。"

## Clarifications

### Session 2025-12-12

- Q: 数据不足时的展示策略 - 如果某个合约的K线数据不足(如新上市合约只有10根4h K线)，系统如何展示？ → A: 显示所有可用K线+顶部警告横幅"数据不足，仅显示XX根K线"，允许用户查看
- Q: 无效URL访问的处理策略 - 用户直接访问不存在的日期/合约组合URL时如何处理？ → A: 显示友好404页面，包含"该日期该合约无筛选记录"说明+返回列表按钮+其他可用日期快捷链接
- Q: 指标计算失败的显示策略 - 当某个合约的某些指标（如RSI、EMA斜率等）计算失败返回None时，详情页应该如何显示？ → A: 显示"计算失败"文本并附带Tooltip说明失败原因（如"数据不足：需要至少15根K线，当前仅有8根"），保持透明度和可调试性
- Q: 图表性能优化策略 - 当K线数量较大（300根）且叠加多条技术指标线时，如何优化渲染性能？ → A: 采用分批渲染策略：第一阶段渲染K线蜡烛图（<500ms），第二阶段异步叠加EMA均线，第三阶段叠加VPA标记和规则信号，用户先看到图表骨架再逐步看到完整内容
- Q: 移动端适配策略 - 移动设备上的K线图交互如何处理？ → A: 当前版本不考虑移动端适配，专注于桌面网页版本的实现，移动端支持可作为未来迭代功能

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看合约分析详情 (Priority: P1)

交易员在日历筛选页面(/screening/daily/)浏览每日筛选结果时，需要深入了解某个合约的完整分析数据，以便做出更明智的交易决策。点击合约旁边的详情按钮，进入独立的详情页，该页面展示所有用于分析的指标、参数和K线数据。

**Why this priority**: 这是核心功能，提供了从列表视图到详情视图的基本导航能力，满足用户深入分析单个合约的核心需求。

**Independent Test**: 可以通过在任意日期的筛选结果中点击任意合约的详情按钮，成功进入详情页并看到该合约的完整数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在/screening/daily/2024-12-05页面查看筛选结果，**When** 点击某个合约(如ZENUSDT)的"详情"按钮，**Then** 页面跳转到该合约的详情页(如/screening/daily/2024-12-05/ZENUSDT)，URL中包含日期和合约symbol
2. **Given** 用户进入合约详情页，**When** 页面加载完成，**Then** 看到该合约的基本信息区域(symbol、当前价格、排名、综合指数)
3. **Given** 用户在详情页向下滚动，**When** 查看页面内容，**Then** 看到所有分析指标按逻辑分组展示(波动率指标、趋势指标、市场数据、资金流分析等)

---

### User Story 2 - 查看关键指标K线图 (Priority: P1)

交易员需要可视化地查看合约的K线走势，并在图表上标记关键技术指标(如EMA均线、布林带、RSI等)，以便直观理解价格走势和指标信号。

**Why this priority**: K线图是技术分析的核心工具，与P1同等重要，因为没有图表，纯数字数据很难让用户理解市场行为。

**Independent Test**: 可以通过进入任意合约详情页，检查页面是否展示了K线图，并且图表上是否正确标记了EMA99、EMA20等关键指标线来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在合约详情页，**When** 页面加载完成，**Then** 看到4h K线图表，展示300根K线数据(约50天历史)
2. **Given** 用户查看K线图，**When** 观察图表叠加层，**Then** 看到EMA99均线(蓝色)和EMA20均线(橙色)叠加在K线图上
3. **Given** 用户查看K线图，**When** 观察图表标记，**Then** 看到特殊价格点的标注(当前价格、网格上下限、止盈止损位)
4. **Given** 用户查看K线图，**When** 将鼠标悬停在某根K线上，**Then** 显示该K线的详细信息(时间、开高低收、成交量)

---

### User Story 3 - 查看多周期K线数据 (Priority: P2)

交易员希望切换不同时间周期的K线图(15m、1h、4h、1d)，以便从不同时间维度分析价格走势和指标有效性。

**Why this priority**: 多周期分析有助于确认信号可靠性，但不是最核心功能，可以在P1完成后实现。

**Independent Test**: 可以通过在详情页K线图上方的周期选择器切换不同周期，检查图表是否正确更新为对应周期的K线数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在合约详情页查看4h K线图，**When** 点击周期切换按钮选择"15m"，**Then** 图表更新为15分钟K线，显示100根K线(约25小时历史)
2. **Given** 用户切换到1h周期，**When** 图表加载完成，**Then** 显示50根1h K线(约2天历史)，并且EMA均线相应调整
3. **Given** 用户切换到1d周期，**When** 图表加载完成，**Then** 显示30根日K线(约1个月历史)

---

### User Story 4 - 查看VPA和规则触发信号 (Priority: P3)

交易员希望在K线图上直观看到VPA模式(急刹车、金针探底、攻城锤、阳包阴)和价格规则(规则6止盈、规则7止损)的触发位置，以便识别关键交易信号。

**Why this priority**: 这是增强型功能，帮助用户更深入理解系统的信号生成逻辑，但不影响基本的数据查看功能。

**Independent Test**: 可以通过选择一个在历史上触发过规则6或规则7的合约和日期，检查详情页K线图上是否在对应位置显示了信号标记来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户查看某个合约在特定日期触发了规则6(止盈信号)，**When** 进入该日期该合约的详情页，**Then** 在K线图上看到绿色向上箭头标记止盈信号触发点，鼠标悬停显示"规则6触发: 急刹车+RSI超卖"
2. **Given** 用户查看K线图，**When** 某根K线被检测为VPA模式(如攻城锤)，**Then** 该K线被特殊高亮或标注，显示VPA模式名称
3. **Given** 用户在详情页查看指标明细区域，**When** 滚动到"规则触发历史"部分，**Then** 看到一个时间轴列表，列出该合约在分析时间范围内所有规则触发记录

---

### Edge Cases

- **数据缺失场景**: 已明确 - 显示所有可用K线+顶部警告横幅"数据不足，仅显示XX根K线(需要YYY根)"，允许用户查看(参见FR-019)
- **URL直接访问**: 已明确 - 显示友好404页面，包含错误说明、返回列表按钮、最近5个可用日期快捷链接(参见FR-027)
- **指标计算失败**: 已明确 - 显示"计算失败"标识+Tooltip说明失败原因（如"数据不足：需要至少15根K线，当前仅有8根"），保持指标行完整性，不隐藏(参见FR-028)
- **图表性能**: 已明确 - 采用分批渲染策略：第一阶段渲染K线蜡烛图（<500ms），第二阶段叠加EMA均线（<1.5s），第三阶段叠加VPA标记（<2s），用户先看到骨架再逐步完善(参见FR-025)
- **移动端适配**: 不在当前范围 - 本版本专注于桌面网页版本，移动端支持作为未来迭代功能
- **历史日期访问**: 用户查看很久以前的筛选结果(如6个月前)，K线数据和指标是基于当时计算的快照还是实时重新计算？如果是快照，数据存储在哪里？

## Requirements *(mandatory)*

### Functional Requirements

#### 页面路由与导航

- **FR-001**: 系统必须在/screening/daily/页面的每个合约行上提供"详情"按钮或链接
- **FR-002**: 点击详情按钮后，系统必须导航到格式为`/screening/daily/<date>/<symbol>`的详情页URL(如/screening/daily/2024-12-05/ZENUSDT)
- **FR-003**: 详情页必须提供"返回列表"按钮，点击后返回原始日期的筛选结果列表页(/screening/daily/<date>)
- **FR-004**: 系统必须支持用户直接通过URL访问详情页，并验证该日期和合约的筛选记录是否存在

#### 基本信息展示

- **FR-005**: 详情页必须在顶部展示合约的基本信息区域，包含:
  - 合约symbol(如ZENUSDT)
  - 当前价格
  - 排名(在当天筛选结果中的排名)
  - 综合指数
  - 筛选日期
- **FR-006**: 系统必须展示该合约在ScreeningResultModel中存储的所有原始指标，包括但不限于:
  - 波动率维度: VDR、KER、振幅累计(amplitude_sum_15m)
  - 趋势维度: EMA99斜率、EMA20斜率、高点回落百分比、价格分位
  - 市场维度: 持仓量、24h交易量、Vol/OI比率、年化资金费率
  - 资金流维度: 大单净流入、资金流强度、大单主导度
- **FR-007**: 系统必须展示网格参数推荐数据:
  - 网格上限/下限价格
  - 推荐网格数
  - 网格步长
  - 止盈价格和百分比
  - 止损价格和百分比
- **FR-008**: 系统必须展示挂单建议数据:
  - RSI(15m)
  - 推荐挂单价
  - 24h/72h触发概率
  - 入场策略标签
  - 3档挂单候选方案(从entry_candidates_json解析)

#### K线图表展示

- **FR-009**: 系统必须展示4h周期的K线图，默认显示300根K线(约50天历史)
- **FR-010**: K线图必须支持标准的蜡烛图形式，使用国际习惯配色方案：阳线(上涨)显示为绿色，阴线(下跌)显示为红色，与主流国际交易平台(Binance、TradingView)保持一致
- **FR-011**: 系统必须在K线图上叠加EMA99均线和EMA20均线，使用不同颜色区分
- **FR-012**: 系统必须在K线图上标注关键价格位，包括:
  - 当前价格(水平虚线)
  - 网格上限和下限(水平实线，不同颜色)
  - 止盈价格和止损价格(水平点线)
- **FR-013**: K线图必须显示成交量柱状图在图表下方
- **FR-014**: 系统必须在K线图上支持鼠标悬停交互，显示该K线的详细信息tooltip(时间、开高低收、成交量)

#### 多周期K线切换

- **FR-015**: 系统必须在K线图上方提供周期切换器，支持至少4种周期: 15m、1h、4h、1d
- **FR-016**: 切换周期时，系统必须重新获取对应周期的K线数据:
  - 15m: 100根(约25小时)
  - 1h: 50根(约2天)
  - 4h: 300根(约50天)
  - 1d: 30根(约1个月)
- **FR-017**: 切换周期时，EMA均线必须基于新周期的K线重新计算并重绘

#### K线数据来源

- **FR-018**: 系统必须从KlineData表获取该合约在指定日期之前的K线数据(使用open_time < screening_date + 1day的逻辑)
- **FR-019**: 如果K线数据不足指定根数(如新合约只有20根4h K线)，系统必须显示实际存在的所有K线，并在图表顶部显示黄色警告横幅"数据不足，仅显示XX根K线(需要YYY根)"，允许用户继续查看可用数据
- **FR-020**: 系统必须优先使用KlineCache服务获取K线数据，以利用本地缓存提升性能

#### VPA信号和规则标记(可选增强)

- **FR-021**: 系统应在K线图上标记规则6(止盈信号)的触发点，使用绿色向上箭头图标
- **FR-022**: 系统应在K线图上标记规则7(止损信号)的触发点，使用红色向下箭头图标
- **FR-023**: 鼠标悬停在规则标记上时，系统应显示该规则的详细信息(VPA模式、技术信号、RSI值、触发时间)

#### 性能与用户体验

- **FR-024**: 详情页初始加载时间(从点击详情按钮到页面可交互)必须在3秒以内
- **FR-025**: K线图必须采用分批渲染策略以优化性能：
  - 第一阶段（首次可见）：渲染基础K线蜡烛图和成交量柱状图，时间<500ms
  - 第二阶段（技术指标）：异步计算并叠加EMA99、EMA20均线，累计时间<1.5s
  - 第三阶段（增强标记）：叠加VPA模式标记、规则触发信号（可选），累计时间<2s
  - 各阶段之间无明显卡顿或白屏，用户感知为流畅的"逐步完善"而非"加载失败"
- **FR-026**: 系统必须提供加载指示器，在数据获取和图表渲染期间显示"加载中..."状态
- **FR-027**: 如果访问的日期或合约不存在筛选记录，系统必须返回HTTP 404状态码，并显示友好错误页面，内容包括：
  - 明确说明"该日期(YYYY-MM-DD)的合约(SYMBOL)无筛选记录"
  - "返回筛选列表"按钮(链接到/screening/daily/)
  - "查看其他日期"区域，展示最近5个有数据的日期快捷链接

#### 指标数据展示

- **FR-028**: 当某个指标计算失败（返回None或异常值）时，系统必须在该指标位置显示"计算失败"标识，并提供Tooltip悬停提示说明具体失败原因，例如：
  - "数据不足：需要至少15根K线，当前仅有8根"
  - "计算异常：除零错误"
  - 使用question-circle图标(ⓘ)标识
  - 保持指标行的完整性，不隐藏失败的指标项
  - 在indicator_calculator.py的各计算函数中，捕获异常并返回包含错误信息的结构

### Key Entities

- **ScreeningResultModel (已存在)**: 存储单个合约在某次筛选中的完整分析数据，包括所有指标、评分、推荐参数
  - 关键属性: record(外键到ScreeningRecord), symbol, current_price, vdr, ker, ovr, ma99_slope, ma20_slope, annual_funding_rate, entry_candidates_json等
  - 关系: 属于某个ScreeningRecord，一对多关系

- **KlineData (已存在)**: 存储K线原始数据
  - 关键属性: symbol, interval(15m/1h/4h/1d), open_time, open, high, low, close, volume
  - 用途: 为详情页提供K线图表数据

- **ScreeningRecord (已存在)**: 存储某次筛选的元数据
  - 关键属性: screening_date, total_candidates, execution_time, weights
  - 关系: 包含多个ScreeningResultModel

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从列表页点击详情按钮到详情页完全加载的时间在95%的情况下不超过3秒
- **SC-002**: 详情页必须展示至少20个以上的分析指标，覆盖波动率、趋势、市场、资金流四个维度
- **SC-003**: K线图表必须在所有主流桌面浏览器(Chrome、Firefox、Safari、Edge)上正确渲染，无图表变形或指标线缺失
- **SC-004**: 用户在详情页停留时间平均超过2分钟，表明页面内容足够有价值让用户深入研究
- **SC-005**: 90%的用户能够在详情页找到他们需要的指标数据，无需返回列表页或查看其他页面
- **SC-006**: K线图支持至少4种周期切换(15m、1h、4h、1d)，且切换响应时间不超过1秒
- **SC-007**: K线图表支持完整的桌面端交互操作，包括鼠标拖动平移、滚轮缩放、悬停显示Tooltip等

### 定性目标

- 详情页的信息架构清晰，用户无需说明即可理解各个区域的含义和数据来源
- K线图的视觉设计专业，颜色对比度合适，关键指标标记醒目易识别
- 页面布局合理，在桌面端浏览器中提供良好的浏览和交互体验

## Assumptions

- 假设所有合约在筛选时都有足够的K线数据用于计算指标(至少100根4h K线)，如果数据不足，详情页将显示警告但不阻止查看
- 假设用户在桌面端使用详情页进行分析，本版本不考虑移动端适配（移动端支持作为未来迭代功能）
- 假设K线图使用轻量级的JS图表库(如Lightweight Charts或ECharts)，不需要后端生成图片
- 假设详情页的K线数据来自历史快照(ScreeningRecord的screening_date时刻的数据)，而非实时最新数据
- 假设规则6和规则7的触发信号可以通过回溯检测K线数据来标记，不需要额外存储触发记录表
- 假设页面采用Django模板渲染(SSR)方式，K线数据通过API异步加载到前端图表
