# Feature Specification: 加密货币交易所新币上线监控系统

**Feature Branch**: `001-listing-monitor`
**Created**: 2025-11-06
**Status**: Draft
**Input**: User description: "我需要获取并监控Binance, hyperliquid, Bybit, Bitget的公告,从中找到新币上线现货/合约信息,分析并整理进数据库并通知。获取公告的方式可以参考crypto_exchange_news_crawler,其中hyperliquid尚未实现,可之后更新。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自动监控交易所新币上线公告 (Priority: P1)

作为一名加密货币交易者或研究员,我需要系统自动监控多个交易所的公告,并及时发现新币上线的信息,这样我就能快速了解市场动态,不会错过新的投资机会。

**Why this priority**: 这是系统的核心价值。没有这个功能,系统就没有存在的意义。自动监控和识别新币上线是所有后续功能的基础。

**Independent Test**: 可以通过启动监控服务,等待一段时间后检查数据库中是否成功捕获并存储了新币上线公告来独立测试。即使没有通知功能,这个核心功能也能独立验证其价值。

**Acceptance Scenarios**:

1. **Given** 系统正常运行且配置了Binance交易所, **When** Binance发布新币上线公告, **Then** 系统在5分钟内检测到该公告并正确识别为"新币上线"类型
2. **Given** 系统监控多个交易所(Binance, Bybit, Bitget), **When** 不同交易所同时发布多个公告, **Then** 系统能准确识别其中的新币上线公告并忽略其他类型公告
3. **Given** 某个交易所的公告页面暂时无法访问, **When** 系统尝试获取公告, **Then** 系统记录错误日志但继续监控其他交易所,不影响整体服务
4. **Given** 系统已运行一段时间, **When** 重新启动系统, **Then** 系统不会重复处理已识别的历史公告

---

### User Story 2 - 新币上线信息结构化存储 (Priority: P2)

作为系统使用者,我需要将识别出的新币上线信息以结构化的方式存储在数据库中,包括币种名称、上线类型(现货/合约)、交易所、时间等关键信息,这样我就能方便地查询、统计和分析历史数据。

**Why this priority**: 数据存储是核心功能的延伸,为后续的数据分析、通知和查询提供基础。但即使暂时不存储,监控功能本身仍然有价值(可以通过日志查看)。

**Independent Test**: 可以通过模拟或等待实际的新币上线公告,然后查询数据库验证数据是否正确存储,包括所有必需字段和正确的数据格式。

**Acceptance Scenarios**:

1. **Given** 系统识别到Binance的BTC现货上线公告, **When** 存储到数据库, **Then** 数据库记录包含币种代码(BTC)、币种全称、交易所名称(Binance)、上线类型(现货)、公告时间、公告URL、识别时间
2. **Given** 同一个币种在不同交易所上线, **When** 分别被识别并存储, **Then** 数据库中保存为独立的记录,可通过币种代码关联查询
3. **Given** 某个币种同时上线现货和合约, **When** 公告被识别, **Then** 系统能区分并分别记录两条记录,或在同一记录中标记两种类型
4. **Given** 数据库连接暂时失败, **When** 尝试存储数据, **Then** 系统缓存数据并在连接恢复后重试,不丢失任何识别到的信息

---

### User Story 3 - 新币上线实时通知 (Priority: P3)

作为系统使用者,当监控到新币上线信息时,我需要立即收到通知,这样我就能在第一时间做出反应,不需要手动查询数据库或等待定期报告。

**Why this priority**: 通知功能提升用户体验,使信息传递更及时。但即使没有通知,用户仍可以通过查询数据库获取信息,所以优先级相对较低。

**Independent Test**: 可以通过模拟新币上线事件,验证系统是否按配置发送通知到指定渠道,通知内容是否包含完整信息。

**Acceptance Scenarios**:

1. **Given** 系统配置了Telegram Bot作为通知渠道, **When** 识别到新币上线, **Then** 在30秒内发送通知到配置的Telegram频道或群组
2. **Given** 短时间内识别到多个新币上线, **When** 触发通知, **Then** 系统为每个新币立即发送独立的通知消息,确保最大实时性
3. **Given** 通知渠道暂时不可用, **When** 尝试发送通知, **Then** 系统记录失败日志,重试3次(间隔1分钟),如果仍失败则跳过并继续监控
4. **Given** 用户配置了通知过滤条件, **When** 新币上线被识别, **Then** 只有满足过滤条件的币种才触发通知

---

### User Story 4 - 扩展Hyperliquid交易所监控 (Priority: P4)

作为系统维护者,我需要能够方便地添加对Hyperliquid交易所的监控支持,遵循与现有交易所一致的模式,这样系统就能覆盖更多交易所,提供更全面的市场信息。

**Why this priority**: 这是功能扩展,不影响核心功能。Hyperliquid是额外的交易所,初期可以先支持Binance、Bybit、Bitget三个主要交易所。

**Independent Test**: 可以通过实现Hyperliquid的爬虫模块,运行测试脚本验证能否成功获取和解析Hyperliquid的公告数据。

**Acceptance Scenarios**:

1. **Given** Hyperliquid爬虫模块已实现, **When** 启用Hyperliquid监控, **Then** 系统能成功获取Hyperliquid的公告列表
2. **Given** Hyperliquid发布新币上线公告, **When** 系统监控Hyperliquid, **Then** 能正确识别并处理,与其他交易所的处理流程一致
3. **Given** Hyperliquid的公告格式与其他交易所不同, **When** 解析公告内容, **Then** 能准确提取币种信息和上线类型

---

### Edge Cases

- **公告内容模糊**: 当公告标题或内容中没有明确标识"新币上线"或类似关键词时,系统必须将其记录到待审核列表,但不发送通知。系统必须提供管理界面供人工审核,并可标记为"新币上线"或"忽略"
- **同一币种重复公告**: 系统必须基于"币种代码+交易所+上线类型"的组合进行去重,24小时内相同组合只通知一次,避免重复公告(预告、正式上线、延期等)造成重复通知
- **多语言公告**: 如果交易所发布多语言版本的公告,如何避免识别为多个不同的上线事件?
- **交易所API限流**: 系统必须实施指数退避策略:首次被限流等待1分钟,之后每次失败等待时间翻倍(最多30分钟)。连续失败3次后暂停该交易所监控1小时,之后自动恢复尝试
- **公告格式变更**: 系统必须监控每个交易所的公告解析成功率。当某交易所连续3个监控周期的解析失败率超过80%时,发送告警通知到管理员,并记录详细的错误日志和页面快照供排查
- **历史数据初始化**: 系统首次启动时,必须获取过去24小时的历史公告,以确保不遗漏启动前发布的新币上线信息
- **币种名称歧义**: 不同交易所对同一币种使用不同的代码或名称时,如何统一标识?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够定期(默认每5分钟)自动获取指定交易所的最新公告列表。系统首次启动时,必须获取过去24小时的历史公告
- **FR-002**: 系统必须支持监控以下交易所:Binance、Bybit、Bitget,并预留Hyperliquid的扩展接口
- **FR-003**: 系统必须能够从公告内容中识别"新币上线"相关信息,包括币种名称、代码、上线类型(现货/合约)。对于内容模糊无法明确判断的公告,记录到待审核列表但不发送通知
- **FR-004**: 系统必须将识别到的新币上线信息存储到数据库,包含:币种代码、币种全称、交易所名称、上线类型、公告标题、公告URL、公告发布时间、系统识别时间
- **FR-005**: 系统必须在识别到新币上线后发送通知,通知内容应包含币种基本信息和公告链接
- **FR-006**: 系统必须能够避免重复处理已经识别过的公告。去重规则:基于"币种代码+交易所+上线类型"的组合,24小时内相同组合只通知一次
- **FR-007**: 系统必须记录所有关键操作日志,包括获取公告、识别结果、存储操作、通知发送等。同时必须监控每个交易所的解析成功率,当连续3个周期失败率>80%时发送告警
- **FR-008**: 系统必须能够处理单个交易所的临时故障,不影响其他交易所的监控。当遇到API限流或访问错误时,实施指数退避策略:首次等待1分钟,后续等待时间翻倍(最多30分钟),连续失败3次后暂停该交易所1小时
- **FR-009**: 系统必须支持通过配置文件或环境变量配置监控参数(监控频率、交易所列表、通知设置等)
- **FR-012**: 系统必须提供管理界面(Web或CLI),允许查看和审核待审核公告列表,并可标记为"确认为新币上线"或"忽略"
- **FR-013**: 系统必须支持管理员告警通知配置,用于接收系统异常告警(如解析失败率过高、数据库连接失败等)
- **FR-010**: 系统必须能够复用现有的crypto_exchange_news_crawler模块来获取公告数据
- **FR-011**: 系统必须能够区分并正确处理同一币种的现货上线和合约上线(可能是同一公告或不同公告)

### Key Entities

- **Exchange(交易所)**: 代表一个加密货币交易所,包含名称、简码、公告页面URL、监控状态等属性
- **Announcement(公告)**: 代表交易所发布的一条公告,包含唯一标识、标题、内容摘要、URL、发布时间、交易所、公告类型等属性
- **Listing(新币上线)**: 代表一个新币上线事件,包含币种代码、币种全称、交易所、上线类型(现货/合约)、公告引用、识别时间、通知状态等属性
- **NotificationRecord(通知记录)**: 代表一次通知发送记录,包含关联的新币上线、通知渠道、发送时间、发送状态、重试次数等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够在新币上线公告发布后的5分钟内检测并识别,漏检率低于5%
- **SC-002**: 系统对新币上线公告的识别准确率达到90%以上(正确识别的数量/总识别数量)
- **SC-003**: 系统对新币上线公告的识别召回率达到85%以上(正确识别的数量/实际新币上线数量)
- **SC-004**: 系统能够7x24小时稳定运行,单次故障恢复时间不超过5分钟
- **SC-005**: 系统在监控3个交易所的情况下,单个监控周期的响应时间不超过30秒
- **SC-006**: 系统对同一新币上线事件的重复识别率低于2%
- **SC-007**: 系统的通知送达成功率达到95%以上(成功发送/总尝试发送)
- **SC-008**: 用户收到新币上线通知后,能在10秒内通过通知中的链接访问到原始公告页面

## Clarifications

### Session 2025-11-06

- Q: 系统首次启动时的历史数据初始化范围? → A: 获取过去24小时的历史公告,确保不遗漏启动前的新币上线
- Q: 重复公告去重策略? → A: 基于币种代码+交易所+上线类型组合去重,24小时内相同组合只通知一次
- Q: API限流/封禁的退避策略? → A: 指数退避策略:首次等待1分钟,之后每次翻倍,最多等待30分钟,连续失败3次后暂停该交易所1小时
- Q: 公告内容模糊时的处理策略? → A: 记录到待审核列表但不发送通知,提供管理界面供人工审核并标记为"新币上线"或"忽略"
- Q: 公告格式变更的监控和告警策略? → A: 监控解析成功率,当某交易所连续3个周期解析失败率>80%时发送告警通知到管理员,并记录详细日志供排查

### Assumptions

- 假设所有目标交易所的公告页面保持公开访问,不需要登录或特殊权限
- 假设crypto_exchange_news_crawler模块已经实现并能稳定获取Binance、Bybit、Bitget的公告数据
- 假设交易所的公告内容中会明确包含"新币上线"或类似的关键标识词(中英文)
- 假设单个监控周期内新发布的公告数量不会超过100条
- 假设系统有稳定的网络环境访问所有目标交易所
- 假设系统部署环境有足够的资源运行监控服务(CPU、内存、磁盘)
- 假设初期使用简单的关键词匹配算法识别新币上线公告,后期可根据需要升级为机器学习模型
- 假设数据库使用关系型数据库(如PostgreSQL或MySQL),可通过ORM访问
