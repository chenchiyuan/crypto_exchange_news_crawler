# Feature Specification: 做空网格标的量化筛选系统

**Feature Branch**: `001-short-grid-screening`
**Created**: 2025-12-03
**Status**: Draft
**Input**: User description: "基于币安SDK的做空网格标的量化筛选系统,优先使用项目中现有的技术栈实现"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 通过命令筛选出适合的做空网格标的 (Priority: P1)

作为量化交易员,我需要运行一个命令行工具来筛选币安永续合约市场中最适合做空网格的标的。系统通过三维筛选框架(波动率、趋势、资金/持仓)计算每个标的的GSS(Grid Short Score)评分,最终在终端输出Top 5标的及其详细指标,这样我就能快速识别出高熵值(高波动)、弱趋势(趋势衰竭)且多头乏力(微观结构弱势)的理想标的。

**Why this priority**: 这是MVP的唯一核心功能。通过命令行完成从数据获取→指标计算→评分排序→结果输出的完整闭环,验证筛选算法的有效性。

**Independent Test**: 运行命令`python manage.py screen_short_grid`,验证终端输出包含Top 5标的代码、GSS得分、三维指标明细(NATR/KER/H/NormSlope/R²/OVR/Funding/CVD)和推荐网格参数。

**Acceptance Scenarios**:

1. **Given** 币安永续合约市场有500+个标的, **When** 用户运行筛选命令, **Then** 系统在60秒内完成全市场扫描,拉取K线、Ticker、持仓、资金费率数据
2. **Given** 已获取全市场数据, **When** 系统执行初筛(流动性>5000万USDT,上市>30天), **Then** 终端显示初筛统计:总标的数、通过数、被过滤数及原因
3. **Given** 初筛后的标的池, **When** 系统计算三维指标, **Then** 每个标的完成NATR/KER/VDR(波动率)、NormSlope/R²/H/Z-Score(趋势)、OVR/Funding/CVD(资金持仓)的计算
4. **Given** 所有标的的三维指标, **When** 系统执行加权评分GSS = 0.2·Rank(NATR) + 0.2·Rank(1-KER) + 0.3·I_Trend + 0.3·I_Micro, **Then** 按GSS得分降序排序
5. **Given** Top 5标的列表, **When** 系统输出结果, **Then** 终端显示格式化表格,包含:排名、标的代码、当前价格、NATR、KER、H、NormSlope、R²、OVR、Funding Rate、CVD背离状态、GSS得分、推荐网格上下限
6. **Given** 用户运行命令时指定--top-n参数, **When** 设置--top-n=10, **Then** 输出Top 10标的(默认5,范围3-10)
7. **Given** 用户需要调整权重, **When** 运行命令时指定--weights="0.3,0.3,0.2,0.2", **Then** 使用自定义权重重新计算GSS

---

### Edge Cases

- **数据缺失**: 当K线数据不足300根时,跳过该标的并在日志中记录警告(不中断流程)
- **API限流**: 当触发429错误时,自动延迟重试(最多60秒),超时则记录错误继续处理其他标的
- **异常波动率**: 当NATR>10%时,在输出中标记为"⚠️ 极端波动",提示人工复核
- **NATR过低**: 当NATR<1%时,剔除该标的(市场静默期,网格效率低)
- **强上升趋势**: 当NormSlope > 阈值 且 R² > 0.8时,GSS直接归零(否决机制)
- **高OVR警告**: 当OVR>2.0时,在输出中标记为"⚠️ 高杠杆拥挤",提示潜在爆仓风险
- **资金费率极端值**: 当Funding > 0.1%时,标记为"⚠️ 逼空风险"
- **全市场无合格标的**: 当初筛后无标的时,输出"当前市场条件不适合做空网格,建议等待"
- **CVD数据不可用**: 当API不提供TakerBuyVolume时,CVD降级为简化计算(仅基于总成交量)
- **权重配置错误**: 当权重总和≠1.0时,拒绝执行并提示错误
- **1分钟K线数据不足**: 当获取1分钟K线失败或数量不足240根时,VDR计算降级跳过,记录WARNING,但不影响其他指标
- **市值数据缺失**: 当无法获取市值排名数据时,不应用市值权重系数(FR-027.1),继续正常筛选

## Requirements *(mandatory)*

### Functional Requirements

#### 步骤一: 全市场扫描与初筛

- **FR-001**: 系统必须通过币安Futures API (/fapi/v1/exchangeInfo) 获取全市场USDT本位永续合约列表
- **FR-002**: 系统必须执行流动性过滤: 24h Quote Volume > 50,000,000 USDT
  - 数据源: /fapi/v1/ticker/24hr
  - 目的: 剔除流动性枯竭的"僵尸币"，防止网格订单无法成交或滑点过大
- **FR-003**: 系统必须执行数据充分性过滤: 上市时间 > 30天,确保至少300根4H K线可用
  - 新币缺乏足够的历史数据，无法准确计算ATR和Hurst指数
- **FR-004**: 系统必须输出初筛统计: 总标的数、通过流动性过滤数、通过时间过滤数、最终通过数

#### 步骤二: 三维指标计算

**第一维度: 波动率 (Volatility)**

- **FR-005**: 系统必须计算归一化ATR (NATR) = ATR(14) / Close × 100,基于4小时K线
  - 真实波幅TR = max(H-L, |H-C_{t-1}|, |L-C_{t-1}|)
  - 14周期移动平均得到ATR(14)
- **FR-006**: 系统必须计算考夫曼效率比 (KER):
  - Direction = |Close_t - Close_{t-N}|,窗口期N=10
  - Volatility = Σ|Close_{t-i} - Close_{t-i-1}| (i=0到N-1)
  - KER = Direction / Volatility
- **FR-007**: 系统必须筛选NATR值处于前20%分位的资产(高波动)
- **FR-008**: 系统必须筛选KER < 0.3的资产(低效率波动,均值回归特征)
- **FR-009**: 系统必须剔除NATR < 1%(静默期)和NATR > 10%(极端波动)的标的
- **FR-010**: 系统必须将NATR和(1-KER)转换为百分位排名(Percentile Rank),范围0-1
- **FR-010.1**: 系统必须计算波动率-位移比 (VDR - Volatility-Displacement Ratio):
  - 对于每个标的，获取过去4小时内的240根1分钟K线数据 (通过/fapi/v1/klines, interval=1m)
  - 计算累积日内波动率: CIV = Σ |Close_i - Open_i| / Open_i (i=1到240)
  - 计算净位移: Displacement = |Close_final - Close_initial| / Close_initial
  - 计算VDR: VDR = CIV / Displacement
  - 筛选条件: VDR > 5.0 表示价格"原地空转"，买卖力量势均力敌，优选此类标的
- **FR-010.2**: 当VDR极高 (>10.0) 时，系统必须在输出中标记为"✓ 高VDR - 完美震荡"

**第二维度: 趋势 (Trend - 负面滤网)**

- **FR-011**: 系统必须对收盘价序列执行线性回归拟合y = mx + b
  - 计算标准化斜率: NormSlope = (m / Close_t) × 10000
  - 计算判定系数R² (拟合优度)
- **FR-012**: 系统必须计算赫斯特指数 (Hurst Exponent):
  - 通过重标极差分析 (R/S Analysis) 计算
  - 对log(R/S)和log(n)进行线性回归,斜率即为H
- **FR-013**: 系统必须筛选H < 0.5的标的(反持久性,均值回归),理想值0.3-0.4
- **FR-014**: 系统必须剔除强上升趋势标的: NormSlope > 阈值 且 R² > 0.8 (GSS归零)
- **FR-015**: 系统必须优选水平震荡标的: NormSlope ≈ 0
- **FR-015.1**: 系统必须计算价格Z-Score (价格偏离度):
  - Z_Score = (Close_t - MA_N) / StdDev_N，其中N=20
  - MA_N为20周期简单移动平均线
  - StdDev_N为20周期标准差（布林带宽度的一半）
- **FR-015.2**: 系统必须筛选高Z-Score标的优化入场点:
  - 筛选 Z_Score > 2.0 的标的（触及布林带上轨或超出）
  - 结合 KER < 0.3 和 H < 0.5，识别假突破（Fake-out）
  - 此类标的在局部高点开启做空网格，第一笔卖单成交在优势位置

**第三维度: 资金/持仓 (Funding/OI - 微观结构)**

- **FR-016**: 系统必须计算持仓量/成交量比率: OVR = OpenInterest / 24h Volume (通过/fapi/v1/openInterest获取)
- **FR-017**: 系统必须获取当前资金费率 (通过/fapi/v1/fundingRate获取)
- **FR-018**: 系统必须筛选正资金费率标的 (> 0.01% / 8h),优选温和正费率(0.01%-0.1%)
- **FR-019**: 系统必须剔除高OVR标的 (> 2.0),优选OVR < 0.5或OVR适中且OI下降的标的
- **FR-020**: 系统必须计算CVD (累积成交量增量):
  - 每根K线: Delta = TakerBuyVolume - (TotalVolume - TakerBuyVolume)
  - CVD_t = CVD_{t-1} + Delta_t
- **FR-021**: 系统必须检测CVD背离: 价格创新高 (P_t > P_high) 但CVD未创新高 (CVD_t < CVD_high),标记为"熊市背离"
- **FR-021.1**: 系统必须计算CVD变化率 (Rate of Change):
  - 计算CVD的5周期变化率: CVD_ROC = (CVD_t - CVD_{t-5}) / |CVD_{t-5}|
  - 当CVD_ROC > 50% (垂直拉升) 时，标记为"⚠️ CVD异常买盘"
  - 此为潜在突破信号，应作为风险预警（虽然MVP不实现自动出场，但应在输出中明确标记）

#### 步骤三: 加权评分模型

- **FR-022**: 系统必须实现GSS评分公式: GSS = w₁·Rank(NATR) + w₂·Rank(1-KER) + w₃·I_Trend + w₄·I_Micro
- **FR-023**: 默认权重必须为: w₁=0.2, w₂=0.2 (波动率40%), w₃=0.3 (趋势30%), w₄=0.3 (微观结构30%)
- **FR-024**: 趋势评分I_Trend必须实现:
  - 强上升趋势(NormSlope > 阈值 且 R² > 0.8): 得分=0 (否决)
  - 水平震荡(NormSlope ≈ 0): 得分=1.0
  - 结合Hurst指数: H < 0.5时加分
  - 结合Z-Score: Z_Score > 2.0 且 KER < 0.3 时额外加分（假突破优势位置）
- **FR-025**: 微观结构评分I_Micro必须实现:
  - CVD背离(Bearish Divergence): 加分
  - 正资金费率(0.01%-0.1%): 加分
  - 高OVR (> 2.0): 扣分
  - VDR > 5.0: 加分（原地空转特征）
  - CVD_ROC > 50%: 扣分（异常买盘预警）
- **FR-026**: 系统必须支持通过命令行参数--weights调整权重,格式:"w1,w2,w3,w4"
- **FR-027**: 系统必须验证权重总和=1.0,否则拒绝执行
- **FR-027.1**: 系统应根据市值排名优化标的权重 (效率悖论原则):
  - 优先筛选市值排名20-100的中等市值资产
  - BTC/ETH等主流币由于市场深度极大、价格发现效率高（高KER），难以产生适合网格的"低效率波动"
  - 中市值山寨币由于做市商操纵、散户情绪化交易，K线充满上下影线（低KER），是网格利润来源
  - 实现方式: 通过API获取标的市值排名，对排名20-100的标的在最终GSS评分上乘以1.2的加权系数

#### 步骤四: 输出推荐清单

- **FR-028**: 系统必须对所有标的按GSS得分降序排序
- **FR-029**: 系统必须输出Top N标的(默认5,可通过--top-n参数配置,范围3-10)
- **FR-030**: 对于每个Top N标的,系统必须计算推荐网格参数:
  - Upper Limit (止损/网格上限) = Current Price + 2 × ATR_daily
  - Lower Limit (网格下限) = Current Price - 3 × ATR_daily
  - Grid Count (格数) = (Upper - Lower) / (0.5 × ATR_hourly),向上取整
  - **注**: ATR_daily基于24小时K线计算（周期=14根日K线），ATR_hourly基于1小时K线计算（周期=14根小时K线）
  - 两者分别计算的目的: daily ATR确定网格的整体价格区间，hourly ATR确定网格的精细间距
- **FR-031**: 系统必须在终端输出格式化表格,包含列: 排名、标的代码、当前价格、NATR(%)、KER、VDR、H、Z-Score、NormSlope、R²、OVR、Funding(%)、CVD状态、CVD_ROC、GSS得分、网格上限、网格下限
- **FR-032**: 系统必须在输出中标记警告项和优势标记:
  - ⚠️ 极端波动: NATR > 10%
  - ⚠️ 高OVR: OVR > 2.0
  - ⚠️ 逼空风险: Funding > 0.1%
  - ⚠️ CVD异常买盘: CVD_ROC > 50%
  - ✓ 高VDR - 完美震荡: VDR > 10.0
  - ✓ 假突破优势: Z_Score > 2.0 且 KER < 0.3
- **FR-033**: 系统必须输出执行摘要: 扫描时长、总标的数、初筛通过数、最终Top N数

#### 命令行接口与参数

- **FR-034**: 系统必须实现Django Management Command: `python manage.py screen_short_grid`
- **FR-035**: 系统必须支持参数:
  - `--top-n`: 输出Top N标的,默认5,范围3-10
  - `--weights`: 自定义权重,格式"w1,w2,w3,w4",默认"0.2,0.2,0.3,0.3"
  - `--min-volume`: 最小流动性阈值(USDT),默认50000000
  - `--min-days`: 最小上市天数,默认30
  - `--interval`: K线周期,默认4h
- **FR-036**: 系统必须在命令开始时输出配置信息: 权重、阈值、K线周期
- **FR-037**: 系统必须在命令结束时输出执行时长和成功/失败状态

#### 数据标准化与错误处理

- **FR-038**: 所有价格变动必须转换为对数收益率或Z-Score,确保跨标的比较有效性
- **FR-039**: 系统必须验证K线数据完整性,检测缺失gap,不完整的标的跳过并记录警告
- **FR-040**: 系统必须处理币安API限流(429错误),自动延迟重试(最多60秒)
- **FR-041**: 系统必须记录日志: INFO(正常流程)、WARNING(异常但可继续)、ERROR(失败)
- **FR-042**: 当CVD数据(TakerBuyVolume)不可用时,必须降级为简化计算,记录警告但不中断

### 深度洞察与风险控制原则

本节基于量化交易的二阶效应（Second-Order Effects）和实战经验，提供超越数学公式的策略指导。这些原则虽不作为强制性FR实现，但应在系统设计、参数调优和用户文档中充分体现。

#### 原则1: 效率悖论（Efficiency Paradox）

**核心洞察**: 传统交易追求"效率"（迅速获利），但网格交易是"反效率"的。我们需要的是"丑陋"的K线，而非流畅的趋势。

**量化表现**:
- **中市值优势**: 市值排名20-100的山寨币通常比BTC/ETH更适合做空网格
- **原因分析**:
  - BTC的市场深度极大，价格发现效率高，一旦形成趋势（高KER），很难回头
  - 中市值山寨币由于做市商操纵、散户情绪化交易等原因，K线极其"丑陋"（低KER），充满上下影线
  - 这种"丑陋"正是网格利润的来源

**实施建议**:
- FR-027.1已实现市值排名优化，对排名20-100的标的应用1.2倍加权系数
- 建议在用户文档中明确说明: 不要盲目迷信主流币，中等市值资产往往提供更好的网格效率

#### 原则2: CVD防空警报（CVD Early Warning）

**核心洞察**: CVD背离用于入场信号，但CVD的**变化率（Rate of Change）**应作为紧急出场信号。

**风险场景**:
- 场景: 做空网格运行期间，CVD突然出现垂直拉升，而价格尚未反应（挂单簿吸收了买盘）
- 含义: 潜在的突破信号，主力资金正在大举建仓
- 后果: 若不及时退出，网格将在价格突破后遭受"瀑布式"亏损

**量化阈值**:
- CVD_ROC > 50% (5周期变化率)
- 此时无论网格是否盈利，策略应强制终止

**实施状态**:
- FR-021.1已实现CVD_ROC计算和标记
- MVP阶段仅在输出中警告，不实现自动平仓（Out of Scope）
- 后续迭代可集成Grid V4，实现基于CVD_ROC的动态止损

**技术优势**:
- 基于微观订单流的止损比基于价格的止损**快一个身位**
- 能有效避免"反应滞后"导致的深度回撤

#### 原则3: 资金费率套利陷阱（Funding Rate Trap）

**核心洞察**: 超高资金费率是陷阱，而非机会。

**常见误区**:
- 初学者倾向于选择资金费率最高的币种开做空网格
- 意图: "吃费率 + 吃网格" 双重收益
- 现实: 这是一个经典的陷阱

**风险分析**:
- 超高费率（如年化100%+）通常意味着极度强势的**逼空行情**（Short Squeeze）
- 在这种情况下，网格产生的价差利润和费率收入，往往瞬间被币价上涨带来的浮亏吞噬
- 本质: 你赚的是"利息"，亏的是"本金"

**量化标准**:
- **优选**: 温和正费率 (0.01% - 0.1% / 8h)
- **警惕**: 极端费率 (> 0.1% / 8h)
- **剔除**: 负费率 (< 0.01% / 8h)

**实施状态**:
- FR-018已实现费率筛选
- FR-032已对Funding > 0.1%标记为"⚠️ 逼空风险"

**策略建议**:
- 我们追求的是**统计学上的稳健性**，而非异常值博弈
- 在费率、波动率、趋势三者间，优先级应为: 趋势（否决权）> 波动率（利润源）> 费率（锦上添花）

#### 原则4: 高频微观结构的重要性

**核心洞察**: 虽然主交易周期是4小时，但1分钟K线揭示的微观波动质量（VDR）是区分"真波动"和"假波动"的关键。

**VDR的深层含义**:
- VDR > 5.0: 价格在激烈博弈但势均力敌，买卖力量胶着，难以形成流畅突破
- VDR < 2.0: 价格运动高效，可能存在单边趋势萌芽，需警惕

**实施建议**:
- FR-010.1已实现VDR计算（需240根1分钟K线）
- 建议在输出中突出显示VDR > 10.0的标的，这是"完美震荡"的黄金标的

### Key Entities

**注**: MVP不涉及数据库持久化,数据仅在内存中处理并输出到终端。以下实体为概念模型,便于理解数据流。

- **MarketSymbol**: 市场标的,属性包括交易对代码、上市时间、24h成交量、当前价格、市值排名
- **VolatilityMetrics**: 波动率指标,属性包括NATR、KER、**VDR**、百分位排名
  - VDR (波动率-位移比): 基于1分钟K线计算的累积日内波动率与净位移的比值，衡量"原地空转"程度
- **TrendMetrics**: 趋势指标,属性包括NormSlope、R²、Hurst指数、**Z-Score**
  - Z-Score (价格偏离度): 价格相对于移动平均线的标准差倍数，用于识别假突破
- **MicrostructureMetrics**: 微观结构指标,属性包括OVR、Funding Rate、CVD值、**CVD_ROC**、背离状态
  - CVD_ROC (CVD变化率): 5周期CVD变化率，用于检测异常买盘
- **ScreeningResult**: 筛选结果,属性包括标的代码、三维指标、GSS得分、排名、推荐网格参数、警告/优势标记

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够在60秒内完成500+标的的全市场扫描和三维指标计算
- **SC-002**: NATR计算结果与TA-Lib参考实现误差 < 0.1%
- **SC-003**: 输出的Top 5标的必须满足: NATR ≥ 前20%分位、KER < 0.3、H < 0.5、正资金费率、优选VDR > 5.0
- **SC-004**: 币安API调用成功率 ≥ 99%,失败时自动重试能够恢复
- **SC-005**: 命令行输出清晰易读,表格格式化对齐,包含所有必需指标
- **SC-006**: 系统可配置性: 权重、阈值、Top N数量可通过命令行参数调整,无需修改代码
- **SC-007**: 强上升趋势标的(NormSlope>阈值 且 R²>0.8)的GSS必须=0,不进入Top N列表
- **SC-008**: 当全市场无合格标的时,输出明确提示信息而非空结果
- **SC-009**: VDR计算准确性: 对于已知的高VDR标的（如长期横盘的山寨币），VDR值应 > 5.0
- **SC-010**: Z-Score识别准确性: 当价格触及布林带上轨时，Z-Score应 > 2.0
- **SC-011**: CVD_ROC预警有效性: 在价格突破前，CVD_ROC应提前出现 > 50% 的信号

## Assumptions

1. **币安API稳定性**: 假设币安Futures API的可用性≥99.5%,且提供足够的API调用限额
2. **K线数据完整性**: 假设4小时K线数据在正常情况下连续,偶尔缺失可通过标记跳过
3. **TakerBuyVolume可用性**: 假设K线接口提供TakerBuyBaseAssetVolume字段,如不可用则降级为简化CVD计算
4. **1分钟K线可用性**: 假设币安API支持获取1分钟级别K线数据用于VDR计算，若不可用则VDR计算降级跳过
5. **市值数据可选性**: 市值排名数据为可选项（用于FR-027.1优化），若无法获取则不影响核心筛选功能
6. **计算资源**: 假设执行环境有至少2GB可用内存和4核CPU,支持并行计算以达到<60秒性能目标

## Dependencies

- **外部依赖**: 币安Futures API (仅需公开市场数据接口,无需API Key或交易权限)
- **技术栈**: Python 3.8+、Django 4.2.8 (Management Command)、NumPy/Pandas (数值计算)、scipy (Hurst指数R/S分析)
- **可选依赖**: TA-Lib或pandas-ta (用于ATR计算验证和对比)

## Out of Scope

以下功能明确排除在MVP范围外:

- **数据持久化**: 不保存筛选结果到数据库,仅输出到终端
- **推送通知**: 不集成慧诚告警或任何通知服务
- **定时任务**: 不实现自动定时筛选,仅支持手动命令触发
- **回测验证**: 不集成Grid V4回测模块,不验证筛选标的的历史表现
- **稳定性测试**: 不实现连续筛选重叠度计算
- **参数优化**: 不实现自动权重优化或参数敏感性分析
- **网格交易执行**: 仅输出推荐网格参数,不实现实际的网格下单和管理
- **风控机制**: 不实现止损、仓位管理、最大回撤监控等风控功能
- **CVD实时监控**: 不实现CVD变化率的持续监控和"防空警报"
- **历史数据分析**: 不提供历史筛选记录的查询和对比分析
- **Web界面**: 不提供可视化Dashboard,仅命令行交互
- **多交易所支持**: 仅支持币安,不包含Bybit/OKX等其他交易所
