# Command Interface Contract: screen_short_grid

**Feature**: 001-short-grid-screening
**Type**: Django Management Command
**Date**: 2025-12-03

## Overview

`screen_short_grid` æ˜¯ä¸€ä¸ªDjango Management Command,æä¾›å‘½ä»¤è¡Œæ¥å£ç”¨äºç­›é€‰åšç©ºç½‘æ ¼æ ‡çš„ã€‚æœ¬æ–‡æ¡£å®šä¹‰å‘½ä»¤çš„è¾“å…¥å‚æ•°ã€è¾“å‡ºæ ¼å¼å’Œè¡Œä¸ºå¥‘çº¦ã€‚

---

## Command Signature

```bash
python manage.py screen_short_grid [OPTIONS]
```

---

## Input Parameters

### Required Parameters

æ— å¿…éœ€å‚æ•°(æ‰€æœ‰å‚æ•°éƒ½æœ‰é»˜è®¤å€¼)

### Optional Parameters

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | èŒƒå›´/æ ¼å¼ | è¯´æ˜ | FR |
|------|------|--------|----------|------|-----|
| `--top-n` | integer | 5 | 3-10 | è¾“å‡ºTop Næ ‡çš„ | FR-029, FR-035 |
| `--weights` | string | "0.2,0.2,0.3,0.3" | "w1,w2,w3,w4" ä¸” sum=1.0 | è‡ªå®šä¹‰GSSè¯„åˆ†æƒé‡ | FR-026, FR-035 |
| `--min-volume` | float | 50000000 | >0 | æœ€å°æµåŠ¨æ€§é˜ˆå€¼(USDT) | FR-002, FR-035 |
| `--min-days` | integer | 30 | >0 | æœ€å°ä¸Šå¸‚å¤©æ•° | FR-003, FR-035 |
| `--interval` | string | "4h" | "1h", "4h", "1d" | Kçº¿å‘¨æœŸ | FR-035 |
| `--verbosity` | integer | 1 | 0-3 | Djangoæ—¥å¿—çº§åˆ«(0=é™é»˜,3=è°ƒè¯•) | Djangoæ ‡å‡† |

### Parameter Validation

**æƒé‡éªŒè¯** (FR-027):
```python
def validate_weights(weights_str: str) -> List[float]:
    """
    éªŒè¯æƒé‡å‚æ•°

    Raises:
        CommandError: æƒé‡æ ¼å¼é”™è¯¯æˆ–æ€»å’Œâ‰ 1.0
    """
    try:
        weights = [float(w) for w in weights_str.split(',')]
    except ValueError:
        raise CommandError("æƒé‡æ ¼å¼é”™è¯¯,åº”ä¸ºé€—å·åˆ†éš”çš„æµ®ç‚¹æ•°,å¦‚'0.2,0.2,0.3,0.3'")

    if len(weights) != 4:
        raise CommandError(f"æƒé‡å¿…é¡»ä¸º4ä¸ªæ•°å€¼,å½“å‰ä¸º{len(weights)}ä¸ª")

    if not math.isclose(sum(weights), 1.0, abs_tol=1e-6):
        raise CommandError(f"æƒé‡æ€»å’Œå¿…é¡»=1.0,å½“å‰ä¸º{sum(weights):.4f}")

    return weights
```

**Top NéªŒè¯** (FR-029):
```python
def validate_top_n(top_n: int) -> int:
    """
    éªŒè¯Top Nå‚æ•°

    Raises:
        CommandError: è¶…å‡ºèŒƒå›´3-10
    """
    if not 3 <= top_n <= 10:
        raise CommandError(f"--top-nå¿…é¡»åœ¨3-10ä¹‹é—´,å½“å‰ä¸º{top_n}")

    return top_n
```

---

## Output Format

### Terminal Output Structure

#### 1. é…ç½®ä¿¡æ¯è¾“å‡º (FR-036)

```
======================================================================
ğŸš€ åšç©ºç½‘æ ¼æ ‡çš„é‡åŒ–ç­›é€‰ç³»ç»Ÿ
======================================================================
â° é…ç½®ä¿¡æ¯:
  - æƒé‡: NATR=0.2, (1-KER)=0.2, Trend=0.3, Micro=0.3
  - åˆç­›é˜ˆå€¼: æµåŠ¨æ€§>50,000,000 USDT, ä¸Šå¸‚>30å¤©
  - Kçº¿å‘¨æœŸ: 4h (300æ ¹)
  - Top N: 5
```

**å¥‘çº¦**:
- å¿…é¡»åœ¨å‘½ä»¤å¼€å§‹æ—¶è¾“å‡º
- åŒ…å«æ‰€æœ‰å…³é”®é…ç½®å‚æ•°
- æ ¼å¼æ¸…æ™°,æ˜“äºå®¡è®¡

#### 2. Pipelineè¿›åº¦è¾“å‡º (FR-004, FR-033)

```
ğŸ“¥ æ­¥éª¤1: å…¨å¸‚åœºæ‰«æä¸åˆç­›
----------------------------------------------------------------------
  è·å–åˆçº¦åˆ—è¡¨... âœ“ 536 ä¸ªæ°¸ç»­åˆçº¦
  æ‰§è¡Œåˆç­›... âœ“ é€šè¿‡æµåŠ¨æ€§: 412, é€šè¿‡æ—¶é—´: 398

ğŸ“Š æ­¥éª¤2: ä¸‰ç»´æŒ‡æ ‡è®¡ç®— (398ä¸ªæ ‡çš„)
----------------------------------------------------------------------
  å¹¶è¡Œè®¡ç®—ä¸­... [========================================] 100%
  âœ“ å®Œæˆ 398 ä¸ªæ ‡çš„çš„æŒ‡æ ‡è®¡ç®— (ç”¨æ—¶: 15.3ç§’)

ğŸ¯ æ­¥éª¤3: åŠ æƒè¯„åˆ†ä¸æ’åº
----------------------------------------------------------------------
  âœ“ GSSè¯„åˆ†å®Œæˆ,æ’åºTop 5

ğŸ“¢ æ­¥éª¤4: è¾“å‡ºæ¨èæ¸…å•
----------------------------------------------------------------------
```

**å¥‘çº¦**:
- å››æ­¥Pipelineæ¸…æ™°å±•ç¤º
- æ¯æ­¥è¾“å‡ºç»Ÿè®¡æ•°æ®(æ€»æ•°/é€šè¿‡æ•°/ç”¨æ—¶)
- è¿›åº¦æ¡(å¯é€‰,è§†å®ç°å¤æ‚åº¦)

#### 3. ç»“æœè¡¨æ ¼è¾“å‡º (FR-031)

```
| Rank | Symbol    | Price     | NATR  | KER   | VDR  | H     | Z-Sc | Slope | RÂ²    | OVR  | Fund    | CVD | CVD_ROC | GSS    | Grid Upper | Grid Lower | Flags          |
|------|-----------|-----------|-------|-------|------|-------|------|-------|-------|------|---------|-----|---------|--------|------------|------------|----------------|
| 1    | PEPEUSDT  | $0.00012  | 3.45% | 0.18  | 8.5  | 0.42  | 2.3  | -8.5  | 0.65  | 0.85 | 0.025%  | âœ“   | 15.2%   | 0.8523 | $0.00014   | $0.00010   | âœ“ å‡çªç ´ä¼˜åŠ¿   |
| 2    | DOGEUSDT  | $0.3850   | 2.98% | 0.22  | 12.1 | 0.38  | 1.8  | -12.3 | 0.58  | 1.20 | 0.018%  | âœ“   | 8.5%    | 0.8201 | $0.4050    | $0.3550    | âœ“ é«˜VDRéœ‡è¡    |
```

**åˆ—æ ¼å¼å¥‘çº¦**:

| åˆ—å | æ ¼å¼ | ç¤ºä¾‹ | ç²¾åº¦ |
|------|------|------|------|
| Rank | æ•´æ•° | 1 | - |
| Symbol | å­—ç¬¦ä¸² | BTCUSDT | - |
| Price | è´§å¸ | $44,000.50 | 2ä½å°æ•° |
| NATR | ç™¾åˆ†æ¯” | 2.45% | 2ä½å°æ•° |
| KER | æµ®ç‚¹æ•° | 0.250 | 3ä½å°æ•° |
| VDR | æµ®ç‚¹æ•° | 8.5 | 1ä½å°æ•° |
| H | æµ®ç‚¹æ•° | 0.450 | 3ä½å°æ•° |
| Z-Score | æµ®ç‚¹æ•° | 2.3 | 1ä½å°æ•° |
| Slope | æµ®ç‚¹æ•° | -12.3 | 1ä½å°æ•° |
| RÂ² | æµ®ç‚¹æ•° | 0.650 | 3ä½å°æ•° |
| OVR | æµ®ç‚¹æ•° | 1.20 | 2ä½å°æ•° |
| Funding | ç™¾åˆ†æ¯” | 0.0250% | 4ä½å°æ•° |
| CVD | ç¬¦å· | âœ“/âœ— | - |
| CVD_ROC | ç™¾åˆ†æ¯” | 15.2% | 1ä½å°æ•° |
| GSS | æµ®ç‚¹æ•° | 0.8523 | 4ä½å°æ•° |
| Grid Upper | è´§å¸ | $0.00014 | æ ¹æ®ä»·æ ¼ç²¾åº¦ |
| Grid Lower | è´§å¸ | $0.00010 | æ ¹æ®ä»·æ ¼ç²¾åº¦ |
| Flags | å­—ç¬¦ä¸² | âœ“/âš ï¸ æ ‡è®°æˆ– - | - |

#### 4. è­¦å‘Šä¸ä¼˜åŠ¿æ ‡è®°è¾“å‡º (FR-032)

```
| Flags                           |
|---------------------------------|
| âœ“ å‡çªç ´ä¼˜åŠ¿                     |
| âœ“ é«˜VDRéœ‡è¡ âš ï¸ CVDå¼‚å¸¸ä¹°ç›˜      |
| -                               |
| âš ï¸ æç«¯æ³¢åŠ¨                      |
| âš ï¸ é«˜æ æ†æ‹¥æŒ¤ âš ï¸ é€¼ç©ºé£é™©        |
```

**è­¦å‘Šç±»å‹å¥‘çº¦**:

| æ ‡è®° | è§¦å‘æ¡ä»¶ | FR |
|------|----------|-----|
| âš ï¸ æç«¯æ³¢åŠ¨ | NATR > 10% | FR-032, Edge Case |
| âš ï¸ é™é»˜æœŸ | NATR < 1% | FR-032, Edge Case |
| âš ï¸ é«˜æ æ†æ‹¥æŒ¤ | OVR > 2.0 | FR-032, Edge Case |
| âš ï¸ é€¼ç©ºé£é™© | Funding > 0.1% | FR-032, Edge Case |
| âš ï¸ CVDå¼‚å¸¸ä¹°ç›˜ | CVD_ROC > 50% | FR-032, FR-021.1 |

**ä¼˜åŠ¿æ ‡è®°å¥‘çº¦**:

| æ ‡è®° | è§¦å‘æ¡ä»¶ | FR |
|------|----------|-----|
| âœ“ é«˜VDR - å®Œç¾éœ‡è¡ | VDR > 10.0 | FR-032, FR-010.2 |
| âœ“ å‡çªç ´ä¼˜åŠ¿ | Z-Score > 2.0 ä¸” KER < 0.3 | FR-032, FR-015.2 |

#### 5. æ‰§è¡Œæ‘˜è¦è¾“å‡º (FR-033, FR-037)

```
======================================================================
âœ… ç­›é€‰å®Œæˆ
======================================================================
ğŸ“Š æ‰§è¡Œæ‘˜è¦:
  - æ‰«ææ—¶é•¿: 58.7ç§’
  - æ€»æ ‡çš„æ•°: 536
  - åˆç­›é€šè¿‡æ•°: 398
  - æœ€ç»ˆTop N: 5
======================================================================
```

**å¥‘çº¦**:
- å¿…é¡»åœ¨å‘½ä»¤ç»“æŸæ—¶è¾“å‡º
- åŒ…å«æ‰§è¡Œæ—¶é•¿å’Œç»Ÿè®¡æ•°æ®
- çŠ¶æ€: âœ… æˆåŠŸ æˆ– âŒ å¤±è´¥

---

## Special Output Cases

### Case 1: å…¨å¸‚åœºæ— åˆæ ¼æ ‡çš„ (Edge Case, FR-032, SC-008)

```
======================================================================
âš ï¸ å½“å‰å¸‚åœºæ¡ä»¶ä¸é€‚åˆåšç©ºç½‘æ ¼,å»ºè®®ç­‰å¾…
======================================================================
ğŸ“Š è¯Šæ–­ä¿¡æ¯:
  - æ€»æ ‡çš„æ•°: 536
  - åˆç­›é€šè¿‡æ•°: 0
  - åŸå› : æµåŠ¨æ€§è¿‡æ»¤åæ— åˆæ ¼æ ‡çš„

ğŸ’¡ å»ºè®®:
  - é™ä½ --min-volume é˜ˆå€¼
  - ç­‰å¾…å¸‚åœºè¿›å…¥éœ‡è¡æœŸ
  - è°ƒæ•´æƒé‡é…ç½®
======================================================================
```

### Case 2: APIé™æµé”™è¯¯ (Edge Case)

```
======================================================================
âŒ æ‰§è¡Œå¤±è´¥
======================================================================
âŒ é”™è¯¯ä¿¡æ¯:
  - ç±»å‹: BinanceAPIError
  - è¯¦æƒ…: 429 Too Many Requests
  - ä½ç½®: è·å–Kçº¿æ•°æ®é˜¶æ®µ

ğŸ’¡ è§£å†³æ–¹æ¡ˆ:
  - ç­‰å¾…1åˆ†é’Ÿåé‡è¯•
  - ç³»ç»Ÿå·²è‡ªåŠ¨é‡è¯•3æ¬¡(60ç§’å»¶è¿Ÿ)
  - å¦‚æŒç»­å¤±è´¥,æ£€æŸ¥ç½‘ç»œæˆ–IPé™åˆ¶
======================================================================
```

### Case 3: æ•°æ®ä¸è¶³è­¦å‘Š (Edge Case)

ç»ˆç«¯ä¼šæ˜¾ç¤ºWARNINGæ—¥å¿—,ä½†ä¸ä¸­æ–­æ‰§è¡Œ:

```
ğŸ“Š æ­¥éª¤2: ä¸‰ç»´æŒ‡æ ‡è®¡ç®— (398ä¸ªæ ‡çš„)
----------------------------------------------------------------------
  âš ï¸ WARNING: FLOKIUSDT Kçº¿æ•°æ®ä¸è¶³300æ ¹(ä»…278æ ¹),è·³è¿‡
  âš ï¸ WARNING: BONKUSDT CVDæ•°æ®ä¸å¯ç”¨,é™çº§ä¸ºç®€åŒ–è®¡ç®—
  å¹¶è¡Œè®¡ç®—ä¸­... [========================================] 100%
  âœ“ å®Œæˆ 396 ä¸ªæ ‡çš„çš„æŒ‡æ ‡è®¡ç®— (ç”¨æ—¶: 15.3ç§’)
```

---

## Exit Codes

| Exit Code | å«ä¹‰ | è§¦å‘æ¡ä»¶ |
|-----------|------|---------|
| 0 | æˆåŠŸ | æ­£å¸¸å®Œæˆç­›é€‰å¹¶è¾“å‡ºç»“æœ |
| 1 | å‚æ•°é”™è¯¯ | æƒé‡éªŒè¯å¤±è´¥/Top Nè¶…èŒƒå›´ |
| 2 | APIé”™è¯¯ | å¸å®‰APIæŒç»­å¤±è´¥(é‡è¯•åä»å¤±è´¥) |
| 3 | æ•°æ®ä¸è¶³ | å…¨å¸‚åœºæ— åˆæ ¼æ ‡çš„(ä½†è¿™ä¸ç®—é”™è¯¯,è¿”å›0) |

---

## Behavior Contracts

### 1. æ€§èƒ½å¥‘çº¦ (SC-001)

**æ‰¿è¯º**: 60ç§’å†…å®Œæˆ500+æ ‡çš„æ‰«æ

**æµ‹é‡æ–¹æ³•**:
```python
import time
start_time = time.time()
# ... æ‰§è¡Œç­›é€‰ ...
elapsed = time.time() - start_time
assert elapsed < 60, f"æ€§èƒ½ä¸è¾¾æ ‡: {elapsed:.1f}ç§’"
```

### 2. ç²¾åº¦å¥‘çº¦ (SC-002)

**æ‰¿è¯º**: NATRè®¡ç®—ä¸TA-Libè¯¯å·® < 0.1%

**éªŒè¯æ–¹æ³•**:
```python
import talib
natr_talib = talib.NATR(high, low, close, timeperiod=14)
natr_ours = calculate_natr(klines, period=14)
error_pct = abs(natr_talib - natr_ours) / natr_talib * 100
assert error_pct < 0.1, f"NATRç²¾åº¦ä¸è¾¾æ ‡: {error_pct:.2f}%"
```

### 3. ç­›é€‰æ¡ä»¶å¥‘çº¦ (SC-003)

**æ‰¿è¯º**: Top 5æ ‡çš„å¿…é¡»æ»¡è¶³:
- NATR â‰¥ å‰20%åˆ†ä½
- KER < 0.3
- H < 0.5
- æ­£èµ„é‡‘è´¹ç‡

**éªŒè¯æ–¹æ³•**:
```python
for result in top_5_results:
    assert result.volatility.natr_percentile >= 0.80
    assert result.volatility.ker < 0.3
    assert result.trend.hurst_exponent < 0.5
    assert result.microstructure.funding_rate > Decimal('0.0001')
```

### 4. è¶‹åŠ¿å½’é›¶å¥‘çº¦ (SC-007)

**æ‰¿è¯º**: å¼ºä¸Šå‡è¶‹åŠ¿æ ‡çš„GSS = 0

**éªŒè¯æ–¹æ³•**:
```python
def test_strong_uptrend_veto():
    # æ¨¡æ‹Ÿå¼ºä¸Šå‡è¶‹åŠ¿æ ‡çš„
    trend = TrendMetrics(
        symbol="TEST",
        norm_slope=60.0,
        r_squared=0.85,
        hurst_exponent=0.45,
        is_strong_uptrend=True
    )
    trend_score = trend.calculate_trend_score(norm_slope_threshold=50.0)
    assert trend_score == 0.0, "å¼ºè¶‹åŠ¿å¦å†³æœºåˆ¶å¤±æ•ˆ"
```

---

## Logging Contract

### Log Levels

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| **INFO** | æ­£å¸¸æµç¨‹ | "å¼€å§‹è·å–åˆçº¦åˆ—è¡¨" |
| **WARNING** | å¼‚å¸¸ä½†å¯ç»§ç»­ | "FLOKIUSDT Kçº¿ä¸è¶³,è·³è¿‡" |
| **ERROR** | ä¸¥é‡é”™è¯¯ | "å¸å®‰APIè°ƒç”¨å¤±è´¥" |
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ | "è®¡ç®—NATR: high=[...], low=[...]" |

### Log Format

```python
logger.info("æ­¥éª¤1: å…¨å¸‚åœºæ‰«æ")  # FR-041
logger.warning("FLOKIUSDT Kçº¿æ•°æ®ä¸è¶³300æ ¹,è·³è¿‡")  # FR-039, FR-041
logger.error("å¸å®‰APIé™æµ: 429 Too Many Requests")  # FR-040, FR-041
```

---

## Testing Contract

### Unit Tests

```python
# tests/grid_trading/unit/test_command_params.py
def test_validate_weights_valid():
    """æµ‹è¯•æœ‰æ•ˆæƒé‡"""
    weights = validate_weights("0.2,0.2,0.3,0.3")
    assert len(weights) == 4
    assert sum(weights) == 1.0

def test_validate_weights_invalid_sum():
    """æµ‹è¯•æƒé‡æ€»å’Œâ‰ 1.0"""
    with pytest.raises(CommandError, match="æƒé‡æ€»å’Œå¿…é¡»=1.0"):
        validate_weights("0.3,0.3,0.3,0.3")

def test_validate_top_n_out_of_range():
    """æµ‹è¯•Top Nè¶…èŒƒå›´"""
    with pytest.raises(CommandError, match="å¿…é¡»åœ¨3-10ä¹‹é—´"):
        validate_top_n(15)
```

### Integration Tests

```python
# tests/grid_trading/integration/test_command_execution.py
def test_command_runs_successfully(mocker):
    """æµ‹è¯•å‘½ä»¤æˆåŠŸæ‰§è¡Œ"""
    # Mockå¸å®‰API
    mocker.patch('grid_trading.services.binance_futures_client...')

    # æ‰§è¡Œå‘½ä»¤
    call_command('screen_short_grid', '--top-n=3', verbosity=0)

    # éªŒè¯è¾“å‡º(æ•è·stdout)
    # ...
```

### E2E Tests

```python
# tests/grid_trading/e2e/test_screen_command.py
def test_full_screening_workflow():
    """ç«¯åˆ°ç«¯æµ‹è¯•(çœŸå®APIè°ƒç”¨,éœ€ç½‘ç»œ)"""
    import subprocess
    result = subprocess.run(
        ['python', 'manage.py', 'screen_short_grid', '--top-n=1'],
        capture_output=True,
        text=True,
        timeout=120
    )

    assert result.returncode == 0
    assert "âœ… ç­›é€‰å®Œæˆ" in result.stdout
    assert "æ‰«ææ—¶é•¿:" in result.stdout
```

---

## Versioning

å½“å‰ç‰ˆæœ¬: **v1.0.0** (MVP)

**å˜æ›´æ—¥å¿—**:
- v1.0.0 (2025-12-03): åˆå§‹ç‰ˆæœ¬,å®ç°ä¸‰ç»´ç­›é€‰æ¡†æ¶å’ŒGSSè¯„åˆ†

**å‘åå…¼å®¹æ€§æ‰¿è¯º**:
- å‘½ä»¤åç§°: `screen_short_grid` ä¸å˜
- å‚æ•°åç§°: ä¸ç§»é™¤æˆ–é‡å‘½åç°æœ‰å‚æ•°
- è¾“å‡ºæ ¼å¼: è¡¨æ ¼åˆ—é¡ºåºä¿æŒç¨³å®š

**æœªæ¥æ‰©å±•é¢„ç•™**:
- æ–°å‚æ•°: å¯æ·»åŠ ,ä½†å¿…é¡»æœ‰é»˜è®¤å€¼(å‘åå…¼å®¹)
- æ–°è¾“å‡ºåˆ—: å¯åœ¨è¡¨æ ¼æœ«å°¾æ·»åŠ 
- æ–°è­¦å‘Šç±»å‹: å¯æ·»åŠ ,ä½†ä¸å½±å“ç°æœ‰è­¦å‘Š

---

## Related Contracts

- [Data Model Contract](../data-model.md): å®šä¹‰å†…å­˜æ•°æ®æ¨¡å‹
- [Binance API Contract](./binance-api-contract.md): å®šä¹‰å¸å®‰APIè°ƒç”¨å¥‘çº¦
- [Indicator Calculation Contract](./indicator-contract.md): å®šä¹‰æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å¥‘çº¦

---

## Summary

æœ¬å¥‘çº¦å®šä¹‰äº†`screen_short_grid`å‘½ä»¤çš„å®Œæ•´æ¥å£è§„èŒƒ,åŒ…æ‹¬:

âœ… è¾“å…¥å‚æ•°(5ä¸ªå¯é€‰å‚æ•°)
âœ… è¾“å‡ºæ ¼å¼(é…ç½®/è¿›åº¦/è¡¨æ ¼/æ‘˜è¦)
âœ… é”™è¯¯å¤„ç†(Edge Cases)
âœ… æ€§èƒ½æ‰¿è¯º(60ç§’)
âœ… ç²¾åº¦ä¿è¯(NATR < 0.1%è¯¯å·®)
âœ… æµ‹è¯•è¦æ±‚(å•å…ƒ/é›†æˆ/E2E)

**åˆè§„æ€§**: æ»¡è¶³FR-034 ~ FR-037, SC-001 ~ SC-008ã€‚
