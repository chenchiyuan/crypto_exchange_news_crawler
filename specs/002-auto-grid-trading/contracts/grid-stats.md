# Management Command API: 网格统计与分析

**说明**: 本文档定义网格策略的统计查询、盈亏分析、性能报告等命令。

---

## 1. 查询统计摘要

### 命令
```bash
python manage.py grid_stats --config <配置名称> [--period <周期>]
```

### 参数

| 参数名 | 类型 | 必填 | 说明 | 可选值 |
|--------|------|------|------|--------|
| `--config` | string | 是 | 网格配置名称 | - |
| `--period` | string | 否 | 统计周期(默认24h) | 1h, 24h, 7d, 30d, all |

### 示例

```bash
# 最近24小时统计
python manage.py grid_stats --config btc_short_grid

# 最近7天统计
python manage.py grid_stats --config btc_short_grid --period 7d

# 全部历史统计
python manage.py grid_stats --config btc_short_grid --period all
```

### 输出

```
📈 网格策略统计: btc_short_grid (最近24小时)

交易统计:
  总交易次数:      156 次
  开仓成交:        78 次 (卖单)
  平仓成交:        78 次 (买单)
  撤单次数:        12 次
  成交率:          92.86%

盈亏统计:
  已实现盈亏:      +45.80 USDT
  未实现盈亏:      +14.00 USDT
  总盈亏:          +59.80 USDT
  网格收益率:      1.5% / 天
  夏普比率:        2.3 (年化)

风险统计:
  最大持仓:        0.12 BTC
  平均持仓:        0.08 BTC
  当前持仓:        0.08 BTC
  最大回撤:        1.8%
  止损触发:        0 次

效率统计:
  平均成交时间:    8.5 分钟
  平均订单挂单时长: 12.3 分钟
  网格利用率:      85% (17/20 层级被触及)
  资金利用率:      40% (持仓 / 最大持仓)

价格统计:
  价格范围:        60,125 ~ 64,875 USDT
  平均价格:        62,450 USDT
  价格波动率:      2.3% (标准差)
  网格覆盖率:      95% (价格在网格内时间占比)

时间统计:
  统计周期:        2025-12-04 14:30 ~ 2025-12-05 14:30
  运行时长:        24小时
  策略可用性:      99.9%
  WebSocket中断:   1次 (已自动恢复)
```

---

## 2. 生成详细报告

### 命令
```bash
python manage.py grid_report --config <配置名称> [--format <格式>] [--output <路径>]
```

### 参数

| 参数名 | 类型 | 必填 | 说明 | 可选值 |
|--------|------|------|------|--------|
| `--config` | string | 是 | 网格配置名称 | - |
| `--format` | string | 否 | 报告格式(默认text) | text, json, csv, html |
| `--output` | string | 否 | 输出文件路径(默认stdout) | 文件路径 |

### 示例

```bash
# 生成文本报告(输出到终端)
python manage.py grid_report --config btc_short_grid

# 生成JSON报告并保存
python manage.py grid_report --config btc_short_grid --format json --output report.json

# 生成HTML报告
python manage.py grid_report --config btc_short_grid --format html --output report.html
```

### 输出 (text格式)

```
================================================================================
                    网格策略详细报告
================================================================================

配置信息:
  策略名称: btc_short_grid
  交易所: Binance Futures
  交易对: BTCUSDT
  网格模式: SHORT (做空网格)
  报告生成时间: 2025-12-05 14:30:00

运行概况:
  运行状态: ✅ 运行中
  启动时间: 2025-12-05 10:30:00
  运行时长: 4小时
  策略可用性: 99.9% (4分钟WebSocket中断,已恢复)

================================================================================
                    盈亏分析
================================================================================

已实现盈亏: +45.80 USDT

分项明细:
  开仓卖出: 78次, 平均价格 62,625 USDT
  平仓买入: 78次, 平均价格 62,450 USDT
  平均每次盈利: 0.59 USDT (175 USDT差价 × 0.01 BTC × 78次 - 手续费)
  手续费支出: -11.80 USDT (maker 0.02%, taker 0.04%)

未实现盈亏: +14.00 USDT

持仓明细:
  当前持仓: -0.08 BTC (8个开仓单已成交,平仓单挂单中)
  平均开仓价: 62,625 USDT
  当前市价: 62,450 USDT
  浮动盈亏: +14.00 USDT (+0.22%)

总盈亏: +59.80 USDT (+4.8% ROI)

================================================================================
                    交易统计
================================================================================

总交易次数: 156次

成交分布:
  ┌─────────────┬───────┬────────┬─────────┐
  │ 订单类型    │ 数量  │ 平均价 │ 总金额  │
  ├─────────────┼───────┼────────┼─────────┤
  │ 开仓卖单    │ 78    │ 62,625 │ 4,884.75│
  │ 平仓买单    │ 78    │ 62,450 │ 4,871.10│
  │ 撤单        │ 12    │ -      │ -       │
  └─────────────┴───────┴────────┴─────────┘

成交时间分布:
  00:00-04:00:  █████░░░░░░░░░░░ 12次
  04:00-08:00:  ████████████░░░░ 28次
  08:00-12:00:  ████████████████ 42次
  12:00-16:00:  ████████████████ 45次
  16:00-20:00:  ███████████░░░░░ 23次
  20:00-24:00:  ██████░░░░░░░░░░ 6次

网格层级热力图 (成交次数):
  层级 +10 (65,000): █░░░░░░░░░ 2次
  层级 +8  (64,500): ████░░░░░░ 8次
  层级 +6  (64,000): ████████░░ 15次
  层级 +4  (63,500): ████████░░ 18次
  层级 +2  (63,000): ██████████ 22次
  层级  0  (62,500): ██████████ 25次  <- 网格中心
  层级 -2  (62,000): ██████████ 23次
  层级 -4  (61,500): ████████░░ 17次
  层级 -6  (61,000): ███████░░░ 14次
  层级 -8  (60,500): ████░░░░░░ 9次
  层级 -10 (60,000): ██░░░░░░░░ 3次

================================================================================
                    风险分析
================================================================================

最大回撤: 1.8%
  发生时间: 2025-12-05 11:45
  触发原因: 价格短时上涨至 63,800 USDT
  持续时间: 15分钟
  恢复时间: 35分钟

持仓风险:
  最大持仓: 0.12 BTC (60% 的最大限制)
  平均持仓: 0.08 BTC (40%)
  当前持仓: 0.08 BTC (40%)
  持仓限制触发: 0次 (未达上限)

止损状态:
  止损触发: 0次
  最接近止损: -3.2% (距离下界止损线 59,700)
  止损缓冲区: 0.5%

================================================================================
                    性能指标
================================================================================

收益指标:
  总收益率:        +4.8% (基于初始投入 1,250 USDT)
  年化收益率:      ~438% (假设保持当前收益率)
  网格收益率:      1.5% / 天
  夏普比率:        2.3 (风险调整后收益)

效率指标:
  成交率:          92.86% (156/168 挂单)
  网格利用率:      85% (17/20 层级被触及)
  资金利用率:      40% (平均持仓 / 最大持仓)
  订单响应速度:    平均 1.2 秒 (WebSocket推送到订单创建)

稳定性指标:
  策略可用性:      99.9% (24小时内运行 23小时56分钟)
  WebSocket稳定性: 99.8% (1次中断,持续4分钟,已自动恢复)
  订单成功率:      100% (无订单创建失败)

================================================================================
                    异常事件
================================================================================

WebSocket中断事件:
  时间: 2025-12-05 12:15:30
  原因: 网络超时
  影响: 订单同步暂停 4分钟
  恢复: 自动重连成功 (第2次尝试)
  处理: 重新同步订单状态,无数据丢失

API限流事件: 无

订单失败事件: 无

================================================================================
                    建议与优化
================================================================================

✅ 策略表现良好,无需调整

可选优化建议:
  1. 网格间距可以适当扩大至 0.5% (当前 0.42%)
     - 理由: 网格中部层级成交频繁,可减少交易次数降低手续费
     - 预期影响: 成交次数 -20%, 手续费 -20%, 单次盈利 +18%

  2. 最大持仓可以提高至 0.25 BTC (当前 0.2 BTC)
     - 理由: 未触发持仓限制,可增加网格容量
     - 预期影响: 极端行情下抗风险能力 +25%

  3. 止损缓冲区可以调整至 1% (当前 0.5%)
     - 理由: 最接近止损 -3.2%, 缓冲区偏小可能导致误触发
     - 预期影响: 止损误触发概率 -80%

================================================================================
                    报告结束
================================================================================
```

### 输出 (JSON格式)

```json
{
  "report_meta": {
    "config_name": "btc_short_grid",
    "exchange": "binance",
    "symbol": "BTCUSDT",
    "grid_mode": "SHORT",
    "report_time": "2025-12-05T14:30:00Z",
    "period_start": "2025-12-05T10:30:00Z",
    "period_end": "2025-12-05T14:30:00Z"
  },
  "pnl": {
    "realized_pnl": 45.80,
    "unrealized_pnl": 14.00,
    "total_pnl": 59.80,
    "roi": 4.8,
    "fees_paid": 11.80
  },
  "trades": {
    "total_trades": 156,
    "entry_orders_filled": 78,
    "exit_orders_filled": 78,
    "canceled_orders": 12,
    "fill_rate": 0.9286
  },
  "risk": {
    "max_drawdown": 0.018,
    "max_position": 0.12,
    "avg_position": 0.08,
    "current_position": 0.08,
    "stop_loss_triggered": 0
  },
  "performance": {
    "annualized_return": 4.38,
    "sharpe_ratio": 2.3,
    "grid_efficiency": 0.85,
    "capital_efficiency": 0.40
  }
}
```

### 输出 (CSV格式)

```csv
timestamp,order_id,intent,side,price,amount,status,pnl,commission
2025-12-05 10:35:15,123456,ENTRY,SELL,62625.00,0.01,FILLED,0.00,0.13
2025-12-05 10:42:30,123457,EXIT,BUY,62450.00,0.01,FILLED,1.62,0.06
2025-12-05 10:50:18,123458,ENTRY,SELL,62875.00,0.01,FILLED,0.00,0.13
...
```

---

## 3. 导出交易明细

### 命令
```bash
python manage.py export_trades --config <配置名称> [--start <开始时间>] [--end <结束时间>] [--output <路径>]
```

### 参数

| 参数名 | 类型 | 必填 | 说明 | 格式 |
|--------|------|------|------|------|
| `--config` | string | 是 | 网格配置名称 | - |
| `--start` | datetime | 否 | 开始时间(默认7天前) | YYYY-MM-DD HH:MM |
| `--end` | datetime | 否 | 结束时间(默认现在) | YYYY-MM-DD HH:MM |
| `--output` | string | 否 | 输出文件(默认stdout) | 文件路径 |

### 示例

```bash
# 导出最近7天交易
python manage.py export_trades --config btc_short_grid --output trades.csv

# 导出指定时间范围
python manage.py export_trades \
  --config btc_short_grid \
  --start "2025-12-01 00:00" \
  --end "2025-12-05 23:59" \
  --output trades_december.csv
```

### 输出 (CSV)

```csv
时间,订单ID,客户端ID,层级,意图,方向,价格,数量,状态,手续费,已实现盈亏,备注
2025-12-05 10:35:15,123456,btc_short_ENTRY_SELL_2_a3f2,2,ENTRY,SELL,62625.00,0.01,FILLED,0.13,0.00,开仓成交
2025-12-05 10:42:30,123457,btc_short_EXIT_BUY_2_c5d3,2,EXIT,BUY,62450.00,0.01,FILLED,0.06,1.62,平仓盈利
2025-12-05 10:50:18,123458,btc_short_ENTRY_SELL_4_b4e1,4,ENTRY,SELL,62875.00,0.01,FILLED,0.13,0.00,开仓成交
2025-12-05 11:05:42,123459,btc_short_EXIT_BUY_4_d6f2,4,EXIT,BUY,62700.00,0.01,FILLED,0.06,1.62,平仓盈利
...
```

---

## 4. 实时监控面板

### 命令
```bash
python manage.py grid_monitor [--config <配置名称>] [--all]
```

### 参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `--config` | string | 否 | 监控特定配置 |
| `--all` | flag | 否 | 监控所有活跃配置 |

### 示例

```bash
# 监控单个策略
python manage.py grid_monitor --config btc_short_grid

# 监控所有活跃策略
python manage.py grid_monitor --all
```

### 输出 (单策略)

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 网格策略实时监控: btc_short_grid                     刷新: 每5秒 │ 14:30:25 │
└──────────────────────────────────────────────────────────────────────────┘

运行状态: ✅ 运行中 (4小时) │ PID: 12345 │ WebSocket: ✅ 已连接

┌─────────────────── 市场信息 ───────────────────┐┌────────────── 仓位信息 ─────────────────┐
│ 当前价格:    62,450 USDT                       ││ 当前持仓:   -0.08 BTC (空头)            │
│ 24h涨跌:     -2.3% ↓                           ││ 持仓占比:   40% / 最大 0.2 BTC          │
│ 价格位置:    网格中部 (49%)                    ││ 开仓均价:   62,625 USDT                 │
│ 网格区间:    60,000 ~ 65,000                   ││ 未实现盈亏: +14.00 USDT (+0.22%)        │
└────────────────────────────────────────────────┘└─────────────────────────────────────────┘

┌─────────────────── 订单信息 ───────────────────┐┌────────────── 盈亏统计 ─────────────────┐
│ 挂单数量:    12个 (开仓 6, 平仓 6)             ││ 已实现盈亏: +45.80 USDT                 │
│ 最近成交:    5分钟前 (卖单 @ 62,625)           ││ 未实现盈亏: +14.00 USDT                 │
│ 成交率:      92.86%                            ││ 总盈亏:     +59.80 USDT (+4.8%)         │
│ 订单响应:    1.2秒 (平均)                      ││ 网格收益率: 1.5% / 天                   │
└────────────────────────────────────────────────┘└─────────────────────────────────────────┘

网格覆盖 (实时):
65,000 ████████░░░░░░░░░░░░░░░░ 上界
64,500 ████████░░░░░░░░░░░░░░░░
64,000 ████████░░░░░░░░░░░░░░░░
63,500 ████████░░░░░░░░░░░░░░░░
63,000 ████████████░░░░░░░░░░░░ <- 挂单 SELL 0.01
62,500 ████████████████████████ <- 当前价 62,450
62,000 ████████████████████████ <- 持仓层级 (8个)
61,500 ████████████████░░░░░░░░ <- 挂单 BUY 0.01
61,000 ████████░░░░░░░░░░░░░░░░
60,500 ████████░░░░░░░░░░░░░░░░
60,000 ████████░░░░░░░░░░░░░░░░ 下界

最近事件 (最新10条):
[14:30:15] FILL   订单成交: SELL @ 62,625, 数量 0.01
[14:28:42] ORDER  创建买单: BUY @ 62,375, 数量 0.01
[14:25:10] INFO   价格更新: 62,450 USDT (-0.3%)
[14:22:38] FILL   订单成交: BUY @ 62,200, 数量 0.01, 盈亏 +1.62 USDT
[14:20:05] ORDER  创建卖单: SELL @ 62,875, 数量 0.01
...

按 Ctrl+C 退出监控
```

### 输出 (多策略)

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 网格策略实时监控: 全部活跃策略 (3个)             刷新: 每5秒 │ 14:30:25 │
└──────────────────────────────────────────────────────────────────────────┘

┌────────────┬──────────┬───────┬──────────┬──────────┬────────┬──────────┐
│ 配置名称   │ 交易对   │ 模式  │ 当前价格 │ 持仓     │ 盈亏   │ 状态     │
├────────────┼──────────┼───────┼──────────┼──────────┼────────┼──────────┤
│ btc_short  │ BTCUSDT  │ SHORT │ 62,450   │ -0.08    │ +59.80 │ ✅ 4h    │
│ eth_neutral│ ETHUSDT  │ NEUTR │ 3,250    │ +0.50    │ +12.30 │ ✅ 2h    │
│ sol_long   │ SOLUSDT  │ LONG  │ 115.50   │ +10.00   │ -3.20  │ ⚠️ 1h    │
└────────────┴──────────┴───────┴──────────┴──────────┴────────┴──────────┘

总计盈亏: +68.90 USDT

按 Ctrl+C 退出监控 │ 按数字键选择策略查看详情
```

---

## 5. 性能基准测试

### 命令
```bash
python manage.py grid_benchmark --config <配置名称> [--duration <秒数>]
```

### 说明
测试策略的性能指标,不执行真实交易,仅统计处理速度。

### 参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `--config` | string | 是 | 网格配置名称 |
| `--duration` | integer | 否 | 测试时长秒数(默认60) |

### 示例

```bash
python manage.py grid_benchmark --config btc_short_grid --duration 60
```

### 输出

```
🏃 性能基准测试: btc_short_grid (60秒)

[========================================] 100% (60/60 秒)

测试结果:

WebSocket性能:
  消息接收速度:     125 msg/s (平均)
  消息处理延迟:     12 ms (P50), 28 ms (P95), 45 ms (P99)
  消息丢失率:       0%

订单同步性能:
  同步周期:         1000 ms (配置值)
  实际同步间隔:     1,002 ms (平均), 偏差 ±5 ms
  单次同步耗时:     85 ms (平均)
  同步幂等性:       100% (无重复订单)

订单创建性能:
  订单创建速度:     18 orders/s (理论峰值)
  API响应时间:      120 ms (平均), 250 ms (P95)
  订单失败率:       0%

数据库性能:
  读取延迟:         3 ms (GridLevel查询)
  写入延迟:         8 ms (TradeLog插入)
  批量更新:         15 ms (20个GridLevel)

内存使用:
  基线内存:         45 MB
  运行时内存:       52 MB (峰值)
  内存增长率:       0.1 MB / 分钟 (稳定)

CPU使用:
  平均CPU:          5.2%
  峰值CPU:          12.8% (订单同步时)
  空闲CPU:          2.1%

✅ 性能测试通过
系统满足性能目标:
  ✅ WebSocket延迟 < 50ms (P95: 28ms)
  ✅ 订单同步延迟 < 2秒 (实际: 85ms)
  ✅ 内存使用 < 100MB (实际: 52MB)
```

---

## 6. 比较多个策略

### 命令
```bash
python manage.py grid_compare --configs <配置1> <配置2> [...] [--period <周期>]
```

### 参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `--configs` | list | 是 | 配置名称列表(空格分隔) |
| `--period` | string | 否 | 统计周期(默认24h) |

### 示例

```bash
python manage.py grid_compare --configs btc_short eth_neutral sol_long --period 7d
```

### 输出

```
📊 策略对比分析 (最近7天)

┌─────────────┬──────────┬───────┬──────────┬──────────┬──────────┬──────────┐
│ 策略        │ 交易对   │ 模式  │ 总盈亏   │ 收益率   │ 成交率   │ 最大回撤 │
├─────────────┼──────────┼───────┼──────────┼──────────┼──────────┼──────────┤
│ btc_short   │ BTCUSDT  │ SHORT │ +320.50  │ +10.5%   │ 92.8%    │ 1.8%     │
│ eth_neutral │ ETHUSDT  │ NEUTR │ +85.20   │ +6.2%    │ 88.5%    │ 2.1%     │
│ sol_long    │ SOLUSDT  │ LONG  │ -12.30   │ -1.1%    │ 76.3%    │ 4.5%     │
└─────────────┴──────────┴───────┴──────────┴──────────┴──────────┴──────────┘

表现排名:
  🥇 最佳收益: btc_short (+10.5%)
  🥈 第二名:   eth_neutral (+6.2%)
  🥉 第三名:   sol_long (-1.1%)

  🏆 最低回撤: btc_short (1.8%)
  🏆 最高成交率: btc_short (92.8%)
  ⚠️  最高风险: sol_long (4.5% 回撤)

建议:
  ✅ btc_short 表现优秀,建议增加仓位
  ⚠️  sol_long 表现不佳,建议暂停或调整参数
```

---

## Django Admin 统计查看

### URL
```
http://localhost:8000/admin/grid_trading/gridstatistics/
```

### 功能
- ✅ 查看所有策略的历史统计
- ✅ 按配置/时间范围筛选
- ✅ 图表展示盈亏趋势(需安装django-admin-charts)
- ✅ 导出统计数据为Excel

---

## 错误码

| 错误码 | 说明 | 解决方法 |
|--------|------|---------|
| `NO_DATA` | 无统计数据 | 策略未运行或刚启动 |
| `INVALID_PERIOD` | 无效的时间周期 | 使用 1h/24h/7d/30d/all |
| `EXPORT_FAILED` | 导出失败 | 检查文件路径权限 |
| `CONFIG_NOT_FOUND` | 配置不存在 | 确认配置名称正确 |
