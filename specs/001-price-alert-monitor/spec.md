# Feature Specification: 价格触发预警监控系统

**Feature Branch**: `001-price-alert-monitor`
**Created**: 2025-12-08
**Status**: Draft
**Input**: User description: "我需要新开分支实现实现003迭代。迭代内容：可以选择指定合约进行价格监控，当价格触发规则之后自动推送。被动选择：后台手动标记合约 自动选择:选择最近7天符合 /screening/daily/ 规则的所有合约。2. 价格触发规则可以自动配置，触发任意一条即推送。目前的触发条件: 1. 7天内价格新高(4h线维度) 2. 7天内价格新低(4h线维度) 3. 价格达到4h ma20的位置。4. 价格达到4h ma99的位置。5. 价格达到价格分布区间90%的高位或者低位 3. 同一代币同一规则1小时最多推送一次(可配置)"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 手动配置合约监控与接收价格触发推送 (Priority: P1)

交易者需要监控特定合约的价格变动，当价格达到关键技术位置时及时获得通知。管理员可以在后台手动添加需要监控的合约标的，系统会持续监控这些合约的价格，并在触发任何一条预设规则时，立即推送通知到指定渠道（如Telegram、邮件等）。

**为什么是P1**: 这是系统的最核心功能，提供了基础的价格监控和通知能力，是后续所有功能的基础。即使只有这一个功能，也能为用户提供有价值的价格预警服务。

**独立测试**: 管理员在后台手动添加一个合约（如BTCUSDT），设置监控状态为"启用"，系统在后台持续监控该合约的4h K线数据，当BTC价格创7天新高时，用户立即收到包含"BTCUSDT触发新高预警"的推送消息。此功能无需依赖任何其他功能模块。

**Acceptance Scenarios**:

1. **Given** 管理员已登录后台，**When** 在合约监控管理页面选择BTCUSDT并标记为"监控中"，**Then** 系统自动开始监控该合约，状态显示为"已启用"
2. **Given** BTCUSDT已被手动标记为监控合约且价格处于区间震荡，**When** BTC价格突破最近7天的最高价（4h线维度），**Then** 系统在3秒内向配置的推送渠道发送预警消息，消息包含：合约代码、触发规则名称、当前价格、触发时间
3. **Given** BTCUSDT在10:00触发了"7天新高"规则并已推送，**When** 价格在10:30再次触发同一规则，**Then** 系统不发送新推送（1小时内同规则仅推送一次）
4. **Given** BTCUSDT在10:00触发了"7天新高"规则，**When** 价格在11:05触发同一规则（距上次推送超过1小时），**Then** 系统发送新的推送通知

---

### User Story 2 - 基于筛选结果自动监控合约 (Priority: P2)

交易者希望自动监控那些符合选币策略的优质标的，而不需要手动逐一添加。系统会定期（如每日10点后）自动获取最近7天符合 `/screening/daily/` API返回的所有合约列表，并自动将这些合约纳入监控范围。

**为什么是P2**: 这个功能极大提高了监控效率，让系统能够自动跟踪策略筛选出的标的。但它依赖P1的监控和推送机制，因此优先级略低。

**独立测试**: 配置系统每日10:30执行自动选币同步任务，检查最近7天的筛选记录（通过 `/screening/daily/api/dates/` API获取日期列表，再获取每日结果），如果发现ZENUSDT在过去7天中有5天出现在筛选结果中，系统自动将ZENUSDT添加到监控列表（如果尚未监控），并开始对其进行价格监控和规则触发检测。

**Acceptance Scenarios**:

1. **Given** 过去7天的筛选结果中包含ETHUSDT（出现在12月1日、3日、5日的筛选结果中），**When** 系统执行自动同步任务，**Then** ETHUSDT被自动添加到监控合约列表，来源标记为"自动筛选"
2. **Given** BTCUSDT已被手动添加到监控列表（来源=手动），**When** 自动同步任务发现BTCUSDT也出现在最近7天的筛选结果中，**Then** 系统不重复添加，但更新合约的"最后筛选出现日期"字段
3. **Given** 某合约XYZUSDT在7天前被自动添加（来源=自动筛选），**When** 最近7天的筛选结果中不再包含该合约，**Then** 系统自动停止监控该合约并将其状态标记为"已过期"
4. **Given** 系统配置了每日10:30执行同步任务，**When** 达到执行时间，**Then** 系统自动调用 `/screening/daily/api/dates/` 获取最近7天的日期列表，逐个调用 `/screening/daily/api/<date>/` 获取各日的筛选结果，汇总所有出现的合约并更新监控列表

---

### User Story 3 - 灵活配置价格触发规则与防重复推送 (Priority: P1)

交易者需要在不同的市场环境下使用不同的价格触发策略。系统提供5种预设的价格触发规则，每条规则都可以独立启用/禁用。当任意一条已启用的规则被触发时，系统立即推送通知。为避免频繁推送造成干扰，系统对同一合约的同一规则实施1小时防重复机制（该防重间隔可在后台配置）。

**为什么是P1**: 规则配置的灵活性和防重复机制是核心用户体验的一部分，直接影响预警的有效性和用户的使用感受。

**独立测试**: 管理员在后台进入"价格触发规则管理"页面，看到5条预设规则（7天新高、7天新低、MA20触及、MA99触及、价格分布区间极值），可以通过开关按钮启用/禁用每条规则。管理员将"防重复推送间隔"设置为30分钟。当ETHUSDT价格触发"MA20触及"规则后，系统在30分钟内不再为该合约的该规则发送重复推送，但如果触发其他规则（如"7天新高"），则会立即推送。

**Acceptance Scenarios**:

1. **Given** 管理员在规则配置页面，**When** 查看规则列表，**Then** 显示5条预设规则：(1)7天价格新高(4h)、(2)7天价格新低(4h)、(3)价格触及MA20、(4)价格触及MA99、(5)价格达到分布区间90%极值，每条规则都有启用/禁用开关和规则说明
2. **Given** 规则"7天新高"已启用，规则"MA20触及"已禁用，**When** BTCUSDT价格同时满足这两个条件，**Then** 系统仅为"7天新高"规则发送推送，不发送"MA20触及"的推送
3. **Given** 防重复间隔设置为60分钟，ETHUSDT在14:00触发"MA20触及"规则并已推送，**When** 该合约在14:30再次触发同一规则，**Then** 系统不发送推送
4. **Given** 防重复间隔设置为60分钟，ETHUSDT在14:00触发"MA20触及"规则并已推送，**When** 该合约在14:10触发"7天新高"规则（不同规则），**Then** 系统立即发送"7天新高"的推送（规则独立计算防重复）
5. **Given** 管理员修改防重复间隔从60分钟改为30分钟，**When** 保存配置，**Then** 系统立即应用新配置，后续的防重复检测使用30分钟间隔

---

### User Story 4 - 定时数据更新与批量规则检测 (Priority: P1)

系统采用**定时批量处理**架构，通过两个独立脚本协同工作：**数据更新脚本**每5分钟获取最新K线数据和价格，更新完成后自动触发**合约监控脚本**遍历所有监控合约并检测规则触发。这种架构比实时WebSocket监控更简单、资源消耗更低，且易于维护和调试。

**为什么是P1**: 这是系统的核心工作流程，定义了数据如何更新和规则如何检测。如果没有这个定时任务机制，系统无法实际运行。

**独立测试**: 配置系统定时任务（如crontab），每5分钟执行数据更新脚本。脚本首先批量获取监控列表中所有合约（如BTCUSDT、ETHUSDT等）的1m、15m、4h K线数据和当前价格，保存到数据库。数据更新完成后，脚本自动调用合约监控脚本，后者遍历每个合约，计算MA均线和价格分布，检查5条规则，发现BTCUSDT触发"7天新高"规则后立即推送通知。整个流程从数据更新到推送完成耗时不超过30秒（假设监控100个合约）。

**Acceptance Scenarios**:

1. **Given** 系统配置了每5分钟执行数据更新脚本（如crontab: */5 * * * *），**When** 达到执行时间（如10:00、10:05、10:10），**Then** 数据更新脚本自动启动，记录执行开始时间
2. **Given** 数据更新脚本启动，监控列表包含50个合约，**When** 脚本执行，**Then** 批量调用交易所API获取这50个合约的1m、15m、4h K线数据（增量更新，仅获取自上次更新后的新数据）
3. **Given** 某合约BTCUSDT的4h K线数据上次更新到2025-12-08 10:00，**When** 当前时间为10:05执行数据更新，**Then** 脚本仅获取10:00之后的新K线（如10:00-10:04的1m K线），不重复获取历史数据
4. **Given** 数据更新脚本成功更新所有合约的K线和当前价格，**When** 更新完成，**Then** 脚本自动调用合约监控脚本（或记录"数据更新完成"标记，由监控脚本定时检查）
5. **Given** 合约监控脚本启动，所有合约的K线数据已是最新，**When** 脚本遍历每个启用状态的合约，**Then** 计算MA20、MA99、价格分布区间，并检查5条规则是否触发
6. **Given** BTCUSDT在10:05的检测中触发"7天新高"规则，**When** 监控脚本检测到触发，**Then** 检查防重复机制（该规则最近1小时内未推送），生成推送消息并调用汇成接口发送通知

---

### User Story 5 - 价格触发规则的精确判定逻辑 (Priority: P2)

系统需要准确判断价格是否触发了各项预设规则。5种规则的判定依据不同的技术指标和时间维度，系统必须基于已更新的K线数据，计算MA均线和价格分布区间，并与当前价格进行比较。

**为什么是P2**: 这是规则触发的技术实现细节，属于P1功能的底层支撑逻辑。虽然重要，但属于实现层面，优先级略低于核心工作流程。

**独立测试**: 配置监控BTCUSDT，数据库中已有最近7天的4h K线数据，当前价格为42000 USDT，系统计算得出：最高价43000、最低价39000、MA20位置41800、MA99位置40500、90%分位价格区间为[39500, 42800]。当下次数据更新后BTC价格涨至43100时，系统检测到触发"7天新高"规则；当价格跌至41850时，系统检测到触发"MA20触及"规则（价格在MA20的±0.5%范围内）。

**Acceptance Scenarios**:

1. **Given** BTCUSDT当前价格42000，过去7天4h K线最高价43000，**When** 价格涨至43100，**Then** 触发"7天新高"规则
2. **Given** BTCUSDT当前价格42000，过去7天4h K线最低价39000，**When** 价格跌至38900，**Then** 触发"7天新低"规则
3. **Given** BTCUSDT的4h MA20当前值为41800，当前价格42000，**When** 价格跌至41850（在MA20的±0.5%范围内），**Then** 触发"MA20触及"规则
4. **Given** BTCUSDT的4h MA99当前值为40500，当前价格42000，**When** 价格跌至40450（在MA99的±0.5%范围内），**Then** 触发"MA99触及"规则
5. **Given** BTCUSDT过去7天4h K线的价格分布区间90%上限为42800、下限为39500，当前价格41000，**When** 价格涨至42850（超过上限），**Then** 触发"价格分布区间高位"规则
6. **Given** BTCUSDT过去7天4h K线的价格分布区间90%下限为39500，当前价格41000，**When** 价格跌至39400（低于下限），**Then** 触发"价格分布区间低位"规则

---

### Edge Cases

- **系统启动时无历史数据**: 系统首次运行或数据库清空后，数据更新脚本首次执行需要回填最近7天的K线历史数据，耗时可能较长（5-10分钟），此期间规则检测应等待数据准备完成
- **API返回空结果**: 当 `/screening/daily/api/<date>/` 返回某日无筛选结果（results为空数组）时，系统如何处理？是否跳过该日期？
- **K线数据不足7天**: 新上市的合约可能没有7天的历史K线数据，规则判定应降级处理（如只使用已有的3天数据计算"7天新高"）
- **交易所API限流**: 数据更新脚本批量获取100+合约的K线数据可能触发交易所API限流（如币安1200请求/分钟），需要实现请求队列和限流控制
- **数据更新失败**: 如果某次数据更新脚本因网络故障或API异常失败，是否跳过本次规则检测还是使用旧数据继续检测？
- **价格快速波动导致多规则同时触发**: 在极端行情下，一个合约可能在同一次检测中同时触发多条规则（如同时触发7天新高和MA20触及），系统应合并为一条消息推送（避免短时间内发送多条通知）
- **监控合约列表过大**: 如果监控列表包含500+合约，数据更新脚本的执行时间可能超过5分钟，导致下次定时任务开始前未完成。需要监控执行时长并在超时时发出告警
- **推送渠道不可用**: 当汇成推送接口故障或网络中断时，系统应将推送消息存入失败队列，等待下次脚本执行时重试（最多重试3次）
- **防重复机制的边界**: 如果防重复间隔设置为0分钟，系统是否每次触发都推送（可能造成消息轰炸）？建议强制最小间隔为5分钟（与数据更新频率一致）
- **规则判定的精度**: MA触及判定使用±0.5%的范围，这个阈值是否可配置？价格分布区间使用90%分位，是否可调整（如85%、95%）？
- **脚本并发执行**: 如果上一次数据更新脚本尚未执行完成，新的定时任务又触发了，如何避免重复执行？需要实现脚本锁机制（如文件锁或数据库锁）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供管理后台界面，允许管理员手动添加、编辑、删除监控合约
- **FR-002**: 系统必须支持为每个监控合约标记来源（手动添加 / 自动筛选）和监控状态（启用 / 禁用 / 已过期）
- **FR-003**: 系统必须提供自动同步任务，每日定时（默认10:30）从 `/screening/daily/` API获取最近7天的筛选结果
- **FR-004**: 自动同步任务必须调用 `/screening/daily/api/dates/` 获取日期列表，再逐个调用 `/screening/daily/api/<date>/` 获取各日结果
- **FR-005**: 系统必须将最近7天筛选结果中出现的所有合约自动添加到监控列表（如尚未存在）
- **FR-006**: 系统必须提供数据更新脚本，每5分钟执行一次，批量更新所有监控合约的K线数据（1分钟、15分钟、4小时）和当前价格
- **FR-006-1**: 数据更新脚本必须支持增量更新，仅获取自上次更新以来的新K线数据
- **FR-006-2**: 数据更新脚本执行完成后，必须自动触发合约监控脚本
- **FR-007**: 系统必须提供合约监控脚本，在数据更新后执行，遍历所有监控中的合约并检测规则触发
- **FR-007-1**: 合约监控脚本必须支持独立运行（不依赖数据更新脚本），方便测试和手动触发
- **FR-007-2**: 合约监控脚本必须记录每次执行的开始/结束时间、检测合约数量、触发通知数量
- **FR-008**: 系统必须提供5种预设价格触发规则的配置界面，每条规则可独立启用/禁用
- **FR-009**: 系统必须实现规则1：检测价格是否创最近7天新高（基于4h K线的最高价）
- **FR-010**: 系统必须实现规则2：检测价格是否创最近7天新低（基于4h K线的最低价）
- **FR-011**: 系统必须实现规则3：检测价格是否触及4h MA20均线（判定阈值：价格在MA20的±0.5%范围内）
- **FR-012**: 系统必须实现规则4：检测价格是否触及4h MA99均线（判定阈值：价格在MA99的±0.5%范围内）
- **FR-013**: 系统必须实现规则5：检测价格是否达到过去7天4h K线价格分布的90%分位高位或低位
- **FR-014**: 系统必须在任意一条已启用规则被触发时，立即生成推送消息
- **FR-015**: 推送消息必须包含：合约代码、触发规则名称、当前价格、触发时间、可选的K线图链接
- **FR-016**: 系统必须实现防重复推送机制：同一合约的同一规则在指定时间间隔内（默认1小时）仅推送一次
- **FR-017**: 系统必须允许管理员在后台配置防重复推送的时间间隔（单位：分钟）
- **FR-018**: 系统必须记录每次规则触发的日志，包括：合约、规则、触发时间、是否推送（或因防重复跳过）
- **FR-019**: 系统必须复用现有的汇成(huicheng)推送接口进行消息推送
- **FR-020**: 系统必须持久化监控合约列表、规则配置、推送历史记录、K线数据到数据库
- **FR-021**: 系统必须提供监控状态仪表盘，显示当前监控合约数量、今日触发次数、最近推送记录、最后数据更新时间

### Key Entities

- **MonitoredContract（监控合约）**:
  - 合约代码（symbol，如BTCUSDT）
  - 来源（source：manual手动 / auto自动筛选）
  - 监控状态（status：enabled启用 / disabled禁用 / expired已过期）
  - 添加时间（created_at）
  - 最后筛选出现日期（last_screening_date，仅自动添加的合约）
  - 最后数据更新时间（last_data_update_at）

- **KlineData（K线数据）**:
  - 合约代码（symbol）
  - K线周期（interval：1m / 15m / 4h）
  - 开盘时间（open_time）
  - 开盘价（open_price）
  - 最高价（high_price）
  - 最低价（low_price）
  - 收盘价（close_price）
  - 成交量（volume）
  - 关系：一个合约对应多条K线数据（按周期和时间区分）

- **PriceAlertRule（价格触发规则）**:
  - 规则ID（rule_id：1-5）
  - 规则名称（name：如"7天新高"）
  - 规则描述（description：技术说明）
  - 启用状态（enabled：true / false）
  - 判定参数（parameters：如MA触及的阈值百分比）

- **AlertTriggerLog（触发日志）**:
  - 合约代码（symbol）
  - 规则ID（rule_id）
  - 触发时间（triggered_at）
  - 当前价格（price）
  - 是否已推送（pushed：true / false）
  - 推送时间（pushed_at，可为空）
  - 跳过原因（skip_reason，如"防重复"）

- **DataUpdateLog（数据更新日志）**:
  - 执行开始时间（started_at）
  - 执行结束时间（ended_at）
  - 更新合约数量（contracts_count）
  - 获取K线总数（klines_count）
  - 执行状态（status：success / failed / timeout）
  - 错误信息（error_message，可为空）

- **SystemConfig（系统配置）**:
  - 防重复推送间隔（duplicate_suppress_minutes，默认60）
  - 数据更新脚本执行间隔（data_update_interval_minutes，默认5）
  - 自动同步任务执行时间（sync_schedule_time，默认"10:30"）
  - 汇成推送接口配置（huicheng_push_config：存储接口URL和认证信息）
  - 规则判定参数（rule_parameters：如MA触及阈值0.5%、价格分布分位90%）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在后台界面1分钟内完成手动添加一个监控合约的操作
- **SC-002**: 自动同步任务能够在5分钟内完成最近7天筛选结果的获取和监控列表更新（假设每天平均20个筛选标的）
- **SC-003**: 数据更新脚本能够在3分钟内完成100个监控合约的K线数据更新（3个周期：1m、15m、4h），平均每个合约1.8秒
- **SC-004**: 合约监控脚本能够在2分钟内完成100个合约的规则检测和推送（平均每个合约1.2秒）
- **SC-005**: 从数据更新脚本启动到所有触发规则的推送完成，整个流程耗时不超过5分钟（满足下次定时任务触发前完成）
- **SC-006**: 系统能够在规则触发后3秒内完成判定并发送推送消息（网络正常情况下）
- **SC-007**: 防重复机制能够100%准确地防止同一合约同一规则在设定时间间隔内的重复推送
- **SC-008**: 推送消息的可靠性达到99%以上（除推送渠道自身故障外，系统不丢失触发事件）
- **SC-009**: 规则判定的准确率达到100%（基于回测历史K线数据，验证判定逻辑无误判）
- **SC-010**: 用户能够在仪表盘实时查看监控状态（包含最后数据更新时间、今日触发次数），页面加载时间不超过2秒

## Assumptions *(optional)*

1. **K线数据来源**: 假设系统已具备从币安或其他交易所API获取K线数据的能力（复用现有的数据采集模块）
2. **筛选API稳定性**: 假设 `/screening/daily/` API已稳定运行，能够正常返回历史筛选结果
3. **推送接口可用性**: 假设项目中已配置汇成推送接口，接口可正常调用并能成功发送消息
4. **服务器资源**: 假设服务器有足够的CPU和内存资源支持定时批量处理100+合约的数据更新和规则检测
5. **定时任务调度器**: 假设服务器已配置定时任务调度器（如crontab或Celery Beat），可以每5分钟触发脚本执行
6. **时区一致性**: 假设系统时间、K线数据时间、筛选结果时间均使用UTC或统一时区，避免时区混乱
7. **规则判定阈值**: MA触及判定使用±0.5%阈值，价格分布区间使用90%分位，这些默认值经过初步验证，后续可根据用户反馈调整
8. **自动移除策略**: 对于不再出现在最近7天筛选结果中的合约（来源=自动筛选），系统将自动停止监控并标记为"已过期"状态，以保持监控列表的活跃性和减少资源消耗
9. **脚本执行环境**: 假设数据更新脚本和合约监控脚本可以通过命令行独立运行（如Django management commands），便于开发、测试和生产环境部署
