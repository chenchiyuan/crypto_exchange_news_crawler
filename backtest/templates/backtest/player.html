<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Strategy V2 - å›æµ‹æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* æ ¸å¿ƒè‰²æ¿ - åŸºäºè®¾è®¡ç¨¿æå– */
            --bg-body: #0b0e14;
            --bg-card: #151925;
            --bg-hover: #1e2330;
            --border-color: #2a2f42;

            --primary: #7c3aed; /* æ’­æ”¾æŒ‰é’®ç´«è‰² */
            --primary-hover: #6d28d9;
            --text-main: #ffffff;
            --text-sub: #9ca3af;

            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 20px;
        }

        /* --- 1. é¡¶éƒ¨å¯¼èˆªæ  --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .header-left h1 { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .header-left .subtitle { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
        .header-right { display: flex; gap: 12px; }
        .tag {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-sub);
            display: flex; align-items: center; gap: 6px;
        }
        .tag.profit { color: var(--accent-green); border-color: rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.05); font-weight: 600; }
        .tag.loss { color: var(--accent-red); border-color: rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); font-weight: 600; }

        /* --- 2. æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡è¡Œ --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-label { font-size: 12px; color: var(--text-sub); margin-bottom: 8px; }
        .stat-value { font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
        .stat-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            opacity: 0.8;
        }

        /* --- 3. æ§åˆ¶æ’­æ”¾æ¡ --- */
        .control-bar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .control-group { display: flex; align-items: center; gap: 15px; }

        /* æ’­æ”¾æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .btn-play {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-play:hover { transform: scale(1.05); }
        .btn-play:active { transform: scale(0.95); }

        .btn-icon {
            background: transparent; border: none; color: var(--text-sub);
            cursor: pointer; font-size: 14px; transition: color 0.2s;
            padding: 8px;
        }
        .btn-icon:hover { color: var(--text-main); }

        /* è¿›åº¦æ¡æ ·å¼ */
        .timeline-wrapper { flex: 1; display: flex; align-items: center; gap: 15px; }
        .timeline-track {
            flex: 1; height: 4px; background: #2a2f42; border-radius: 2px;
            position: relative; cursor: pointer;
        }
        .timeline-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%);
            border-radius: 2px; width: 0%;
            position: relative;
        }
        .timeline-thumb {
            width: 12px; height: 12px; background: #fff; border-radius: 50%;
            position: absolute; right: -6px; top: -4px;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
            transition: transform 0.1s;
        }
        .timeline-track:hover .timeline-thumb { transform: scale(1.3); }
        .step-counter { font-family: monospace; color: var(--text-sub); font-size: 12px; min-width: 80px; text-align: right; }

        /* ä¸‹æ‹‰ä¸é€Ÿåº¦é€‰æ‹© */
        .select-dark {
            background: var(--bg-body); color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 6px; font-size: 13px;
            outline: none; cursor: pointer;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-box {
            background: var(--bg-body); color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 6px; font-size: 13px;
            outline: none; min-width: 200px;
        }
        .search-box:focus {
            border-color: var(--primary);
        }

        /* --- 4. ä¸»å†…å®¹åŒº --- */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px; /* å›¾è¡¨å®½ï¼Œè¯¦æƒ…çª„ */
            gap: 20px;
            overflow: hidden; /* å†…éƒ¨æ»šåŠ¨ */
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex; flex-direction: column;
            position: relative;
        }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .panel-title { font-size: 16px; font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .panel-badge { background: #262626; color: #999; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .legend-custom { display: flex; gap: 15px; font-size: 12px; color: var(--text-sub); }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #mainChart {
            flex: 1;
            width: 100%;
            min-height: 0;
            position: relative;  /* ç¡®ä¿å›¾è¡¨å†…å®¹ä¸é®æŒ¡zoom-control */
        }

        /* å³ä¾§è¯¦æƒ…ä¾§è¾¹æ  */
        .detail-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        /* ç©ºçŠ¶æ€å ä½ */
        .empty-state {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); gap: 15px; text-align: center; padding: 20px;
        }
        .empty-icon { font-size: 48px; opacity: 0.2; }

        /* å®é™…æ•°æ®å†…å®¹ */
        .data-list { overflow-y: auto; flex: 1; padding: 15px; }
        .data-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px; padding: 12px; margin-bottom: 10px;
        }
        .data-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
        .data-row:last-child { margin-bottom: 0; }
        .lbl { color: var(--text-sub); }
        .val { font-family: monospace; }
        .txt-green { color: var(--accent-green); }
        .txt-red { color: var(--accent-red); }

        /* LoadingçŠ¶æ€ */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(11, 14, 20, 0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-right { width: 100%; justify-content: space-between; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .control-bar { flex-direction: column; align-items: stretch; }
            .timeline-wrapper { width: 100%; }
            .main-content { grid-template-columns: 1fr; overflow-y: auto; }
            .detail-panel { height: 300px; }
            body { height: auto; overflow-y: auto; }
        }

        /* --- ç¼©æ”¾æ§åˆ¶å™¨ (ç±»ä¼¼åœ°å›¾) --- */
        .zoom-control {
            position: absolute;
            right: 10px;  /* ä»30pxæ”¹ä¸º10pxï¼Œé¿å…è¶…å‡ºchart-panelè¾¹ç•Œ */
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;  /* ä»100æ”¹ä¸º1000ï¼Œç¡®ä¿åœ¨EChartså›¾è¡¨ä¸Šæ–¹ */
            pointer-events: auto;  /* ç¡®ä¿å¯ä»¥ç‚¹å‡» */
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .zoom-slider {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 6px;
            height: 120px;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-slider::-webkit-slider-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .zoom-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-slider::-moz-range-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .zoom-level-indicator {
            font-size: 11px;
            color: var(--text-sub);
            white-space: nowrap;
            font-weight: 500;
            padding: 4px 6px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- Loading çŠ¶æ€ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div style="color: var(--text-sub);">æ­£åœ¨åŠ è½½å›æµ‹æ•°æ®...</div>
    </div>

    <!-- 1. é¡¶éƒ¨æ  -->
    <div class="header">
        <div class="header-left">
            <h1>
                <i class="fa-solid fa-chart-simple" style="color: var(--primary);"></i>
                Grid Strategy V2
            </h1>
            <div class="subtitle">å›æµ‹æ’­æ”¾å™¨</div>
        </div>
        <div class="header-right">
            <div class="tag">äº¤æ˜“å¯¹ <span style="color:#fff" id="headerSymbol">--</span></div>
            <div class="tag">å‘¨æœŸ <span style="color:#fff" id="headerInterval">--</span></div>
            <div class="tag" id="headerReturn">æ”¶ç›Šç‡ <span style="color:#fff">--</span></div>
        </div>
    </div>

    <!-- 2. ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
    <div class="stats-grid">
        <!-- å¡ç‰‡1: å½“å‰ä»·æ ¼ -->
        <div class="stat-card">
            <div class="stat-label">å½“å‰ä»·æ ¼</div>
            <div class="stat-value" style="color: var(--accent-blue);" id="val-price">--</div>
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);">
                <i class="fa-solid fa-dollar-sign"></i>
            </div>
        </div>
        <!-- å¡ç‰‡2: è´¦æˆ·ä»·å€¼ -->
        <div class="stat-card">
            <div class="stat-label">è´¦æˆ·ä»·å€¼</div>
            <div class="stat-value" style="color: var(--accent-cyan);" id="val-balance">--</div>
            <div class="stat-icon" style="background: rgba(6, 182, 212, 0.1); color: var(--accent-cyan);">
                <i class="fa-solid fa-chart-pie"></i>
            </div>
        </div>
        <!-- å¡ç‰‡3: ç°é‡‘ä½™é¢ -->
        <div class="stat-card">
            <div class="stat-label">ç°é‡‘ä½™é¢</div>
            <div class="stat-value" style="color: var(--accent-yellow);" id="val-cash">--</div>
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--accent-yellow);">
                <i class="fa-solid fa-wallet"></i>
            </div>
        </div>
        <!-- å¡ç‰‡4: ç›ˆäºé‡‘é¢ -->
        <div class="stat-card">
            <div class="stat-label">ç›ˆäºé‡‘é¢</div>
            <div class="stat-value" id="val-pnl">--</div>
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green);">
                <i class="fa-solid fa-arrow-trend-up"></i>
            </div>
        </div>
        <!-- å¡ç‰‡5: ç›ˆäºæ¯”ä¾‹ -->
        <div class="stat-card">
            <div class="stat-label">ç›ˆäºæ¯”ä¾‹</div>
            <div class="stat-value" id="val-pnl-pct">--</div>
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green);">
                <i class="fa-solid fa-percent"></i>
            </div>
        </div>
    </div>

    <!-- 3. æ§åˆ¶æ¡ -->
    <div class="control-bar">
        <div class="control-group">
            <span style="color: var(--text-sub); font-size: 13px;">æœç´¢</span>
            <input type="text"
                   class="search-box"
                   id="searchInput"
                   placeholder="æœç´¢ID/åç§°/äº¤æ˜“å¯¹..."
                   onkeyup="handleSearch(event)">
        </div>

        <div class="control-group">
            <span style="color: var(--text-sub); font-size: 13px;">é€‰æ‹©å›æµ‹</span>
            <select class="select-dark" id="backtestSelect" onchange="loadBacktest()" style="min-width: 400px;">
                <option value="">-- åŠ è½½ä¸­ --</option>
            </select>
        </div>

        <div class="control-group" style="margin-left: 20px;">
            <button class="btn-icon" onclick="seekStep(-10)" title="åé€€10æ­¥"><i class="fa-solid fa-backward"></i></button>
            <button class="btn-icon" onclick="seekStep(-1)" title="åé€€1æ­¥"><i class="fa-solid fa-chevron-left"></i></button>

            <button class="btn-play" id="playBtn" onclick="togglePlay()" title="æ’­æ”¾/æš‚åœ">
                <i class="fa-solid fa-play" style="margin-left: 2px;"></i>
            </button>

            <button class="btn-icon" onclick="seekStep(1)" title="å‰è¿›1æ­¥"><i class="fa-solid fa-chevron-right"></i></button>
            <button class="btn-icon" onclick="seekStep(10)" title="å‰è¿›10æ­¥"><i class="fa-solid fa-forward"></i></button>
        </div>

        <div class="control-group" style="margin-left: 10px;">
            <span style="color: var(--text-sub); font-size: 13px;">é€Ÿåº¦</span>
            <select class="select-dark" id="speedSelect" onchange="updateSpeed()">
                <option value="1000">0.5x</option>
                <option value="500">1x</option>
                <option value="200" selected>2x</option>
                <option value="100">5x</option>
                <option value="50">10x</option>
            </select>
        </div>

        <div class="timeline-wrapper" onclick="clickTimeline(event)">
            <div class="timeline-track">
                <div class="timeline-fill" id="progressBar">
                    <div class="timeline-thumb"></div>
                </div>
            </div>
            <div class="step-counter" id="stepCounter">0 / 0</div>
        </div>
    </div>

    <!-- 4. ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- å·¦ä¾§å›¾è¡¨ -->
        <div class="chart-panel">
            <div class="panel-header">
                <div class="panel-title">
                    ä»·æ ¼èµ°åŠ¿ & ç½‘æ ¼å±‚çº§ <span class="panel-badge" id="klineIndex">Kçº¿ #0</span>
                </div>
                <div class="legend-custom">
                    <div class="legend-item"><div class="dot" style="background: #7c3aed;"></div> ä»·æ ¼</div>
                    <div class="legend-item"><div class="dot" style="background: #10b981;"></div> è´¦æˆ·ä»·å€¼</div>
                    <div class="legend-item"><div class="dot" style="background: #ef4444;"></div> ç½‘æ ¼å±‚çº§</div>
                </div>
            </div>
            <div id="mainChart"></div>

            <!-- ç¼©æ”¾æ§åˆ¶å™¨ (ç±»ä¼¼åœ°å›¾) -->
            <div class="zoom-control">
                <button class="zoom-btn zoom-in" id="zoomIn" title="æ”¾å¤§">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <div class="zoom-slider-container">
                    <input type="range"
                           class="zoom-slider"
                           id="zoomSlider"
                           min="0"
                           max="5"
                           step="1"
                           value="3"
                           orient="vertical">
                    <div class="zoom-level-indicator" id="zoomLevelText">30å¤©</div>
                </div>
                <button class="zoom-btn zoom-out" id="zoomOut" title="ç¼©å°">
                    <i class="fa-solid fa-minus"></i>
                </button>
            </div>
        </div>

        <!-- å³ä¾§è¯¦æƒ… -->
        <div class="detail-panel">
            <!-- å ä½å›¾ (æ— æ•°æ®æ—¶æ˜¾ç¤º) -->
            <div id="emptyState" class="empty-state">
                <i class="fa-solid fa-layer-group empty-icon"></i>
                <div>
                    <div>ç‚¹å‡»å›¾è¡¨æˆ–ä½¿ç”¨æ—¶é—´è½´</div>
                    <div style="font-size: 12px; margin-top: 5px;">æŸ¥çœ‹è¯¦ç»†å¿«ç…§ä¿¡æ¯</div>
                </div>
            </div>

            <!-- æ•°æ®åˆ—è¡¨ -->
            <div id="dataContent" class="data-list" style="display: none;">
                <div style="color: var(--text-sub); font-size: 12px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">å½“å‰Kçº¿è¯¦æƒ…</div>
                <div class="data-item">
                    <div class="data-row">
                        <span class="lbl">æ—¶é—´</span>
                        <span class="val" id="detail-time">--</span>
                    </div>
                    <div class="data-row">
                        <span class="lbl">Kçº¿ç´¢å¼•</span>
                        <span class="val" id="detail-index">--</span>
                    </div>
                </div>

                <div style="color: var(--text-sub); font-size: 12px; margin: 15px 0 10px; text-transform: uppercase; letter-spacing: 1px;">ç½‘æ ¼å±‚çº§</div>
                <div class="data-item" style="border-left: 3px solid var(--accent-red);">
                    <div class="data-row">
                        <span class="lbl" style="color: var(--accent-red)">R2 å‹åŠ›ä½</span>
                        <span class="val" id="detail-r2">--</span>
                    </div>
                    <div class="data-row" style="margin-top: 5px;">
                        <span class="lbl" style="color: var(--accent-red); opacity: 0.7;">R1 å–å‡ºä½</span>
                        <span class="val" id="detail-r1">--</span>
                    </div>
                </div>
                <div class="data-item" style="border-left: 3px solid var(--accent-green);">
                    <div class="data-row">
                        <span class="lbl" style="color: var(--accent-green); opacity: 0.7;">S1 ä¹°å…¥ä½</span>
                        <span class="val" id="detail-s1">--</span>
                    </div>
                    <div class="data-row" style="margin-top: 5px;">
                        <span class="lbl" style="color: var(--accent-green)">S2 æ”¯æ’‘ä½</span>
                        <span class="val" id="detail-s2">--</span>
                    </div>
                </div>

                <div style="color: var(--text-sub); font-size: 12px; margin: 15px 0 10px; text-transform: uppercase; letter-spacing: 1px;">
                    æŒä»“ <span id="positionsCount"></span>
                </div>
                <div id="positionsList">
                    <!-- JS ç”Ÿæˆ -->
                </div>

                <div style="color: var(--text-sub); font-size: 12px; margin: 15px 0 10px; text-transform: uppercase; letter-spacing: 1px;">
                    äº‹ä»¶ <span id="eventsCount"></span>
                </div>
                <div id="eventsList">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let currentBacktestId = null;
        let snapshots = [];
        let events = [];
        let backtest = null;
        let currentIndex = 0;
        let isPlaying = false;
        let playTimer = null;
        let speed = 200;
        let myChart = null;
        const initialBalance = 10000;

        // ==================== åˆå§‹åŒ– ====================
        window.onload = async function() {
            await loadBacktestList();
            initZoomControl();  // åˆå§‹åŒ–ç¼©æ”¾æ§åˆ¶
        };

        window.onresize = function() {
            myChart && myChart.resize();
        };

        // ==================== ç¼©æ”¾æ§åˆ¶ ====================
        const ZOOM_LEVELS = [
            { value: 0, label: '1å¤©', days: 1 },
            { value: 1, label: '3å¤©', days: 3 },
            { value: 2, label: '7å¤©', days: 7 },
            { value: 3, label: '30å¤©', days: 30 },
            { value: 4, label: '90å¤©', days: 90 },
            { value: 5, label: 'å…¨éƒ¨', days: null }
        ];

        let currentZoomLevel = 3; // é»˜è®¤30å¤©

        function initZoomControl() {
            const slider = document.getElementById('zoomSlider');
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');

            // æ»‘å—å˜åŒ–äº‹ä»¶
            slider.addEventListener('input', function() {
                currentZoomLevel = parseInt(this.value);
                applyZoom(currentZoomLevel);
            });

            // + æŒ‰é’®ï¼ˆæ”¾å¤§ï¼‰
            zoomIn.addEventListener('click', function() {
                if (currentZoomLevel > 0) {
                    currentZoomLevel--;
                    slider.value = currentZoomLevel;
                    applyZoom(currentZoomLevel);
                }
            });

            // - æŒ‰é’®ï¼ˆç¼©å°ï¼‰
            zoomOut.addEventListener('click', function() {
                if (currentZoomLevel < ZOOM_LEVELS.length - 1) {
                    currentZoomLevel++;
                    slider.value = currentZoomLevel;
                    applyZoom(currentZoomLevel);
                }
            });
        }

        function applyZoom(zoomLevel) {
            if (!myChart || !snapshots || snapshots.length === 0) return;

            const level = ZOOM_LEVELS[zoomLevel];
            const levelText = document.getElementById('zoomLevelText');
            levelText.textContent = level.label;

            if (level.days === null) {
                // æ˜¾ç¤ºå…¨éƒ¨
                myChart.setOption({
                    dataZoom: [
                        { start: 0, end: 100 },
                        { start: 0, end: 100 }
                    ]
                });
            } else {
                // è®¡ç®—æ˜¾ç¤ºçš„Kçº¿æ•°é‡
                // 4å°æ—¶Kçº¿ï¼Œæ¯å¤©6æ ¹
                const klinesPerDay = 6;
                const targetKlines = level.days * klinesPerDay;

                // ä»¥å½“å‰ç´¢å¼•ä¸ºä¸­å¿ƒæ˜¾ç¤º
                const centerIndex = currentIndex;
                const halfRange = Math.floor(targetKlines / 2);

                let startIndex = Math.max(0, centerIndex - halfRange);
                let endIndex = Math.min(snapshots.length - 1, centerIndex + halfRange);

                // è°ƒæ•´è¾¹ç•Œä»¥ä¿æŒçª—å£å¤§å°
                if (startIndex === 0) {
                    endIndex = Math.min(snapshots.length - 1, targetKlines);
                } else if (endIndex === snapshots.length - 1) {
                    startIndex = Math.max(0, snapshots.length - targetKlines);
                }

                const startPercent = (startIndex / (snapshots.length - 1)) * 100;
                const endPercent = (endIndex / (snapshots.length - 1)) * 100;

                myChart.setOption({
                    dataZoom: [
                        { start: startPercent, end: endPercent },
                        { start: startPercent, end: endPercent }
                    ]
                });
            }
        }

        // ==================== APIè°ƒç”¨ ====================
        let allBacktests = []; // å­˜å‚¨æ‰€æœ‰å›æµ‹æ•°æ®ç”¨äºæœç´¢

        async function loadBacktestList(searchQuery = '') {
            showLoading(true);
            try {
                let url = '/backtest/api/backtests/';
                if (searchQuery) {
                    url += `?search=${encodeURIComponent(searchQuery)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    allBacktests = data.backtests;

                    if (data.backtests.length > 0) {
                        const selector = document.getElementById('backtestSelect');
                        selector.innerHTML = data.backtests.map(bt => {
                            // æ ¼å¼åŒ–æ—¥æœŸ
                            const startDate = bt.start_date ? new Date(bt.start_date).toLocaleDateString('zh-CN', {
                                month: '2-digit',
                                day: '2-digit'
                            }) : 'N/A';
                            const endDate = bt.end_date ? new Date(bt.end_date).toLocaleDateString('zh-CN', {
                                month: '2-digit',
                                day: '2-digit'
                            }) : 'N/A';

                            // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´
                            const createdDate = new Date(bt.created_at).toLocaleString('zh-CN', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const returnPct = (bt.total_return * 100).toFixed(2);
                            const sign = bt.total_return >= 0 ? '+' : '';

                            // å®Œæ•´æ˜¾ç¤ºæ ¼å¼
                            return `<option value="${bt.id}">
                                #${bt.id} | ${bt.symbol} ${bt.interval} |
                                ${startDate}-${endDate} (${bt.days}å¤©) |
                                ${sign}${returnPct}% |
                                ${bt.total_trades}ç¬” |
                                åˆ›å»ºäº ${createdDate}
                            </option>`;
                        }).join('');

                        // å¦‚æœä¹‹å‰æ²¡æœ‰é€‰æ‹©çš„å›æµ‹ï¼Œè‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ª
                        if (!currentBacktestId) {
                            await loadBacktest();
                        }
                    } else {
                        document.getElementById('backtestSelect').innerHTML = '<option value="">-- æ— åŒ¹é…ç»“æœ --</option>';
                        if (!searchQuery) {
                            alert('æš‚æ— å›æµ‹æ•°æ®');
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å›æµ‹åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å›æµ‹åˆ—è¡¨å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æœç´¢å¤„ç†å‡½æ•°
        let searchTimer = null;
        function handleSearch(event) {
            // é˜²æŠ–ï¼šç”¨æˆ·åœæ­¢è¾“å…¥300msåæ‰æ‰§è¡Œæœç´¢
            if (searchTimer) clearTimeout(searchTimer);

            searchTimer = setTimeout(() => {
                const query = event.target.value.trim();
                loadBacktestList(query);
            }, 300);
        }

        async function loadBacktest() {
            const backtestId = document.getElementById('backtestSelect').value;
            if (!backtestId) return;

            showLoading(true);
            currentBacktestId = backtestId;
            pause();

            try {
                // åŠ è½½å›æµ‹è¯¦æƒ…
                const detailResponse = await fetch(`/backtest/api/backtests/${backtestId}/`);
                const detailData = await detailResponse.json();

                // åŠ è½½å¿«ç…§æ•°æ®
                const snapshotsResponse = await fetch(`/backtest/api/backtests/${backtestId}/snapshots/`);
                const snapshotsData = await snapshotsResponse.json();

                if (detailData.success && snapshotsData.success) {
                    backtest = detailData.backtest;
                    snapshots = snapshotsData.klines;
                    events = snapshotsData.events;

                    // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
                    updateHeader();

                    // åˆå§‹åŒ–å›¾è¡¨
                    initChart();

                    // åŠ è½½ç¬¬ä¸€ä¸ªå¿«ç…§
                    renderFrame(0);

                    // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('dataContent').style.display = 'block';
                } else {
                    throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å›æµ‹æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½å›æµ‹æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function updateHeader() {
            document.getElementById('headerSymbol').textContent = backtest.symbol;
            document.getElementById('headerInterval').textContent = backtest.interval;

            const returnPct = (backtest.total_return * 100).toFixed(2);
            const sign = backtest.total_return >= 0 ? '+' : '';
            const returnTag = document.getElementById('headerReturn');
            returnTag.innerHTML = `æ”¶ç›Šç‡ <span style="color:#fff">${sign}${returnPct}%</span>`;
            returnTag.className = backtest.total_return >= 0 ? 'tag profit' : 'tag loss';
            if (backtest.total_return >= 0) {
                returnTag.innerHTML = `<i class="fa-solid fa-arrow-trend-up"></i> æ”¶ç›Šç‡ <span style="color:#fff">${sign}${returnPct}%</span>`;
            } else {
                returnTag.innerHTML = `<i class="fa-solid fa-arrow-trend-down"></i> æ”¶ç›Šç‡ <span style="color:#fff">${sign}${returnPct}%</span>`;
            }
        }

        // ==================== å›¾è¡¨åˆå§‹åŒ– ====================
        function initChart() {
            if (!myChart) {
                myChart = echarts.init(document.getElementById('mainChart'));
            }

            // å‡†å¤‡æ•°æ®
            const times = snapshots.map(s => new Date(s.time));
            const prices = snapshots.map(s => s.price);
            const values = snapshots.map(s => s.value);

            // æ ‡è®°ä¹°å…¥/å–å‡º/æ­¢æŸäº‹ä»¶
            // ğŸŸ¢ ç»¿è‰²ï¼šä¹°å…¥
            const buyMarks = events.filter(e => e.type === 'buy').map(e => ({
                coord: [new Date(e.time), e.price],
                value: 'ä¹°',
                symbol: 'triangle',  // ä¸‰è§’å½¢å‘ä¸Š
                symbolSize: 40,
                itemStyle: { color: '#10b981' },
                label: { color: '#10b981', fontSize: 12, fontWeight: 'bold', offset: [0, -15] }
            }));

            // ğŸŸ¡ é»„è‰²ï¼šéƒ¨åˆ†å–å‡º | ğŸ”´ çº¢è‰²ï¼šå…¨éƒ¨å–å‡º
            // TODO: éœ€è¦åç«¯æä¾›positionçŠ¶æ€ä¿¡æ¯æ¥åŒºåˆ†
            const sellMarks = events.filter(e => e.type === 'sell').map(e => ({
                coord: [new Date(e.time), e.price],
                value: 'å–',
                symbol: 'diamond',  // è±å½¢
                symbolSize: 38,
                itemStyle: { color: '#f59e0b' },  // é»„è‰²ï¼ˆéƒ¨åˆ†å–å‡ºï¼‰
                label: { color: '#f59e0b', fontSize: 12, fontWeight: 'bold', offset: [0, -15] }
            }));

            // ğŸ”µ è“è‰²ï¼šæ­¢æŸ
            const stopLossMarks = events.filter(e => e.type === 'stop_loss').map(e => ({
                coord: [new Date(e.time), e.price],
                value: 'æ­¢æŸ',
                symbol: 'rect',  // æ–¹å½¢
                symbolSize: 40,
                itemStyle: { color: '#3b82f6' },  // è“è‰²
                label: { color: '#3b82f6', fontSize: 12, fontWeight: 'bold', offset: [0, -15] }
            }));

            const option = {
                backgroundColor: 'transparent',
                grid: {
                    left: '3%',
                    right: '5%',
                    top: '5%',
                    bottom: '8%',
                    containLabel: true
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(21, 25, 37, 0.95)',
                    borderColor: '#2a2f42',
                    textStyle: { color: '#fff', fontSize: 12 },
                    axisPointer: {
                        type: 'cross',
                        label: { backgroundColor: '#7c3aed' },
                        crossStyle: { color: '#6b7280' }
                    },
                    formatter: function(params) {
                        let result = `<div style="font-size:12px;">${new Date(params[0].axisValue).toLocaleString()}</div>`;
                        params.forEach(p => {
                            // p.valueæ˜¯æ•°ç»„ [timestamp, value]ï¼Œå› ä¸ºxAxisæ˜¯timeç±»å‹
                            const actualValue = Array.isArray(p.value) ? p.value[1] : p.value;
                            const value = actualValue.toFixed(2);
                            result += `<div style="margin-top:5px;">${p.marker} ${p.seriesName}: <b>$${value}</b></div>`;
                        });
                        return result;
                    }
                },
                xAxis: {
                    type: 'time',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11,
                        formatter: function(value) {
                            const date = new Date(value);
                            return `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                        }
                    },
                    splitLine: { show: false }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100,
                        minValueSpan: 3600 * 1000 * 24 * 1, // æœ€å°æ˜¾ç¤º1å¤©ï¼ˆä¼˜åŒ–ç¼©æ”¾çµæ´»æ€§ï¼‰
                        zoomLock: false  // å…è®¸ç”¨æˆ·è‡ªç”±ç¼©æ”¾
                    },
                    {
                        type: 'slider',  // æ·»åŠ æ»‘å—æ§åˆ¶æ¡
                        start: 0,
                        end: 100,
                        minValueSpan: 3600 * 1000 * 24 * 1,
                        height: 20,
                        bottom: 10,
                        borderColor: '#2a2f42',
                        fillerColor: 'rgba(124, 58, 237, 0.2)',
                        handleStyle: {
                            color: '#7c3aed',
                            borderColor: '#7c3aed'
                        },
                        textStyle: {
                            color: '#6b7280',
                            fontSize: 10
                        },
                        dataBackground: {
                            lineStyle: { color: '#7c3aed', opacity: 0.5 },
                            areaStyle: { color: 'rgba(124, 58, 237, 0.1)' }
                        },
                        selectedDataBackground: {
                            lineStyle: { color: '#7c3aed' },
                            areaStyle: { color: 'rgba(124, 58, 237, 0.3)' }
                        }
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: 'ä»·æ ¼',
                        position: 'left',
                        scale: true,
                        splitLine: {
                            lineStyle: { color: '#2a2f42', type: 'dashed' }
                        },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 11,
                            formatter: v => '$' + v.toFixed(0)
                        },
                        axisLine: { show: false },
                        axisTick: { show: false }
                    },
                    {
                        type: 'value',
                        name: 'è´¦æˆ·',
                        position: 'right',
                        scale: true,
                        splitLine: { show: false },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 11,
                            formatter: v => '$' + v.toFixed(0)
                        },
                        axisLine: { show: false },
                        axisTick: { show: false }
                    }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: times.map((t, i) => [t, prices[i]]),
                        smooth: false,
                        lineStyle: { color: '#7c3aed', width: 2 },
                        itemStyle: { color: '#7c3aed' },
                        symbol: 'none',
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(124, 58, 237, 0.2)' },
                                { offset: 1, color: 'rgba(124, 58, 237, 0)' }
                            ])
                        },
                        markPoint: {
                            data: [...buyMarks, ...sellMarks, ...stopLossMarks],
                            symbolSize: 35,
                            label: { fontSize: 11, fontWeight: 'bold' }
                        },
                        markLine: {
                            symbol: ['none', 'none'],
                            label: { show: false },
                            lineStyle: {
                                color: '#fff',
                                width: 1,
                                type: 'solid',
                                opacity: 0.3
                            },
                            animation: false,
                            data: []
                        }
                    },
                    {
                        name: 'è´¦æˆ·ä»·å€¼',
                        type: 'line',
                        yAxisIndex: 1,
                        data: times.map((t, i) => [t, values[i]]),
                        smooth: false,
                        lineStyle: { color: '#10b981', width: 2 },
                        itemStyle: { color: '#10b981' },
                        symbol: 'none'
                    }
                ]
            };

            myChart.setOption(option);

            // ç‚¹å‡»å›¾è¡¨äº¤äº’ï¼ˆå¢å¼ºè§†è§‰åé¦ˆï¼‰
            myChart.getZr().on('click', params => {
                const pointInPixel = [params.offsetX, params.offsetY];
                if (myChart.containPixel('grid', pointInPixel)) {
                    // convertFromPixelè¿”å›çš„æ˜¯[timestamp, value]ï¼Œå› ä¸ºxAxisæ˜¯timeç±»å‹
                    const pointInGrid = myChart.convertFromPixel({ seriesIndex: 0 }, pointInPixel);
                    const clickedTimestamp = pointInGrid[0]; // è·å–æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

                    // åœ¨snapshotsä¸­æ‰¾åˆ°æœ€æ¥è¿‘è¯¥æ—¶é—´æˆ³çš„Kçº¿ç´¢å¼•
                    let targetIndex = 0;
                    let minDiff = Math.abs(new Date(snapshots[0].time).getTime() - clickedTimestamp);

                    for (let i = 1; i < snapshots.length; i++) {
                        const diff = Math.abs(new Date(snapshots[i].time).getTime() - clickedTimestamp);
                        if (diff < minDiff) {
                            minDiff = diff;
                            targetIndex = i;
                        }
                    }

                    // ğŸ¯ è§†è§‰åé¦ˆï¼šé«˜äº®ç‚¹å‡»çš„Kçº¿
                    const clickedSnapshot = snapshots[targetIndex];
                    myChart.setOption({
                        series: [{
                            markPoint: {
                                data: [
                                    ...buyMarks,
                                    ...sellMarks,
                                    ...stopLossMarks,
                                    // æ·»åŠ ä¸´æ—¶é«˜äº®ç‚¹
                                    {
                                        coord: [new Date(clickedSnapshot.time), clickedSnapshot.price],
                                        symbol: 'circle',
                                        symbolSize: 20,
                                        itemStyle: {
                                            color: 'rgba(124, 58, 237, 0.3)',
                                            borderColor: '#7c3aed',
                                            borderWidth: 2
                                        },
                                        animation: true,
                                        animationDuration: 300
                                    }
                                ],
                                symbolSize: 35,
                                label: { fontSize: 11, fontWeight: 'bold' }
                            }
                        }]
                    });

                    pause();
                    renderFrame(targetIndex);
                }
            });
        }

        // ==================== æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ====================
        async function renderFrame(index) {
            if (index < 0) index = 0;
            if (index >= snapshots.length) {
                index = snapshots.length - 1;
                pause();
            }
            currentIndex = index;
            const snapshot = snapshots[index];

            // 1. æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
            updateStats(snapshot);

            // 2. æ›´æ–°æ§åˆ¶æ¡
            const progress = (index / (snapshots.length - 1)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('stepCounter').textContent = `${index + 1} / ${snapshots.length}`;

            // æ›´æ–°Kçº¿ç´¢å¼•å’Œæ—¶é—´
            const klineTime = new Date(snapshot.time);
            const timeStr = `${klineTime.getMonth()+1}/${klineTime.getDate()} ${klineTime.getHours().toString().padStart(2, '0')}:${klineTime.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('klineIndex').textContent = `Kçº¿ #${index + 1} | ${timeStr}`;

            // 3. æ›´æ–°è¯¦æƒ…é¢æ¿
            await updateDetailPanel(index);

            // 4. æ›´æ–°å›¾è¡¨æ—¶é—´å…‰æ ‡ï¼ˆä¸å†å¼ºåˆ¶æ›´æ–°dataZoomï¼Œè®©ç”¨æˆ·è‡ªç”±æ‹–åŠ¨ï¼‰
            // ğŸ”§ ä¼˜åŒ–ï¼šç§»é™¤å¼ºåˆ¶æ›´æ–°dataZoomçš„é€»è¾‘ï¼Œè§£å†³æ‹–åŠ¨ä¸é¡ºæ»‘é—®é¢˜
            // ç”¨æˆ·ç°åœ¨å¯ä»¥è‡ªç”±æ‹–åŠ¨å’Œç¼©æ”¾å›¾è¡¨ï¼Œæ’­æ”¾å™¨åªæ›´æ–°æ—¶é—´å…‰æ ‡
            myChart.setOption({
                series: [
                    {
                        markLine: {
                            data: [{ xAxis: new Date(snapshot.time) }]
                        }
                    },
                    {} // ä¿æŒç¬¬äºŒä¸ªseriesä¸å˜
                ]
            }, {notMerge: false, lazyUpdate: true});  // ä½¿ç”¨lazyUpdateä¼˜åŒ–æ€§èƒ½
        }

        function updateStats(snapshot) {
            document.getElementById('val-price').textContent = `$${snapshot.price.toFixed(2)}`;
            document.getElementById('val-balance').textContent = `$${snapshot.value.toFixed(2)}`;
            document.getElementById('val-cash').textContent = `$${snapshot.cash.toFixed(2)}`;

            const pnl = snapshot.value - initialBalance;
            const pnlPct = (pnl / initialBalance) * 100;

            const pnlEl = document.getElementById('val-pnl');
            const pnlPctEl = document.getElementById('val-pnl-pct');

            pnlEl.textContent = (pnl >= 0 ? '+' : '') + `$${pnl.toFixed(2)}`;
            pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

            pnlPctEl.textContent = (pnlPct >= 0 ? '+' : '') + `${pnlPct.toFixed(2)}%`;
            pnlPctEl.style.color = pnlPct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }

        async function updateDetailPanel(index) {
            try {
                const response = await fetch(`/backtest/api/backtests/${currentBacktestId}/snapshots/${index}/`);
                const data = await response.json();

                if (data.success) {
                    const detail = data.snapshot;

                    // æ›´æ–°æ—¶é—´
                    document.getElementById('detail-time').textContent = new Date(detail.timestamp).toLocaleString();
                    document.getElementById('detail-index').textContent = `#${detail.index}`;

                    // æ›´æ–°ç½‘æ ¼å±‚çº§
                    if (detail.grid_levels) {
                        const g = detail.grid_levels;
                        document.getElementById('detail-r2').textContent = `$${g.resistance_2.price.toFixed(2)}`;
                        document.getElementById('detail-r1').textContent = `$${g.resistance_1.price.toFixed(2)}`;
                        document.getElementById('detail-s1').textContent = `$${g.support_1.price.toFixed(2)}`;
                        document.getElementById('detail-s2').textContent = `$${g.support_2.price.toFixed(2)}`;
                    }

                    // æ›´æ–°æŒä»“
                    const posContainer = document.getElementById('positionsList');
                    document.getElementById('positionsCount').textContent = detail.positions ? `(${detail.positions.length})` : '(0)';

                    if (detail.positions && detail.positions.length > 0) {
                        posContainer.innerHTML = detail.positions.map(p => {
                            const pnlColor = p.pnl >= 0 ? 'txt-green' : 'txt-red';
                            let statusBadge = '';
                            if (p.status === 'open') {
                                statusBadge = '<span style="color: var(--accent-green); font-size: 10px;">â— OPEN</span>';
                            } else if (p.status === 'partial') {
                                statusBadge = '<span style="color: var(--accent-yellow); font-size: 10px;">â— PARTIAL</span>';
                            } else {
                                statusBadge = '<span style="color: var(--text-sub); font-size: 10px;">â— CLOSED</span>';
                            }

                            // è®¡ç®—ç›ˆäºæ¯”ä¾‹
                            const pnlPct = (p.pnl / p.buy_cost) * 100;
                            const pnlPctStr = `${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%`;

                            return `
                                <div class="data-item" style="border-left: 3px solid ${p.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                    <div class="data-row">
                                        <span class="val">ä»“ä½ #${p.id} ${statusBadge}</span>
                                        <span class="val ${pnlColor}">${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(2)} (${pnlPctStr})</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">ä¹°å…¥å‡ä»·</span>
                                        <span class="val">$${p.avg_buy_price.toFixed(2)} (${p.buy_level})</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">æŒä»“æ•°é‡</span>
                                        <span class="val">${p.remaining.toFixed(6)} ETH</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">æŒä»“æ€»ä»·</span>
                                        <span class="val">$${p.current_value.toFixed(2)}</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">æ­¢æŸä»·</span>
                                        <span class="val txt-red">$${p.stop_loss_price.toFixed(2)}</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">R1ç›®æ ‡</span>
                                        <span class="val">$${p.r1_target.toFixed(2)} <span style="color: var(--text-sub);">(å·²å–${p.r1_sold_pct.toFixed(0)}%)</span></span>
                                    </div>
                                    <div class="data-row">
                                        <span class="lbl">R2ç›®æ ‡</span>
                                        <span class="val">$${p.r2_target.toFixed(2)} <span style="color: var(--text-sub);">(å·²å–${p.r2_sold_pct.toFixed(0)}%)</span></span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        posContainer.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:10px;">æ— æŒä»“</div>';
                    }

                    // æ›´æ–°äº‹ä»¶
                    const eventsContainer = document.getElementById('eventsList');
                    document.getElementById('eventsCount').textContent = detail.events ? `(${detail.events.length})` : '(0)';

                    if (detail.events && detail.events.length > 0) {
                        eventsContainer.innerHTML = detail.events.map(e => {
                            let icon = '';
                            let color = '';
                            let desc = '';

                            if (e.type === 'buy') {
                                icon = '<i class="fa-solid fa-arrow-up"></i>';
                                color = 'var(--accent-green)';
                                desc = `ä¹°å…¥ ä»“ä½#${e.position_id} ${e.level} $${e.price.toFixed(2)} æˆæœ¬$${e.cost.toFixed(2)}`;
                            } else if (e.type === 'sell') {
                                icon = '<i class="fa-solid fa-arrow-down"></i>';
                                color = 'var(--accent-yellow)';
                                desc = `å–å‡º ä»“ä½#${e.position_id} ${e.target} $${e.price.toFixed(2)} æ”¶å…¥$${e.revenue.toFixed(2)}`;
                            } else if (e.type === 'stop_loss') {
                                icon = '<i class="fa-solid fa-xmark"></i>';
                                color = 'var(--accent-red)';
                                desc = `æ­¢æŸ ${e.position_ids.length}ä¸ªä»“ä½ $${e.price.toFixed(2)} æ”¶å…¥$${e.total_revenue.toFixed(2)}`;
                            }

                            return `
                                <div class="data-item" style="border-left: 3px solid ${color};">
                                    <div class="data-row">
                                        <span style="color: ${color};">${icon} ${e.type.toUpperCase()}</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-sub); margin-top: 4px;">${desc}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        eventsContainer.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:10px;">æ— äº‹ä»¶</div>';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å¿«ç…§è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // ==================== æ’­æ”¾æ§åˆ¶ ====================
        function togglePlay() {
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }

        function play() {
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-pause"></i>';
            playTimer = setInterval(() => {
                if (currentIndex >= snapshots.length - 1) {
                    pause();
                } else {
                    renderFrame(currentIndex + 1);
                }
            }, speed);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-play" style="margin-left:2px;"></i>';
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
            }
        }

        function seekStep(step) {
            pause();
            renderFrame(currentIndex + step);
        }

        function updateSpeed() {
            speed = parseInt(document.getElementById('speedSelect').value);
            if (isPlaying) {
                pause();
                play();
            }
        }

        function clickTimeline(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            const targetIndex = Math.floor(pct * snapshots.length);
            pause();
            renderFrame(Math.max(0, Math.min(targetIndex, snapshots.length - 1)));
        }
    </script>
</body>
</html>
