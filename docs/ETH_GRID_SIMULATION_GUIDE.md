# ETH网格模拟测试指南

## 概述

本指南介绍如何使用GRVT实时行情数据进行ETH网格交易的**本地模拟测试**。

**重要**: 此模式**不会执行真实交易**，仅用于测试网格逻辑的正确性。

## 工作原理

```
GRVT WebSocket (实时行情)
         ↓
   价格数据流
         ↓
  本地模拟订单引擎
         ↓
   检查订单成交
         ↓
   更新网格状态
```

- ✅ 接入GRVT真实行情数据
- ✅ 在本地模拟订单匹配
- ✅ 测试网格逻辑正确性
- ❌ **不执行真实下单**
- ❌ **不消耗真实资金**

## 快速开始

### 第一步：环境变量

**只需要API KEY，不需要私钥**：

```bash
export GRVT_API_KEY=your_api_key
export GRVT_ENV=testnet  # optional
```

**注意**: 模拟模式只需要读取行情，所以：
- ✅ 需要: `GRVT_API_KEY`
- ❌ 不需要: `GRVT_PRIVATE_KEY`
- ❌ 不需要: `GRVT_TRADING_ACCOUNT_ID`

### 第二步：创建网格配置

```bash
python scripts/setup_eth_grid.py
```

输出示例：
```
============================================================
创建ETH网格交易配置
============================================================

✓ 配置创建成功!
  ID: 1
  名称: ETH_SHORT_GRID_TEST
  交易对: ETHUSDT
  网格模式: SHORT
  价格区间: 3000 - 3300
  网格层数: 20
  网格间距: 1.5789%
```

### 第三步：运行模拟测试

```bash
python scripts/test_eth_grid_simulation.py
```

## 运行示例

### 初始化阶段

```
============================================================
ETH网格模拟测试
============================================================
✓ GRVT_API_KEY: your_api_k...
✓ GRVT_ENV: testnet

✓ 找到配置: ETH_SHORT_GRID_TEST
  - 交易对: ETHUSDT
  - 价格区间: 3000 - 3300
  - 网格层数: 20
  - 网格模式: SHORT

============================================================
初始化模拟网格交易器
============================================================

1. 初始化GRVT市场数据订阅...
✓ 市场数据订阅器初始化完成

2. 加载网格层级...
✓ 加载了 20 个网格层级

3. 订阅 ETHUSDT 实时行情...
✓ 成功订阅 ETHUSDT Ticker数据

等待首次价格数据...
✓ 接收到首次价格: 3150.50
```

### 运行阶段

```
============================================================
开始模拟网格交易
============================================================

按Ctrl+C停止

放置初始网格订单...
当前价格: 3150.50
✓ 创建了 20 个初始订单

------------------------------------------------------------
[10:30:15] 网格状态
------------------------------------------------------------
当前价格: 3152.30
挂单数量: 18
总成交次数: 2
  - 开仓: 1
  - 平仓: 1
累计盈亏: 15.7894 USDT
------------------------------------------------------------

✓ [开仓成交] 层级5: SELL 0.01 @ 3155.20

✓ [平仓成交] 层级5: BUY 0.01 @ 3145.50, PnL=0.9700 USDT
```

### 停止后统计

```
收到停止信号...

清理资源...

============================================================
最终统计
============================================================
总成交次数: 15
开仓成交: 8
平仓成交: 7
累计盈亏: 47.3250 USDT
============================================================
✓ 清理完成
```

## 模拟逻辑说明

### 1. 订单创建

```python
# 创建开仓订单（挂在网格价位）
order = {
    "order_id": "sim_grid_5_entry",
    "side": "SELL",  # 做空模式
    "price": 3150.00,
    "quantity": 0.01,
    "status": "PENDING"
}
```

### 2. 成交判断

```python
# 每次价格更新时检查
if order["side"] == "SELL":
    # 卖单: 当前价 >= 订单价 → 成交
    if current_price >= order["price"]:
        fill_order(order)

elif order["side"] == "BUY":
    # 买单: 当前价 <= 订单价 → 成交
    if current_price <= order["price"]:
        fill_order(order)
```

### 3. 网格循环

```
1. 初始状态: 所有层级IDLE
2. 创建开仓订单: ENTRY_WORKING
3. 开仓成交: POSITION_OPEN
4. 创建平仓订单: EXIT_WORKING
5. 平仓成交: 回到IDLE
6. 重新创建开仓订单 (循环)
```

## 测试场景

### 场景1: 震荡行情

价格在3000-3300区间内震荡，网格不断成交：

```
价格: 3100 → 3150 → 3200 → 3150 → 3100
        ↓      ↓      ↓      ↓      ↓
      开仓   平仓   开仓   平仓   开仓

累计盈亏: 每次震荡赚取网格间距
```

### 场景2: 单边上涨

价格持续上涨，逐渐开仓：

```
价格: 3100 → 3150 → 3200 → 3250 → 3300
              ↓      ↓      ↓      ↓
            开仓   开仓   开仓   开仓

持仓: 不断增加（最多到max_position_size）
```

### 场景3: 单边下跌

价格持续下跌，逐渐平仓：

```
价格: 3300 → 3250 → 3200 → 3150 → 3100
              ↓      ↓      ↓      ↓
            平仓   平仓   平仓   平仓

盈亏: 做空获利
```

## 查看模拟结果

### 1. 实时监控

运行中会每30秒显示一次状态：
- 当前价格
- 挂单数量
- 成交统计
- 累计盈亏

### 2. 数据库查看

```bash
# 查看交易日志
python manage.py shell -c "
from grid_trading.models import TradeLog, GridConfig
config = GridConfig.objects.get(name='ETH_SHORT_GRID_TEST')
logs = TradeLog.objects.filter(config=config, log_type='fill').order_by('-timestamp')[:10]
for log in logs:
    print(f'[{log.log_type}] {log.detail}')
"
```

### 3. Web后台

启动Django服务器：
```bash
python manage.py runserver
```

访问: http://localhost:8000/grid-trading/grids/

可以看到：
- 网格层级状态
- 成交历史
- 盈亏统计

## 网格参数调整

### 修改配置

编辑 `scripts/setup_eth_grid.py`:

```python
config = GridConfig.objects.create(
    # 调整价格区间
    upper_price=Decimal("3500"),  # 改为3500
    lower_price=Decimal("2500"),  # 改为2500

    # 调整网格层数
    grid_levels=30,  # 改为30层

    # 调整单笔数量
    trade_amount=Decimal("0.02"),  # 改为0.02 ETH
)
```

重新运行配置脚本。

### 不同的网格模式

**做多网格(LONG)**:
```python
grid_mode="LONG",
# 下方买入开仓，上方卖出平仓
# 适合震荡上涨行情
```

**中性网格(NEUTRAL)**:
```python
grid_mode="NEUTRAL",
# 下方买入，上方卖出
# 适合双向震荡
```

## 与真实交易的区别

| 特性 | 模拟模式 | 真实交易 |
|------|---------|---------|
| 行情数据 | ✅ GRVT实时 | ✅ GRVT实时 |
| 订单执行 | ❌ 本地模拟 | ✅ 交易所 |
| 成交判断 | 简化（价格触达） | 真实撮合 |
| 滑点 | ❌ 无 | ✅ 有 |
| 手续费 | ❌ 未计算 | ✅ 扣除 |
| 资金消耗 | ❌ 无 | ✅ 有 |
| 测试目的 | ✅ 逻辑验证 | ❌ 不适合 |

## 常见问题

### Q: 无法连接GRVT?

**A**: 检查：
1. `GRVT_API_KEY` 是否正确
2. 网络连接是否正常
3. GRVT服务是否可用

### Q: 价格一直不更新?

**A**: 可能原因：
1. WebSocket连接断开
2. Symbol不正确
3. 查看日志获取详细错误

### Q: 为什么没有成交?

**A**: 检查：
1. 当前价格是否在网格范围内
2. 网格密度是否合理
3. 查看挂单价格是否合理

### Q: 盈亏计算对吗?

**A**: 模拟模式的盈亏计算：
- 做空: `(开仓价 - 平仓价) × 数量`
- 做多: `(平仓价 - 开仓价) × 数量`
- **未扣除手续费**
- **未考虑滑点**

真实交易时实际盈亏会更少。

## 下一步

模拟测试通过后，可以：

1. ✅ 确认网格逻辑正确
2. ✅ 调整网格参数
3. ✅ 验证不同行情表现
4. ⏳ 准备真实交易环境
5. ⏳ 小金额实盘测试

## 参考文档

- `docs/GRVT_GRID_TRADING_GUIDE.md` - 完整交易指南
- `docs/ADAPTER_INTEGRATION_COMPLETE.md` - 适配器集成
- GRVT API文档: https://api-docs.grvt.io/

---

**最后更新**: 2025-12-05
**模式**: 模拟测试（不涉及真实交易）
