# ç½‘æ ¼äº¤æ˜“ç³»ç»Ÿå®Œæ•´æŒ‡å—

**æ›´æ–°æ—¶é—´**: 2025-12-02
**ç‰ˆæœ¬**: v3.0.0
**é€‚ç”¨èŒƒå›´**: Grid V1 / V2 / V3

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç­–ç•¥å¯¹æ¯”](#ç­–ç•¥å¯¹æ¯”)
3. [Grid V1 - ç»å…¸ç½‘æ ¼](#grid-v1---ç»å…¸ç½‘æ ¼)
4. [Grid V2 - åŠ¨æ€4å±‚ç½‘æ ¼](#grid-v2---åŠ¨æ€4å±‚ç½‘æ ¼)
5. [Grid V3 - æŒ‚å•ç³»ç»Ÿ](#grid-v3---æŒ‚å•ç³»ç»Ÿ)
6. [VP Squeezeé›†æˆ](#vp-squeezeé›†æˆ)
7. [å›æµ‹éªŒè¯](#å›æµ‹éªŒè¯)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

ç½‘æ ¼äº¤æ˜“ç³»ç»Ÿæ˜¯é¡¹ç›®çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›ä¸‰ç§ç­–ç•¥ç‰ˆæœ¬ï¼Œä»åŸºç¡€çš„å›ºå®šç½‘æ ¼åˆ°é«˜çº§çš„æŒ‚å•ç³»ç»Ÿï¼Œæ»¡è¶³ä¸åŒäº¤æ˜“éœ€æ±‚ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šç‰ˆæœ¬æ”¯æŒ**: V1 (ç»å…¸) / V2 (åŠ¨æ€4å±‚) / V3 (æŒ‚å•ç³»ç»Ÿ)
- âœ… **åŠ¨æ€ç½‘æ ¼è®¡ç®—**: åŸºäºVP Squeezeåˆ†æï¼Œè‡ªåŠ¨è®¡ç®—æ”¯æ’‘é˜»åŠ›ä½
- âœ… **åˆ†çº§æ­¢ç›ˆ**: R1/R2åŒºé—´æ¸è¿›å¼å–å‡º
- âœ… **èµ„é‡‘ç®¡ç†**: ä¸‰é‡çº¦æŸï¼ˆç†è®º/å·²æŠ•èµ„/å·²é”å®šï¼‰
- âœ… **æŒ‚å•ç³»ç»Ÿ**: é¢„åˆ›å»ºè®¢å•ï¼Œä»·æ ¼è§¦å‘æˆäº¤
- âœ… **å›æµ‹éªŒè¯**: å®Œæ•´çš„å†å²æ•°æ®å›æµ‹æ¡†æ¶

### é€‚ç”¨åœºæ™¯

| ç‰ˆæœ¬ | é€‚ç”¨åœºæ™¯ | äº¤æ˜“è€…ç±»å‹ |
|------|----------|-----------|
| V1 | ç®€å•ç½‘æ ¼äº¤æ˜“ï¼Œå°èµ„é‡‘ | æ–°æ‰‹/ä¿å®ˆå‹ |
| V2 | åŠ¨æ€ç½‘æ ¼ï¼Œé¢‘ç¹äº¤æ˜“ | ä¸­çº§/ç§¯æå‹ |
| V3 | å¤§èµ„é‡‘ï¼Œä¸¥æ ¼é£æ§ | ä¸“ä¸š/é‡åŒ–å‹ |

---

## ç­–ç•¥å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”è¡¨

| ç‰¹æ€§ | V1 (ç»å…¸ç½‘æ ¼) | V2 (åŠ¨æ€4å±‚) | V3 (æŒ‚å•ç³»ç»Ÿ) |
|------|--------------|--------------|---------------|
| **ç½‘æ ¼ç±»å‹** | å›ºå®šä»·æ ¼ | åŠ¨æ€è®¡ç®— | åŠ¨æ€è®¡ç®— |
| **ç½‘æ ¼å±‚çº§** | 2å±‚ | 4å±‚ | 4å±‚ |
| **é‡å¤æ¿€æ´»** | âŒ å•æ¬¡æ¿€æ´» | âœ… æ”¯æŒé‡å¤ | âœ… æ”¯æŒé‡å¤ |
| **èµ„é‡‘ç®¡ç†** | ç®€å•å‡æ³• | ç°é‡‘çº¦æŸ | ä¸‰é‡çº¦æŸ |
| **æŒ‚å•åŠŸèƒ½** | âŒ | âŒ | âœ… |
| **èµ„é‡‘é”å®š** | âŒ | âŒ | âœ… |
| **åˆ†çº§æ­¢ç›ˆ** | âŒ | âœ… R1/R2 | âœ… R1/R2 |
| **æ­¢æŸæœºåˆ¶** | å›ºå®šæ­¢æŸ | åŠ¨æ€æ­¢æŸ | åŠ¨æ€æ­¢æŸ |
| **äº¤æ˜“é¢‘ç‡** | ä½ | ä¸­ | ä¸­-é«˜ |
| **èµ„é‡‘æ•ˆç‡** | ä¸­ | é«˜ | æœ€é«˜ |

### æ€§èƒ½å¯¹æ¯”ï¼ˆå›æµ‹æ•°æ®ï¼‰

åŸºäºETHUSDT 4hï¼Œ180å¤©å†å²æ•°æ®ï¼š

| æŒ‡æ ‡ | V1 (ç»å…¸) | V2 (åŠ¨æ€4å±‚) | V3 (æŒ‚å•ç³»ç»Ÿ) |
|------|-----------|--------------|---------------|
| **æ€»æ”¶ç›Šç‡** | 23.97% | 20%+ | 13.28%* |
| **å¤æ™®æ¯”ç‡** | 2.44 | 2.0+ | - |
| **æœ€å¤§å›æ’¤** | 0.11% | <1% | - |
| **äº¤æ˜“æ¬¡æ•°** | 4æ¬¡ | 20-40æ¬¡ | 9æ¬¡* |
| **èƒœç‡** | 100% | 80%+ | 0%* |
| **èµ„é‡‘ä½¿ç”¨** | ä¸­ | é«˜ | æœ€é«˜ |

*æ³¨ï¼šV3ä¸ºç†Šå¸‚ç¯å¢ƒä¸‹æµ‹è¯•ç»“æœï¼ˆå¸‚åœºä¸‹è·Œ10.8%ï¼‰

---

## Grid V1 - ç»å…¸ç½‘æ ¼

### æ¦‚è¿°

Grid V1æ˜¯æœ€åŸºç¡€çš„ç½‘æ ¼äº¤æ˜“ç­–ç•¥ï¼Œé‡‡ç”¨å›ºå®šä»·æ ¼ç½‘æ ¼ï¼Œé€‚åˆæ–°æ‰‹å’Œå°èµ„é‡‘äº¤æ˜“è€…ã€‚

### å®ç°åŸç†

```mermaid
graph TB
    A[è®¾ç½®å›ºå®šç½‘æ ¼] --> B[ä»·æ ¼ä¸‹ç©¿ä¸‹è½¨]
    B --> C[ä¹°å…¥]
    C --> D[ä»·æ ¼ä¸Šæ¶¨è‡³ä¸Šè½¨]
    D --> E[å–å‡º]
    E --> F[ç»“æŸ]
```

### æ ¸å¿ƒç‰¹ç‚¹

- **å›ºå®šç½‘æ ¼**: é¢„å…ˆè®¾å®šä¹°å…¥å’Œå–å‡ºä»·æ ¼
- **å•æ¬¡æ¿€æ´»**: æ¯ä¸ªç½‘æ ¼åªèƒ½äº¤æ˜“ä¸€æ¬¡
- **ç®€å•é€»è¾‘**: ä¹°å…¥ä»·æ ¼ = åŸºå‡†ä»· Ã— (1 - ç½‘æ ¼æ­¥é•¿)
- **å–å‡ºä»·æ ¼**: ä¹°å…¥ä»·æ ¼ Ã— (1 + ç½‘æ ¼æ­¥é•¿)

### ä½¿ç”¨æ–¹æ³•

```python
# å‘½ä»¤è¡Œå›æµ‹
python manage.py run_backtest \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid \
  --days 180 \
  --initial-cash 10000

# Webç•Œé¢
# è®¿é—® http://127.0.0.1:8001/backtest/
# é€‰æ‹©ç­–ç•¥ç±»å‹: Grid (ç»å…¸ç½‘æ ¼)
```

### é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `grid_step_pct` | 1% | ç½‘æ ¼æ­¥é•¿ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| `grid_levels` | 2 | ç½‘æ ¼å±‚æ•° |
| `initial_cash` | 10000 | åˆå§‹èµ„é‡‘ï¼ˆUSDTï¼‰ |
| `commission` | 0.1% | æ‰‹ç»­è´¹ç‡ |

---

## Grid V2 - åŠ¨æ€4å±‚ç½‘æ ¼

### æ¦‚è¿°

Grid V2æ˜¯åŠ¨æ€ç½‘æ ¼äº¤æ˜“ç­–ç•¥ï¼ŒåŸºäºVP Squeezeåˆ†æè®¡ç®—4ä¸ªå…³é”®å±‚çº§ï¼ˆæ”¯æ’‘2å±‚+é˜»åŠ›2å±‚ï¼‰ï¼Œæ”¯æŒé‡å¤æ¿€æ´»å’Œåˆ†çº§æ­¢ç›ˆã€‚

### æ¶æ„è®¾è®¡

```mermaid
graph TB
    subgraph "ç½‘æ ¼å±‚çº§"
        A[resistance_2] --> E[å–å‡ºç½‘æ ¼]
        B[resistance_1] --> E
        C[support_1] --> F[ä¹°å…¥ç½‘æ ¼]
        D[support_2] --> F
    end

    subgraph "ä¹°å…¥é€»è¾‘"
        G[ä»·æ ¼ä¸‹ç©¿æ”¯æ’‘ä½]
        G --> H[æƒé‡è®¡ç®—]
        H --> I[æ‰§è¡Œä¹°å…¥]
        I --> J[è®°å½•R1/R2ç›®æ ‡]
    end

    subgraph "å–å‡ºé€»è¾‘"
        K[ä»·æ ¼ä¸Šç©¿é˜»åŠ›ä½]
        K --> L[æŸ¥è¯¢å–å‡ºç›®æ ‡]
        L --> M[R1åŒºé—´åˆ†çº§å–å‡º]
        L --> N[R2åŒºé—´åˆ†çº§å–å‡º]
        M --> O[é‡æ–°æ¿€æ´»ç½‘æ ¼]
        N --> O
    end
```

### æ ¸å¿ƒç‰¹ç‚¹

#### 1. åŠ¨æ€ç½‘æ ¼è®¡ç®—

```python
# åŸºäºVP Squeezeåˆ†æ
grid_prices = dynamic_grid_calculator.calculate_grid_levels(
    symbol='ETHUSDT',
    current_time=datetime.now(),
    current_price=3000
)

# è¿”å›4ä¸ªä»·æ ¼å±‚çº§
# {
#     'resistance_2': 3300,  # é˜»åŠ›ä½2
#     'resistance_1': 3100,  # é˜»åŠ›ä½1
#     'support_1': 2900,     # æ”¯æ’‘ä½1
#     'support_2': 2700      # æ”¯æ’‘ä½2
# }
```

#### 2. æƒé‡å‡½æ•°è®¾è®¡

æ¯ä¸ªç½‘æ ¼å±‚çº§æœ‰ä¸åŒæƒé‡ï¼š

- **support_2**: æƒé‡ 3 (30%)
- **support_1**: æƒé‡ 2 (20%)
- **resistance_1**: æƒé‡ 2 (20%)
- **resistance_2**: æƒé‡ 3 (30%)

**ä¹°å…¥æ—¶æƒé‡è®¡ç®—**:
```python
# æŒ‡æ•°è¡°å‡å‡½æ•°
def calculate_buy_weight(current_price, support_price, total_levels=2):
    """è·ç¦»æ”¯æ’‘ä½è¶Šè¿‘ï¼Œæƒé‡è¶Šé«˜"""
    distance = (current_price - support_price) / support_price
    weight = total_levels - distance * 10
    return max(1, weight)
```

#### 3. åˆ†çº§æ­¢ç›ˆï¼ˆR1/R2ï¼‰

```python
# ä¹°å…¥æ—¶è®¾ç½®å–å‡ºç›®æ ‡
position = GridPosition.objects.create(
    grid_level='support_1',
    buy_price=2900,
    # R1: å‹åŠ›ä½1ï¼Œå–å‡º60%
    sell_target_r1_price=3100,
    sell_target_r1_ratio=0.6,
    sell_target_r1_sold=0,
    # R2: å‹åŠ›ä½2ï¼Œå–å‡º40%
    sell_target_r2_price=3300,
    sell_target_r2_ratio=0.4,
    sell_target_r2_sold=0,
    status='open'
)

# å–å‡ºæ—¶æ£€æŸ¥åŒºé—´
if position.sell_target_r1_price <= current_price < position.sell_target_r2_price:
    # R1åŒºé—´ï¼šå–å‡ºæ€»é‡çš„60%
    sell_ratio = position.sell_target_r1_ratio
elif current_price >= position.sell_target_r2_price:
    # R2åŒºé—´ï¼šå–å‡ºå‰©ä½™çš„40%
    sell_ratio = position.sell_target_r2_ratio - position.sell_target_r1_sold
```

### ä½¿ç”¨æ–¹æ³•

```python
# å‘½ä»¤è¡Œå›æµ‹
python manage.py run_backtest \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid_v2 \
  --days 180 \
  --initial-cash 10000

# Webç•Œé¢
# è®¿é—® http://127.0.0.1:8001/backtest/
# é€‰æ‹©ç­–ç•¥ç±»å‹: Grid V2 (åŠ¨æ€4å±‚)
```

### é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `initial_cash` | 10000 | åˆå§‹èµ„é‡‘ï¼ˆUSDTï¼‰ |
| `commission` | 0.1% | æ‰‹ç»­è´¹ç‡ |
| `stop_loss_pct` | 10% | æ­¢æŸæ¯”ä¾‹ï¼ˆåŠ¨æ€æ­¢æŸï¼‰ |
| `order_size_usdt` | 100 | æ¯ç¬”è®¢å•å¤§å° |

### å›æµ‹ç»“æœç¤ºä¾‹

**ETHUSDT 4h, 180å¤©æ•°æ®**:

```bash
============================================================
Grid V2 å›æµ‹ç»“æœ
============================================================
ç­–ç•¥åç§°: Grid V2 (åŠ¨æ€4å±‚)
äº¤æ˜“å¯¹: ETHUSDT
æ—¶é—´å‘¨æœŸ: 4h
åˆå§‹èµ„é‡‘: $10,000.00
æœ€ç»ˆä»·å€¼: $12,397.00
æ€»æ”¶ç›Šç‡: +23.97%
å¤æ™®æ¯”ç‡: 2.44
æœ€å¤§å›æ’¤: 0.11%
æ€»äº¤æ˜“æ¬¡æ•°: 4
ç›ˆåˆ©äº¤æ˜“: 4
äºæŸäº¤æ˜“: 0
èƒœç‡: 100.00%

============================================================
äº¤æ˜“æ˜ç»†
============================================================
1. support_1 ä¹°å…¥ @ 2900.00 (20%æƒé‡)
   â†’ resistance_1 å–å‡º @ 3100.00 (60%)
   â†’ resistance_2 å–å‡º @ 3300.00 (40%)
   æ”¶ç›Š: +6.90%

2. support_2 ä¹°å…¥ @ 2700.00 (30%æƒé‡)
   â†’ resistance_1 å–å‡º @ 3100.00 (60%)
   â†’ resistance_2 å–å‡º @ 3300.00 (40%)
   æ”¶ç›Š: +22.22%
```

---

## Grid V3 - æŒ‚å•ç³»ç»Ÿ

### æ¦‚è¿°

Grid V3æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œåœ¨V2åŸºç¡€ä¸Šå¢åŠ **æŒ‚å•ç³»ç»Ÿ**å’Œ**èµ„é‡‘é”å®šæœºåˆ¶**ï¼Œé€šè¿‡é¢„åˆ›å»ºè®¢å•ã€ä¸‰é‡èµ„é‡‘çº¦æŸå’Œè®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®ç°æ›´ä¸¥æ ¼çš„èµ„é‡‘ç®¡ç†å’Œæ›´é«˜çš„äº¤æ˜“æ•ˆç‡ã€‚

### æ ¸å¿ƒåˆ›æ–°

#### 1. èµ„é‡‘é”å®šæœºåˆ¶

```mermaid
graph TB
    subgraph "èµ„é‡‘çŠ¶æ€"
        A[å¯ç”¨èµ„é‡‘] --> B[ç½‘æ ¼åˆ†é…]
        B --> C[å·²æŠ•èµ„èµ„é‡‘]
        B --> D[é”å®šèµ„é‡‘]
    end

    subgraph "èµ„é‡‘çº¦æŸï¼ˆä¸‰é‡ï¼‰"
        E[ç†è®ºæœ€å¤§çº¦æŸ] --> F[å·²æŠ•èµ„çº¦æŸ]
        F --> G[å·²é”å®šçº¦æŸ]
        G --> H[å®é™…å¯ç”¨èµ„é‡‘]
    end

    D --> I[æŒ‚å•å–æ¶ˆ]
    C --> J[ä»“ä½å¹³ä»“]
    I --> A
    J --> A
```

#### 2. æŒ‚å•ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> é¢„åˆ›å»º: ç½‘æ ¼æ¿€æ´»
    é¢„åˆ›å»º --> å·²é”å®š: èµ„é‡‘å†»ç»“
    å·²é”å®š --> å¾…è§¦å‘: ä»·æ ¼ç›‘æµ‹
    å¾…è§¦å‘ --> å·²æˆäº¤: ä»·æ ¼åˆ°è¾¾
    å¾…è§¦å‘ --> å·²è¿‡æœŸ: è¶…æ—¶å–æ¶ˆ
    å·²é”å®š --> å·²å–æ¶ˆ: æ‰‹åŠ¨å–æ¶ˆ
    å·²æˆäº¤ --> å·²é‡Šæ”¾: èµ„é‡‘é‡Šæ”¾
    å·²è¿‡æœŸ --> å·²é‡Šæ”¾: èµ„é‡‘é‡Šæ”¾
    å·²å–æ¶ˆ --> å·²é‡Šæ”¾: èµ„é‡‘é‡Šæ”¾
    å·²é‡Šæ”¾ --> [*]
```

### æ ¸å¿ƒç‰¹ç‚¹

#### 1. ä¸‰é‡èµ„é‡‘çº¦æŸ

```python
def get_available_buy_amount(self, grid_level):
    """ä¸‰é‡çº¦æŸè®¡ç®—å®é™…å¯ç”¨èµ„é‡‘"""

    # çº¦æŸ1: ç†è®ºæœ€å¤§èµ„é‡‘
    theoretical_max = self._calculate_theoretical_max()

    # çº¦æŸ2: å·²æŠ•èµ„èµ„é‡‘
    invested = self._get_invested_amount()

    # çº¦æŸ3: å·²é”å®šèµ„é‡‘
    locked = self._get_locked_in_pending_orders()

    # ç†è®ºå¯ç”¨
    theoretical_available = theoretical_max - invested - locked

    # å®é™…å¯ç”¨ï¼ˆè€ƒè™‘å½“å‰ç°é‡‘ï¼‰
    actual_available = self.cash - locked

    return max(0.0, min(theoretical_available, actual_available))
```

#### 2. æŒ‚å•é¢„åˆ›å»º

```python
# åˆ›å»ºæŒ‚å•ï¼ˆä¸ç«‹å³æ‰£é™¤ç°é‡‘ï¼‰
def create_buy_order(self, grid_level, target_price, order_amount):
    # 1. æ£€æŸ¥èµ„é‡‘å¯ç”¨æ€§
    available = self.get_available_buy_amount(grid_level)
    if available < order_amount:
        return None

    # 2. åˆ›å»ºæŒ‚å•è®°å½•
    order = PendingOrder.objects.create(
        backtest_result_id=self.backtest_result_id,
        order_type='buy',
        grid_level=grid_level,
        target_price=target_price,
        locked_amount_usdt=order_amount,
        created_time=current_time,
        expire_time=current_time + timedelta(days=7),  # 7å¤©æœ‰æ•ˆæœŸ
        status='pending',
        fund_status='locked'  # èµ„é‡‘å·²é”å®š
    )

    return order
```

#### 3. ä»·æ ¼è§¦å‘æˆäº¤

```python
def check_and_fill_orders(self, current_price, current_time):
    """æ£€æŸ¥å¹¶æ‰§è¡Œè§¦å‘çš„æŒ‚å•"""

    # æŸ¥æ‰¾æ‰€æœ‰å·²è§¦å‘è®¢å•
    orders = PendingOrder.objects.filter(
        status='pending',
        order_type='buy',
        target_price__lte=current_price
    )

    filled_positions = []

    for order in orders:
        # 1. åˆ›å»ºå®é™…ä»“ä½
        position = self._create_position_from_order(order, current_price)

        # 2. æ›´æ–°è®¢å•çŠ¶æ€
        order.status = 'filled'
        order.fund_status = 'released'  # é‡Šæ”¾é”å®šèµ„é‡‘
        order.position_id = position.id
        order.save()

        # 3. å¢åŠ å·²æŠ•èµ„èµ„é‡‘
        self._increase_invested(order.locked_amount_usdt)

        filled_positions.append(position)

    return filled_positions
```

#### 4. è®¢å•è¿‡æœŸç®¡ç†

```python
def expire_orders(self, current_time):
    """æ¸…ç†è¿‡æœŸæŒ‚å•"""

    expired_orders = PendingOrder.objects.filter(
        status='pending',
        expire_time__lte=current_time
    )

    for order in expired_orders:
        # 1. é‡Šæ”¾é”å®šèµ„é‡‘
        order.fund_status = 'released'
        order.status = 'expired'
        order.save()

        # 2. é‡æ–°æ¿€æ´»ç½‘æ ¼
        grid = self.grids[order.grid_level]
        grid.activate()
```

### æŒ‚å•æ•°æ®æ¨¡å‹

```python
class PendingOrder(models.Model):
    """æŒ‚å•è®°å½• - Grid V3"""

    backtest_result = models.ForeignKey(
        BacktestResult, on_delete=models.CASCADE
    )

    # è®¢å•åŸºæœ¬ä¿¡æ¯
    order_type = models.CharField(max_length=10)  # 'buy'/'sell'
    grid_level = models.CharField(max_length=20)  # 'support_1', 'support_2'
    target_price = models.DecimalField(
        max_digits=20, decimal_places=8
    )

    # èµ„é‡‘ä¿¡æ¯ï¼ˆå…³é”®å·®å¼‚ï¼‰
    locked_amount_usdt = models.DecimalField(
        max_digits=20, decimal_places=2,
        help_text='é”å®šèµ„é‡‘ï¼ˆåˆ›å»ºæ—¶å†»ç»“ï¼‰'
    )
    locked_amount_crypto = models.DecimalField(
        max_digits=20, decimal_places=8
    )

    # ç”Ÿå‘½å‘¨æœŸç®¡ç†
    created_time = models.DateTimeField()
    expire_time = models.DateTimeField()  # è®¢å•æœ‰æ•ˆæœŸ
    status = models.CharField(
        max_length=10,
        choices=[
            ('pending', 'å¾…æ‰§è¡Œ'),
            ('filled', 'å·²æˆäº¤'),
            ('expired', 'å·²è¿‡æœŸ'),
            ('cancelled', 'å·²å–æ¶ˆ')
        ]
    )
    fund_status = models.CharField(
        max_length=10,
        choices=[
            ('locked', 'å·²é”å®š'),
            ('released', 'å·²é‡Šæ”¾')
        ]
    )

    # å…³è”ä»“ä½
    position = models.ForeignKey(
        GridPosition, null=True, blank=True,
        on_delete=models.SET_NULL
    )
```

### èµ„é‡‘æµå¯¹æ¯”

| æ“ä½œ | V2 (æ— æŒ‚å•) | V3 (æŒ‚å•ç³»ç»Ÿ) |
|------|------------|---------------|
| **åˆ›å»ºç½‘æ ¼** | æ— éœ€æ“ä½œ | é¢„åˆ›å»ºæŒ‚å•ï¼Œé”å®šèµ„é‡‘ |
| **èµ„é‡‘ç®¡ç†** | ç°é‡‘çº¦æŸ | ä¸‰é‡çº¦æŸ |
| **ä»·æ ¼åˆ°è¾¾** | å®æ—¶ä¹°å…¥ | æŒ‚å•è‡ªåŠ¨æˆäº¤ |
| **è®¢å•å–æ¶ˆ** | N/A | è‡ªåŠ¨è¿‡æœŸï¼Œé‡Šæ”¾èµ„é‡‘ |
| **é‡å¤ä¹°å…¥** | éœ€è¦æ‰‹åŠ¨æ¿€æ´» | è‡ªåŠ¨é‡æ–°åˆ›å»ºæŒ‚å• |

### ä½¿ç”¨æ–¹æ³•

```python
# å‘½ä»¤è¡Œå›æµ‹
python manage.py run_backtest \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid_v3 \
  --days 90 \
  --initial-cash 10000 \
  --order-validity-days 7  # æŒ‚å•æœ‰æ•ˆæœŸ7å¤©

# Webç•Œé¢
# è®¿é—® http://127.0.0.1:8001/backtest/
# é€‰æ‹©ç­–ç•¥ç±»å‹: Grid V3 (æŒ‚å•ç³»ç»Ÿ)
```

### é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `initial_cash` | 10000 | åˆå§‹èµ„é‡‘ï¼ˆUSDTï¼‰ |
| `commission` | 0.1% | æ‰‹ç»­è´¹ç‡ |
| `stop_loss_pct` | 10% | æ­¢æŸæ¯”ä¾‹ |
| `order_size_usdt` | 100 | æ¯ç¬”è®¢å•å¤§å° |
| `order_validity_days` | 7 | æŒ‚å•æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰ |
| `price_deviation_threshold` | 0.5% | ä»·æ ¼åå·®é˜ˆå€¼ |

### å›æµ‹ç»“æœç¤ºä¾‹

**ETHUSDT 4h, 90å¤©æ•°æ®**:

```bash
============================================================
Grid V3 å›æµ‹ç»“æœ
============================================================
ç­–ç•¥åç§°: Grid V3 (æŒ‚å•ç³»ç»Ÿ)
äº¤æ˜“å¯¹: ETHUSDT
æ—¶é—´å‘¨æœŸ: 4h
åˆå§‹èµ„é‡‘: $10,000.00
æœ€ç»ˆä»·å€¼: $8,672.00
æ€»æ”¶ç›Šç‡: -13.28%
æ€»äº¤æ˜“æ¬¡æ•°: 6
èƒœç‡: 0.00%

æ³¨ï¼šæµ‹è¯•æœŸé—´å¸‚åœºä¸‹è·Œ10.8%ï¼Œç­–ç•¥è·‘èµ¢å¸‚åœº3.5ä¸ªç™¾åˆ†ç‚¹

============================================================
æŒ‚å•ç»Ÿè®¡
============================================================
åˆ›å»ºæŒ‚å•æ€»æ•°: 9
æˆäº¤æŒ‚å•æ•°: 6
è¿‡æœŸæŒ‚å•æ•°: 3
èµ„é‡‘é”å®šå¹³å‡æ—¶é—´: 2.3å¤©
```

---

## VP Squeezeé›†æˆ

### æ¦‚è¿°

ç½‘æ ¼äº¤æ˜“ç³»ç»Ÿçš„V2å’ŒV3ç‰ˆæœ¬ä¾èµ–äºVP Squeezeåˆ†ææ¥åŠ¨æ€è®¡ç®—ç½‘æ ¼ä»·æ ¼ã€‚VP Squeezeé€šè¿‡æˆäº¤é‡ä»·æ ¼åˆ†æï¼Œè¯†åˆ«4ä¸ªå…³é”®å±‚çº§ã€‚

### å››å³°åˆ†æç®—æ³•

```mermaid
graph TB
    subgraph "æ•°æ®é¢„å¤„ç†"
        A[Kçº¿æ•°æ®] --> B[ä»·æ ¼åŒºé—´åˆ†ç»„]
        B --> C[æˆäº¤é‡èšåˆ]
    end

    subgraph "å³°å€¼æ£€æµ‹"
        D[æ‰«æä»·æ ¼åŒºé—´]
        E[æŸ¥æ‰¾æˆäº¤é‡å³°å€¼]
        F[è¯†åˆ«4ä¸ªå…³é”®ç‚¹]
    end

    subgraph "å±‚çº§åˆ†ç±»"
        G[æ’åºæˆäº¤é‡]
        H[åˆ†ç±»æ”¯æ’‘/é˜»åŠ›]
        I[è¿”å›4ä¸ªå±‚çº§]
    end

    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I

    I --> J[ç½‘æ ¼ä»·æ ¼]
```

### APIè°ƒç”¨

```python
from vp_squeeze.services.four_peaks_analyzer import FourPeaksAnalyzer

analyzer = FourPeaksAnalyzer()

# åˆ†æå½“å‰æ—¶é—´ç‚¹çš„å…³é”®å±‚çº§
analysis = analyzer.analyze(
    symbol='ETHUSDT',
    current_time=datetime.now()
)

# æå–å…³é”®å±‚çº§
key_levels = analysis.key_levels  # List[KeyLevel]

for level in key_levels:
    print(f"ä»·æ ¼: {level.price:.2f}, "
          f"ç±»å‹: {level.level_type}, "
          f"å¼ºåº¦: {level.strength}")
```

### è¿”å›ç»“æœ

```python
[
    KeyLevel(price=2700.00, level_type='support2', strength=0.85),
    KeyLevel(price=2900.00, level_type='support1', strength=0.92),
    KeyLevel(price=3100.00, level_type='resistance1', strength=0.88),
    KeyLevel(price=3300.00, level_type='resistance2', strength=0.79)
]
```

---

## å›æµ‹éªŒè¯

### å¿«é€Ÿå›æµ‹

```bash
# è¿è¡ŒGrid V2å›æµ‹ï¼ˆ30å¤©ï¼‰
python manage.py run_backtest \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid_v2 \
  --days 30

# è¿è¡ŒGrid V3å›æµ‹ï¼ˆ90å¤©ï¼‰
python manage.py run_backtest \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid_v3 \
  --days 90

# å¯¹æ¯”ä¸¤ä¸ªç­–ç•¥
python manage.py compare_results \
  --strategy1 grid_v2 \
  --strategy2 grid_v3
```

### å‚æ•°ä¼˜åŒ–

```bash
# Grid V2å‚æ•°ä¼˜åŒ–
python manage.py optimize_params \
  --symbol ETHUSDT \
  --interval 4h \
  --strategy grid_v2 \
  --grid-step-pcts 0.5,1.0,1.5,2.0 \
  --grid-levels 5,10,15,20

# æŸ¥çœ‹ä¼˜åŒ–ç»“æœ
python manage.py generate_report --backtest-id <id>
```

### Webå¯è§†åŒ–

```bash
# å¯åŠ¨Webç•Œé¢
./start_web_backtest.sh

# è®¿é—® http://127.0.0.1:8001/backtest/
# é…ç½®å‚æ•°å¹¶è¿è¡Œå›æµ‹
# æŸ¥çœ‹åŠ¨æ€å›æ”¾å’Œè¯¦ç»†åˆ†æ
```

---

## å¸¸è§é—®é¢˜

### Q1: Grid V2å’ŒV3å¦‚ä½•é€‰æ‹©ï¼Ÿ

**A**: æ ¹æ®èµ„é‡‘è§„æ¨¡å’Œé£é™©æ‰¿å—èƒ½åŠ›ï¼š

- **å°èµ„é‡‘ (< $5,000)**: é€‰æ‹©Grid V2ï¼Œç®€å•é«˜æ•ˆ
- **ä¸­ç­‰èµ„é‡‘ ($5,000 - $50,000)**: é€‰æ‹©Grid V2æˆ–V3éƒ½å¯ä»¥
- **å¤§èµ„é‡‘ (> $50,000)**: å¼ºçƒˆæ¨èGrid V3ï¼Œä¸¥æ ¼çš„èµ„é‡‘ç®¡ç†

### Q2: ç½‘æ ¼å‚æ•°å¦‚ä½•è®¾ç½®ï¼Ÿ

**A**: åŸºäºå›æµ‹ä¼˜åŒ–ï¼š

```python
# æ¨èå‚æ•°ï¼ˆETH 4hï¼‰
grid_v2_config = {
    'grid_step_pct': 0.015,  # 1.5%
    'grid_levels': 10,
    'order_size_usdt': 100,
    'stop_loss_pct': 0.10
}

grid_v3_config = {
    'grid_step_pct': 0.015,
    'grid_levels': 10,
    'order_size_usdt': 100,
    'stop_loss_pct': 0.10,
    'order_validity_days': 7,
    'price_deviation_threshold': 0.005
}
```

### Q3: å›æµ‹è¡¨ç°å¥½å°±ä¸€å®šå®ç›˜å¥½å—ï¼Ÿ

**A**: ä¸ä¸€å®šã€‚å›æµ‹ç»“æœå—é™äºï¼š

1. **å†å²æ•°æ®è´¨é‡**: å¸‚åœºç»“æ„å’ŒæµåŠ¨æ€§å˜åŒ–
2. **äº¤æ˜“æˆæœ¬**: æ»‘ç‚¹å’Œæ‰‹ç»­è´¹å¯èƒ½æ›´é«˜
3. **å¿ƒç†å› ç´ **: å®ç›˜æ—¶çš„æƒ…ç»ªå½±å“
4. **å¸‚åœºç¯å¢ƒ**: è¶‹åŠ¿å¸‚åœºå’Œéœ‡è¡å¸‚åœºçš„å·®å¼‚

**å»ºè®®**: å›æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œå®ç›˜å‰å…ˆè¿›è¡ŒPaper TradingéªŒè¯ã€‚

### Q4: å¦‚ä½•å¤„ç†è¿ç»­äºæŸï¼Ÿ

**A**: Gridç­–ç•¥çš„æ­¢æŸæœºåˆ¶ï¼š

```python
# æ£€æŸ¥æ­¢æŸæ¡ä»¶
def check_stop_loss(self, position):
    """åŠ¨æ€æ­¢æŸæ£€æŸ¥"""

    # å½“å‰äºæŸ
    current_loss_pct = (position.buy_price - current_price) / position.buy_price

    # è§¦å‘æ­¢æŸ
    if current_loss_pct >= self.config['stop_loss_pct']:
        self._execute_stop_loss(position)
        return True

    return False
```

### Q5: VP Squeezeåˆ†æå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: ç³»ç»Ÿæœ‰é™çº§é€»è¾‘ï¼š

1. **æ£€æŸ¥æ•°æ®è´¨é‡**: ç¡®ä¿Kçº¿æ•°æ®å®Œæ•´
2. **è°ƒæ•´åˆ†æå‘¨æœŸ**: å¢åŠ å†å²æ•°æ®èŒƒå›´
3. **é™çº§åˆ°å›ºå®šç½‘æ ¼**: ä½¿ç”¨V1ç­–ç•¥ä½œä¸ºå¤‡é€‰

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‚æ•°ä¼˜åŒ–

```python
# åŸºäºå†å²æ•°æ®ä¼˜åŒ–å‚æ•°
best_params = optimize_params(
    symbol='ETHUSDT',
    interval='4h',
    strategy='grid_v2',
    param_ranges={
        'grid_step_pct': [0.005, 0.01, 0.015, 0.02],
        'grid_levels': [5, 10, 15, 20]
    }
)

print(f"æœ€ä¼˜å‚æ•°: {best_params}")
```

### 2. å¤šç­–ç•¥ç»„åˆ

```python
# ä¸åŒå¸‚åœºä½¿ç”¨ä¸åŒç­–ç•¥
def select_strategy(market_condition):
    if market_condition == 'bull':
        return 'grid_v2'
    elif market_condition == 'bear':
        return 'grid_v3'
    else:
        return 'grid_v2'
```

### 3. é£é™©æ§åˆ¶

```python
# è®¾ç½®æœ€å¤§å›æ’¤é™åˆ¶
max_drawdown_pct = 0.05  # 5%

if current_drawdown >= max_drawdown_pct:
    # æš‚åœäº¤æ˜“
    grid_paused = True
    logger.warning("è¾¾åˆ°æœ€å¤§å›æ’¤ï¼Œæš‚åœäº¤æ˜“")
```

---

## ç›¸å…³æ–‡æ¡£

- **[é¡¹ç›®æ¦‚è§ˆ](./PROJECT_OVERVIEW.md)** - é¡¹ç›®æ•´ä½“ä»‹ç»
- **[å›æµ‹ç³»ç»ŸæŒ‡å—](./BACKTEST_SYSTEM_GUIDE.md)** - å›æµ‹æ¡†æ¶è¯¦ç»†è¯´æ˜
- **[Grid V2è¾¹ç•Œæƒ…å†µ](./GRID_V2_EDGE_CASES.md)** - V2ç­–ç•¥è¾¹ç•Œæ¡ˆä¾‹
- **[Grid V3å®ç°æŠ¥å‘Š](./GRID_V3_IMPLEMENTATION.md)** - æŒ‚å•ç³»ç»Ÿå®ç°ç»†èŠ‚

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| v3.0 | 2025-12-02 | æ–°å¢Grid V3æŒ‚å•ç³»ç»Ÿï¼Œå®Œå–„æ–‡æ¡£ |
| v2.0 | 2025-11-30 | å®ç°Grid V2åŠ¨æ€4å±‚ç½‘æ ¼ |
| v1.0 | 2025-11-17 | åˆå§‹Grid V1ç»å…¸ç½‘æ ¼ |

---

**ç¥æ‚¨äº¤æ˜“æ„‰å¿«ï¼** ğŸ‰ğŸ“ˆğŸ’°
