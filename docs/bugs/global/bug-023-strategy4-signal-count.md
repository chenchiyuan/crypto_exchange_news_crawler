# Bug-023: ç­–ç•¥4å›æµ‹ä¿¡å·æ•°é‡å¼‚å¸¸åå°‘

**Bug ID**: bug-023
**åˆ›å»ºæ—¶é—´**: 2026-01-07
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯
**ä¸¥é‡ç¨‹åº¦**: P1ï¼ˆé«˜ï¼‰
**å½±å“èŒƒå›´**: ç­–ç•¥4ï¼ˆæƒ¯æ€§ä¸­å€¼çªç ´åšç©ºï¼‰

---

## ğŸ“‹ é˜¶æ®µä¸€ï¼šéœ€æ±‚å¯¹é½ä¸æ¾„æ¸…

### 1.1 ç”¨æˆ·åŸå§‹éœ€æ±‚

```
åŒ¹é…çš„è®¢å•æ•°é‡æ¯”æˆ‘é¢„æ–™çš„å°‘å¾ˆå¤šï¼Œ2025å¹´8æœˆ7å·åˆ°14å·ä¹‹é—´åº”è¯¥æœ‰å¤§é‡çš„æˆäº¤æœºä¼šï¼Œ
æˆ‘è§‰å¾—å¯èƒ½ä¹Ÿæ˜¯ä¹‹å‰ç±»ä¼¼p95ä»·æ ¼è®¡ç®—çš„é—®é¢˜é€ æˆæ²¡æœ‰åŒ¹é…è®¢å•ã€‚
è¯·ä»”ç»†å®šä½å¹¶æ£€æŸ¥
```

### 1.2 ç­–ç•¥4å®šä¹‰ï¼ˆæ¥è‡ªBug-022ï¼‰

**Bug-022ä¿®æ”¹åçš„å®ç°**:

```python
ç­–ç•¥4: æƒ¯æ€§æ‰‡é¢ä¸Šç•Œçªç ´åšç©ºï¼ˆBug-022ç‰ˆæœ¬ï¼‰

å¼€ç©ºæ¡ä»¶:
    kline['high'] > (inertia_upper + P95) / 2  # âŒ é”™è¯¯ä½¿ç”¨inertia_upper

å¹³ç©ºæ¡ä»¶ï¼ˆå…ˆæ»¡è¶³çš„å¹³ä»“ï¼‰:
    1. ä»·æ ¼ä¸Šæ¶¨5%æ­¢æŸ
    2. EMA25å›å½’
```

### 1.3 æ­£ç¡®çŠ¶æ€å®šä¹‰ï¼ˆç”¨æˆ·å·²ç¡®è®¤ï¼‰

âœ… **ç”¨æˆ·ç¡®è®¤**: "æ˜ç™½äº†ï¼Œåº”è¯¥ä½¿ç”¨inertia_mid"

**æ­£ç¡®çš„ç­–ç•¥4å®šä¹‰**:
```python
ç­–ç•¥4: æƒ¯æ€§ä¸­å€¼çªç ´åšç©ºï¼ˆä¿®å¤åï¼‰

å¼€ç©ºæ¡ä»¶:
    kline['high'] > (inertia_mid + P95) / 2  # âœ… æ­£ç¡®ä½¿ç”¨inertia_mid
```

---

## ğŸ“Š é˜¶æ®µäºŒï¼šé—®é¢˜ç°è±¡æè¿°

### 2.1 é—®é¢˜è¡¨ç°

**å›æµ‹ç»“æœï¼ˆBug-022ç‰ˆæœ¬ï¼‰**:
- å…¨æ—¶æ®µï¼ˆ2025-01-01è‡³ä»Šï¼‰: ä»…13ä¸ªè®¢å•
- 2025å¹´8æœˆ7-14æ—¥: **0ä¸ªè§¦å‘ä¿¡å·**

**ç”¨æˆ·é¢„æœŸ**:
- 2025å¹´8æœˆ7-14æ—¥åº”è¯¥æœ‰å¤§é‡åšç©ºæœºä¼š

### 2.2 åˆæ­¥éªŒè¯æ•°æ®

è¿è¡Œä¸´æ—¶éªŒè¯è„šæœ¬ `bug-023-verify-signals.py`:

**ä½¿ç”¨inertia_upperï¼ˆé”™è¯¯ï¼‰**:
```
å‹åŠ›ä½å‡å€¼: 4650.80
ä»·æ ¼å‡å€¼(High): 4311.76
å·®å€¼: -339.04  # ä»·æ ¼è¿œä½äºå‹åŠ›ä½ï¼Œæ— æ³•è§¦å‘
è§¦å‘æ¬¡æ•°: 0 / 48
```

**ç»“è®º**: inertia_upperè¿‡é«˜ï¼Œå¯¼è‡´å‹åŠ›ä½è¿‡é«˜ï¼Œä¿¡å·æ— æ³•è§¦å‘ã€‚

---

## ğŸ”¬ é˜¶æ®µä¸‰ï¼šä¸‰å±‚ç«‹ä½“è¯Šæ–­åˆ†æ

### 3.1 è¡¨ç°å±‚è¯Šæ–­

#### ä»£ç åˆ†æ
- æŸ¥çœ‹ `signal_calculator.py:346-404`
- ç­–ç•¥4ä½¿ç”¨äº† `inertia_upper` è®¡ç®—å‹åŠ›ä½

#### è¡¨ç°åˆ†æ
- 2025å¹´8æœˆ7-14æ—¥æœŸé—´ï¼Œ48æ ¹Kçº¿å…¨éƒ¨æœªè§¦å‘
- å³ä½¿ä»·æ ¼æœ€é«˜æ¶¨åˆ°4788ï¼Œä»æœªçªç ´5127.76çš„å‹åŠ›ä½

#### éªŒè¯ç»“è®º
- âœ… **è¡¨ç°å±‚æ­£ç¡®**: ä»£ç é€»è¾‘æ‰§è¡Œæ­£å¸¸ï¼ŒæŒ‰é¢„æœŸåˆ¤æ–­äº†è§¦å‘æ¡ä»¶
- âŒ **å‚æ•°é”™è¯¯**: ä½¿ç”¨äº†é”™è¯¯çš„æŒ‡æ ‡ï¼ˆinertia_upperï¼‰

### 3.2 é€»è¾‘å±‚è¯Šæ–­

#### ä»£ç åˆ†æ
- `signal_calculator.py:385-386` è®¡ç®—å‹åŠ›ä½
  ```python
  pressure_line = (inertia_upper + p95) / 2  # Bugæ‰€åœ¨
  ```
- Bug-022ä¸­ç†è§£"upper"ä¸ºinertia_upper

#### é€»è¾‘åˆ†æ
**å¯¹æ¯”éªŒè¯**ï¼ˆè¿è¡Œ`bug-023-verify-mid.py`ï¼‰:

| æŒ‡æ ‡ | inertia_upperï¼ˆé”™è¯¯ï¼‰ | inertia_midï¼ˆæ­£ç¡®ï¼‰ | å·®å¼‚ |
|------|----------------------|---------------------|------|
| å‡å€¼ | 5031.15 | 4401.80 | -629.35 |
| å‹åŠ›ä½ | 4650.80 | 4336.12 | -314.68 |
| è§¦å‘æ¬¡æ•° | 0 / 48 | **17 / 48** | **+17ä¸ª** |

#### éªŒè¯ç»“è®º
- âŒ **é€»è¾‘å±‚é”™è¯¯**: Bug-022ä¸­å¯¹"upper"çš„ç†è§£é”™è¯¯
- âœ… **æ ¹å› å®šä½**: åº”è¯¥ä½¿ç”¨`inertia_mid`è€Œé`inertia_upper`

### 3.3 æ•°æ®å±‚è¯Šæ–­

#### ä»£ç åˆ†æ
- `run_strategy_backtest.py:450-451` å·²æ­£ç¡®è®¡ç®—inertia_upperå’Œinertia_mid
- `ddpsz_adapter.py:481-502` ä¼ é€’äº†inertia_upperç»™SignalCalculator

#### æ•°æ®éªŒè¯
**2025å¹´8æœˆ7-14æ—¥æ•°æ®ç»Ÿè®¡**:
```
inertia_midå‡å€¼: 4401.80  âœ… æ¥è¿‘ä»·æ ¼æ°´å¹³
inertia_upperå‡å€¼: 5031.15  âŒ è¿œé«˜äºä»·æ ¼æ°´å¹³
P95å‡å€¼: 4270.45
```

#### éªŒè¯ç»“è®º
- âœ… **æ•°æ®å±‚æ­£ç¡®**: æŒ‡æ ‡è®¡ç®—å‡†ç¡®ï¼Œæ•°æ®å®Œæ•´
- âŒ **æ•°æ®é€‰æ‹©é”™è¯¯**: é€‰é”™äº†æŒ‡æ ‡ï¼ˆåº”è¯¥ç”¨midä¸æ˜¯upperï¼‰

### 3.4 ä¸‰å±‚è”åŠ¨éªŒè¯

**è·¨å±‚ä¸€è‡´æ€§æ£€æŸ¥**:
- è¡¨ç°å±‚ï¼šæŒ‰ç…§é€»è¾‘å±‚çš„å‚æ•°æ­£ç¡®æ‰§è¡Œ âœ…
- é€»è¾‘å±‚ï¼šä½¿ç”¨äº†é”™è¯¯çš„æ•°æ®å±‚æŒ‡æ ‡ âŒ
- æ•°æ®å±‚ï¼šæä¾›äº†æ­£ç¡®çš„æ•°æ®ä½†è¢«é”™è¯¯ä½¿ç”¨ âœ…

**åå‘æ’é™¤éªŒè¯**:
- å‡è®¾è¡¨ç°å±‚é”™è¯¯ â†’ ä¸ä¼šå¯¼è‡´æ‰€æœ‰ä¿¡å·éƒ½æ— æ³•è§¦å‘ â†’ æ’é™¤
- å‡è®¾é€»è¾‘å±‚é”™è¯¯ â†’ ä¼šå¯¼è‡´å‹åŠ›ä½è®¡ç®—è¿‡é«˜ï¼Œä¿¡å·æ— æ³•è§¦å‘ â†’ **ç¡®è®¤æ ¹å› **
- å‡è®¾æ•°æ®å±‚é”™è¯¯ â†’ éªŒè¯æ•°æ®æ­£ç¡®ï¼Œæ’é™¤

**æ•´ä½“æ£€æŸ¥**:
- Bug-022ä¸­å¯¹ç”¨æˆ·éœ€æ±‚"upper"çš„ç†è§£å‡ºç°åå·®
- ç”¨æˆ·è¯´çš„"upper"å®é™…æŒ‡inertia_midï¼ˆæƒ¯æ€§ä¸­å€¼ï¼‰
- æˆ‘é”™è¯¯ç†è§£ä¸ºinertia_upperï¼ˆæƒ¯æ€§æ‰‡é¢ä¸Šç•Œï¼‰

### 3.5 è¯Šæ–­ç»“è®º

âœ… **Bugæ ¹å› **: Bug-022ä¸­é”™è¯¯ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œå°†"upper"ç†è§£ä¸º`inertia_upper`ï¼Œå®é™…åº”è¯¥ä½¿ç”¨`inertia_mid`

**è¯æ®é“¾**:
```
è¡¨ç°å±‚: 0ä¸ªä¿¡å·è§¦å‘
  â†“
é€»è¾‘å±‚: pressure_lineè¿‡é«˜ï¼ˆ4650.80 vs ä»·æ ¼4311.76ï¼‰
  â†“
æ•°æ®å±‚: inertia_upperè¿‡é«˜ï¼ˆ5031.15 vs inertia_mid 4401.80ï¼‰
  â†“
æ ¹å› : ç­–ç•¥4åº”è¯¥ä½¿ç”¨inertia_midè€Œéinertia_upper
```

---

## ğŸ”§ é˜¶æ®µå››ï¼šä¿®å¤æ–¹æ¡ˆç¡®è®¤

### 4.1 ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šä¿®æ­£ä¸ºä½¿ç”¨inertia_midï¼ˆæ¨èï¼‰

**ä¿®æ”¹å†…å®¹**:
1. `signal_calculator.py`: ä¿®æ”¹`_calculate_strategy4()`ä½¿ç”¨inertia_mid
2. `ddpsz_adapter.py`: ç§»é™¤inertia_upperè¦æ±‚ï¼Œä¼ é€’inertia_mid
3. ç§»é™¤Bug-022ç›¸å…³çš„inertia_upperä»£ç 

**ä¼˜ç‚¹**:
- âœ… ä¿®å¤ç®€å•ï¼Œå½±å“é¢å°
- âœ… ç¬¦åˆç”¨æˆ·ç¡®è®¤çš„æ­£ç¡®ç†è§£
- âœ… ä¿¡å·æ•°é‡å°†å¤§å¹…å¢åŠ 

**ç¼ºç‚¹**:
- âš ï¸ ç­–ç•¥è¡¨ç°å¯èƒ½ä¸å¦‚Bug-022ç‰ˆæœ¬ï¼ˆèƒœç‡ä¼šé™ä½ï¼‰

**é¢„æœŸæ•ˆæœ**:
- 2025å¹´8æœˆ7-14æ—¥: 17ä¸ªä¿¡å·ï¼ˆå½“å‰0ä¸ªï¼‰
- å…¨æ—¶æ®µä¿¡å·æ•°é‡: é¢„è®¡400-500ä¸ªï¼ˆå½“å‰13ä¸ªï¼‰

#### æ–¹æ¡ˆBï¼šä¿ç•™Bug-022ç‰ˆæœ¬ï¼Œæ–°å¢ç­–ç•¥4B

**ä¸æ¨èç†ç”±**: å¢åŠ å¤æ‚åº¦ï¼Œç”¨æˆ·å·²æ˜ç¡®è¦ä½¿ç”¨inertia_mid

### 4.2 æ¨èæ–¹æ¡ˆ

âœ… **æ–¹æ¡ˆA**: ç›´æ¥ä¿®å¤ï¼Œä½¿ç”¨inertia_mid

---

## âœ… é˜¶æ®µäº”ï¼šç”¨æˆ·ç¡®è®¤

âœ… **ç”¨æˆ·å·²ç¡®è®¤**: "æ˜ç™½äº†ï¼Œåº”è¯¥ä½¿ç”¨inertia_mid"

---

## ğŸ› ï¸ é˜¶æ®µå…­ï¼šå®æ–½ä¿®å¤

### 6.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. `ddps_z/calculators/signal_calculator.py`
2. `strategy_adapter/adapters/ddpsz_adapter.py`

### 6.2 ä¿®æ”¹è¯¦æƒ…

#### ä¿®æ”¹1: SignalCalculator._calculate_strategy4()

**æ–‡ä»¶**: `ddps_z/calculators/signal_calculator.py:346-404`

**ä¿®æ”¹å‰**:
```python
def _calculate_strategy4(self, kline, p95, inertia_upper):
    """è®¡ç®—ç­–ç•¥4: æƒ¯æ€§æ‰‡é¢ä¸Šç•Œçªç ´åšç©º"""
    pressure_line = (inertia_upper + p95) / 2
    triggered = high > pressure_line
    # ...
```

**ä¿®æ”¹å**:
```python
def _calculate_strategy4(self, kline, p95, inertia_mid):
    """è®¡ç®—ç­–ç•¥4: æƒ¯æ€§ä¸­å€¼çªç ´åšç©º

    ğŸ”§ Bug-023ä¿®å¤: ä¿®æ­£ä¸ºä½¿ç”¨inertia_midè€Œéinertia_upper
    """
    pressure_line = (inertia_mid + p95) / 2  # âœ… ä½¿ç”¨inertia_mid
    triggered = high > pressure_line
    # ...
```

#### ä¿®æ”¹2: SignalCalculator.calculate()

**åˆ é™¤**:
```python
# ğŸ†• Bug-022: ç­–ç•¥4éœ€è¦inertia_upper
if 4 in enabled_strategies and inertia_upper_series is None:
    raise DataInsufficientError("ç­–ç•¥4éœ€è¦inertia_upperåºåˆ—")
```

**ä¿®æ”¹è°ƒç”¨**:
```python
# ä¿®æ”¹å‰
strategy4_result = self._calculate_strategy4(
    kline=kline,
    p95=p95_series[i],
    inertia_upper=inertia_upper_series[i]  # âŒ
)

# ä¿®æ”¹å
strategy4_result = self._calculate_strategy4(
    kline=kline,
    p95=p95_series[i],
    inertia_mid=inertia_mid_series[i]  # âœ…
)
```

#### ä¿®æ”¹3: DDPSZStrategy.generate_short_signals()

**æ–‡ä»¶**: `strategy_adapter/adapters/ddpsz_adapter.py:479-512`

**åˆ é™¤**:
```python
# ğŸ†• Bug-022: ç­–ç•¥4éœ€è¦inertia_upper
if 4 in self.enabled_strategies:
    required_indicators.append('inertia_upper')

# ğŸ†• Bug-022: æå–inertia_upper
inertia_upper_series = indicators.get('inertia_upper', pd.Series([np.nan] * len(klines))).values
```

**ä¿®æ”¹è°ƒç”¨**:
```python
# ä¿®æ”¹å‰
result = self.calculator.calculate(
    # ...
    inertia_upper_series=inertia_upper_series,  # âŒ
    enabled_strategies=short_strategies
)

# ä¿®æ”¹å
result = self.calculator.calculate(
    # ...ï¼ˆä¸ä¼ é€’inertia_upper_seriesï¼‰
    enabled_strategies=short_strategies
)
```

### 6.3 ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨è®°å½•

#### åˆ†æè„šæœ¬
- `temp_scripts/analysis/bug-023-verify-signals.py` - éªŒè¯inertia_upperç‰ˆæœ¬
- `temp_scripts/analysis/bug-023-verify-mid.py` - å¯¹æ¯”inertia_mid vs inertia_upper

#### æ¸…ç†çŠ¶æ€
- âœ… æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å°†åœ¨éªŒè¯å®Œæˆåæ¸…ç†

---

## âœ”ï¸ é˜¶æ®µä¸ƒï¼šéªŒè¯äº¤ä»˜

### 7.1 å›æµ‹éªŒè¯

**æµ‹è¯•å‘½ä»¤**:
```bash
python manage.py run_strategy_backtest \
  --config strategy_adapter/configs/strategy4_inertia_short.json \
  --save-to-db
```

### 7.2 ä¿®å¤æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ï¼ˆinertia_upperï¼‰ | ä¿®å¤åï¼ˆinertia_midï¼‰ | å˜åŒ– |
|------|-------------------------|----------------------|------|
| **è§¦å‘ä¿¡å·** | 13ä¸ª | **490ä¸ª** | **+37.7å€** |
| **å®é™…è®¢å•** | 13ä¸ª | **451ä¸ª** | **+34.7å€** |
| **èƒœç‡** | 76.92% | 26.98% | -49.94% |
| **å‡€åˆ©æ¶¦** | +40.50 USDT | -364.34 USDT | -404.84 USDT |
| **æ”¶ç›Šç‡** | +0.40% | -3.64% | -4.04% |

### 7.3 2025å¹´8æœˆ7-14æ—¥éªŒè¯

**ä¿®å¤å‰**: 0ä¸ªä¿¡å·
**ä¿®å¤å**: 17ä¸ªä¿¡å·ï¼ˆ35.4%è§¦å‘ç‡ï¼‰

**ä¿¡å·è¯¦æƒ…**:
- 2025-08-08 00:00 âœ…
- 2025-08-08 12:00 âœ…
- 2025-08-08 20:00 âœ…
- 2025-08-09 04:00 âœ…
- 2025-08-09 08:00 âœ…
- 2025-08-09 20:00 âœ…
- 2025-08-10 00:00 âœ…
- 2025-08-12 16:00 âœ…
- 2025-08-12 20:00 âœ…
- 2025-08-13 00:00 âœ…
- 2025-08-13 04:00 âœ…
- 2025-08-13 08:00 âœ…
- 2025-08-13 12:00 âœ…
- 2025-08-13 16:00 âœ…
- 2025-08-13 20:00 âœ…
- 2025-08-14 00:00 âœ…
- 2025-08-14 04:00 âœ…

### 7.4 å…³é”®å‘ç°

#### 1. ä¿¡å·æ•°é‡æ­£å¸¸äº†
- **ä¿®å¤å‰**: 13ä¸ªä¿¡å·ï¼ˆå¼‚å¸¸åå°‘ï¼‰
- **ä¿®å¤å**: 490ä¸ªä¿¡å·ï¼ˆç¬¦åˆé¢„æœŸï¼‰

#### 2. èƒœç‡é™ä½å±æ­£å¸¸
- **ä¿®å¤å‰76.92%**: å› ä¸ºå‹åŠ›ä½è¿‡é«˜ï¼Œåªè§¦å‘æç«¯ä¿¡å·
- **ä¿®å¤å26.98%**: çœŸå®çš„ç­–ç•¥è¡¨ç°
- åšç©ºç­–ç•¥æœ¬èº«èƒœç‡è¾ƒä½æ˜¯æ­£å¸¸ç°è±¡

#### 3. ç­–ç•¥éœ€è¦ä¼˜åŒ–
å½“å‰ç­–ç•¥4è¡¨ç°ï¼š
- äºæŸ -364.34 USDT ï¼ˆ-3.64%ï¼‰
- èƒœç‡ä»…26.98%
- å»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–å‚æ•°æˆ–è°ƒæ•´ç­–ç•¥é€»è¾‘

#### 4. Webç•Œé¢éªŒè¯
- å›æµ‹è®°å½•ID: 29
- æŸ¥çœ‹åœ°å€: http://127.0.0.1:8000/strategy-adapter/backtest/29/

### 7.5 ä¸´æ—¶æ–‡ä»¶æ¸…ç†

**æ¸…ç†æ£€æŸ¥æ¸…å•**:
- âœ… `temp_scripts/analysis/bug-023-verify-signals.py` å·²åˆ é™¤
- âœ… `temp_scripts/analysis/bug-023-verify-mid.py` å·²åˆ é™¤
- âœ… `temp_scripts/` ç›®å½•å·²æ¸…ç†
- âœ… å·¥ä½œç›®å½•æ•´æ´

### 7.6 éªŒè¯ç»“è®º

âœ… **Bug-023ä¿®å¤æˆåŠŸ**

**æ ¸å¿ƒæˆæœ**:
1. âœ… ä¿¡å·æ•°é‡æ¢å¤æ­£å¸¸ï¼ˆ13â†’490ä¸ªï¼‰
2. âœ… 8æœˆ7-14æ—¥æ­£å¸¸è§¦å‘17ä¸ªä¿¡å·
3. âœ… ç­–ç•¥4é€»è¾‘æ­£ç¡®ä½¿ç”¨inertia_mid
4. âœ… æ•°æ®éªŒè¯ç¬¦åˆé¢„æœŸ

**åç»­å»ºè®®**:
- ç­–ç•¥4å½“å‰è¡¨ç°ä¸ä½³ï¼ˆ-3.64%æ”¶ç›Šç‡ï¼‰
- å¯è€ƒè™‘è°ƒæ•´å‚æ•°æˆ–ä¼˜åŒ–ç­–ç•¥é€»è¾‘
- ä½†è‡³å°‘ç°åœ¨ä¿¡å·æ•°é‡æ˜¯æ­£ç¡®çš„ï¼Œå¯åŸºäºçœŸå®æ•°æ®ä¼˜åŒ–

---

**åˆ›å»ºäºº**: PowerBy Bug-Fix Specialist
**æœ€åæ›´æ–°**: 2026-01-07
**å…³è”æ–‡æ¡£**:
- Bug-022: ç­–ç•¥4é€»è¾‘ä¼˜åŒ–ï¼ˆåŒ…å«éœ€æ±‚ç†è§£é”™è¯¯ï¼‰
- Bug-021: å‘å‰çœ‹åå·®ä¿®å¤
