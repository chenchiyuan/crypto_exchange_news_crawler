# Bug-028: DDPSæ¨é€æ¶ˆæ¯æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ

## æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| Bugç¼–å· | 028 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-08 |
| å®Œæˆæ—¥æœŸ | 2026-01-08 |
| çŠ¶æ€ | âœ… å·²ä¿®å¤ |
| ä¸¥é‡ç¨‹åº¦ | ä¸­ç­‰ |
| å½±å“èŒƒå›´ | æ¨é€åŠŸèƒ½ |
| å…³è”è¿­ä»£ | 023-ddps-price-monitor |

---

## é˜¶æ®µ1: éœ€æ±‚å¯¹é½ä¸æ¾„æ¸… ğŸ”

### 1.1 ç”¨æˆ·åé¦ˆ

ç”¨æˆ·åé¦ˆæ¨é€å†…å®¹ä¸ç¬¦åˆé¢„æœŸï¼Œå…·ä½“é—®é¢˜ï¼š

1. **å‘¨æœŸæ˜¾ç¤ºé—®é¢˜**ï¼š
   - å½“å‰å®ç°ï¼šæ˜¾ç¤º"ä¸Šæ¶¨å‘¨æœŸ"å’Œ"ä¸‹è·Œå‘¨æœŸ"ï¼ŒåŒ…å«æ‰€æœ‰ä¸Šæ¶¨/ä¸‹è·Œç›¸å…³çš„äº¤æ˜“å¯¹
   - ç”¨æˆ·æœŸæœ›ï¼šåªæ˜¾ç¤º"ä¸Šæ¶¨é¢„è­¦"å’Œ"ä¸‹è·Œé¢„è­¦"ä¸¤ä¸ªç‰¹å®šå‘¨æœŸçš„ä»£å¸

2. **ä»·æ ¼çŠ¶æ€ä¿¡æ¯ç¼ºå¤±**ï¼š
   - å½“å‰å®ç°ï¼š`{symbol}: {price} (P{probability}, {cycle_label})`
   - ç”¨æˆ·æœŸæœ›ï¼šéœ€è¦åŒ…å«P5ã€P95ã€æƒ¯æ€§æ‰‡å½¢é¢„æµ‹èŒƒå›´

3. **æ ‡é¢˜æ ¼å¼é—®é¢˜**ï¼š
   - å½“å‰å®ç°ï¼š`ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š - 2026-01-08 14:35`
   - ç”¨æˆ·æœŸæœ›ï¼š`month-day hour:minï¼šä¹°å…¥ä¿¡å·(æ•°é‡) å–å‡ºä¿¡å·(æ•°é‡) ä¸Šæ¶¨é¢„è­¦(æ•°é‡) ä¸‹è·Œé¢„è­¦(æ•°é‡)`

### 1.2 PRDéœ€æ±‚å¯¹ç…§

æ ¹æ® PRD æ–‡æ¡£ï¼ˆdocs/iterations/023-ddps-price-monitor/prd.mdï¼‰ï¼š

**REQ-004 å‘¨æœŸé¢„è­¦**ï¼š
```
ğŸ”´ ä¸Šæ¶¨å‘¨æœŸé¢„è­¦: BTC, ETH
ğŸ”µ ä¸‹è·Œå‘¨æœŸé¢„è­¦: SOL, SUI
```
- PRDåŸæ„æ˜¯"ä¸Šæ¶¨å‘¨æœŸé¢„è­¦"å’Œ"ä¸‹è·Œå‘¨æœŸé¢„è­¦"ï¼Œä½†ç”¨æˆ·æ˜ç¡®åªè¦"ä¸Šæ¶¨é¢„è­¦"å’Œ"ä¸‹è·Œé¢„è­¦"ä¸¤ä¸ªç‰¹å®šé˜¶æ®µ

**REQ-005 ä»·æ ¼çŠ¶æ€**ï¼š
```
â”‚ Symbol  â”‚ ç°ä»·     â”‚ å‘¨æœŸ       â”‚ P5         â”‚ P95        â”‚ æ¦‚ç‡ä½ç½® â”‚
```
- PRDå®šä¹‰äº†å®Œæ•´çš„æ•°æ®å­—æ®µï¼Œä½†å½“å‰å®ç°ç¼ºå°‘P5/P95/æƒ¯æ€§èŒƒå›´

**PriceStatus æ•°æ®ç±»**ï¼ˆPRDå®šä¹‰ï¼‰ï¼š
```python
@dataclass
class PriceStatus:
    symbol: str           # äº¤æ˜“å¯¹
    current_price: Decimal  # ç°ä»·
    cycle_phase: str      # å‘¨æœŸé˜¶æ®µ
    p5: Decimal          # P5ä»·æ ¼
    p95: Decimal         # P95ä»·æ ¼
    ema25: Decimal       # EMA25
    inertia_mid: Decimal # æƒ¯æ€§ä¸­å€¼
    inertia_upper: Decimal # æƒ¯æ€§ä¸Šç•Œ â† ç¼ºå¤±
    inertia_lower: Decimal # æƒ¯æ€§ä¸‹ç•Œ â† ç¼ºå¤±
    probability: int     # å½“å‰ä»·æ ¼æ¦‚ç‡ä½ç½® (0-100)
    beta: float          # Î²æ–œç‡ â† ç¼ºå¤±
```

### 1.3 é‡åŒ–æ˜ç¡®çš„æ­£ç¡®è¡Œä¸º

#### æ ‡é¢˜æ ¼å¼
```
01-08 14:35: ä¹°å…¥(1) å–å‡º(0) ä¸Šæ¶¨é¢„è­¦(2) ä¸‹è·Œé¢„è­¦(1)
```

#### å‘¨æœŸé¢„è­¦éƒ¨åˆ†
åªæ˜¾ç¤º `bull_warning` å’Œ `bear_warning` ä¸¤ä¸ªé˜¶æ®µçš„äº¤æ˜“å¯¹ï¼š
```
ä¸Šæ¶¨é¢„è­¦: ETH, BTC
ä¸‹è·Œé¢„è­¦: SOL
```
ä¸æ˜¾ç¤ºï¼šbull_strong, bear_strong, consolidation

#### ä»·æ ¼çŠ¶æ€éƒ¨åˆ†
```
ETHUSDT: 2783.00 (ä¸Šæ¶¨é¢„è­¦)
  P5=2650.00 P95=2950.00
  æƒ¯æ€§èŒƒå›´: 2680.00~2880.00
  æ¦‚ç‡: P82
```

---

## é˜¶æ®µ2: é—®é¢˜ç°è±¡æè¿°

### 2.1 å½“å‰è¾“å‡ºç¤ºä¾‹

```
æ ‡é¢˜: ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š - 2026-01-08 14:35

å†…å®¹:
æ—¶é—´: 2026-01-08 14:35

ä¹°å…¥ä¿¡å· (0ä¸ª):
  æ— 

å–å‡ºä¿¡å· (0ä¸ª):
  æ— 

ä¸Šæ¶¨å‘¨æœŸ: ETHUSDT, BTCUSDT        â† é”™è¯¯ï¼šæ··åˆäº†bull_warningå’Œbull_strong
éœ‡è¡æœŸ: HYPEUSDT, BNBUSDT, SOLUSDT, SUIUSDT

ä»·æ ¼çŠ¶æ€:
  ETHUSDT: 2783.00 (P82, ä¸Šæ¶¨é¢„è­¦)    â† ç¼ºå°‘P5/P95/æƒ¯æ€§èŒƒå›´
  BTCUSDT: 83849.66 (P67, ä¸Šæ¶¨å¼ºåŠ¿)
  ...
```

### 2.2 æœŸæœ›è¾“å‡ºç¤ºä¾‹

```
æ ‡é¢˜: 01-08 14:35: ä¹°å…¥(0) å–å‡º(0) ä¸Šæ¶¨é¢„è­¦(1) ä¸‹è·Œé¢„è­¦(0)

å†…å®¹:
æ—¶é—´: 2026-01-08 14:35

ä¹°å…¥ä¿¡å· (0ä¸ª):
  æ— 

å–å‡ºä¿¡å· (0ä¸ª):
  æ— 

ä¸Šæ¶¨é¢„è­¦: ETHUSDT
ä¸‹è·Œé¢„è­¦: æ— 

ä»·æ ¼çŠ¶æ€:
  ETHUSDT: 2783.00 (ä¸Šæ¶¨é¢„è­¦)
    P5=2650.00 P95=2950.00
    æƒ¯æ€§èŒƒå›´: 2680.00~2880.00
    æ¦‚ç‡: P82
  BTCUSDT: 83849.66 (ä¸Šæ¶¨å¼ºåŠ¿)
    P5=80000.00 P95=90000.00
    æƒ¯æ€§èŒƒå›´: 81000.00~86500.00
    æ¦‚ç‡: P67
```

---

## é˜¶æ®µ3: ä¸‰å±‚ç«‹ä½“è¯Šæ–­åˆ†æ ğŸ”¬

### 3.1 è¡¨ç°å±‚è¯Šæ–­

| é—®é¢˜ | è¡¨ç° | åŸå›  |
|------|------|------|
| æ ‡é¢˜æ ¼å¼é”™è¯¯ | æ˜¾ç¤º"ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š" | format_push_messageæ–¹æ³•å®ç°ä¸ç¬¦åˆéœ€æ±‚ |
| å‘¨æœŸé¢„è­¦æ··åˆ | bull_warning + bull_strong åˆå¹¶æ˜¾ç¤º | ä»£ç é€»è¾‘è®¾è®¡å¦‚æ­¤ |
| ä»·æ ¼çŠ¶æ€ç®€ç•¥ | åªæ˜¾ç¤ºä»·æ ¼å’Œæ¦‚ç‡ | format_push_messageåªå–éƒ¨åˆ†å­—æ®µ |

### 3.2 é€»è¾‘å±‚è¯Šæ–­

**ä»£ç ä½ç½®**: `ddps_z/services/ddps_monitor_service.py:586-665`

**é—®é¢˜1: æ ‡é¢˜æ„å»º**
```python
if buy_count > 0 or exit_count > 0:
    title = f"ğŸ“Š DDPSä¿¡å·: {buy_count}ä¹°/{exit_count}å– - {current_time}"
else:
    title = f"ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š - {current_time}"
```
- ç¼ºå°‘ä¸Šæ¶¨é¢„è­¦/ä¸‹è·Œé¢„è­¦æ•°é‡
- æ—¶é—´æ ¼å¼ä¸æ˜¯ "month-day hour:min"

**é—®é¢˜2: å‘¨æœŸé¢„è­¦é€»è¾‘**
```python
bull_list = warning.bull_warning + warning.bull_strong  # æ··åˆäº†ä¸¤ç§
bear_list = warning.bear_warning + warning.bear_strong  # æ··åˆäº†ä¸¤ç§
```
- åº”è¯¥åªæ˜¾ç¤º warning ç±»å‹

**é—®é¢˜3: ä»·æ ¼çŠ¶æ€æ ¼å¼åŒ–**
```python
lines.append(
    f"  {status.symbol}: {status.current_price:.2f} "
    f"(P{status.probability}, {cycle_label})"
)
```
- ç¼ºå°‘ P5/P95/æƒ¯æ€§èŒƒå›´

### 3.3 æ•°æ®å±‚è¯Šæ–­

**PriceStatus æ•°æ®ç±»å®šä¹‰**ï¼š
```python
@dataclass
class PriceStatus:
    symbol: str
    current_price: Decimal
    cycle_phase: str
    p5: Decimal
    p95: Decimal
    ema25: Decimal
    inertia_mid: Decimal  # æœ‰
    probability: int
    # ç¼ºå°‘: inertia_upper, inertia_lower, beta
```

æ•°æ®ç±»å®šä¹‰ç¼ºå°‘æƒ¯æ€§ä¸Šä¸‹ç•Œï¼Œéœ€è¦è¡¥å……ã€‚

---

## é˜¶æ®µ4: ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: æœ€å°ä¿®æ”¹ï¼ˆæ¨èï¼‰

åªä¿®æ”¹ `format_push_message` æ–¹æ³•ï¼Œä½¿ç”¨ç°æœ‰çš„ PriceStatus å­—æ®µï¼š
- ä¿®æ”¹æ ‡é¢˜æ ¼å¼
- å‘¨æœŸé¢„è­¦åªæ˜¾ç¤º warning ç±»å‹
- ä»·æ ¼çŠ¶æ€ä½¿ç”¨ inertia_mid è¿‘ä¼¼æ˜¾ç¤º

**ä¼˜ç‚¹**: æ”¹åŠ¨æœ€å°ï¼Œé£é™©ä½
**ç¼ºç‚¹**: æƒ¯æ€§èŒƒå›´æ˜¾ç¤ºä¸å®Œæ•´

### æ–¹æ¡ˆB: å®Œæ•´å®ç°

1. æ‰©å±• PriceStatus æ•°æ®ç±»ï¼Œæ·»åŠ  inertia_upper, inertia_lower
2. ä¿®æ”¹ _calculate_symbol_indicators è¡¥å……è®¡ç®—
3. ä¿®æ”¹ format_push_message å®Œæ•´æ ¼å¼åŒ–

**ä¼˜ç‚¹**: å®Œå…¨ç¬¦åˆPRDå®šä¹‰
**ç¼ºç‚¹**: æ”¹åŠ¨èŒƒå›´å¤§

**æ¨è**: æ–¹æ¡ˆAï¼ˆæœ€å°ä¿®æ”¹ï¼‰ï¼Œåç»­å¦‚æœ‰éœ€è¦å†æ‰©å±•

---

## é˜¶æ®µ5: ç”¨æˆ·ç¡®è®¤

é‡‡ç”¨æ–¹æ¡ˆAï¼ˆæœ€å°ä¿®æ”¹ï¼‰ï¼Œç›´æ¥ä¿®å¤ `format_push_message` æ–¹æ³•ã€‚

---

## é˜¶æ®µ6: å®æ–½ä¿®å¤

### 6.1 ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**: `ddps_z/services/ddps_monitor_service.py`

**ä¿®æ”¹å†…å®¹**: `format_push_message` æ–¹æ³•

### 6.2 ä¿®æ”¹è¦ç‚¹

1. **æ ‡é¢˜æ ¼å¼ä¿®æ”¹**:
   ```python
   # æ—§: ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š - 2026-01-08 14:35
   # æ–°: 01-08 14:35: ä¹°å…¥(0) å–å‡º(0) ä¸Šæ¶¨é¢„è­¦(1) ä¸‹è·Œé¢„è­¦(0)
   title = (
       f"{time_short}: "
       f"ä¹°å…¥({buy_count}) å–å‡º({exit_count}) "
       f"ä¸Šæ¶¨é¢„è­¦({bull_warning_count}) ä¸‹è·Œé¢„è­¦({bear_warning_count})"
   )
   ```

2. **å‘¨æœŸé¢„è­¦åªæ˜¾ç¤º warning ç±»å‹**:
   ```python
   # æ—§: bull_list = warning.bull_warning + warning.bull_strong
   # æ–°: åªä½¿ç”¨ warning.bull_warning å’Œ warning.bear_warning
   if warning.bull_warning:
       lines.append(f"ä¸Šæ¶¨é¢„è­¦: {', '.join(warning.bull_warning)}")
   else:
       lines.append("ä¸Šæ¶¨é¢„è­¦: æ— ")
   ```

3. **ä»·æ ¼çŠ¶æ€å®Œæ•´æ ¼å¼**:
   ```python
   # æ–°æ ¼å¼:
   # ETHUSDT: 2783.00 (ä¸Šæ¶¨é¢„è­¦)
   #   P5=2667.71 P95=2814.46
   #   æƒ¯æ€§èŒƒå›´: 2741.08~2835.31
   #   æ¦‚ç‡: P82
   ```

---

## é˜¶æ®µ7: éªŒè¯äº¤ä»˜

### 7.1 éªŒè¯ç»“æœ

```
ã€æ ‡é¢˜ã€‘
01-08 14:56: ä¹°å…¥(0) å–å‡º(0) ä¸Šæ¶¨é¢„è­¦(1) ä¸‹è·Œé¢„è­¦(0)

ã€å†…å®¹ã€‘
æ—¶é—´: 2026-01-08 14:56

ä¹°å…¥ä¿¡å· (0ä¸ª):
  æ— 

å–å‡ºä¿¡å· (0ä¸ª):
  æ— 

ä¸Šæ¶¨é¢„è­¦: ETHUSDT
ä¸‹è·Œé¢„è­¦: æ— 

ä»·æ ¼çŠ¶æ€:
  ETHUSDT: 2783.00 (ä¸Šæ¶¨é¢„è­¦)
    P5=2667.71 P95=2814.46
    æƒ¯æ€§èŒƒå›´: 2741.08~2835.31
    æ¦‚ç‡: P82
  BTCUSDT: 83849.66 (ä¸Šæ¶¨å¼ºåŠ¿)
    P5=79141.72 P95=86496.47
    æƒ¯æ€§èŒƒå›´: 82819.10~87029.92
    æ¦‚ç‡: P67
  ...
```

### 7.2 æ¨é€éªŒè¯

âœ“ æ¨é€æˆåŠŸå‘é€åˆ°æ…§è¯šå¹³å° `price_ddps` é¢‘é“

### 7.3 ä¿®å¤ç¡®è®¤

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| æ ‡é¢˜æ ¼å¼ | ğŸ“Š DDPSç›‘æ§æŠ¥å‘Š - YYYY-MM-DD HH:MM | MM-DD HH:MM: ä¹°å…¥(N) å–å‡º(N) ä¸Šæ¶¨é¢„è­¦(N) ä¸‹è·Œé¢„è­¦(N) | âœ“ |
| å‘¨æœŸé¢„è­¦ | æ··åˆæ˜¾ç¤ºæ‰€æœ‰ä¸Šæ¶¨/ä¸‹è·Œå‘¨æœŸ | åªæ˜¾ç¤º warning ç±»å‹ | âœ“ |
| ä»·æ ¼çŠ¶æ€ | ç®€ç•¥æ˜¾ç¤º | åŒ…å«P5/P95/æƒ¯æ€§èŒƒå›´/æ¦‚ç‡ | âœ“ |
