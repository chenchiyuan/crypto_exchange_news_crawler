# Bug-016: å›æµ‹èµ„é‡‘ç®¡ç†é”™è¯¯ - å–å‡ºåæœªé‡Šæ”¾èµ„é‡‘

**Bug ID**: BUG-016
**åˆ›å»ºæ—¥æœŸ**: 2026-01-06
**çŠ¶æ€**: ğŸ” éœ€æ±‚å¯¹é½ä¸­
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**å½±å“èŒƒå›´**: ç­–ç•¥å›æµ‹åŠŸèƒ½ï¼Œèµ„é‡‘ç®¡ç†æ¨¡å—
**åˆ†æ”¯**: bugfix/bug-016-capital-management-error

---

## ğŸ“‹ ç¬¬ä¸€é˜¶æ®µï¼šéœ€æ±‚å¯¹é½ä¸æ¾„æ¸…

### 1.1 ç›¸å…³PRDæ–‡æ¡£

- **è¿­ä»£013**: ç­–ç•¥é€‚é…å±‚ (`docs/iterations/013-strategy-adapter-layer/prd.md`)
- **æ ¸å¿ƒæ¨¡å—**: UnifiedOrderManager (ç»Ÿä¸€è®¢å•ç®¡ç†å™¨)

### 1.2 é—®é¢˜æè¿°

**ç”¨æˆ·æŠ¥å‘Š**:
```
æ‰§è¡ŒæŠ¥é”™ï¼šå›æµ‹å¤±è´¥: available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: -100

æˆ‘çŒœæµ‹çš„åŸå› ï¼š
1. è´­ä¹°ä¹‹åå–å‡ºæ²¡æœ‰å¢åŠ available_capital
2. æç«¯æƒ…å†µï¼šavailable_capitalä¸è¶³æ—¶è´­ä¹°å¤±è´¥ï¼ˆæç¤ºå³å¯ï¼‰ï¼Œä¸åº”è¯¥é˜»å¡å›æµ‹

æ­¤å¤–ï¼š
run_strategy_backtestä¹Ÿéœ€è¦åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºå‡ºå–å‡ºæ—¶é—´ï¼Œæ ‡è®°ä¸‹å¯¹åº”çš„ä¹°å…¥æ—¶é—´ã€‚
```

### 1.3 æ­£ç¡®çš„ä¸šåŠ¡è¡Œä¸ºå®šä¹‰

æ ¹æ®PRDæ–‡æ¡£ï¼Œ**æ­£ç¡®çš„èµ„é‡‘ç®¡ç†è¡Œä¸º**åº”è¯¥æ˜¯ï¼š

#### èµ„é‡‘æµè½¬ç”Ÿå‘½å‘¨æœŸ

1. **åˆå§‹çŠ¶æ€**:
   - `initial_capital` = 10000 USDTï¼ˆåˆå§‹èµ„é‡‘ï¼‰
   - `available_capital` = 10000 USDTï¼ˆå¯ç”¨èµ„é‡‘ï¼‰
   - `locked_capital` = 0 USDTï¼ˆé”å®šèµ„é‡‘ï¼‰

2. **ä¹°å…¥æ—¶**:
   - `available_capital -= order_cost`ï¼ˆæ‰£é™¤è®¢å•æˆæœ¬ï¼‰
   - `locked_capital += order_cost`ï¼ˆé”å®šèµ„é‡‘ï¼‰
   - åˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸º `open`

3. **å–å‡ºæ—¶**:
   - è®¡ç®—ç›ˆäºï¼š`profit = (sell_price - buy_price) Ã— quantity`
   - `locked_capital -= order_cost`ï¼ˆé‡Šæ”¾é”å®šèµ„é‡‘ï¼‰
   - `available_capital += (order_cost + profit)`ï¼ˆå½’è¿˜æœ¬é‡‘+ç›ˆäºï¼‰
   - æ›´æ–°è®¢å•ï¼ŒçŠ¶æ€ä¸º `closed`

4. **èµ„é‡‘å®ˆæ’å…¬å¼**:
   ```
   initial_capital = available_capital + locked_capital + total_profit
   ```

#### è¾¹ç•Œæ¡ä»¶å¤„ç†

1. **èµ„é‡‘ä¸è¶³æ—¶**:
   - åº”è¯¥è®°å½•WARNINGæ—¥å¿—ï¼š"èµ„é‡‘ä¸è¶³ï¼Œè·³è¿‡ä¹°å…¥ä¿¡å·"
   - **ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸é˜»å¡å›æµ‹**
   - ç»§ç»­å¤„ç†åç»­ä¿¡å·

2. **å¼‚å¸¸æƒ…å†µ**:
   - `available_capital` **ä¸åº”è¯¥**ä¸ºè´Ÿå€¼
   - å¦‚æœå‡ºç°è´Ÿå€¼ï¼Œè¯´æ˜èµ„é‡‘ç®¡ç†é€»è¾‘æœ‰bug

### 1.4 é‡åŒ–æ­£ç¡®æƒ…å†µ

**æ­£ç¡®æƒ…å†µåº”è¯¥æ»¡è¶³**ï¼š

| ç»´åº¦ | æ­£ç¡®è¡Œä¸º | å½“å‰å®é™… |
|------|---------|---------|
| **å–å‡ºåèµ„é‡‘é‡Šæ”¾** | âœ… `available_capital` å¢åŠ  | âŒ å¯èƒ½æœªå¢åŠ  |
| **èµ„é‡‘å®ˆæ’** | âœ… å§‹ç»ˆæ»¡è¶³å®ˆæ’å…¬å¼ | âŒ å¯èƒ½è¿å |
| **èµ„é‡‘ä¸è¶³å¤„ç†** | âœ… è®°å½•WARNINGï¼Œç»§ç»­å›æµ‹ | âŒ å¯èƒ½æŠ›å‡ºå¼‚å¸¸ |
| **æ—¥å¿—å¯è§æ€§** | âœ… æ˜¾ç¤ºä¹°å…¥/å–å‡ºæ—¶é—´å’Œå…³è” | âŒ æ—¥å¿—ä¸å®Œæ•´ |

### 1.5 æ ¸å¿ƒé—®é¢˜å®šä¹‰

**é—®é¢˜é™ˆè¿°**:
å›æµ‹æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ`available_capital` å˜ä¸ºè´Ÿå€¼ï¼ˆ-100 USDTï¼‰ï¼Œå¯¼è‡´åç»­ä¹°å…¥å¤±è´¥å¹¶æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢å›æµ‹ã€‚

**é¢„æœŸè¡Œä¸º**:
1. å–å‡ºè®¢å•åï¼Œ`available_capital` åº”è¯¥å¢åŠ ï¼ˆæœ¬é‡‘+ç›ˆäºï¼‰
2. èµ„é‡‘ä¸è¶³æ—¶åº”è®°å½•WARNINGå¹¶è·³è¿‡ï¼Œä¸åº”ç»ˆæ­¢å›æµ‹
3. æ—¥å¿—åº”æ˜¾ç¤ºå–å‡ºæ—¶é—´å’Œå…³è”çš„ä¹°å…¥è®¢å•

**å®é™…è¡Œä¸º**:
1. å–å‡ºåèµ„é‡‘å¯èƒ½æœªæ­£ç¡®é‡Šæ”¾
2. èµ„é‡‘ä¸è¶³æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸
3. æ—¥å¿—ç¼ºå°‘å–å‡ºæ—¶é—´å’Œä¹°å…¥å…³è”ä¿¡æ¯

---

## ğŸ” ç¬¬äºŒé˜¶æ®µï¼šé—®é¢˜ç°è±¡æè¿°

### 2.1 å¤ç°æ­¥éª¤

**æ‰§è¡Œå‘½ä»¤**:
```bash
python manage.py run_strategy_backtest ETHUSDT \
  --start-date 2025-01-06 \
  --end-date 2026-01-06 \
  --interval 4h \
  --market-type futures \
  --initial-cash 10000
```

**é¢„æœŸç»“æœ**: å›æµ‹å®Œæˆï¼Œèµ„é‡‘ä¸è¶³æ—¶è·³è¿‡è®¢å•
**å®é™…ç»“æœ**: å›æµ‹ç»ˆæ­¢ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹

### 2.2 é”™è¯¯æ—¥å¿—

```
[INFO] åˆ›å»ºè®¢å•: order_1744099200000, ç­–ç•¥: DDPS-Z, ä»·æ ¼: 1588.32
[ERROR] å›æµ‹å¤±è´¥: available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: -100
Traceback (most recent call last):
  File "strategy_adapter/management/commands/run_strategy_backtest.py", line 171, in handle
    result = adapter.adapt_for_backtest(klines_df, indicators)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "strategy_adapter/core/strategy_adapter.py", line 174, in adapt_for_backtest
    order = self.order_manager.create_order(
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "strategy_adapter/core/unified_order_manager.py", line 123, in create_order
    raise ValueError(f"available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: {available_capital}")
ValueError: available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: -100
```

**å…³é”®å‘ç°**:
- åœ¨åˆ›å»ºç¬¬100+ä¸ªè®¢å•æ—¶ï¼Œ`available_capital` å˜ä¸º -100
- æ¯ä¸ªè®¢å•å›ºå®šæˆæœ¬100 USDT
- åˆå§‹èµ„é‡‘10000 USDTï¼Œç†è®ºä¸Šæœ€å¤šå¯æ”¯æŒ100ä¸ªè®¢å•
- è¯´æ˜ä¹‹å‰å·²ç»åˆ›å»ºäº†100+ä¸ªè®¢å•ï¼Œä½†å–å‡ºåèµ„é‡‘æœªé‡Šæ”¾

### 2.3 å½±å“èŒƒå›´

- **å½±å“åŠŸèƒ½**: ç­–ç•¥å›æµ‹åŠŸèƒ½ï¼ˆè¿­ä»£013ï¼‰
- **å—å½±å“ç”¨æˆ·**: å¼€å‘è€…æœ¬äºº
- **æ•°æ®å‡†ç¡®æ€§**: å›æµ‹æ— æ³•å®Œæˆï¼Œç»Ÿè®¡æ•°æ®ä¸å®Œæ•´
- **åç»­å½±å“**: æ— æ³•éªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§

### 2.4 ä¸¥é‡ç¨‹åº¦è¯„ä¼°

- **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
- **ç†ç”±**:
  1. èµ„é‡‘ç®¡ç†é€»è¾‘é”™è¯¯ï¼Œæ ¸å¿ƒåŠŸèƒ½å¤±æ•ˆ
  2. å¯¼è‡´å›æµ‹æ— æ³•å®Œæˆï¼Œé˜»å¡ç­–ç•¥éªŒè¯
  3. å¯èƒ½å½±å“æ‰€æœ‰ç­–ç•¥çš„å›æµ‹å‡†ç¡®æ€§

---

## ğŸ”¬ ç¬¬ä¸‰é˜¶æ®µï¼šä¸‰å±‚ç«‹ä½“è¯Šæ–­åˆ†æ

### 3.1 è¡¨ç°å±‚è¯Šæ–­

**âŒ ä¸é€‚ç”¨** - æ­¤é—®é¢˜ä¸æ¶‰åŠUI/å‰ç«¯è¡¨ç°

### 3.2 é€»è¾‘å±‚è¯Šæ–­ï¼ˆæ ¸å¿ƒè¯Šæ–­ï¼‰

#### å‡è®¾1ï¼šå–å‡ºåæœªé‡Šæ”¾èµ„é‡‘ ğŸ¯ **æ ¹å› ç¡®è®¤**

**è¯Šæ–­ç›®æ ‡**: æ£€æŸ¥èµ„é‡‘ç®¡ç†é€»è¾‘

**ä»£ç åˆ†æ**:

**ä½ç½®**: `strategy_adapter/core/strategy_adapter.py:177-178`

```python
# æ›´æ–°å¯ç”¨èµ„é‡‘ï¼ˆç®€åŒ–å¤„ç†ï¼šä¸è€ƒè™‘å–å‡ºåèµ„é‡‘å›æµï¼‰
available_capital -= order.position_value
```

**è¯æ®é“¾**:

1. âœ… **ä¹°å…¥æ—¶æ‰£é™¤èµ„é‡‘**ï¼ˆç¬¬171-178è¡Œï¼‰:
   ```python
   available_capital = initial_cash  # åˆå§‹10000 USDT
   for signal in buy_signals:
       order = self.order_manager.create_order(...)
       available_capital -= order.position_value  # æ¯æ¬¡æ‰£é™¤100 USDT
   ```

2. âŒ **å–å‡ºæ—¶æœªé‡Šæ”¾èµ„é‡‘**ï¼ˆç¬¬194-198è¡Œï¼‰:
   ```python
   for signal in sell_signals:
       self.order_manager.update_order(signal['order_id'], signal)
       # âŒ ç¼ºå¤±ï¼šavailable_capital += (order.position_value + order.profit_loss)
   ```

3. **èµ„é‡‘æµè½¬éªŒè¯**:
   - åˆå§‹èµ„é‡‘ï¼š10000 USDT
   - æ¯ä¸ªè®¢å•ï¼š100 USDT
   - æœ€å¤šæ”¯æŒï¼š100ä¸ªè®¢å•
   - å®é™…ä¹°å…¥ä¿¡å·ï¼š228ä¸ª
   - **ç¬¬101ä¸ªè®¢å•æ—¶**ï¼š`available_capital = 10000 - 100Ã—100 = 0`
   - **ç¬¬102ä¸ªè®¢å•æ—¶**ï¼š`available_capital = 0 - 100 = -100` âŒ è§¦å‘å¼‚å¸¸

**ç»“è®º**: âœ… **æ ¹å› ç¡®è®¤ï¼** å–å‡ºåæœªé‡Šæ”¾èµ„é‡‘ï¼Œå¯¼è‡´å¯ç”¨èµ„é‡‘æŒç»­å‡å°‘è‡³è´Ÿå€¼ã€‚

#### å‡è®¾2ï¼šèµ„é‡‘ä¸è¶³æ—¶æŠ›å‡ºå¼‚å¸¸ ğŸ¯ **æ¬¡è¦é—®é¢˜**

**è¯Šæ–­ç›®æ ‡**: æ£€æŸ¥èµ„é‡‘ä¸è¶³çš„å¼‚å¸¸å¤„ç†

**ä»£ç åˆ†æ**:

**ä½ç½®**: `strategy_adapter/core/unified_order_manager.py:122-123`

```python
if available_capital < 0:
    raise ValueError(f"available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: {available_capital}")
```

**é—®é¢˜åˆ†æ**:
- å½“ `available_capital < 0` æ—¶ï¼Œ**ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢å›æµ‹**
- åº”è¯¥æ”¹ä¸ºè®°å½•WARNINGï¼Œè·³è¿‡è®¢å•ï¼Œç»§ç»­å›æµ‹

**ç»“è®º**: âœ… **ç¡®è®¤æ¬¡è¦é—®é¢˜**ï¼šèµ„é‡‘ä¸è¶³æ—¶åº”è¯¥é™çº§å¤„ç†ï¼Œè€Œéç»ˆæ­¢å›æµ‹ã€‚

### 3.3 æ•°æ®å±‚è¯Šæ–­

**è¯Šæ–­ç›®æ ‡**: éªŒè¯Orderå¯¹è±¡çš„ç›ˆäºè®¡ç®—æ˜¯å¦æ­£ç¡®

**å…³é”®ä»£ç **: `strategy_adapter/models/order.py` (Order.calculate_pnl())

**éªŒè¯**:
```python
# UnifiedOrderManager.update_order() ç¬¬227è¡Œ
order.calculate_pnl()  # âœ… ç›ˆäºè®¡ç®—æ­£ç¡®
```

**ç»“è®º**: âœ… æ•°æ®å±‚æ­£å¸¸ï¼Œç›ˆäºè®¡ç®—é€»è¾‘æ­£ç¡®

### 3.4 ä¸‰å±‚è”åŠ¨éªŒè¯

#### è·¨å±‚ä¸€è‡´æ€§æ£€æŸ¥

| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ |
|------|------|------|
| è¡¨ç°å±‚ | - | N/A |
| é€»è¾‘å±‚ | èµ„é‡‘æ‰£é™¤ï¼ˆä¹°å…¥ï¼‰ | âœ… æ­£ç¡® |
| é€»è¾‘å±‚ | èµ„é‡‘é‡Šæ”¾ï¼ˆå–å‡ºï¼‰ | âŒ **ç¼ºå¤±** |
| é€»è¾‘å±‚ | èµ„é‡‘ä¸è¶³å¤„ç† | âŒ **å¼‚å¸¸ç»ˆæ­¢** |
| æ•°æ®å±‚ | ç›ˆäºè®¡ç®— | âœ… æ­£ç¡® |

#### åå‘æ’é™¤éªŒè¯

âŒ **æ’é™¤å‡è®¾**: Orderç›ˆäºè®¡ç®—é”™è¯¯ï¼ˆå·²éªŒè¯æ­£ç¡®ï¼‰
âŒ **æ’é™¤å‡è®¾**: æ•°æ®å±‚é—®é¢˜ï¼ˆé€»è¾‘å±‚æœªè°ƒç”¨èµ„é‡‘å›æµï¼‰
âœ… **ç¡®è®¤å‡è®¾**: å–å‡ºåæœªé‡Šæ”¾èµ„é‡‘ï¼ˆ**ä¸»è¦æ ¹å› **ï¼‰
âœ… **ç¡®è®¤å‡è®¾**: èµ„é‡‘ä¸è¶³ç›´æ¥å¼‚å¸¸ï¼ˆ**æ¬¡è¦é—®é¢˜**ï¼‰

#### æ•´ä½“æ£€æŸ¥

**è¯æ®é“¾æ±‡æ€»**:
1. âœ… ä»£ç æ³¨é‡Šæ˜ç¡®è¯´æ˜ï¼š"ä¸è€ƒè™‘å–å‡ºåèµ„é‡‘å›æµ"
2. âœ… ç¬¬101ä¸ªè®¢å•æ—¶èµ„é‡‘è€—å°½
3. âœ… èµ„é‡‘ä¸è¶³æ—¶æŠ›å‡ºå¼‚å¸¸è€Œéé™çº§å¤„ç†
4. âœ… æ—¥å¿—æœªæ˜¾ç¤ºå–å‡ºæ—¶é—´å’Œä¹°å…¥å…³è”

**ç»“è®º**:
ğŸ¯ **æ ¹å› ç¡®è®¤**:
1. **ä¸»è¦æ ¹å› **: å–å‡ºåæœªæ‰§è¡Œèµ„é‡‘å›æµé€»è¾‘ï¼ˆ`available_capital += order.position_value + profit_loss`ï¼‰
2. **æ¬¡è¦é—®é¢˜**: èµ„é‡‘ä¸è¶³æ—¶åº”é™çº§å¤„ç†è€Œéç»ˆæ­¢å›æµ‹
3. **æ”¹è¿›éœ€æ±‚**: æ—¥å¿—éœ€è¦æ˜¾ç¤ºå–å‡ºæ—¶é—´å’Œä¹°å…¥å…³è”

---

## ğŸ”§ ç¬¬å››é˜¶æ®µï¼šä¿®å¤æ–¹æ¡ˆç¡®è®¤

### 4.1 æ–¹æ¡ˆé€‰é¡¹

#### æ–¹æ¡ˆ1ï¼šåœ¨å–å‡ºå¾ªç¯ä¸­é‡Šæ”¾èµ„é‡‘ï¼ˆæ¨èï¼‰

**æè¿°**:
åœ¨ `StrategyAdapter.adapt_for_backtest()` æ–¹æ³•çš„å–å‡ºå¾ªç¯ä¸­ï¼Œæ·»åŠ èµ„é‡‘å›æµé€»è¾‘ã€‚

**å®ç°æ­¥éª¤**:

```python
# strategy_adapter/core/strategy_adapter.py

# === æ­¥éª¤5: æ›´æ–°è®¢å•ï¼ˆå¹³ä»“ï¼‰ ===
# æ ¹æ®å–å‡ºä¿¡å·æ›´æ–°è®¢å•çŠ¶æ€ï¼Œè‡ªåŠ¨è®¡ç®—ç›ˆäº
for signal in sell_signals:
    # è·å–è®¢å•å¯¹è±¡
    order = self.order_manager._orders[signal['order_id']]
    
    # æ›´æ–°è®¢å•ï¼ˆå¹³ä»“ï¼‰
    self.order_manager.update_order(signal['order_id'], signal)
    
    # ğŸ†• é‡Šæ”¾èµ„é‡‘ï¼šå½’è¿˜æœ¬é‡‘ + ç›ˆäº
    available_capital += order.position_value + (order.profit_loss or Decimal("0"))
    
    logger.info(f"å¹³ä»“è®¢å•: {signal['order_id']}, "
               f"ä¹°å…¥æ—¶é—´: {order.open_timestamp}, "
               f"å–å‡ºæ—¶é—´: {signal['timestamp']}, "
               f"ç›ˆäº: {order.profit_loss}, "
               f"å‰©ä½™èµ„é‡‘: {available_capital}")
```

**ä¼˜ç‚¹**:
- âœ… é€»è¾‘ç®€å•ï¼Œä¿®æ”¹æœ€å°‘
- âœ… èµ„é‡‘å®ˆæ’å…¬å¼å¾—åˆ°ä¿è¯
- âœ… ä¸ç°æœ‰ä»£ç ç»“æ„ä¸€è‡´
- âœ… æ˜“äºç†è§£å’Œç»´æŠ¤

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦åœ¨æ›´æ–°è®¢å•åè®¿é—®è®¢å•å¯¹è±¡ï¼ˆæœ‰è½»å¾®è€¦åˆï¼‰

**å½±å“è¯„ä¼°**:
- ä»£ç ä¿®æ”¹èŒƒå›´ï¼š1ä¸ªæ–¹æ³•ï¼Œçº¦10è¡Œä»£ç 
- ç ´åæ€§ï¼šâŒ æ— ï¼Œä»…ä¿®æ”¹å†…éƒ¨å®ç°
- å‘åå…¼å®¹ï¼šâœ… å®Œå…¨å…¼å®¹

---

#### æ–¹æ¡ˆ2ï¼šä¿®æ”¹UnifiedOrderManagerè¿”å›èµ„é‡‘å˜åŠ¨

**æè¿°**:
ä¿®æ”¹ `UnifiedOrderManager.update_order()` æ–¹æ³•ï¼Œè¿”å›èµ„é‡‘å˜åŠ¨é‡ï¼Œç”±è°ƒç”¨æ–¹ç®¡ç†èµ„é‡‘ã€‚

**ä¼˜ç‚¹**:
- âœ… è´£ä»»åˆ†ç¦»æ›´æ¸…æ™°

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¿®æ”¹OrderManagerçš„æ¥å£ï¼ˆå¯èƒ½å½±å“å…¶ä»–è°ƒç”¨æ–¹ï¼‰
- âŒ ä¿®æ”¹èŒƒå›´æ›´å¤§

**ç»“è®º**: âŒ ä¸æ¨èï¼ˆè¿‡åº¦è®¾è®¡ï¼‰

---

### 4.2 èµ„é‡‘ä¸è¶³å¤„ç†ä¼˜åŒ–

**é—®é¢˜**: èµ„é‡‘ä¸è¶³æ—¶æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢å›æµ‹

**ä¿®å¤æ–¹æ¡ˆ**:

```python
# strategy_adapter/core/strategy_adapter.py

# === æ­¥éª¤2: åˆ›å»ºè®¢å• ===
available_capital = initial_cash
for signal in buy_signals:
    current_price = Decimal(str(signal['price']))
    position_size = self.strategy.calculate_position_size(
        signal, available_capital, current_price
    )
    
    # ğŸ†• èµ„é‡‘ä¸è¶³æ—¶è·³è¿‡è®¢å•ï¼ˆé™çº§å¤„ç†ï¼‰
    if position_size <= 0 or available_capital < position_size:
        logger.warning(f"èµ„é‡‘ä¸è¶³ï¼Œè·³è¿‡ä¹°å…¥ä¿¡å·: timestamp={signal['timestamp']}, "
                      f"æ‰€éœ€èµ„é‡‘={position_size}, å¯ç”¨èµ„é‡‘={available_capital}")
        continue
    
    order = self.order_manager.create_order(
        signal, self.strategy, current_price, available_capital, symbol
    )
    available_capital -= order.position_value
```

**åŒæ—¶**ï¼šç§»é™¤ `UnifiedOrderManager.create_order()` ä¸­çš„å¼‚å¸¸æŠ›å‡º

```python
# strategy_adapter/core/unified_order_manager.py:122-123

# âŒ åˆ é™¤è¿™è¡Œï¼ˆä¸å†éœ€è¦ï¼‰
# if available_capital < 0:
#     raise ValueError(f"available_capitalä¸èƒ½ä¸ºè´Ÿï¼Œå½“å‰å€¼: {available_capital}")
```

---

### 4.3 æ—¥å¿—æ”¹è¿›

**éœ€æ±‚**: æ—¥å¿—éœ€è¦æ˜¾ç¤ºå–å‡ºæ—¶é—´å’Œä¹°å…¥å…³è”

**å®ç°**:

```python
# åœ¨ StrategyAdapter.adapt_for_backtest() çš„å–å‡ºå¾ªç¯ä¸­

logger.info(f"å¹³ä»“è®¢å•: {signal['order_id']}, "
           f"ä¹°å…¥æ—¶é—´: {pd.Timestamp(order.open_timestamp, unit='ms', tz='UTC')}, "
           f"å–å‡ºæ—¶é—´: {pd.Timestamp(signal['timestamp'], unit='ms', tz='UTC')}, "
           f"æŒä»“å‘¨æœŸ: {(signal['timestamp'] - order.open_timestamp) / 3600000:.1f}å°æ—¶, "
           f"ç›ˆäº: {order.profit_loss} USDT ({order.profit_loss_rate}%)")
```

---

### 4.4 æ¨èæ–¹æ¡ˆ

âœ… **ç»¼åˆæ–¹æ¡ˆï¼šæ–¹æ¡ˆ1 + èµ„é‡‘ä¸è¶³ä¼˜åŒ– + æ—¥å¿—æ”¹è¿›**

**ç†ç”±**:
1. ä¿®æ”¹èŒƒå›´æœ€å°ï¼Œé€»è¾‘æœ€æ¸…æ™°
2. å®Œå…¨è§£å†³ä¸»è¦é—®é¢˜ï¼ˆèµ„é‡‘å›æµï¼‰
3. æ”¹è¿›ç”¨æˆ·ä½“éªŒï¼ˆèµ„é‡‘ä¸è¶³æ—¶é™çº§å¤„ç†ï¼‰
4. æå‡å¯è§‚æµ‹æ€§ï¼ˆå®Œæ•´æ—¥å¿—ï¼‰

**ä¿®æ”¹æ–‡ä»¶**:
- `strategy_adapter/core/strategy_adapter.py` (ä¸»è¦ä¿®å¤)
- `strategy_adapter/core/unified_order_manager.py` (ç§»é™¤å¼‚å¸¸æ£€æŸ¥)

---

## âœ… ç¬¬äº”é˜¶æ®µï¼šç”¨æˆ·ç¡®è®¤

**å¾…ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜**:

1. âœ… æ‚¨åŒæ„ä½¿ç”¨**æ–¹æ¡ˆ1**ï¼ˆåœ¨å–å‡ºå¾ªç¯ä¸­é‡Šæ”¾èµ„é‡‘ï¼‰å—ï¼Ÿ
2. âœ… èµ„é‡‘ä¸è¶³æ—¶æ”¹ä¸ºWARNINGæ—¥å¿—å¹¶è·³è¿‡è®¢å•ï¼Œè¿™æ ·å¤„ç†æ˜¯å¦åˆç†ï¼Ÿ
3. âœ… æ—¥å¿—æ ¼å¼æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼ˆä¹°å…¥æ—¶é—´ã€å–å‡ºæ—¶é—´ã€æŒä»“å‘¨æœŸã€ç›ˆäºï¼‰ï¼Ÿ

**è¯·ç”¨æˆ·ç¡®è®¤åå†è¿›å…¥å®æ–½é˜¶æ®µã€‚**

---

**åˆ›å»ºæ—¶é—´**: 2026-01-06
**æœ€åæ›´æ–°**: 2026-01-06
**è¯Šæ–­äºº**: PowerBy Engineer
**çŠ¶æ€**: âœ… ç­‰å¾…ç”¨æˆ·ç¡®è®¤ä¿®å¤æ–¹æ¡ˆ
