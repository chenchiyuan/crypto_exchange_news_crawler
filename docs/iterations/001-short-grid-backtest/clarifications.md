# 需求澄清记录 (Clarifications Record)

**迭代编号**：001
**迭代名称**：做空网格回测系统
**生成时间**：2025-12-19
**状态**：已完成（P1阶段无待澄清项）

---

## 澄清过程概述

本文档记录了P1需求定义+澄清阶段的所有决策点和澄清过程。通过多轮对话，所有模糊需求已明确，待决策清单已清空。

---

## 澄清轮次记录

### 第1轮：初始需求收集（2025-12-19）

**用户原始需求**：
> "实现做空网格回测功能，支持指定交易对、网格方向、范围、时间。使用1分钟K线数据，生成回测报告，支持回放。"

**AI提出的澄清问题**：
1. 网格范围如何定义？（手动指定 vs 动态计算）
2. 做空网格的交易逻辑是什么？（经典网格 vs 首次建仓分批平仓）
3. 仓位如何分配？（等额 vs 马丁格尔）
4. 触发判断的精确逻辑？（区间包含 vs 收盘价触发）
5. 止损/止盈规则是什么？

---

### 第2轮：关键决策确认（2025-12-19）

#### 决策点A：网格范围定义方式

**问题**：用户如何指定网格范围？

**用户反馈**：
> 选择方案A1：手动指定上下界 + 网格数量

**澄清结果**：
- **输入参数**：
  - `price_upper`：价格上界（做空起始价），如2000 USDT
  - `price_lower`：价格下界（做空结束价），如1800 USDT
  - `grid_count`：网格数量，如10
- **计算方式**：等间距网格，`grid_spacing = (upper - lower) / count`
- **输出**：11个网格价格点（含边界）

**不采纳方案**：
- 方案A2：手动指定 + 百分比间距（复杂度高）
- 方案A3：复用现有动态计算（仅4层级，不适合回测）

---

#### 决策点B：做空网格交易逻辑

**问题**：做空网格的开仓/平仓逻辑如何设计？

**用户反馈**：
> 选择方案B1：经典网格 - 每个网格独立开平

**澄清结果**：
- **开仓规则**：价格上升触及某网格 → 在该网格卖出开空
- **平仓规则**：价格下降触及下一网格 → 买入平仓上一层空单
- **核心原理**：高抛低吸，多次获利
- **优势**：
  - 真正的网格交易本质
  - 仓位管理灵活，风险分散
  - 适合1分钟K线频繁触发

**不采纳方案**：
- 方案B2：首次建仓 + 分批平仓（只有一次开仓机会，不符合网格精神）

---

#### 决策点C：仓位分配方式

**问题**：总资金如何分配到各网格？

**用户反馈**：
> 选择方案C1：等额分配

**澄清结果**：
- **计算公式**：`position_size_per_grid = total_capital / grid_count`
- **示例**：总资金10000 USDT，10个网格，每网格1000 USDT
- **优势**：简单可控，风险均衡

**不采纳方案**：
- 方案C2：马丁格尔加倍（风险过高，MVP不适合）

---

#### 决策点D：1分钟K线触发判断逻辑

**问题**：如何判断价格是否触及网格？

**用户反馈**：
> 选择方案D1：区间包含判断 `low <= grid_price <= high`

**澄清结果**：
- **判断逻辑**：如果1分钟K线的[low, high]区间包含网格价格，视为触发
- **用户明确表述**："这一分钟K线包含目标网格价格即视为触发"
- **精度处理**：使用Decimal类型避免浮点数误差
- **边界情况**：单根K线触及多个网格时，按价格顺序依次处理

**不采纳方案**：
- 方案D2：收盘价触发（丢失K线内部价格波动信息）

---

#### 决策点E：止损/止盈规则

**问题**：何时触发止损？是否需要额外止盈逻辑？

**用户反馈**：
> 同意建议的默认值

**澄清结果**：

**止损规则**：
- **触发条件**：价格突破 `price_upper × (1 + stop_loss_pct)`
- **默认止损比例**：2%
- **执行动作**：立即平掉所有未平仓空单，记录止损事件

**止盈规则**：
- **方式**：自然完成（无需额外逻辑）
- **说明**：当价格下跌到price_lower时，所有网格空单已逐层平仓完毕

**回测结束强制平仓**：
- **时刻**：最后一根K线
- **动作**：以收盘价平掉所有剩余持仓
- **标记**：记录为"超时平仓"事件

---

### 第3轮：细节补充（2025-12-19）

#### 澄清点F：默认交易对

**问题**：默认交易对使用哪个？

**用户反馈**：
> "默认交易对使用ethusdt，我更加熟悉。"

**澄清结果**：
- **默认值**：ETHUSDT
- **原因**：用户更熟悉ETH价格波动，便于快速验证回测逻辑

---

#### 澄清点G：网格机制量化定义的必要性

**问题**：是否需要明确量化定义网格机制？

**用户反馈**：
> "功能点需要明确定义网格实现机制，现有网格机制不一定符合需求。必须量化清晰描述。"

**澄清结果**：
- AI在PRD第二章节提供了完整的量化定义（共7个子章节）
- 包含：
  - 网格范围与价格序列生成算法
  - 开仓/平仓规则的伪代码
  - 仓位分配计算公式
  - 触发判断的Decimal实现
  - 止损/止盈的触发条件
  - 手续费计算示例
  - 持仓状态追踪数据结构
- **用户确认**："其他无问题，可以进行下一步"

---

## 待决策清单（当前状态：已清空）

| 决策点ID | 问题描述 | 状态 | 决策结果 | 确认时间 |
|---------|---------|------|---------|---------|
| A | 网格范围定义方式 | ✅ 已决策 | 方案A1：手动指定 + 网格数量 | 2025-12-19 |
| B | 做空网格交易逻辑 | ✅ 已决策 | 方案B1：经典网格独立开平 | 2025-12-19 |
| C | 仓位分配方式 | ✅ 已决策 | 方案C1：等额分配 | 2025-12-19 |
| D | 触发判断逻辑 | ✅ 已决策 | 方案D1：区间包含 | 2025-12-19 |
| E | 止损/止盈规则 | ✅ 已决策 | 止损2%，止盈自然完成 | 2025-12-19 |
| F | 默认交易对 | ✅ 已决策 | ETHUSDT | 2025-12-19 |

**结论**：所有待决策项已确认，无剩余模糊需求。

---

## MVP功能范围确认

### 包含的功能（P0）

✅ **回测参数配置**：
- 交易对选择（默认ETHUSDT）
- 网格方向固定（做空）
- 网格范围设定（手动指定上下界和网格数）
- 回测时间段选择（≤90天）
- 止损比例设定（默认2%）

✅ **K线数据管理**：
- 1分钟K线本地缓存（Binance API → PostgreSQL）
- K线数据查询接口（返回DataFrame）
- 缓存数据验证（自动补全缺失数据）

✅ **做空策略执行模拟**：
- 网格价格序列生成（等间距）
- 区间包含触发判断（Decimal精度）
- 卖出开空模拟
- 买入平仓模拟
- 持仓状态追踪
- 重复开仓防护
- 等额仓位分配
- 手续费计算（0.1%）
- Decimal精度处理

✅ **回测结果计算**：
- 总盈亏计算
- 网格触发次数统计
- 收益率计算
- 手续费统计
- 止损触发记录

✅ **Web报告生成**：
- 独立HTML页面生成
- K线图表展示（ECharts）
- 网格线叠加
- 开仓/平仓标记
- 盈亏汇总表格

✅ **回放功能**：
- 时间轴控制
- 开平仓事件高亮
- 持仓状态实时显示

### 不包含的功能（P1推迟）

❌ **推迟到后续迭代**：
- 做多方向网格
- 多交易对批量回测
- 滑点模拟
- 动态手续费率
- 高级风险指标（最大回撤、夏普比率）
- 交互式图表（zoom, hover）
- 播放速度调节
- 大数据量性能优化（按需）

**推迟理由**：
- 用户明确表示"上面聊到的方案和优先级符合我需求"
- MVP优先验证核心逻辑正确性，避免过度设计

---

## 核心假设验证

### 假设1：1分钟K线足够模拟真实触发

**假设内容**：使用1分钟K线的[low, high]区间判断触发，能够足够接近真实tick数据。

**用户确认**：
> "回测最好是基于tick数据，但是我手头没有。最贴近的就是1分钟级别k线作为价格模拟了。这是在性能，可信度和可行性之间的平衡。"

**验证方式**：
- 通过回测结果判断：如果1分钟K线回测结果与实盘表现差异过大，则升级到tick数据
- MVP阶段先用1分钟K线验证逻辑，后续可优化

---

### 假设2：等额仓位分配适合网格策略

**假设内容**：总资金平均分配到所有网格，能够平衡收益和风险。

**用户确认**：同意采用等额分配（方案C1）

**验证方式**：
- 通过多组回测对比不同仓位分配策略的效果
- MVP先用等额分配，后续可扩展为可配置策略

---

### 假设3：2%止损比例合理

**假设内容**：止损比例设为2%，能够在控制风险和避免频繁止损之间取得平衡。

**用户确认**：同意默认2%（可调整）

**验证方式**：
- 用户通过回测结果判断止损触发频率是否合理
- MVP提供可调整接口，后续可根据实际情况优化

---

## 技术约束澄清

### 约束1：1分钟K线数据量

**问题**：1分钟K线数据量巨大（1天=1440根），是否会影响性能？

**用户反馈**：
> "1分钟k线数据需要缓存在本地，其他均为本地模拟计算，不存在严重的性能问题。"

**解决方案**：
- 本地PostgreSQL缓存所有1分钟K线数据
- 回测计算纯内存操作，性能目标：10天（14400根）< 30秒

---

### 约束2：Web报告文件大小

**问题**：回测数据内联到HTML中，文件是否会过大？

**解决方案**：
- MVP采用方案A（数据内联），满足"独立HTML文件"需求
- 性能目标：10天回测HTML文件 < 50MB
- 如发现文件过大，后续可引入数据分页/懒加载（P1推迟）

---

## 用户明确表述记录

以下是用户在澄清过程中的明确表述，记录在此以便开发时参考：

1. **关于1分钟K线的重要性**：
   > "回测最好是基于tick数据，但是我手头没有。最贴近的就是1分钟级别k线作为价格模拟了。这是在性能，可信度和可行性之间的平衡。"

2. **关于触发判断**：
   > "价格触发，这一分钟线包含目标网格价格即视为触发"

3. **关于性能问题**：
   > "1分钟k线数据需要缓存在本地，其他均为本地模拟计算，不存在严重的性能问题。"

4. **关于默认交易对**：
   > "默认交易对使用ethusdt，我更加熟悉。"

5. **关于方案确认**：
   > "上面聊到的方案和优先级符合我需求"

6. **关于量化定义**：
   > "功能点需要明确定义网格实现机制，现有网格机制不一定符合需求。必须量化清晰描述。"

7. **关于进入下一阶段**：
   > "其他无问题，可以进行下一步"

---

## 澄清完成标记

✅ **P1阶段澄清已完成**

- 所有待决策项已确认（6个决策点）
- 所有核心假设已验证（3个假设）
- 所有技术约束已澄清（2个约束）
- MVP功能范围已明确（21个P0功能点，10个P1推迟）
- PRD已包含完整的量化定义（网格机制7个子章节）

**下一步**：进入P3技术调研阶段（如需要）或直接P5开发规划。

---

**文档结束**
