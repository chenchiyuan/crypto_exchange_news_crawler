# 需求澄清记录 - K线批量更新增强

**迭代编号**: 003
**迭代名称**: K线批量更新增强
**创建日期**: 2024-12-24
**版本**: v1.0.0

---

## 📋 澄清事项总览

| 编号 | 澄清事项 | 状态 | 优先级 |
|------|----------|------|--------|
| C1 | 批量更新的默认行为 | ✅ 已澄清 | P0 |
| C2 | 强制更新的安全机制 | ✅ 已澄清 | P0 |
| C3 | 增量更新的数据源判断 | ✅ 已澄清 | P0 |
| C4 | 默认获取的K线数量 | ✅ 已澄清 | P0 |

---

## 澄清事项详情

### C1: 批量更新的默认行为

**问题背景**：
用户需求提到"默认支持扫描所有交易对"，但未明确以下细节：
1. 是否需要新增 `--all` 参数来显式触发批量更新？
2. 还是不指定 `--symbol` 时自动批量更新？
3. 如何确保不破坏现有用法（必须指定 `--symbol`）？

**澄清过程**：
根据用户需求"默认支持扫描所有交易对"和"信息更新需要复用已有的数据结构和服务"，推断：
- **目标**：最大化自动化，减少手动操作
- **兼容性**：保持现有 `--symbol` 用法不变

**澄清结论**：
✅ **采用方案**：
- **不指定 `--symbol` 时**：自动批量更新所有 active 合约
- **指定 `--symbol` 时**：只更新该交易对（向后兼容）
- **不新增 `--all` 参数**：简化用法，避免参数冗余

**实现细节**：
```python
def handle(self, *args, **options):
    symbol = options.get('symbol')

    if symbol:
        # 单个交易对更新（向后兼容）
        self._update_single_symbol(symbol, ...)
    else:
        # 批量更新所有合约（新增功能）
        self._update_all_symbols(...)
```

**用户影响**：
- ✅ **现有用户**：完全兼容，无需修改脚本
- ✅ **新用户**：更简单，不需要指定 `--symbol` 即可批量更新

---

### C2: 强制更新的安全机制

**问题背景**：
用户需求提到"支持force参数，可以忽略缓存，强制更新全部数据"，但未明确：
1. 强制更新是否需要确认提示（避免误删数据）？
2. 是否支持批量强制更新（删除所有合约的数据）？
3. 删除范围如何界定（只删除指定 interval 还是所有 interval）？

**澄清过程**：
考虑到数据安全性和用户体验：
- **生产环境风险**：强制更新会删除历史数据，需要谨慎
- **批量操作风险**：批量强制更新可能删除大量数据
- **用户意图**：主要用于修复脏数据或测试场景

**澄清结论**：
✅ **采用方案**：
1. **显示警告信息**：删除数据前输出警告（非交互式确认，避免cron任务阻塞）
2. **支持批量强制更新**：允许 `--force` + 不指定 `--symbol`
3. **删除范围**：只删除指定 `interval` 的数据（精确控制）

**实现细节**：
```python
if force:
    # 显示警告
    self.stdout.write(
        self.style.WARNING(
            f"⚠️  强制更新模式：将删除 {symbol} {interval} 的所有现有数据"
        )
    )

    # 删除数据
    deleted_count = KLine.objects.filter(
        symbol=symbol,
        interval=interval
    ).delete()[0]

    self.stdout.write(f"已删除 {deleted_count} 条历史数据")
```

**安全建议**：
- ⚠️ **生产环境**：建议先备份数据库再使用 `--force`
- ⚠️ **批量强制更新**：极少使用，仅用于重置环境

---

### C3: 增量更新的数据源判断

**问题背景**：
用户需求提到"数据支持增量更新"，但未明确：
1. 如何判断哪些数据需要更新？
2. 是基于数据库最新时间还是固定时间窗口？
3. 如果数据库数据缺口怎么处理？

**澄清过程**：
根据现有 `DataFetcher.update_latest_data()` 实现：
```python
def update_latest_data(self, limit: int = 100) -> int:
    # 获取最新limit条数据
    kline_data_list = fetch_klines(
        symbol=self.symbol,
        interval=self.interval,
        limit=limit
    )
    # _save_klines() 通过 open_time 唯一性检查防止重复
    saved_count = self._save_klines(kline_data_list)
```

**澄清结论**：
✅ **采用方案**：
- **增量更新逻辑**：调用 `update_latest_data(limit)`，获取最新 N 条数据
- **去重机制**：`_save_klines()` 通过 `open_time` 唯一性检查，只插入新数据
- **数据缺口**：不主动检测缺口（延后到 P1-F2）

**实现细节**：
```python
# 现有实现已支持增量更新
fetcher = DataFetcher(symbol, interval)
saved_count = fetcher.update_latest_data(limit=limit)
```

**优势**：
- ✅ **简单可靠**：复用现有实现，无需重复开发
- ✅ **性能优化**：只获取最新N条，避免全量拉取
- ✅ **数据一致性**：唯一性约束保证无重复

---

### C4: 默认获取的K线数量

**问题背景**：
用户补充需求："默认4h K线获取至少2000根，接近一年的数据"

**业务分析**：
- **4h K线**：每天6根
- **2000根** = 2000 ÷ 6 ≈ 333天 ≈ **11个月数据**
- **业务目的**：确保有足够的历史数据用于技术指标计算（如MA、OBV等需要较长周期）

**澄清结论**：
✅ **采用方案**：
- **默认limit值**：`2000`（针对所有周期，统一标准）
- **覆盖范围**：
  - 1h: 2000根 ≈ 83天
  - 4h: 2000根 ≈ 333天（接近一年）
  - 1d: 2000根 ≈ 5.5年

**实现细节**：
```python
parser.add_argument(
    '--limit', '-l',
    type=int,
    default=2000,  # 修改默认值从100到2000
    help='获取最新N条，默认2000（4h周期约一年数据）'
)
```

**用户影响**：
- ✅ **首次运行**：自动获取充足的历史数据，无需手动调整
- ✅ **定时任务**：后续增量更新仍然高效（只新增少量数据）
- ⚠️ **执行时间**：首次批量更新时间增加（500个交易对 × 2000根 ≈ 10-15分钟）

**性能考虑**：
- 币安API单次限制1000条，需要分批获取（现有 `_fetch_multiple_batches` 已支持）
- 首次运行耗时长，但后续增量更新仍然快速

---

## 📊 澄清总结

### 关键决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 默认行为 | 不指定 `--symbol` 时批量更新 | 简化用法，最大化自动化 |
| 向后兼容 | 保持 `--symbol` 参数功能 | 不影响现有用户 |
| 默认limit值 | 2000根K线 | 确保充足历史数据（4h约一年） |
| 强制更新警告 | 显示警告但不交互确认 | 支持 cron 任务 |
| 强制更新范围 | 只删除指定 interval 数据 | 精确控制，降低风险 |
| 增量更新实现 | 复用 `update_latest_data()` | 简单可靠，无需重复开发 |

### 风险缓解

| 风险 | 缓解措施 |
|------|----------|
| 批量强制更新误删数据 | 显示警告信息，建议生产环境先备份 |
| API限流导致批量更新失败 | 添加0.1秒延迟，单个失败不影响其他 |
| 数据缺口未检测 | 延后到 P1-F2，先验证核心功能 |

---

## 📝 未解决的问题

**无** - 所有关键模糊点已澄清

---

## 📈 澄清结果对PRD的影响

### PRD更新

| 章节 | 更新内容 |
|------|----------|
| 功能需求 - P0-F1 | 明确默认批量更新行为 |
| 功能需求 - P0-F4 | 明确强制更新的警告机制和范围 |
| 功能需求 - P0-F3 | 明确增量更新复用现有实现 |
| 范围边界 - Out-of-Scope | 明确数据缺口检测延后到 P1 |

---

**文档版本**: v1.0.0
**最后更新**: 2024-12-24
**相关文档**:
- PRD: `docs/iterations/003-klines-batch-update/prd.md`
- 功能点清单: `docs/iterations/003-klines-batch-update/function-points.md`
