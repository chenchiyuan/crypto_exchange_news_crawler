# PRD: DDPS-Z做空策略扩展

**迭代编号**: 015
**迭代名称**: short-strategies
**版本**: v1.0
**状态**: Draft
**创建日期**: 2026-01-06
**最后更新**: 2026-01-06

---

## 1. 背景与目标

### 1.1 背景

当前DDPS-Z回测系统仅支持做多策略（策略1、策略2），无法验证做空策略的有效性。在加密货币合约市场中，做空是重要的盈利手段，特别是在下跌趋势中。

现有架构：
- **策略1（EMA斜率未来预测）**: K线low < P5 且 未来6周期EMA预测 > close → 做多
- **策略2（惯性下跌中值突破）**: β < 0 且 inertia_mid < P5 且 low < (mid+P5)/2 → 做多
- **平多策略**: K线包含EMA25 → 平仓

### 1.2 核心目标

1. **新增做空策略3、4**：与策略1、2形成镜像对称逻辑
2. **支持策略组合回测**：用户可指定使用哪些策略组合
3. **全局资金管理**：多组策略共享同一资金池，仓位互不干扰

---

## 2. 需求详情

### 2.1 做空策略定义

#### 策略3：EMA斜率未来预测做空

镜像策略1的逻辑：

| 维度 | 策略1（做多） | 策略3（做空） |
|------|---------------|---------------|
| 触发条件1 | K线low < P5 | K线high >= P95 |
| 触发条件2 | 未来6周期EMA > close | 未来6周期EMA < close |
| 操作 | 买入（开多） | 卖空（开空） |

**策略3完整定义**：
- 条件：`kline['high'] >= P95` **且** `future_ema < kline['close']`
- 解释：价格冲高至P95压力位以上，但EMA斜率预测未来价格将下跌
- 操作：卖空（开空仓）

#### 策略4：惯性上涨中值突破做空

镜像策略2的逻辑：

| 维度 | 策略2（做多） | 策略4（做空） |
|------|---------------|---------------|
| 前置条件 | β < 0（下跌趋势） | β > 0（上涨趋势） |
| 触发条件1 | inertia_mid < P5 | inertia_mid > P95 |
| 触发条件2 | low < (mid+P5)/2 | high > (mid+P95)/2 |
| 操作 | 买入（开多） | 卖空（开空） |

**策略4完整定义**：
- 前置：`beta > 0`
- 条件：`inertia_mid > P95` **且** `kline['high'] > (inertia_mid + P95) / 2`
- 解释：上涨惯性中，惯性中值已超过P95压力位，价格冲破中值线
- 操作：卖空（开空仓）

#### 平空策略：EMA25回归

与平多策略保持一致：
- 条件：`kline['low'] <= ema25 <= kline['high']`
- 操作：平空（买入平仓）
- 平仓价格：EMA25值

### 2.2 策略组合配置

#### CLI参数设计

```bash
# 默认行为（向后兼容）：使用策略1+2做多
python manage.py run_strategy_backtest ETHUSDT

# 指定做空策略组合
python manage.py run_strategy_backtest ETHUSDT --strategies 3,4

# 混合策略组合
python manage.py run_strategy_backtest ETHUSDT --strategies 1,2,3,4

# 仅策略1
python manage.py run_strategy_backtest ETHUSDT --strategies 1
```

#### 参数定义

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--strategies` | string | `"1,2"` | 逗号分隔的策略ID列表 |

#### 策略ID映射

| ID | 名称 | 类型 | 说明 |
|----|------|------|------|
| 1 | EMA斜率未来预测做多 | long | 现有策略1 |
| 2 | 惯性下跌中值突破做多 | long | 现有策略2 |
| 3 | EMA斜率未来预测做空 | short | 新增 |
| 4 | 惯性上涨中值突破做空 | short | 新增 |

### 2.3 全局资金管理

#### 核心原则

1. **资金池共享**：所有策略共用初始资金（initial_cash）
2. **仓位独立**：每笔订单独立计算仓位价值
3. **多空互不干扰**：做多和做空订单各自独立管理
4. **资金守恒**：`可用资金 + 持仓总价值 = 总权益`

#### 资金流转逻辑

```
开仓时：
  available_capital -= position_size
  持仓列表 += 新订单

平仓时：
  available_capital += position_value + profit_loss
  持仓列表 -= 已平订单
```

#### 做空订单的盈亏计算

做空盈亏计算方式（与做多相反）：
- **做多盈亏**: `(sell_price - buy_price) * quantity - commission`
- **做空盈亏**: `(open_price - close_price) * quantity - commission`

**示例**：
- 开空价格：2000 USDT，平仓价格：1900 USDT，数量：1
- 盈亏：(2000 - 1900) * 1 = +100 USDT（盈利）

### 2.4 指标扩展

#### P95价格线计算

新增P95指标（与P5对称）：
```
P95 = EMA × (1 + z_p95 × ewma_std)
其中 z_p95 = +1.645 对应正态分布95%分位
```

#### 回测报告扩展

需要区分显示多空订单统计：

```
【订单统计】
  总订单数: 25
  ├── 做多订单: 15
  │   ├── 已平仓: 12
  │   └── 持仓中: 3
  └── 做空订单: 10
      ├── 已平仓: 8
      └── 持仓中: 2
```

---

## 3. 技术约束

### 3.1 向后兼容

- 默认`--strategies 1,2`保持现有行为
- 现有回测结果数据结构不变
- Order模型需��展`direction`字段（long/short）

### 3.2 依赖现有组件

- `DDPSService`: 计算EMA、EWMA_STD、β
- `InertiaCalculator`: 计算惯性中值
- `BuySignalCalculator`: 需扩展为`SignalCalculator`支持多空
- `DDPSZStrategy`: 需扩展支持做空信号生成

### 3.3 数据要求

- 需要P95价格序列（目前只有P5）
- 做空只适用于合约市场（`market_type=futures`）

---

## 4. 验收标准

### 4.1 功能验收

| AC-ID | 描述 | 验证方法 |
|-------|------|----------|
| AC-001 | 策略3在high>=P95且future_ema<close时触发 | 单元测试 |
| AC-002 | 策略4在β>0且mid>P95且high>(mid+P95)/2时触发 | 单元测试 |
| AC-003 | 平空在K线包含EMA25时触发 | 单元测试 |
| AC-004 | `--strategies 3,4`仅执行做空策略 | 集成测试 |
| AC-005 | `--strategies 1,2,3,4`同时执行多空策略 | 集成测试 |
| AC-006 | 资金在多空开平仓时正确增减 | 单元测试 |
| AC-007 | 做空盈亏计算正确（开仓价-平仓价） | 单元测试 |
| AC-008 | 默认`--strategies 1,2`保持向后兼容 | 回归测试 |

### 4.2 性能验收

| 指标 | 目标 |
|------|------|
| 4策略组合回测1年数据 | < 60秒 |

---

## 5. 范围边界

### 5.1 本次迭代范围（MVP）

- [x] 策略3、4信号计算器实现
- [x] P95价格序列计算
- [x] Order模型direction字段扩展
- [x] CLI --strategies参数支持
- [x] 做空盈亏计算逻辑
- [x] 全局资金管理（多空共用资金池）

### 5.2 延期功能

- [ ] 做空策略止损/止盈
- [ ] 多空对冲仓位管理
- [ ] 策略权重配置
- [ ] 做空保证金率配置

---

## 6. 风险与依赖

### 6.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Order模型修改影响现有数据 | 中 | 添加默认值`direction='long'` |
| 做空逻辑与做多混淆 | 高 | 清晰命名，单独测试 |

### 6.2 依赖项

| 依赖 | 状态 | 说明 |
|------|------|------|
| DDPSService | 已完成 | 需扩展P95计算 |
| BuySignalCalculator | 已完成 | 需重构为SignalCalculator |
| UnifiedOrderManager | 已完成 | 需支持direction字段 |

---

## 7. 时间线

本PRD不提供时间估算，仅列出实现步骤：

1. Order模型扩展direction字段
2. P95价格序列计算
3. 实现策略3、4信号计算器
4. 扩展DDPSZStrategy支持做空
5. CLI参数--strategies实现
6. 做空盈亏计算逻辑
7. 回测报告多空统计
8. 单元测试和集成测试

---

## 附录：策略对照表

| 维度 | 策略1（做多） | 策略2（做多） | 策略3（做空） | 策略4（做空） |
|------|---------------|---------------|---------------|---------------|
| 名称 | EMA斜率未来预测 | 惯性下跌中值突破 | EMA斜率未来预测 | 惯性上涨中值突破 |
| 类型 | long | long | short | short |
| 前置条件 | - | β < 0 | - | β > 0 |
| 价格条件 | low < P5 | low < (mid+P5)/2 | high >= P95 | high > (mid+P95)/2 |
| 预测条件 | future_ema > close | mid < P5 | future_ema < close | mid > P95 |
| 操作 | 买入开多 | 买入开多 | 卖出开空 | 卖出开空 |
| 平仓 | EMA25回归 | EMA25回归 | EMA25回归 | EMA25回归 |
