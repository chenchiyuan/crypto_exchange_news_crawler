# 需求澄清记录: DDPS-Z做空策略扩展

**迭代编号**: 015
**创建日期**: 2026-01-06

---

## 已确认的需求理解

### Q1: 策略3的触发条件确认

**用户原始描述**:
> 条件：K线最高价 >= P95 价格 且 未来6周期EMA预测价格 < 当前收盘价

**确认理解**:
- 条件1: `kline['high'] >= P95`（价格触及或突破P95压力位）
- 条件2: `future_ema < kline['close']`（EMA斜率预测未来下跌）
- 操作: 卖空（开空仓）

**状态**: ✅ 已确认

---

### Q2: 策略4的触发条件确认

**用户原始描述**:
> 条件：惯性中值(inertia_mid) > P95 且 K线最低价 > (惯性中值 + P95) / 2

**澄清问题**: 用户描述中使用"K线最低价"，但根据策略2的镜像逻辑，应该使用"K线最高价"。

**确认理解**:
- 前置条件: `beta > 0`（上涨趋势）
- 条件1: `inertia_mid > P95`
- 条件2: `kline['high'] > (inertia_mid + P95) / 2`（使用high而非low）
- 操作: 卖空（开空仓）

**澄清原因**:
- 策略2（做多）检测"下跌过度"，使用`low`判断价格跌破支撑
- 策略4（做空）检测"上涨过度"，应使用`high`判断价格突破压力

**状态**: ✅ 已确认（使用high，符合镜像逻辑）

---

### Q3: 平空策略确认

**用户原始描述**:
> 平空策略（EMA25回归）
> 条件：K线价格区间包含EMA25值，即 low <= EMA25 <= high

**确认理解**:
- 与平多策略逻辑完全一致
- 平仓价格: EMA25值
- 触发条件: `kline['low'] <= ema25 <= kline['high']`

**状态**: ✅ 已确认

---

### Q4: 策略组合回测需求

**用户原始描述**:
> run_strategy_backtest 指令需要指定策略回测，目前默认是（策略1+策略2），现在要支持单独测试（策略3+策略4）

**确认理解**:
- 新增`--strategies`参数
- 默认值: `"1,2"`（保持向后兼容）
- 支持任意组合: `"1"`, `"3,4"`, `"1,2,3,4"` 等

**状态**: ✅ 已确认

---

### Q5: 全局资金管理

**用户原始描述**:
> 关键点在于全局的现金仓位管理

**确认理解**:
1. **资金池共享**: 所有策略（无论多空）共用同一个`initial_cash`
2. **仓位独立**: 每笔订单独立计算，互不影响
3. **资金守恒**:
   - 开仓: `available_capital -= position_size`
   - 平仓: `available_capital += position_value + profit_loss`
4. **多空并行**: 可同时持有多头和空头仓位

**状态**: ✅ 已确认

---

## 待确认问题

无待确认问题。

### ~~待确认1: 策略4使用high还是low~~ (已解决)

**结论**: 使用 `high`（符合镜像逻辑）

用户确认原始描述有误，策略4应使用`high`判断价格突破上方压力：
- 策略2（做多）: `low < (mid + P5) / 2` - 检测价格跌破下方支撑
- 策略4（做空）: `high > (mid + P95) / 2` - 检测价格突破上方压力

**确认时间**: 2026-01-06

---

## 设计决策记录

| 决策ID | 决策内容 | 原因 | 日期 |
|--------|----------|------|------|
| D-001 | Order.direction默认值为'long' | 向后兼容现有数据 | 2026-01-06 |
| D-002 | 做空仅支持futures市场 | 现货市场不支持做空 | 2026-01-06 |
| D-003 | 平空逻辑与平多相同（EMA25回归） | 用户明确要求 | 2026-01-06 |
| D-004 | --strategies默认"1,2" | 向后兼容 | 2026-01-06 |
