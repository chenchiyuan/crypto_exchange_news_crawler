# 产品需求文档 (PRD) - 现货交易对支持

**项目名称**: 加密货币量价异常检测系统 - 现货交易对支持扩展
**迭代编号**: 004
**文档版本**: v1.0.0
**创建日期**: 2024-12-25
**生命周期阶段**: P1 - 需求定义+澄清
**创建人**: PowerBy-Product (AI Product Manager)

---

## 一、迭代背景与目标

### 1.1 背景说明

**现状问题**:
- 当前系统（迭代002巨量诱多检测系统 + 迭代003 K线批量更新）**仅支持USDT永续合约**
- 用户在实际使用中发现：**现货市场与合约市场的量价异常表现不一致**
- 具体案例：2025年11月26日，ALLO/USDT现货出现显著的量价异常信号（符合8个检测条件），但当前系统仅扫描合约交易对，**无法捕获现货市场的异常信号**

**用户痛点**:
1. **信号遗漏**：现货市场的异常信号无法被系统检测到
2. **市场覆盖不全**：只监控合约市场，遗漏了现货市场的投资机会/风险
3. **数据割裂**：无法统一分析同一币种在现货和合约两个市场的表现

**业务价值**:
- 扩展系统覆盖范围，从"仅合约"到"合约+现货"双市场支持
- 提升异常信号捕获的全面性，降低信号遗漏风险
- 为用户提供更完整的市场监控能力

### 1.2 迭代目标

**核心目标**: 扩展现有量价异常检测系统，使其能够同时处理**现货交易对**和**合约交易对**的K线数据。

**抽象目标**: **针对所有有K线数据的交易对（无论现货还是合约）进行量价异常分析。**

**具体目标**:
1. ✅ **支持现货K线数据获取** - 新增现货K线数据获取能力（Binance Spot API）
2. ✅ **支持现货数据存储** - 扩展KLine模型，支持存储现货和合约K线数据
3. ✅ **支持现货异常检测** - 将8个检测器扩展到现货交易对
4. ✅ **区分显示结果** - 用户可以分别查看现货和合约的检测结果
5. ✅ **保持向后兼容** - 现有合约检测功能完全不受影响

**非目标 (Out of Scope)**:
- ❌ 不对比现货和合约的差异（未来迭代可考虑）
- ❌ 不调整检测阈值（现货和合约使用相同的8个检测器和阈值）
- ❌ 不支持币安以外的交易所（初期只支持Binance，留扩展点）

---

## 二、需求澄清与确认

### 2.1 澄清问题与用户回答

以下是需求定义阶段与用户进行的关键澄清：

#### 问题1: MVP范围 - 支持哪些现货交易对类型？
**用户回答**: "先只支持USDT本位现货"

**解读**:
- ✅ 支持: USDT-based spot trading pairs (如BTC/USDT, ETH/USDT)
- ❌ 不支持: BTC本位、ETH本位等其他计价单位的现货交易对
- **MVP聚焦**: 与现有合约监控保持一致（合约也是USDT本位）

#### 问题2: 数据源与API - 优先支持哪个交易所？
**用户回答**: "目前只需要支持币安交易对，留下扩展即可"

**解读**:
- ✅ 初期: 只支持Binance Spot API
- 📝 架构要求: 代码设计需要留下扩展点，便于未来支持其他交易所（如OKX、Bybit等）

#### 问题3: 分析方式 - 是否需要同时监控现货和合约？
**用户回答**: "不用同时监控，同币种的现货和合约当成两个分别分析就行。抽象出来就是针对所有有k线的交易对，无论现货合约都能分析。"

**解读**:
- ✅ **核心抽象**: 从"合约检测"抽象为"交易对检测"（trading pair, 不区分现货/合约）
- ✅ **独立分析**: BTC/USDT现货 和 BTCUSDT永续合约 被视为两个独立的交易对
- ❌ **不做对比**: 不需要对比同币种现货和合约的价差、溢价等

#### 问题4: 检测规则 - 现货和合约使用相同的检测规则吗？
**用户回答**: "跟合约使用一套规则，阈值也不用调整"

**解读**:
- ✅ **复用检测器**: 8个检测器（RVOL、Amplitude、Volume Retention等）完全复用
- ✅ **阈值不变**: RVOL ≥ 8x, Amplitude ≥ 3x, Upper Shadow ≥ 50% 等阈值保持不变
- ✅ **三阶段FSM**: Discovery → Confirmation → Validation 状态机流程复用

### 2.2 核心假设与风险

**假设1: 现货和合约的量价特征相似**
- **假设内容**: 现货市场和合约市场的"巨量诱多/弃盘"特征相似，可以使用相同的检测规则
- **验证方式**: 通过历史案例（如ALLO/USDT 2025-11-26）回测验证
- **风险**: 如果特征差异较大，可能需要在后续迭代中分别调整阈值

**假设2: 用户只需要USDT本位现货**
- **假设内容**: USDT本位现货足以满足用户的监控需求
- **验证方式**: 通过用户反馈确认是否需要支持其他计价单位
- **风险**: 如果用户需要BTC本位或其他计价单位，需要扩展数据模型

**假设3: 不需要对比分析**
- **假设内容**: 用户不需要对比同币种现货和合约的差异
- **验证方式**: 通过用户使用反馈确认
- **风险**: 如果用户需要对比分析（如套利机会），需要在后续迭代中新增功能

---

## 三、功能需求定义

### 3.1 核心价值主张

**用户故事**:
> 作为一名量化交易员，我希望能够同时监控现货和合约市场的量价异常信号，以便**全面捕获市场机会和风险**，避免因只监控合约而遗漏现货市场的异常信号。

**核心价值**:
1. **全面性**: 覆盖现货+合约双市场
2. **一致性**: 使用相同的检测规则，保持分析标准一致
3. **灵活性**: 可分别查看现货和合约的检测结果
4. **兼容性**: 不影响现有合约检测功能

### 3.2 功能点清单（MVP）

详细的功能点清单请参阅: `function-points.md`

以下是P0（MVP必须）功能点概览：

#### P0-1: 现货K线数据获取能力
**描述**: 新增从Binance Spot API获取现货K线数据的能力

**核心逻辑**:
- 调用Binance Spot API `/api/v3/klines` 端点
- 支持USDT本位现货交易对（如BTC/USDT, ETH/USDT）
- 支持1h/4h/1d三种周期
- 默认获取2000条历史数据（与合约保持一致）

**验收标准**:
- ✅ 能够成功获取现货K线数据
- ✅ 数据格式与合约K线一致（OHLCV + 其他字段）
- ✅ 支持增量更新（只获取新数据）

#### P0-2: 现货数据存储扩展
**描述**: 扩展KLine模型，支持区分现货和合约数据

**核心逻辑**:
- 在KLine模型中新增 `market_type` 字段（'spot' | 'futures'）
- 调整唯一性约束为 `(symbol, interval, market_type, open_time)`
- 保持向后兼容（现有合约数据自动设置为'futures'）

**验收标准**:
- ✅ 数据库迁移成功，现有数据不受影响
- ✅ 可以同时存储同symbol的现货和合约数据

#### P0-3: 现货交易对列表管理
**描述**: 新增SpotContract模型或扩展现有模型，管理现货交易对列表

**核心逻辑**:
- 类似FuturesContract模型，创建SpotContract模型
- 包含: symbol, current_price, status, first_seen, last_updated
- 支持从Binance API同步现货交易对列表

**验收标准**:
- ✅ 可以通过命令同步现货交易对列表
- ✅ 支持active/delisted状态管理

#### P0-4: 现货异常检测扩展
**描述**: 将8个检测器扩展到现货交易对

**核心逻辑**:
- 检测器代码无需修改（检测逻辑通用）
- 扫描命令需要支持扫描现货交易对
- VolumeTrapMonitor关联到现货交易对

**验收标准**:
- ✅ 能够检测现货交易对的量价异常
- ✅ 三阶段状态机正常工作

#### P0-5: 结果区分显示
**描述**: API支持按市场类型（现货/合约）筛选结果

**核心逻辑**:
- MonitorListAPI 新增 `market_type` 筛选参数
- 前端/CLI可以分别查看现货和合约的监控结果

**验收标准**:
- ✅ API支持 `?market_type=spot` 和 `?market_type=futures` 筛选
- ✅ 可以分别查看现货和合约的监控池列表

### 3.3 P1/P2功能点（未来迭代）

以下功能点在当前迭代**不做**，留待后续迭代：

#### P1功能点（高优先级，未来迭代考虑）
- 现货与合约价差监控
- 跨市场套利信号检测
- 现货和合约的对比分析面板

#### P2功能点（中优先级，未来迭代考虑）
- 支持其他交易所现货（OKX、Bybit等）
- 支持BTC本位、ETH本位现货
- 现货期货联动分析

---

## 四、技术约束与依赖

### 4.1 技术约束

1. **数据库约束**:
   - 必须保持向后兼容，现有合约数据不能受影响
   - KLine表的数据量会增加（现货+合约），需要考虑性能

2. **API限制**:
   - Binance Spot API有速率限制（1200 requests/min, weight-based）
   - 需要与现有合约API共享速率限制池

3. **检测器约束**:
   - 8个检测器的计算逻辑必须保持不变
   - 检测阈值不调整（RVOL ≥ 8x, Amplitude ≥ 3x等）

### 4.2 现有依赖

**直接依赖**:
- ✅ 迭代002: 巨量诱多检测系统（8个检测器、三阶段FSM）
- ✅ 迭代003: K线批量更新增强（批量更新命令、数据获取服务）

**间接依赖**:
- ✅ backtest.models.KLine: K线数据模型
- ✅ monitor.models.FuturesContract: 合约列表模型
- ✅ monitor.api_clients.binance: Binance API客户端
- ✅ volume_trap.detectors.*: 8个检测器
- ✅ volume_trap.services.volume_trap_fsm: 状态机服务

### 4.3 新增依赖

**需要新增**:
- 📝 Binance Spot API Client（参考现有BinanceFuturesClient）
- 📝 SpotContract模型（参考FuturesContract）
- 📝 fetch_spot_contracts 管理命令（参考fetch_futures）
- 📝 update_klines支持现货（扩展现有命令）

---

## 五、用户体验设计

### 5.1 命令行交互设计

#### 场景1: 同步现货交易对列表
```bash
# 新增命令：获取现货交易对列表
$ python manage.py fetch_spot_contracts --exchange binance

🚀 开始获取现货交易对数据
✓ 已自动创建交易所: Binance (binance)
正在获取现货交易对...
✓ 成功获取 500 个现货交易对
✓ 保存完成: 总计500, 新增450, 更新50
```

#### 场景2: 批量更新现货K线
```bash
# 扩展现有命令：支持market_type参数
$ python manage.py update_klines --interval 4h --market-type spot

正在更新所有活跃现货交易对的K线数据 (interval=4h, limit=2000)...
找到 500 个活跃现货交易对

批量更新进度:
[====>........................] 20% (100/500) 成功:98, 失败:2
...
```

#### 场景3: 扫描现货异常
```bash
# 扩展现有命令：支持market_type参数
$ python manage.py scan_volume_traps --interval 4h --market-type spot

=== 开始巨量诱多/弃盘检测扫描 (interval=4h, market_type=spot) ===
初始化状态机...
✓ 状态机初始化完成

执行三阶段扫描 (interval=4h, market_type=spot)...
[INFO] Discovery: 扫描500个现货交易对...
[INFO] Discovery: 发现3个新异常信号
  - BTC/USDT (RVOL=12.5x, Amplitude=3.8x)
  - ETH/USDT (RVOL=9.2x, Amplitude=3.2x)
  - ALLO/USDT (RVOL=10.1x, Amplitude=4.1x)

[INFO] Confirmation: 检查5个pending记录...
[INFO] Confirmation: 1个进入疑似弃盘状态

[INFO] Validation: 检查3个suspected记录...
[INFO] Validation: 无进入确定弃盘状态

=== 扫描完成 ===
  阶段1 - Discovery（发现）: 3个
  阶段2 - Confirmation（确认）: 1个
  阶段3 - Validation（验证）: 0个
  耗时: 15.23秒
```

#### 场景4: 查询结果（区分现货/合约）
```bash
# API查询 - 只看现货
$ curl "http://localhost:8000/api/volume-trap/monitors/?market_type=spot&status=pending"

{
  "count": 3,
  "results": [
    {
      "id": 101,
      "symbol": "BTC/USDT",
      "market_type": "spot",
      "interval": "4h",
      "trigger_time": "2024-12-25T16:00:00Z",
      "trigger_price": "98234.56",
      "status": "pending"
    },
    ...
  ]
}

# API查询 - 只看合约
$ curl "http://localhost:8000/api/volume-trap/monitors/?market_type=futures"

{
  "count": 12,
  "results": [
    {
      "id": 85,
      "symbol": "BTCUSDT",
      "market_type": "futures",
      "interval": "4h",
      "trigger_time": "2024-12-25T12:00:00Z",
      "trigger_price": "98500.00",
      "status": "suspected_abandonment"
    },
    ...
  ]
}
```

### 5.2 向后兼容性设计

**原则**: 现有用户使用不受任何影响

1. **命令行兼容**:
   ```bash
   # 现有命令仍然可用（默认处理合约）
   $ python manage.py update_klines --interval 4h
   # 等同于
   $ python manage.py update_klines --interval 4h --market-type futures
   ```

2. **API兼容**:
   ```bash
   # 现有API调用不变（默认返回合约）
   $ curl "http://localhost:8000/api/volume-trap/monitors/"
   # 等同于
   $ curl "http://localhost:8000/api/volume-trap/monitors/?market_type=futures"
   ```

3. **数据库兼容**:
   - 数据迁移脚本自动为现有KLine记录设置 `market_type='futures'`
   - 现有查询代码无需修改（ORM自动处理）

---

## 六、验收标准

### 6.1 功能验收标准

#### ✅ 标准1: 现货K线数据获取
- [ ] 能够通过命令获取Binance现货K线数据
- [ ] 支持USDT本位现货交易对（如BTC/USDT）
- [ ] 支持1h/4h/1d三种周期
- [ ] 默认获取2000条历史数据
- [ ] 支持增量更新（只获取新数据）

#### ✅ 标准2: 数据存储与隔离
- [ ] KLine表新增 `market_type` 字段
- [ ] 能够同时存储BTC/USDT现货和BTCUSDT合约的K线数据
- [ ] 唯一性约束正确（不会重复存储）
- [ ] 现有合约数据完整性不受影响

#### ✅ 标准3: 现货异常检测
- [ ] 能够扫描现货交易对并检测异常
- [ ] 8个检测器在现货数据上正常工作
- [ ] 三阶段状态机正常流转
- [ ] 失效检测正常工作

#### ✅ 标准4: 结果区分显示
- [ ] API支持 `market_type` 筛选参数
- [ ] 能够分别查看现货和合约的监控结果
- [ ] 前端/CLI工具能够区分显示

#### ✅ 标准5: 向后兼容
- [ ] 现有合约检测功能不受影响
- [ ] 现有命令在不指定market_type时默认处理合约
- [ ] 数据迁移成功，无数据丢失

### 6.2 性能验收标准

**参考指标** (基于迭代003的性能目标):
- 批量更新500个现货交易对: ≤ 5分钟
- 单次扫描500个现货交易对: ≤ 30秒
- API响应时间（列表查询）: ≤ 500ms

### 6.3 质量验收标准

- [ ] 代码覆盖率: ≥ 80% (单元测试)
- [ ] 所有管理命令有帮助文档
- [ ] API有完整的接口文档
- [ ] 无P0/P1级别的Bug

---

## 七、风险评估与缓解

### 7.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| **现货和合约检测规则不适配** | 高 | 中 | 通过历史案例回测验证；如发现问题，P1迭代调整阈值 |
| **数据量翻倍导致性能下降** | 中 | 高 | 优化数据库索引；考虑分表；监控性能指标 |
| **API速率限制冲突** | 中 | 中 | 现货和合约API分别限流；错峰更新数据 |
| **数据迁移失败** | 高 | 低 | 充分测试迁移脚本；提供回滚方案 |

### 7.2 业务风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| **用户需要对比分析** | 中 | 中 | 当前迭代不做，通过用户反馈确认需求，P1迭代考虑 |
| **需要支持其他计价单位** | 低 | 低 | 架构设计留扩展点，后续迭代容易扩展 |
| **现货信号质量不如合约** | 中 | 中 | 通过实际使用验证信号质量，必要时调整阈值 |

---

## 八、项目排期（参考）

**注意**: 本PRD不包含具体的时间估算（遵循"不提供时间线"原则），以下仅为流程参考。

### P1 阶段（当前）：需求定义+澄清 ✅
- [x] 用户访谈与需求收集
- [x] 澄清问题与用户确认
- [x] PRD文档编写
- [x] 功能点清单生成

### P3 阶段：技术调研
- [ ] 充分了解现有项目架构
- [ ] 研究Binance Spot API
- [ ] 评估数据模型扩展方案
- [ ] 识别可复用的服务

### P4 阶段：架构设计
- [ ] 设计方案评审（提交用户审核）⚠️
- [ ] 数据模型设计
- [ ] API接口设计
- [ ] 命令行交互设计

### P5 阶段：开发规划
- [ ] 任务分解
- [ ] 依赖关系梳理
- [ ] 开发计划制定

### P6 阶段：开发实现
- [ ] 数据模型迁移
- [ ] Spot API客户端开发
- [ ] 命令扩展开发
- [ ] 检测器适配
- [ ] 单元测试编写

### P7 阶段：代码审查
- [ ] 代码质量审查
- [ ] 性能测试
- [ ] 集成测试

### P8 阶段：交付
- [ ] 用户验收测试
- [ ] 文档更新
- [ ] 部署上线

---

## 九、参考文档

### 现有迭代文档
- [迭代002: 巨量诱多检测系统 - PRD](../002-volume-trap-detection/prd.md)
- [迭代003: K线批量更新增强 - PRD](../003-klines-batch-update/prd.md)

### 架构文档
- [迭代002: 架构设计](../002-volume-trap-detection/architecture.md)
- [迭代003: 架构设计](../003-klines-batch-update/architecture.md)

### 用户故事与案例
- Bug-004 调查报告: `docs/bugs/global/bug-004-investigation.md` (如存在)
- ALLO/USDT 现货案例: 2025-11-26

---

## 十、附录

### A. 术语表

| 术语 | 定义 |
|------|------|
| **现货 (Spot)** | 即时交割的交易市场，买入后直接持有资产 |
| **合约 (Futures)** | 期货合约市场，通过保证金杠杆交易，不直接持有资产 |
| **USDT本位** | 以USDT作为计价单位的交易对（如BTC/USDT） |
| **市场类型 (Market Type)** | 区分现货和合约的标识字段 |
| **交易对 (Trading Pair)** | 抽象概念，包含现货和合约（如BTC/USDT现货 和 BTCUSDT合约是两个不同的交易对） |

### B. 用户反馈记录

**2024-12-24 - 用户发现现货和合约信号不一致**:
> "我查看的case是allo/usdt 2025年11月26日的现货k线，这说明异常指标在现货和合约上表现不一致。我建议的方式是数据不只支持合约，还得支持现货。"

**2024-12-24 - 用户确认需求范围**:
> "先只支持usdt本位现货"
> "不用同时监控，同币种的现货和合约当成两个分别分析就行"
> "目前只需要支持币安交易对，留下扩展即可"
> "跟合约使用一套规则，阈值也不用调整"

---

**文档状态**: ✅ P1阶段完成，待用户审核
**下一步**: 用户审核确认后，进入P3技术调研阶段

---

**变更历史**:
- v1.0.0 (2024-12-25): 初始版本，完成P1需求定义+澄清
