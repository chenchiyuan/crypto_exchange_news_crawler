# 需求澄清记录: 原子策略组合框架

**迭代编号**: 033
**迭代名称**: 原子策略组合框架
**创建日期**: 2025-01-12
**状态**: 澄清完成

---

## 澄清记录

### Q1: 策略定义格式

**问题**: 策略定义使用纯Python还是支持YAML配置？

**澄清结果**:
- MVP阶段使用纯Python声明式定义
- P1阶段可考虑YAML配置文件支持
- 原因：纯Python更灵活，支持自定义函数；YAML适合非开发者配置

**决策**: 优先纯Python，YAML作为P1功能

---

### Q2: 现有策略兼容性

**问题**: 是否需要保持现有策略实现（SignalCalculator）可运行？

**澄清结果**:
- 用户确认：现有策略量不多，如果修改长期收益很高，可以考虑修改
- 采用渐进式迁移策略：
  1. 新增原子条件层，不删除原有代码
  2. 新增ConditionBasedSignalCalculator与原SignalCalculator并存
  3. 逐步迁移策略到新框架
  4. 验证完成后可删除旧代码

**决策**: 允许修改现有实现，但采用渐进式迁移降低风险

---

### Q3: 优先级体系设计

**问题**: Exit条件优先级是否需要重新设计？

**澄清结果**:
- 现有优先级分散（5,7,9,10,17,20,30），含义不清
- 建议统一优先级体系：
  - 1-10: 保本/止损（最高优先级）
  - 11-20: 策略信号/关键条件
  - 21-30: 目标止盈
  - 31+: 回调/跟踪/兜底

**决策**: 在架构设计阶段统一优先级规范

---

### Q4: 性能要求

**问题**: 对回测性能有特殊要求吗？

**澄清结果**:
- 无特别严格的性能要求
- 期望：1000根K线回测 < 10秒可接受
- 条件评估使用短路优化即可满足

**决策**: 不需要特殊性能优化，使用标准实现

---

### Q5: 可视化工具

**问题**: 是否需要策略条件的可视化工具？

**澄清结果**:
- MVP阶段不需要
- 可作为P1功能考虑
- 优先保证核心功能完整

**决策**: 可视化工具作为P1功能

---

### Q6: 入场/出场条件统一程度

**问题**: 入场条件和出场条件是否使用完全相同的接口？

**澄清结果**:
- 核心接口（ICondition）统一
- 出场需要额外适配器（ConditionBasedExit）以兼容现有IExitCondition体系
- 原因：保持与ExitConditionCombiner的兼容性

**决策**: 统一接口 + 出场适配器

---

## 范围确认

### 包含范围 (In Scope)

1. **原子条件层**
   - ICondition接口及核心实现
   - 价格条件、指标条件、周期条件
   - AND/OR/NOT组合条件

2. **策略定义层**
   - StrategyDefinition数据结构
   - 策略注册表
   - 策略1,2,7声明式迁移

3. **执行引擎**
   - ConditionBasedSignalCalculator
   - ConditionBasedExit适配器

### 排除范围 (Out of Scope)

1. **P1功能**
   - YAML配置文件支持
   - 可视化工具
   - 策略3,4,6,8,10迁移

2. **不修改的部分**
   - IExitCondition接口定义
   - ExitConditionCombiner核心逻辑
   - BacktestEngine和vectorbt集成

---

## 假设与约束

### 假设

1. 现有Exit条件（EmaReversionExit, P95TakeProfitExit等）继续工作
2. 新增的原子条件可与现有Exit条件混用
3. 策略注册表在运行时不会动态修改

### 约束

1. 必须兼容Python 3.8+
2. 必须与现有StrategyAdapter协同工作
3. 条件评估必须是无状态的

---

**澄清状态**: ✅ 所有关键问题已澄清
**下一步**: 技术调研与架构设计
