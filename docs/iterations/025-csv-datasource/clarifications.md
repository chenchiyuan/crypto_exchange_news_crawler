# 需求澄清记录: CSV数据源K线获取服务

**迭代编号**: 025
**版本**: 1.0
**澄清日期**: 2026-01-09

---

## 澄清问题与决策

### Q1: CSV数据源的使用场景是什么？

**问题描述**: CSV数据源是用于历史数据回测、还是作为备用数据源替代API？

**用户回答**: 仅回测使用

**决策**:
- CSV数据源仅用于本地回测场景
- 不需要实现实时监控功能
- 不需要与API数据源做降级切换
- 专注于历史数据的高效加载和解析

**影响**:
- 可以使用简单的全量加载策略
- 不需要实现数据源切换逻辑
- 不需要实现增量更新机制

---

### Q2: CSV文件的存放位置和命名规范是否固定？

**问题描述**: 当前文件命名为`{SYMBOL}-{INTERVAL}-{YEAR}-{MONTH}.csv`，是否需要支持其他格式？

**用户回答**: 灵活路径

**决策**:
- 支持用户指定任意CSV文件绝对路径
- 不强制命名规范，仅要求CSV内容符合币安格式
- 通过配置文件或参数传递文件路径

**影响**:
- `CSVFetcher`初始化需要`csv_path`参数
- 不实现自动文件发现功能
- 用户需要在配置中明确指定文件路径

---

### Q3: 大文件加载的性能优化策略偏好？

**问题描述**: 1秒级K线数据量很大（268万行/月），是按需加载还是全量加载？

**用户回答**: 全量加载

**决策**:
- 首次使用时将整个CSV文件加载到内存
- 使用pandas DataFrame进行数据存储和查询
- 后续查询直接从内存中过滤数据

**影响**:
- 首次加载时间较长（预估<30秒）
- 内存占用较高（预估300MB/文件）
- 后续查询速度极快
- 不需要实现复杂的分块加载逻辑（延迟到P1）

---

### Q4: 回测结果是否需要持久化到数据库？

**问题描述**: CSV数据回测后的结果是否需要保存到数据库，以便后续查看？

**用户回答**: 需要，必须能看到完整的回测结果

**决策**:
- CSV数据源回测必须支持`--save-to-db`参数
- 回测结果存储到`BacktestResult`模型（配置、权益曲线、量化指标）
- 订单详情存储到`BacktestOrder`模型（买卖时间、价格、盈亏）
- 复用现有`/backtest/results/`页面查看回测结果

**影响**:
- 需要确保CSV回测流程与现有持久化机制兼容
- 需要确保量化指标计算（17个P0指标）正常工作
- Web界面无需新增页面，复用现有视图

---

## 隐含假设确认

### A1: CSV文件格式假设
**假设**: CSV文件为币安官方数据导出格式，12列无表头
**确认**: ✅ 已通过实际文件验证

### A2: 时间戳单位假设
**假设**: 1s K线CSV中timestamp为微秒（6位小数精度）
**确认**: ✅ 已通过实际数据验证（`1764547200000000`为微秒）

### A3: 数据完整性假设
**假设**: CSV文件数据连续，无缺失K线
**确认**: ⚠️ 需要在实现中处理可能的数据缺失

---

## 边界条件确认

### B1: 文件大小限制
- **最大支持**: 单文件300万行（约1个月1s数据）
- **内存限制**: 加载后内存占用<2GB

### B2: 时间范围限制
- **最小粒度**: 1秒
- **最大跨度**: 无限制（受内存限制）

### B3: 周期支持范围
- **支持**: 1s, 1m
- **不支持**: 更大周期（4h, 1d等）需要聚合计算（P1）

---

## 需求变更日志

| 日期 | 变更内容 | 原因 | 影响 |
|------|----------|------|------|
| 2026-01-09 | 初始需求定义 | 新功能开发 | - |

---

## 相关文档

- PRD: `docs/iterations/025-csv-datasource/prd.md`
- 功能点清单: `docs/iterations/025-csv-datasource/function-points.md`
