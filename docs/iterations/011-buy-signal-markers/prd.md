# PRD: K线图买入点标记系统 (Buy Signal Markers)

**迭代编号**: 011
**迭代名称**: 买入点标记系统
**文档版本**: 1.0
**创建日期**: 2026-01-06
**状态**: 需求定义
**优先级**: P0

---

## ⚠️ 增量更新声明

**本迭代是增量更新，遵循以下原则：**

| 原则 | 说明 |
|------|------|
| **完全兼容** | 现有 DDPS-Z 所有功能保持不变（EMA、概率带、惯性预测、Z-Score信号） |
| **功能叠加** | 买入点标记是**新增**功能，作为独立的策略验证工具 |
| **复用优先** | 充分复用现有计算能力（P5、惯性mid、EMA、β等） |
| **UI 扩展** | 前端新增买入点标记和悬浮Card，不修改现有图表元素 |

---

## 第一部分：需求原始输入

### 1.1 核心目标
为DDPS-Z系统添加买入点标记功能，帮助用户**验证买入策略的有效性**。

### 1.2 目标用户
- 主要用户：产品开发者本人
- 使用目的：策略回测验证

### 1.3 使用场景
用户在查看K线图时，能够看到历史上所有触发买入策略的点位，通过鼠标悬停或点击查看详细触发信息，验证策略的触发频率和准确性。

### 1.4 预期效果
用户看到买入点标记后，能够：
1. 快速识别策略触发的时机
2. 了解触发的具体原因
3. 评估策略的历史表现
4. 调整和优化策略参数

---

## 第二部分：功能规格框架

### 2.1 买入策略定义

#### 策略1：EMA斜率未来预测买入
**触发条件**（必须同时满足）：
1. 空间准则：K线low < P5价格（静态5%分位带）
2. 趋势准则：未来6周期EMA预测价格 > 当前K线close

**计算逻辑**：
```python
# 1. 计算EMA斜率
β = EMA[t] - EMA[t-1]

# 2. 预测未来6周期EMA价格
未来EMA价格 = EMA[t] + (β × 6)

# 3. 判断买入
if (kline.low < P5) and (未来EMA价格 > kline.close):
    触发买入信号
    买入价格 = kline.close
```

**触发原因描述**：
"策略1: 价格跌破P5静态阈值，但EMA趋势预测未来6周期将回升至 ${未来EMA价格}，高于当前收盘价"

---

#### 策略2：惯性下跌中值突破买入
**触发条件**（必须同时满足）：
1. 趋势方向：β < 0（下跌惯性）
2. 空间准则：惯性预测mid < P5
3. 突破准则：K线low < (惯性mid + P5) / 2

**计算逻辑**：
```python
# 1. 判断下跌趋势
if β < 0:
    # 2. 计算中值线
    中值线 = (惯性mid + P5) / 2

    # 3. 判断买入
    if (惯性mid < P5) and (kline.low < 中值线):
        触发买入信号
        买入价格 = kline.close
```

**触发原因描述**：
"策略2: 下跌惯性中，惯性预测mid (${惯性mid}) 低于P5 (${P5})，且价格跌破中值线"

---

#### 多策略处理
- **并存机制**：同一根K线可同时触发多个策略
- **数组结构**：所有触发的策略存储在数组中
- **扩展性**：为未来策略3、4预留结构

---

### 2.2 可视化设计

#### 2.2.1 买入点标记
**位置**：K线图时间轴上，对齐触发K线
**样式**：
- 图标：绿色向上箭头 ↑
- 颜色：`#28a745`（复用Bootstrap成功色）
- 大小：适中，不遮挡K线

**实现**：使用LightweightCharts的`setMarkers()` API

---

#### 2.2.2 悬浮信息Card
**触发方式**：
1. 鼠标悬停（Hover）在买入点标记上
2. 点击买入点标记（固定显示，点击其他区域或按ESC关闭）

**Card内容**：
```
┌─────────────────────────────────────────┐
│ 📊 买入信号详情                          │
├─────────────────────────────────────────┤
│ 🕐 触发时间: 2026-01-06 16:00:00        │
│ 💰 买入价格: $49,876.54                 │
├─────────────────────────────────────────┤
│ ✅ 触发策略:                             │
│                                         │
│ 策略1: EMA斜率未来预测                   │
│ └─ 原因: 价格跌破P5 ($48,234)，         │
│    但未来6周期EMA预测 ($50,456)          │
│    高于当前收盘价                        │
│                                         │
│ 策略2: 惯性下跌中值突破                  │
│ └─ 原因: 下跌惯性中，惯性mid ($48,100)   │
│    低于P5，且价格跌破中值线 ($48,167)    │
└─────────────────────────────────────────┘
```

**Card样式**：
- Bootstrap Card组件
- 白色半透明背景 `rgba(255, 255, 255, 0.95)`
- 圆角边框
- 阴影效果

---

#### 2.2.3 策略筛选控件
**位置**：图表上方控制栏，与周期选择器、时间范围选择器并列
**样式**：Bootstrap按钮组
**选项**：
- 全部（默认）
- 策略1
- 策略2

**行为**：
- 选中后只显示对应策略的买入点标记
- 其他策略的标记完全隐藏
- 筛选状态持久化（刷新页面后保持）

---

### 2.3 历史回溯功能

#### 2.3.1 数据范围
- 与现有图表时间范围一致
- 用户选择1周/1月/3月等时间范围时，自动计算该范围内所有买入点
- 支持动态加载：滚动到更早时间时，自动计算并标记买入点

#### 2.3.2 性能优化
- 买入信号计算在后端完成
- 前端只负责渲染标记
- 标记数据随K线数据一起返回（无额外请求）

---

### 2.4 技术实现

#### 2.4.1 系统架构
```
┌─────────────────────────────────────────────────────────────┐
│                  ddps_z 模块（增量扩展）                      │
├─────────────────────────────────────────────────────────────┤
│  calculators/                                               │
│  ├─ ema_calculator.py           (✅ 复用，不修改)            │
│  ├─ inertia_calculator.py       (✅ 复用，不修改)            │
│  ├─ zscore_calculator.py        (✅ 复用，不修改)            │
│  └─ buy_signal_calculator.py    (🆕 新增文件)                │
├─────────────────────────────────────────────────────────────┤
│  services/                                                  │
│  ├─ ddps_service.py             (✅ 复用，不修改)            │
│  └─ chart_data_service.py       (📝 扩展：添加buy_signals)   │
├─────────────────────────────────────────────────────────────┤
│  templates/                                                 │
│  └─ detail.html                 (📝 扩展：买入点标记渲染)     │
└─────────────────────────────────────────────────────────────┘

图例：✅ 复用（不修改） | 🆕 新增 | 📝 扩展（向后兼容）
```

---

#### 2.4.2 API 扩展

**GET /ddps-z/api/chart/** 响应扩展：
```json
{
  "chart": {
    // ✅ 现有字段保持不变
    "candles": [...],
    "ema": [...],
    "bands": {...},
    "zscore": [...],
    "fan": {...},

    // 🆕 新增 buy_signals 字段
    "buy_signals": [
      {
        "timestamp": 1736078400000,
        "kline_index": 123,
        "strategies": [
          {
            "id": "strategy_1",
            "name": "EMA斜率未来预测",
            "triggered": true,
            "reason": "价格跌破P5 ($48,234)，但未来6周期EMA预测 ($50,456) 高于当前收盘价",
            "details": {
              "current_low": 48000.0,
              "p5": 48234.0,
              "future_ema": 50456.0,
              "current_close": 49876.54
            }
          },
          {
            "id": "strategy_2",
            "name": "惯性下跌中值突破",
            "triggered": true,
            "reason": "下跌惯性中，惯性mid ($48,100) 低于P5，且价格跌破中值线 ($48,167)",
            "details": {
              "beta": -0.0012,
              "inertia_mid": 48100.0,
              "p5": 48234.0,
              "mid_line": 48167.0,
              "current_low": 48000.0
            }
          }
        ],
        "buy_price": 49876.54
      }
    ]
  }
}
```

---

#### 2.4.3 前端扩展

**LightweightCharts扩展**：
```javascript
// 1. 设置买入点标记
const markers = buySignals.map(signal => ({
    time: signal.timestamp / 1000,
    position: 'belowBar',
    color: '#28a745',
    shape: 'arrowUp',
    text: 'B',  // Buy
    size: 1
}));
candleSeries.setMarkers(markers);

// 2. Hover事件监听
chart.subscribeCrosshairMove((param) => {
    // 检测是否hover在买入点上
    // 显示悬浮Card
});

// 3. Click事件监听
chart.subscribeClick((param) => {
    // 检测是否点击买入点
    // 固定显示Card
});
```

**筛选控件**：
```html
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-success btn-sm active" data-filter="all">全部</button>
    <button type="button" class="btn btn-outline-success btn-sm" data-filter="strategy_1">策略1</button>
    <button type="button" class="btn btn-outline-success btn-sm" data-filter="strategy_2">策略2</button>
</div>
```

---

## 第三部分：AI分析与建议

### 3.1 MVP功能点清单（已确认）

#### 📊 **核心功能（P0 - 必须实现）**

- **[P0] 策略1计算器：EMA斜率未来预测**
  - 触发条件：K线low < P5 且 未来6周期EMA > 当前close
  - 斜率计算：β = EMA[t] - EMA[t-1]（单周期斜率）
  - 未来预测：未来EMA = EMA[t] + (β × 6)
  - 输出：触发标记、买入价格、详细原因

- **[P0] 策略2计算器：惯性下跌中值突破**
  - 前置条件：β < 0（下跌趋势）
  - 触发条件：惯性mid < P5 且 K线low < (mid + P5) / 2
  - 输出：触发标记、买入价格、详细原因

- **[P0] 买入信号数据结构**
  - 支持多策略并存（数组结构）
  - 包含触发时间、策略列表、买入价格
  - 为未来策略扩展预留结构

- **[P0] 时间轴买入点标记**
  - 绿色向上箭头图标
  - 使用LightweightCharts Markers API
  - 对齐触发K线位置

- **[P0] Hover悬浮Card**
  - 鼠标悬停显示详细信息
  - 包含：触发时间、买入价格、所有触发策略及原因
  - Bootstrap Card样式，半透明白色背景

- **[P0] 点击固定Card**
  - 点击买入点标记固定显示Card
  - 点击其他区域或按ESC关闭

- **[P0] 策略筛选控件**
  - 按钮组：全部、策略1、策略2
  - 位置：图表上方控制栏
  - 行为：隐藏/显示对应策略标记

- **[P0] 历史买入点显示**
  - 与图表时间范围一致
  - 自动计算所有历史买入点
  - 支持滚动动态加载

- **[P0] 后端API扩展**
  - 在chart API响应中新增buy_signals字段
  - 完整的策略触发信息和详细数据

---

#### 🎨 **增强功能（P1 - 可推迟）**

- **[P1] 策略参数可配置**
  - 理由：MVP阶段参数固定即可（未来6周期、P5阈值等）
  - 建议：策略验证有效后再实现配置化

- **[P1] 买入点颜色区分**
  - 理由：MVP阶段统一绿色箭头即可
  - 建议：后续可用深绿（策略1）、浅绿（策略2）、金色（双策略）

- **[P1] 买入后表现统计**
  - 理由：MVP阶段专注于"看到买入点"，表现分析可后续扩展
  - 建议：未来在Card中添加"买入后7天收益率"等指标

- **[P1] 策略胜率统计面板**
  - 理由：需要先积累足够历史数据
  - 建议：未来在页面顶部显示"策略1胜率 65%"等汇总数据

---

### 3.2 已解决的决策点

#### ✅ 决策点1：策略1未来EMA价格计算方法
**采用方案**：简单线性外推
- 斜率：β = EMA[t] - EMA[t-1]
- 预测：未来EMA = EMA[t] + (β × 6)
- 周期数：固定6周期

#### ✅ 决策点2：策略2"下跌时"定义
**采用方案**：基于惯性预测方向
- 判定条件：β < 0
- 理由：与现有惯性系统一致，计算成本为零

#### ✅ 决策点3：买入价格选择
**采用方案**：固定使用close价格
- 所有买入信号的买入价格 = K线close
- 理由：最简单，与大多数策略一致

#### ✅ 决策点4：历史回溯数据范围
**采用方案**：与现有图表数据范围一致
- 复用现有时间范围选择器
- 支持动态加载机制

#### ✅ 决策点5：筛选功能UI位置
**采用方案**：在图表上方控制栏
- 与周期选择器并列
- 隐藏/显示逻辑，最直观

---

### 3.3 验收标准

#### 功能验收
| 功能点 | 验收标准 |
|--------|----------|
| 策略1计算 | 正确识别low < P5且未来EMA > close的情况 |
| 策略2计算 | 正确识别β < 0且惯性mid < P5且low < 中值线的情况 |
| 买入点标记 | 所有触发点都正确标记在时间轴上 |
| Hover Card | 悬停显示完整信息，包含所有触发策略 |
| 筛选功能 | 正确隐藏/显示对应策略的标记 |
| 历史回溯 | 正确计算所有历史买入点 |

#### 性能指标
| 指标 | 目标值 |
|------|--------|
| 买入信号计算延迟 | < 50ms（增量） |
| 标记渲染性能 | 500个标记 < 100ms |
| Card显示延迟 | < 10ms |

---

### 3.4 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 买入点过多导致页面拥挤 | 可视化效果差 | 1. 限制最大显示数量；2. 提供缩放功能 |
| 策略计算错误 | 验证结果不准确 | 1. 单元测试覆盖；2. 手动验证关键案例 |
| 性能问题 | 页面卡顿 | 1. 后端计算；2. 限制数据量 |

---

### 3.5 排期建议

**总计工作量**: 约2天

| 阶段 | 任务 | 工作量 |
|------|------|--------|
| 后端开发 | 买入信号计算器 + API扩展 | 1天 |
| 前端开发 | 买入点标记 + Card + 筛选 | 1天 |
| 测试验证 | 策略验证 + 回归测试 | 0.5天 |

---

## 附录

### A. 公式速查

| 名称 | 公式 |
|------|------|
| EMA斜率 | β = EMA[t] - EMA[t-1] |
| 未来EMA预测 | 未来EMA = EMA[t] + (β × 6) |
| 策略1空间准则 | low < P5 |
| 策略1趋势准则 | 未来EMA > close |
| 策略2趋势方向 | β < 0 |
| 策略2空间准则 | 惯性mid < P5 |
| 策略2突破准则 | low < (mid + P5) / 2 |
| 买入价格 | buy_price = close |

### B. 数据依赖

买入信号计算依赖的现有数据：
- ✅ EMA25序列（ema_calculator.py）
- ✅ P5静态阈值（zscore_calculator.py）
- ✅ 惯性预测mid值（inertia_calculator.py）
- ✅ β斜率（inertia_calculator.py）
- ✅ K线OHLC数据（chart_data_service.py）

### C. 技术栈

| 层级 | 技术 |
|------|------|
| 后端计算 | Python + NumPy |
| API | Django REST Framework |
| 前端渲染 | LightweightCharts + Bootstrap |
| 数据格式 | JSON |

---

**文档状态**: ✅ MVP需求定稿完成
**Gate 1检查**: ✅ 已通过
**下一阶段**: 技术实现（P3-P4）
