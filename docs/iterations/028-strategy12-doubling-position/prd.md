# PRD: 策略12 - 倍增仓位限价挂单

## 文档信息

| 属性 | 值 |
|------|-----|
| 迭代编号 | 028 |
| 迭代名称 | strategy12-doubling-position |
| 版本 | 1.0 |
| 状态 | Draft |
| 创建日期 | 2026-01-11 |
| 关联迭代 | 027-strategy11-limit-order |

---

## 1. 产品概述

### 1.1 核心价值（一句话）

**在策略11限价挂单基础上，引入倍增仓位机制实现马丁格尔式分批建仓，配合固定比例止盈，优化低位加仓的收益潜力。**

### 1.2 背景与动机

策略11采用固定金额（100U）的等额挂单，在价格持续下跌时无法充分利用更低价格的建仓机会。策略12通过倍增仓位（100→200→400→800→1600）实现：
1. **低位加重仓**：价格越低，买入金额越大，降低平均成本
2. **马丁格尔思想**：亏损加仓，收益弹性更大
3. **简化止盈**：固定2%止盈，逻辑清晰

### 1.3 目标用户

量化回测研究人员，用于验证倍增仓位策略在DDPS-Z框架下的有效性。

---

## 2. 功能范围

### 2.1 In-Scope (P0)

| 功能点 | 描述 |
|--------|------|
| **买入挂单价格计算** | 复用策略11逻辑：mid < P5时首笔=(P5+mid)/2×(1-discount) |
| **倍增仓位计算** | 首单100U，第N单=首单×(倍增系数^(N-1)) |
| **挂单数量配置** | 默认5笔，可配置 |
| **固定比例止盈** | 每笔订单独立计算，达到2%止盈即卖出 |
| **配置参数** | 倍增系数(2)、首单金额(100)、止盈比例(2%)均可配置 |

### 2.2 Out-of-Scope (P1延迟)

| 功能点 | 延迟原因 |
|--------|----------|
| 止损机制 | 用户明确不需要 |
| 均价止盈 | 增加复杂度，MVP先用单笔独立止盈 |
| 持久化挂单历史 | 复用策略11决策，纯内存存储 |
| 动态倍增系数 | 固定系数满足MVP需求 |

---

## 3. 详细需求

### 3.1 买入挂单逻辑

#### 3.1.1 挂单价格计算

与策略11完全相同：

| 条件 | 首笔挂单价格 | 第N笔挂单价格 |
|------|-------------|---------------|
| mid < P5 | (P5 + mid) / 2 × (1 - discount) | 首笔 × (1 - (N-1) × interval) |
| mid >= P5 | P5 × (1 - discount) | 首笔 × (1 - (N-1) × interval) |

**默认参数**：
- `first_order_discount`: 1%（首笔折扣）
- `order_interval`: 1%（挂单间隔）

#### 3.1.2 倍增仓位计算

```
第1笔金额 = base_amount (默认100 USDT)
第N笔金额 = base_amount × multiplier^(N-1)
```

**示例（multiplier=2, base_amount=100）**：

| 挂单序号 | 金额(USDT) | 累计金额 |
|----------|-----------|----------|
| 1 | 100 | 100 |
| 2 | 200 | 300 |
| 3 | 400 | 700 |
| 4 | 800 | 1500 |
| 5 | 1600 | 3100 |

#### 3.1.3 挂单流程

```
每根K线结束时:
1. 取消所有未成交买入挂单，解冻资金
2. 计算5个挂单价格
3. 计算5个挂单金额（倍增）
4. 依次创建买入挂单，逐笔冻结资金
   - 资金不足时跳过该笔及后续挂单
5. 检查上根K线的挂单是否成交
   - 成交条件: low <= 挂单价 <= high
   - 成交后转为Order持仓
```

### 3.2 卖出条件

#### 3.2.1 固定比例止盈

**规则**：
- 每笔Order独立计算止盈
- 止盈价格 = 买入价 × (1 + take_profit_rate)
- 默认 take_profit_rate = 2%

**成交条件**：
```
K线.low <= 止盈价 <= K线.high
```

**无止损**：订单持有直到止盈成交或回测结束。

---

## 4. 配置参数

### 4.1 完整配置示例

```json
{
  "project_name": "策略12-倍增仓位限价挂单",
  "symbol": "ETHUSDT",
  "interval": "1m",
  "initial_cash": 10000,
  "entry": {
    "strategy_id": 12,
    "order_count": 5,
    "order_interval": 0.01,
    "first_order_discount": 0.01,
    "base_amount": 100,
    "multiplier": 2
  },
  "exits": [
    {
      "type": "take_profit",
      "params": {
        "take_profit_rate": 0.02
      }
    }
  ]
}
```

### 4.2 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `order_count` | int | 5 | 每根K线挂单数量 |
| `order_interval` | float | 0.01 | 挂单间隔比例(1%) |
| `first_order_discount` | float | 0.01 | 首笔折扣比例(1%) |
| `base_amount` | Decimal | 100 | 首单金额(USDT) |
| `multiplier` | float | 2 | 倍增系数 |
| `take_profit_rate` | float | 0.02 | 止盈比例(2%) |

---

## 5. 验收标准

### 5.1 功能验收

| AC编号 | 验收条件 |
|--------|----------|
| AC-001 | 倍增金额计算正确：100→200→400→800→1600 |
| AC-002 | 挂单价格与策略11一致（相同P5/mid输入） |
| AC-003 | 单笔止盈正确：卖出价 = 买入价 × 1.02 |
| AC-004 | 资金不足时正确跳过后续挂单 |
| AC-005 | 回测报告正确显示策略12的统计指标 |

### 5.2 性能验收

| 指标 | 目标值 |
|------|--------|
| 单根K线处理时间 | < 10ms |
| 1个月1m数据回测 | < 60秒 |
| 内存占用 | < 2GB |

---

## 6. 技术约束

1. **复用策略11组件**：LimitOrderManager、LimitOrderPriceCalculator
2. **独立策略类**：DoublingPositionStrategy，不修改策略11代码
3. **新增Exit条件**：TakeProfitExit（固定比例止盈）
4. **配置驱动**：通过JSON配置文件指定所有参数

---

## 附录

### A. 与策略11对比

| 特性 | 策略11 | 策略12 |
|------|--------|--------|
| 挂单数量 | 10笔 | 5笔 |
| 挂单金额 | 固定100U | 倍增(100→200→...) |
| 首笔折扣 | 1% | 1% |
| 挂单间隔 | 0.5% | 1% |
| 止盈方式 | min(5%止盈, EMA25) | 固定2%止盈 |
| 止损 | 无 | 无 |
| 总资金需求 | 1000U | 3100U |

### B. 变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-01-11 | 初始版本 |
