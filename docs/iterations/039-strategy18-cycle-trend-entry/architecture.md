# æ¶æ„è®¾è®¡ - ç­–ç•¥18ï¼šå‘¨æœŸè¶‹åŠ¿å…¥åœºç­–ç•¥

## æ–‡æ¡£ä¿¡æ¯
- **è¿­ä»£ç¼–å·**: 039
- **åˆ›å»ºæ—¥æœŸ**: 2026-01-13

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç»„ä»¶å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Strategy18CycleTrendEntry                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æŒ‡æ ‡è®¡ç®—æ¨¡å—    â”‚  â”‚  å‘¨æœŸçŠ¶æ€åˆ¤æ–­    â”‚  â”‚  è®¢å•ç®¡ç†æ¨¡å—    â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ - EMA7/25/99    â”‚  â”‚ - 42å‘¨æœŸå æ¯”    â”‚  â”‚ - åŒæŒ‚å•ç®¡ç†    â”‚  â”‚
â”‚  â”‚ - cycle_phases  â”‚  â”‚ - EMA25æ–œç‡    â”‚  â”‚ - æŒä»“ç®¡ç†      â”‚  â”‚
â”‚  â”‚ - Î²å€¼è®¡ç®—       â”‚  â”‚ - çŠ¶æ€æ ‡è®°      â”‚  â”‚ - æ­¢ç›ˆæ­¢æŸ      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                    â”‚           â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                â–¼                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚    run_backtest()   â”‚                      â”‚
â”‚                    â”‚    ä¸»å›æµ‹å¾ªç¯        â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å›æµ‹ç»“æœè¾“å‡º       â”‚
                    â”‚   orders/statistics â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµ

```
Kçº¿æ•°æ® (DataFrame)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŒ‡æ ‡è®¡ç®—        â”‚
â”‚ EMA7/25/99        â”‚
â”‚ cycle_phases      â”‚
â”‚ Î²å€¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘¨æœŸå æ¯”è®¡ç®—     â”‚â”€â”€â”€â”€â–ºâ”‚  EMA25æ–œç‡è®¡ç®—    â”‚
â”‚  (æœ€è¿‘42æ ¹)       â”‚     â”‚  (æœ€è¿‘6æ ¹)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  å‘¨æœŸçŠ¶æ€åˆ¤æ–­     â”‚
              â”‚  bull/bear/cons.  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼               â–¼
   [ä¸Šæ¶¨å‘¨æœŸ]      [ä¸‹è·Œå‘¨æœŸ]      [éœ‡è¡å‘¨æœŸ]
        â”‚               â”‚               â”‚
        â–¼               â”‚               â”‚
   åŒæŒ‚å•ä¹°å…¥           â”‚               â”‚
   (EMA7+EMA25)         â”‚               â”‚
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    æŒä»“æ£€æŸ¥       â”‚
              â”‚  æ­¢æŸâ†’æ­¢ç›ˆâ†’å‘¨æœŸ  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒç±»è®¾è®¡

### 2.1 Strategy18CycleTrendEntry

```python
class Strategy18CycleTrendEntry(IStrategy):
    """
    ç­–ç•¥18ï¼šå‘¨æœŸè¶‹åŠ¿å…¥åœºç­–ç•¥

    åŸºäº42å‘¨æœŸå æ¯”å’ŒEMA25æ–œç‡åŒé‡ç¡®è®¤çš„è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥ã€‚

    Attributes:
        position_size: å•ç¬”ä»“ä½é‡‘é¢ï¼ˆUSDTï¼‰
        max_positions: æœ€å¤§æŒä»“æ•°é‡
        cycle_window: å‘¨æœŸå æ¯”ç»Ÿè®¡çª—å£ï¼ˆé»˜è®¤42ï¼‰
        bull_threshold: ä¸Šæ¶¨å‘¨æœŸå æ¯”é˜ˆå€¼ï¼ˆé»˜è®¤40%ï¼‰
        bear_threshold: ä¸‹è·Œå‘¨æœŸå æ¯”é˜ˆå€¼ï¼ˆé»˜è®¤40%ï¼‰
        slope_window: EMA25æ–œç‡æ¯”è¾ƒçª—å£ï¼ˆé»˜è®¤6ï¼‰
        take_profit_pct: æ­¢ç›ˆæ¯”ä¾‹ï¼ˆé»˜è®¤10%ï¼‰
        stop_loss_pct: æ­¢æŸæ¯”ä¾‹ï¼ˆé»˜è®¤3%ï¼‰
    """

    STRATEGY_ID = 'strategy_18'
    STRATEGY_NAME = 'å‘¨æœŸè¶‹åŠ¿å…¥åœº'
    STRATEGY_VERSION = '1.0'

    def __init__(self, ...): ...

    # æ ¸å¿ƒæ–¹æ³•
    def run_backtest(self, klines_df, initial_capital) -> Dict: ...

    # æŒ‡æ ‡è®¡ç®—
    def _calculate_indicators(self, klines_df) -> Dict[str, pd.Series]: ...

    # å‘¨æœŸçŠ¶æ€åˆ¤æ–­
    def _calculate_cycle_distribution(self, cycle_phases, window=42) -> Dict[str, float]: ...
    def _calculate_ema_slopes(self, ema25_series) -> np.ndarray: ...
    def _is_slope_highest(self, slopes, window=6) -> bool: ...
    def _is_slope_lowest(self, slopes, window=6) -> bool: ...
    def _determine_cycle_state(self, distribution, is_highest, is_lowest) -> str: ...

    # è®¢å•ç®¡ç†
    def _create_pending_orders(self, ema7, ema25, timestamp, kline_index) -> List[PendingOrder]: ...
    def _check_order_fill(self, order, low) -> bool: ...
    def _check_stop_loss(self, holding, low) -> Optional[Dict]: ...
    def _check_take_profit(self, holding, high) -> Optional[Dict]: ...
    def _check_cycle_exit(self, holding, cycle_state, ema7, ema25, prev_ema7, prev_ema25) -> bool: ...

    # ç»“æœç”Ÿæˆ
    def _generate_result(self, initial_capital, kline_count) -> Dict: ...
```

### 2.2 çŠ¶æ€ç®¡ç†

```python
# æŒ‚å•ç®¡ç†ï¼ˆæ¯æ ¹Kçº¿æœ€å¤š2ç¬”ï¼‰
_pending_orders: List[PendingOrder] = []

# æŒä»“ç®¡ç†
_holdings: Dict[str, Dict] = {
    'order_id': {
        'buy_price': Decimal,
        'quantity': Decimal,
        'amount': Decimal,
        'buy_timestamp': int,
        'kline_index': int,
        'metadata': {
            'cross_triggered': bool,  # æ˜¯å¦å·²è§¦å‘EMAä¸‹ç©¿
            'pending_exit': bool,     # æ˜¯å¦ç­‰å¾…ä¸‹æ ¹Kçº¿å–å‡º
        }
    }
}

# å·²å®Œæˆè®¢å•
_completed_orders: List[Dict] = []

# å¯ç”¨èµ„é‡‘
_available_capital: Decimal
```

---

## 3. å…³é”®ç®—æ³•

### 3.1 å‘¨æœŸçŠ¶æ€åˆ¤æ–­

```python
def _determine_cycle_state(self, distribution, is_slope_highest, is_slope_lowest) -> str:
    """
    åˆ¤æ–­å½“å‰å‘¨æœŸçŠ¶æ€

    Returns:
        'bull': ä¸Šæ¶¨å‘¨æœŸ
        'bear': ä¸‹è·Œå‘¨æœŸ
        'consolidation': éœ‡è¡å‘¨æœŸ
    """
    bull_strong_pct = distribution.get('bull_strong', 0)
    bear_strong_pct = distribution.get('bear_strong', 0)

    if bull_strong_pct > self.bull_threshold and is_slope_highest:
        return 'bull'
    elif bear_strong_pct > self.bear_threshold and is_slope_lowest:
        return 'bear'
    else:
        return 'consolidation'
```

### 3.2 åŒæŒ‚å•æœºåˆ¶

```python
def _create_pending_orders(self, ema7, ema25, timestamp, kline_index) -> List[PendingOrder]:
    """
    åˆ›å»ºåŒæŒ‚å•ï¼ˆEMA7 + EMA25ï¼‰
    """
    orders = []

    # æŒ‚å•1: EMA7ä»·æ ¼
    if self._available_capital >= self.position_size:
        order1 = PendingOrder(
            order_id=f"pending_{timestamp}_{kline_index}_ema7",
            price=ema7,
            amount=self.position_size,
            quantity=self.position_size / ema7,
            status=PendingOrderStatus.PENDING,
            side=PendingOrderSide.BUY,
            frozen_capital=self.position_size,
            kline_index=kline_index,
            created_at=timestamp,
            metadata={'entry_type': 'ema7'}
        )
        orders.append(order1)
        self._available_capital -= self.position_size

    # æŒ‚å•2: EMA25ä»·æ ¼
    if self._available_capital >= self.position_size:
        order2 = PendingOrder(
            order_id=f"pending_{timestamp}_{kline_index}_ema25",
            price=ema25,
            amount=self.position_size,
            quantity=self.position_size / ema25,
            status=PendingOrderStatus.PENDING,
            side=PendingOrderSide.BUY,
            frozen_capital=self.position_size,
            kline_index=kline_index,
            created_at=timestamp,
            metadata={'entry_type': 'ema25'}
        )
        orders.append(order2)
        self._available_capital -= self.position_size

    return orders
```

### 3.3 å–å‡ºä¼˜å…ˆçº§å¤„ç†

```python
# åœ¨æ¯æ ¹Kçº¿å¤„ç†æŒä»“æ—¶çš„æ£€æŸ¥é¡ºåº
for order_id, holding in self._holdings.items():
    # 1. æ£€æŸ¥æ­¢æŸï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    stop_loss_result = self._check_stop_loss(holding, low)
    if stop_loss_result:
        holdings_to_close.append(stop_loss_result)
        continue

    # 2. æ£€æŸ¥æ­¢ç›ˆ
    take_profit_result = self._check_take_profit(holding, high)
    if take_profit_result:
        holdings_to_close.append(take_profit_result)
        continue

    # 3. æ£€æŸ¥å‘¨æœŸçŠ¶æ€æ­¢ç›ˆ
    if self._check_cycle_exit(holding, cycle_state, ema7, ema25, prev_ema7, prev_ema25):
        # æ ‡è®°ä¸‹æ ¹Kçº¿ä»¥openå–å‡º
        holding['metadata']['pending_exit'] = True
```

---

## 4. é…ç½®æ–‡ä»¶æ ¼å¼

```json
{
  "project_name": "ç­–ç•¥18-å‘¨æœŸè¶‹åŠ¿å…¥åœº",
  "description": "åŸºäº42å‘¨æœŸå æ¯”å’ŒEMA25æ–œç‡åŒé‡ç¡®è®¤çš„è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥",
  "version": "1.0",
  "created_at": "2026-01-13",
  "iteration": "039",

  "backtest_config": {
    "symbol": "ETHUSDT",
    "interval": "4h",
    "market_type": "futures",
    "start_date": "2025-01-01",
    "end_date": "2025-12-31",
    "initial_cash": 10000,
    "commission_rate": 0.001
  },

  "capital_management": {
    "mode": "shared",
    "position_size_mode": "fixed",
    "position_size": 1000,
    "max_positions": 10
  },

  "strategies": [
    {
      "id": "strategy_18",
      "name": "å‘¨æœŸè¶‹åŠ¿å…¥åœº",
      "type": "strategy-18-cycle-trend",
      "enabled": true,
      "entry": {
        "cycle_window": 42,
        "bull_threshold": 40,
        "bear_threshold": 40,
        "slope_window": 6,
        "description": "ä¸Šæ¶¨å‘¨æœŸ(bull_strong>40%ä¸”EMA25æ–œç‡æœ€é«˜)æ—¶åŒæŒ‚å•(EMA7+EMA25)"
      },
      "exits": [
        {
          "type": "stop_loss",
          "params": { "percentage": 3 },
          "description": "3%æ­¢æŸ"
        },
        {
          "type": "take_profit",
          "params": { "percentage": 10 },
          "description": "10%æ­¢ç›ˆ"
        },
        {
          "type": "cycle_state",
          "params": {},
          "description": "éä¸Šæ¶¨å‘¨æœŸ+EMA7ä¸‹ç©¿EMA25â†’ä¸‹æ ¹Kçº¿openå–å‡º"
        }
      ]
    }
  ]
}
```

---

## 5. æ–‡ä»¶ç»“æ„

```
strategy_adapter/
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ __init__.py                    # æ·»åŠ Strategy18å¯¼å‡º
â”‚   â””â”€â”€ strategy18_cycle_trend_entry.py  # ğŸ†• ç­–ç•¥18å®ç°
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ strategy18_cycle_trend.json    # ğŸ†• ç­–ç•¥18é…ç½®
â””â”€â”€ tests/
    â””â”€â”€ test_strategy18.py             # ğŸ†• ç­–ç•¥18æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
```

---

## 6. å›æµ‹ä¸»å¾ªç¯ä¼ªä»£ç 

```python
def run_backtest(self, klines_df, initial_capital):
    # åˆå§‹åŒ–
    self._available_capital = initial_capital
    self._pending_orders = []
    self._holdings = {}
    self._completed_orders = []

    # è®¡ç®—æŒ‡æ ‡
    indicators = self._calculate_indicators(klines_df)

    # é€Kçº¿å¤„ç†
    for i in range(42, len(klines_df)):  # ä»ç¬¬42æ ¹å¼€å§‹ï¼ˆéœ€è¦42æ ¹å†å²ï¼‰
        kline = klines_df.iloc[i]
        timestamp = int(klines_df.index[i].timestamp() * 1000)

        # è·å–å½“å‰æŒ‡æ ‡
        ema7 = indicators['ema7'].iloc[i]
        ema25 = indicators['ema25'].iloc[i]
        cycle_phases = indicators['cycle_phases'][:i+1]

        # Step 1: å¤„ç†å¾…å–å‡ºè®¢å•ï¼ˆä¸Šæ ¹Kçº¿æ ‡è®°çš„ï¼‰
        self._process_pending_exits(kline['open'], timestamp)

        # Step 2: æ£€æŸ¥æŒ‚å•æˆäº¤
        self._process_pending_orders(kline['low'], timestamp, i)

        # Step 3: æ£€æŸ¥æŒä»“æ­¢ç›ˆæ­¢æŸ
        self._process_holdings(kline, indicators, i, timestamp)

        # Step 4: åˆ¤æ–­å‘¨æœŸçŠ¶æ€
        distribution = self._calculate_cycle_distribution(cycle_phases)
        slopes = self._calculate_ema_slopes(indicators['ema25'].iloc[:i+1])
        is_highest = self._is_slope_highest(slopes)
        is_lowest = self._is_slope_lowest(slopes)
        cycle_state = self._determine_cycle_state(distribution, is_highest, is_lowest)

        # Step 5: åˆ›å»ºæ–°æŒ‚å•ï¼ˆä»…ä¸Šæ¶¨å‘¨æœŸï¼‰
        if cycle_state == 'bull':
            self._cancel_pending_orders()  # å–æ¶ˆæ—§æŒ‚å•
            new_orders = self._create_pending_orders(ema7, ema25, timestamp, i)
            self._pending_orders.extend(new_orders)
        else:
            self._cancel_pending_orders()  # éä¸Šæ¶¨å‘¨æœŸå–æ¶ˆæ‰€æœ‰æŒ‚å•

    return self._generate_result(initial_capital, len(klines_df))
```

---

## 7. æ¶æ„å†³ç­–è®°å½•

| å†³ç­– | é€‰é¡¹ | é€‰æ‹© | ç†ç”± |
|-----|------|-----|------|
| ç­–ç•¥å®ç°æ–¹å¼ | Mixin/ç‹¬ç«‹ç±» | ç‹¬ç«‹ç±» | é€»è¾‘ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤ |
| å‘¨æœŸå æ¯”è®¡ç®— | å¤ç”¨Service/å†…è” | å†…è” | é¿å…ä¾èµ–ï¼Œä¿æŒç‹¬ç«‹ |
| æŒ‚å•ç®¡ç† | å¤ç”¨LimitOrderManager/å†…ç½® | å†…ç½® | åŒæŒ‚å•é€»è¾‘ç®€å•ï¼Œæ— éœ€å¤æ‚ç®¡ç†å™¨ |
| å‘¨æœŸçŠ¶æ€æ­¢ç›ˆ | ç«‹å³å–å‡º/ä¸‹æ ¹Kçº¿å–å‡º | ä¸‹æ ¹Kçº¿open | ç¬¦åˆç”¨æˆ·éœ€æ±‚ |
