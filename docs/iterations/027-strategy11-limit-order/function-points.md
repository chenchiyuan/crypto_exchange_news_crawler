# 功能点清单: 策略11 - 限价挂单买卖机制

## 文档信息

| 属性 | 值 |
|------|-----|
| 迭代编号 | 027 |
| 迭代名称 | strategy11-limit-order |
| 版本 | 1.0 |
| 创建日期 | 2026-01-10 |
| 关联PRD | prd.md |

---

## 功能点总览

| 优先级 | 数量 | 说明 |
|--------|------|------|
| P0 (MVP必须) | 18 | 核心限价挂单机制 |
| P1 (延迟) | 4 | 扩展功能 |

---

## P0 功能点 (MVP必须)

### 模块1: 限价挂单管理器

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-027-001 | PendingOrder数据结构 | 定义挂单数据结构：order_id, price, quantity, status, created_at, kline_index | 数据结构完整，支持序列化 |
| FP-027-002 | 创建挂单 | 根据价格和数量创建PendingOrder | 返回PendingOrder实例 |
| FP-027-003 | 批量取消挂单 | 取消指定K线的所有未成交挂单，解冻资金 | 资金正确解冻 |
| FP-027-004 | 成交判断 | 检查挂单价格是否在K线[low, high]区间内 | 返回布尔值 |
| FP-027-005 | 资金冻结 | 挂单时冻结position_size金额 | 可用资金减少 |
| FP-027-006 | 资金解冻 | 取消挂单时解冻资金 | 可用资金恢复 |

### 模块2: 买入挂单逻辑

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-027-007 | 计算首笔挂单价格 | 计算 (P5 + mid) / 2 | 价格正确 |
| FP-027-008 | 计算批量挂单价格 | 按order_interval递减计算N笔挂单价格 | N个价格正确 |
| FP-027-009 | 生成买入挂单 | 每根K线生成order_count笔买入挂单 | 挂单数量正确 |
| FP-027-010 | 资金不足处理 | 资金不足时记录失败，不中断后续挂单 | 日志记录正确 |
| FP-027-011 | 挂单成交转换 | 成交的挂单转换为Order持仓 | Order创建正确 |

### 模块3: 卖出挂单逻辑

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-027-012 | 计算卖出价格 | min(买入价×1.05, EMA25) | 价格取较低值 |
| FP-027-013 | 创建卖出挂单 | 为每笔持仓创建卖出挂单 | 挂单数量=持仓数量 |
| FP-027-014 | 动态更新卖出价 | 每根K线重新计算卖出价格 | EMA25值正确更新 |
| FP-027-015 | 卖出成交处理 | 成交时平仓并计算盈亏 | 盈亏计算正确 |

### 模块4: 策略集成

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-027-016 | 策略11配置解析 | 解析order_count, order_interval参数 | 参数正确加载 |
| FP-027-017 | DDPSZAdapter扩展 | 支持strategy_id=11 | 策略11可选择 |
| FP-027-018 | 回测流程集成 | 策略11融入现有回测流程 | 回测可正常执行 |

---

## P1 功能点 (延迟)

| ID | 功能点 | 描述 | 延迟原因 |
|----|--------|------|----------|
| FP-027-P1-001 | 挂单可视化 | 在K线图上显示挂单位置 | 非MVP核心功能 |
| FP-027-P1-002 | 部分成交支持 | 支持挂单部分成交 | 增加复杂度 |
| FP-027-P1-003 | 挂单有效期 | 设置挂单的有效K线数量 | 当前每根K线重新挂单已满足需求 |
| FP-027-P1-004 | 做空挂单 | 支持限价做空挂单 | 先完成做多验证 |

---

## 功能点依赖关系

```
FP-027-001 (PendingOrder结构)
    ↓
FP-027-002 (创建挂单) ←── FP-027-005 (资金冻结)
    ↓
FP-027-007 (首笔价格) → FP-027-008 (批量价格) → FP-027-009 (生成挂单)
    ↓
FP-027-004 (成交判断) → FP-027-011 (挂单转Order)
    ↓
FP-027-012 (卖出价格) → FP-027-013 (卖出挂单)
    ↓
FP-027-014 (动态更新) → FP-027-015 (卖出成交)
    ↓
FP-027-016~018 (策略集成)
```

---

## 配置参数清单

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| order_count | int | 10 | 每根K线挂单数量 |
| order_interval | float | 0.005 | 挂单价格间隔(0.5%) |
| position_size | Decimal | 100 | 单笔挂单金额(USDT) |
| take_profit_rate | float | 0.05 | 止盈比例(5%) |
| ema_period | int | 25 | EMA周期 |

---

## 测试用例概要

### 单元测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| UT-001 | 计算首笔挂单价格 | (P5+mid)/2 |
| UT-002 | 计算第N笔挂单价格 | 首笔×(1-(N-1)×interval) |
| UT-003 | 资金不足挂单 | 挂单失败，日志记录 |
| UT-004 | 挂单成交判断 | low<=price<=high返回True |
| UT-005 | 卖出价格计算 | min(买入价×1.05, EMA25) |

### 集成测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| IT-001 | 单根K线挂10笔单 | 10笔挂单创建成功 |
| IT-002 | 挂单成交转持仓 | Order正确创建 |
| IT-003 | 持仓卖出成交 | 盈亏计算正确 |
| IT-004 | CSV数据回测 | 回测完成无报错 |

---

## 风险评估

| 风险点 | 影响程度 | 缓解措施 |
|--------|----------|----------|
| 挂单数量过多导致性能问题 | 中 | 限制order_count最大值 |
| 资金冻结/解冻逻辑错误 | 高 | 单元测试覆盖 |
| 与现有策略冲突 | 低 | 策略11独立实现 |
