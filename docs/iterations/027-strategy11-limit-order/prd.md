# PRD: 策略11 - 限价挂单买卖机制

## 文档信息

| 属性 | 值 |
|------|-----|
| 迭代编号 | 027 |
| 迭代名称 | strategy11-limit-order |
| 版本 | 1.0 |
| 状态 | Draft |
| 创建日期 | 2026-01-10 |
| 关联任务 | TASK-027-xxx |

---

## 1. 背景与目标

### 1.1 业务背景

现有DDPS-Z策略体系（策略1~10）均采用**市价单**机制：检测到信号后立即以当前价格买入/卖出。这种方式存在以下局限：

1. **滑点问题**：市价单在高波动行情中可能产生较大滑点
2. **价格控制不足**：无法精确控制成交价格
3. **策略灵活性受限**：无法实现"低价挂单等待成交"的交易策略

用户希望新增**策略11**，引入**限价挂单机制**，实现更精细的价格控制和分批建仓策略。

### 1.2 核心目标

构建策略11，实现以下功能：

1. **买入挂单**：基于DDPS概率分布计算挂单价格，每根K线挂10笔限价买单
2. **卖出挂单**：为每笔持仓订单动态计算卖出价格，等待成交
3. **成交判断**：下根K线的[low, high]区间包含挂单价格即视为成交
4. **资金管理**：挂单即冻结资金，资金不足时挂单失败

### 1.3 策略定位

- **策略类型**：做多策略（限价挂单）
- **入场特征**：分批挂单，从(P5+mid)/2开始，每隔0.5%向下挂单
- **出场特征**：5%止盈 或 EMA25回归，取较低价格挂单
- **核心创新**：首个采用限价挂单机制的策略

---

## 2. 核心功能需求

### 2.1 买入挂单机制

#### 2.1.1 挂单价格计算

| 序号 | 挂单价格公式 | 说明 |
|------|-------------|------|
| 1 | `(P5 + mid) / 2` | 第一笔挂单价格 |
| 2 | `第1笔 × (1 - 0.5%)` | 第二笔挂单价格 |
| 3 | `第1笔 × (1 - 1.0%)` | 第三笔挂单价格 |
| ... | ... | ... |
| N | `第1笔 × (1 - (N-1) × 0.5%)` | 第N笔挂单价格 |

**数据来源**：
- **P5**：DDPS模块计算的概率分布5%位置
- **mid**：DDPS模块计算的扇形中间位置

#### 2.1.2 挂单规则

| 规则ID | 规则描述 | 说明 |
|--------|----------|------|
| BUY-1 | 每根K线重新挂单 | 取消所有未成交挂单，基于最新K线数据重新计算并挂单 |
| BUY-2 | 挂单数量可配置 | 默认10笔，通过`order_count`参数配置 |
| BUY-3 | 挂单间隔可配置 | 默认0.5%，通过`order_interval`参数配置 |
| BUY-4 | 挂单即冻结资金 | 每笔挂单立即占用`position_size`金额 |
| BUY-5 | 资金不足记录失败 | 资金不足时该笔挂单失败，记录日志，继续处理后续挂单 |

#### 2.1.3 成交判断

```
成交条件：下根K线的 low <= 挂单价格 <= high
成交价格：挂单价格（限价单精确成交）
```

### 2.2 卖出挂单机制

#### 2.2.1 卖出价格计算

```python
卖出价格 = min(买入价 × 1.05, EMA25)
```

**逻辑说明**：
- **5%止盈价**：买入价 × 1.05
- **EMA25回归价**：当前K线的EMA25值
- 取两者中的**较低价格**作为卖出挂单价格

#### 2.2.2 卖出规则

| 规则ID | 规则描述 | 说明 |
|--------|----------|------|
| SELL-1 | 每根K线动态更新 | 基于最新EMA25值重新计算卖出价格 |
| SELL-2 | 每笔持仓独立挂单 | 每个持仓订单有独立的卖出挂单 |
| SELL-3 | 成交判断 | 下根K线 low <= 卖出价 <= high 即成交 |

### 2.3 策略配置

```json
{
  "id": "strategy_11",
  "name": "限价挂单策略",
  "type": "ddps-z",
  "enabled": true,
  "entry": {
    "strategy_id": 11,
    "description": "每根K线挂N笔限价买单",
    "order_count": 10,
    "order_interval": 0.005
  },
  "exits": [
    {
      "type": "limit_order_exit",
      "params": {
        "take_profit_rate": 0.05,
        "ema_period": 25
      },
      "description": "min(5%止盈, EMA25) 挂限价卖单"
    }
  ]
}
```

---

## 3. 回测配置需求

### 3.1 默认回测配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 数据源类型 | csv_local | 本地CSV文件 |
| 数据文件 | ETHUSDT-1m-2025-12.csv | 1分钟K线数据 |
| 交易对 | ETHUSDT | 以太坊/USDT |
| K线周期 | 1m | 1分钟 |
| 时间范围 | CSV全部数据 | 不限定日期 |
| 初始资金 | 10000 USDT | 默认值 |
| 单笔金额 | 100 USDT | 每笔挂单金额 |

### 3.2 配置文件示例

```json
{
  "project_name": "策略11-限价挂单回测",
  "description": "使用1分钟K线CSV数据进行策略11回测",
  "version": "1.0",

  "data_source": {
    "type": "csv_local",
    "csv_path": "/Users/chenchiyuan/projects/crypto_exchange_news_crawler/data/ETHUSDT-1m-2025-12.csv",
    "interval": "1m",
    "timestamp_unit": "microseconds"
  },

  "backtest_config": {
    "symbol": "ETHUSDT",
    "interval": "1m",
    "market_type": "csv_local",
    "initial_cash": 10000,
    "commission_rate": 0.001
  },

  "capital_management": {
    "mode": "shared",
    "position_size_mode": "fixed",
    "position_size": 100,
    "max_positions": 100
  },

  "strategies": [
    {
      "id": "strategy_11",
      "name": "限价挂单策略",
      "type": "ddps-z",
      "enabled": true,
      "entry": {
        "strategy_id": 11,
        "order_count": 10,
        "order_interval": 0.005
      },
      "exits": [
        {
          "type": "limit_order_exit",
          "params": {
            "take_profit_rate": 0.05,
            "ema_period": 25
          }
        }
      ]
    }
  ]
}
```

---

## 4. 系统影响分析

### 4.1 架构变更

策略11引入了全新的**限价挂单机制**，与现有市价单策略有本质区别，需要新增以下组件：

| 组件 | 类型 | 说明 |
|------|------|------|
| LimitOrderManager | 新增 | 管理限价挂单的创建、取消、成交判断 |
| PendingOrder | 新增模型 | 表示未成交的挂单 |
| LimitOrderStrategy | 新增策略 | 实现策略11的挂单逻辑 |
| limit_order_exit | 新增Exit | 限价卖出挂单处理 |

### 4.2 需修改模块

| 模块 | 文件 | 修改类型 | 说明 |
|------|------|----------|------|
| SignalCalculator | `ddps_z/calculators/signal_calculator.py` | 扩展 | 新增策略11信号计算（获取P5、mid） |
| DDPSZAdapter | `strategy_adapter/adapters/ddpsz_adapter.py` | 扩展 | 支持strategy_id=11 |
| StrategyAdapter | `strategy_adapter/core/strategy_adapter.py` | 扩展 | 支持限价挂单流程 |
| ProjectLoader | `strategy_adapter/core/project_loader.py` | 扩展 | 解析新配置参数 |

### 4.3 复用现有组件

- **DDPS计算**：复用现有P5、mid计算逻辑
- **EMA25计算**：复用EMACalculator
- **配置系统**：复用JSON配置框架
- **回测框架**：复用现有回测命令和统计计算

---

## 5. 验收标准

### 5.1 功能验收

| 验收项 | 验收标准 |
|--------|----------|
| AC-1 | 策略11配置文件可正常加载 |
| AC-2 | 每根K线正确生成N笔挂单（默认10笔） |
| AC-3 | 挂单价格计算正确：第1笔=(P5+mid)/2，后续每隔0.5%递减 |
| AC-4 | 资金不足时挂单失败并记录日志 |
| AC-5 | 下根K线正确判断挂单是否成交 |
| AC-6 | 卖出价格=min(买入价×1.05, EMA25) |
| AC-7 | 卖出挂单每根K线动态更新 |
| AC-8 | 回测结果可保存到数据库 |
| AC-9 | Web界面可查看回测结果 |

### 5.2 性能验收

| 指标 | 目标值 |
|------|--------|
| 单根K线处理时间 | < 10ms |
| 1个月1m数据回测 | < 60秒 |
| 内存占用 | < 2GB |

---

## 6. 技术约束

1. **向后兼容**：不破坏现有策略1~10的功能
2. **配置驱动**：策略参数通过JSON配置
3. **复用优先**：优先复用现有DDPS计算和回测框架
4. **限价单精确成交**：成交价格为挂单价格，非K线的open/close

---

## 7. 风险与依赖

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 挂单管理复杂度 | 中 | 设计独立的LimitOrderManager |
| 资金冻结逻辑 | 中 | 清晰定义冻结/解冻时机 |
| 与现有流程集成 | 低 | 策略11独立实现，不修改现有策略 |

### 7.2 依赖项

- DDPS模块的P5、mid计算功能
- CSV数据源功能（迭代025）
- EMA25计算功能

---

## 附录

### A. 策略对比

| 策略ID | 订单类型 | 入场条件 | 出场条件 |
|--------|----------|----------|----------|
| 策略1~10 | 市价单 | 信号触发即买入 | EMA25回归/止盈/止损 |
| **策略11** | **限价单** | **每根K线挂N笔单** | **min(5%止盈, EMA25)挂单** |

### B. 挂单生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                     挂单生命周期                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  K线N:  计算(P5+mid)/2 → 挂10笔买单 → 冻结资金              │
│              ↓                                               │
│  K线N+1: 检查成交 → 成交的订单进入持仓                        │
│              ↓        → 未成交的挂单全部取消                  │
│              ↓                                               │
│          重新计算 → 挂新的10笔买单                            │
│              ↓                                               │
│  持仓订单: 计算卖出价 → 挂卖单                               │
│              ↓                                               │
│  K线N+2: 检查卖单成交 → 成交则平仓                           │
│              ↓          → 未成交则更新卖价重新挂单            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### C. 相关文档

- 策略框架：`docs/iterations/017-multi-strategy-backtest/`
- 策略10参考：`docs/iterations/026-strategy10-mid-p5-entry/`
- CSV数据源：`docs/iterations/025-csv-datasource/`
