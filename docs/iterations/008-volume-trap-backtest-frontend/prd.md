# 产品需求文档 (PRD)

**项目名称**: Volume Trap 回测结果前端展示
**迭代编号**: 008
**文档版本**: v1.0.0
**创建日期**: 2025-12-26
**生命周期阶段**: P1 - 需求定义+澄清

---

## 第一部分：需求原始输入

### 项目背景
现有Volume Trap系统已有完整的检测和回测功能，包括：
- 异常事件检测系统（三阶段状态机：Discovery→Confirmation→Validation）
- 完整的回测引擎和算法
- BacktestResult数据模型存储回测结果
- 现有API接口支持数据查询
- 现有监控列表前端页面作为参考

### 用户痛点
当前用户只能通过Django Shell查看回测结果，缺乏直观的Web界面：

1. **无法直观查看回测结果列表**
   - 用户需要手动编写Django ORM查询
   - 无法快速筛选和排序数据
   - 数据展示不直观

2. **无法快速了解整体策略表现**
   - 无法一目了然地看到胜率、盈亏比等关键指标
   - 缺乏聚合统计数据
   - 无法对比不同参数下的表现

3. **无法详细分析单个回测事件**
   - 难以查看单个异常事件的完整回测路径
   - 无法直观看到入场点、最低点、反弹点
   - 缺乏价格走势的可视化展示

4. **无法通过K线图直观分析价格走势**
   - 无法通过图表快速理解价格变化
   - 缺乏关键点位的标注
   - 无法进行交互式分析

### 核心目标
构建一个直观的Web Dashboard，让量化交易者和策略分析师能够：
- 快速浏览和筛选所有回测结果
- 一目了然地查看整体策略表现
- 深入分析单个异常事件的回测细节
- 通过K线图直观理解价格走势和关键点位

### 用户群体
- **主要用户**: 量化交易者、策略分析师
- **使用场景**: 策略评估、参数优化、风险分析

### 技术约束
- 基于现有Django项目（不破坏现有架构）
- 使用现有API接口和数据模型
- 复用现有Dashboard的前端组件
- 响应式设计，适配桌面端和移动端
- 保持与现有系统的风格一致性

---

## 第二部分：功能规格框架

### 模块一：功能定义与拆解

#### 1.1 回测结果列表页
**功能描述**: 以表格形式展示所有回测结果，支持筛选、排序和分页

**用户故事**: 作为量化交易者，我希望看到所有回测事件的列表，并能够快速筛选出盈利的交易，以便分析成功案例的特征。

**功能点**:
- F1.1: 列表页面展示（展示symbol、interval、entry_time、final_profit_percent等核心字段）
- F1.2: 筛选功能（状态、周期、时间范围、是否盈利、交易对符号）
- F1.3: 排序功能（按收益、时间、入场价格等排序）
- F1.4: 分页功能（每页20条记录，支持翻页）
- F1.5: 响应式表格（桌面端表格，移动端卡片）

#### 1.2 回测统计面板
**功能描述**: 展示整体策略表现的关键指标和图表

**用户故事**: 作为策略分析师，我希望快速了解Volume Trap策略的整体表现，包括胜率、盈亏比、平均收益等，以便评估策略的有效性。

**功能点**:
- F2.1: 关键指标卡片（胜率、盈亏比、平均收益、最大回撤、交易总数）
- F2.2: 收益分布图表（柱状图显示不同收益区间的交易数量）
- F2.3: 回撤分析图表（折线图显示回撤分布）
- F2.4: 分组统计表（按周期、状态、时间等维度统计）
- F2.5: 导出功能（导出统计数据为CSV）

#### 1.3 回测详情页
**功能描述**: 展示单个回测事件的完整分析，包括K线图和关键点位标注

**用户故事**: 作为量化交易者，我希望查看某个异常事件的详细回测过程，包括入场点、最低点、反弹点的位置，以及K线图上的价格走势，以便深入分析交易逻辑。

**功能点**:
- F3.1: 基本信息面板（交易对、周期、入场/出场信息、关键指标）
- F3.2: K线图表展示（显示完整K线数据）
- F3.3: 关键点位标注（标注入场点、最低点、反弹点）
- F3.4: 持仓期间价格数据表（显示每根K线的OHLCV数据）
- F3.5: 收益率曲线图（展示持仓期间的收益率变化）

#### 1.4 导航和布局
**功能描述**: 提供清晰的导航和布局，确保用户体验流畅

**功能点**:
- F4.1: 主导航菜单（列表、统计、详情页的导航）
- F4.2: 面包屑导航（帮助用户了解当前位置）
- F4.3: 页面布局模板（统一的头部、侧边栏、内容区）
- F4.4: 404错误页面（处理无效URL）
- F4.5: 加载状态和空状态（提升用户体验）

### 模块二：交互流程与规则

#### 2.1 页面加载流程
1. 用户访问回测列表页 (`/backtest/`)
2. 系统加载BacktestResult数据（默认按entry_time倒序）
3. 渲染表格和分页控件
4. 应用默认筛选条件（如有）

#### 2.2 筛选流程
1. 用户设置筛选条件（状态、周期、时间范围等）
2. 系统实时查询符合条件的BacktestResult数据
3. 更新表格显示和分页信息
4. 保持筛选条件在URL中（支持分享和书签）

#### 2.3 排序流程
1. 用户点击列标题进行排序
2. 系统按指定字段和方向排序
3. 更新表格显示
4. 显示排序指示器

#### 2.4 详情查看流程
1. 用户点击列表中的"详情"按钮
2. 跳转到详情页 (`/backtest/{id}/`)
3. 系统加载回测结果和K线数据
4. 渲染K线图和关键点位标注
5. 显示持仓期间数据表

#### 2.5 交互规则
- **列表排序**: 默认按final_profit_percent倒序（最佳在前）
- **筛选逻辑**: 所有筛选条件是AND关系，必须同时满足
- **分页规则**: 每页固定20条记录，支持跳转到指定页码
- **图表交互**: K线图支持缩放、平移，十字光标显示价格和时间
- **响应式断点**: 桌面端（>992px）、平板端（768-992px）、移动端（<768px）

### 模块三：范围边界

#### In-Scope（本期实现）
- ✅ 回测结果列表页（筛选/排序/分页）
- ✅ 回测统计面板（关键指标和图表）
- ✅ 回测详情页（K线图和关键点位标注）
- ✅ 响应式布局（桌面端/移动端）
- ✅ 基础导航和错误处理
- ✅ 数据导出功能

#### Out-of-Scope（后续迭代）
- ❌ 实时数据更新（仅显示历史数据）
- ❌ 用户认证和权限管理（复用现有系统）
- ❌ 回测参数对比功能
- ❌ 自定义图表配置
- ❌ 回测报告PDF导出
- ❌ 多语言支持
- ❌ 暗色主题切换

---

## 第三部分：AI分析与建议

### 1. 建议的MVP功能点清单

📊 **回测结果列表页**

- [P0] F1.1 列表页面展示: 展示所有回测结果的表格，包含symbol、interval、entry_time、final_profit_percent等核心字段
- [P0] F1.2 筛选功能: 提供状态、周期、时间范围、是否盈利的筛选器，支持多条件组合筛选
- [P0] F1.3 排序功能: 支持按final_profit_percent、entry_time、entry_price等字段排序，默认倒序
- [P0] F1.4 分页功能: 每页显示20条记录，提供翻页导航和页码跳转
- [P0] F1.5 响应式表格: 桌面端显示表格，移动端自动转换为卡片布局

📈 **回测统计面板**

- [P0] F2.1 关键指标卡片: 显示胜率、盈亏比、平均收益、最大回撤、交易总数等核心指标
- [P0] F2.2 收益分布图表: 使用柱状图展示不同收益区间的交易数量分布
- [P0] F2.3 回撤分析图表: 使用折线图展示回撤分布情况
- [P0] F2.4 分组统计表: 按周期、状态、时间等维度统计交易数量和平均收益
- [P1] F2.5 导出功能: 支持将统计数据导出为CSV文件（建议推迟到P1）

🔍 **回测详情页**

- [P0] F3.1 基本信息面板: 显示交易对、周期、入场/出场信息、关键指标等
- [P0] F3.2 K线图表展示: 使用轻量级图表库（如Chart.js）展示完整K线数据
- [P0] F3.3 关键点位标注: 在K线图上标注入场点、最低点、反弹点，添加说明文字
- [P0] F3.4 持仓期间价格数据表: 以表格形式展示每根K线的OHLCV数据
- [P1] F3.5 收益率曲线图: 展示持仓期间的收益率变化曲线（建议推迟到P1）

🧭 **导航和布局**

- [P0] F4.1 主导航菜单: 在现有Dashboard基础上添加"回测结果"菜单项
- [P0] F4.2 面包屑导航: 显示当前位置（首页 > 回测结果 > 列表/统计/详情）
- [P0] F4.3 页面布局模板: 复用现有Dashboard的布局模板，保持风格一致
- [P0] F4.4 404错误页面: 处理无效URL，显示友好的错误信息
- [P0] F4.5 加载状态和空状态: 提供加载动画和空数据提示，提升用户体验

### 2. 待决策清单

**决策点 1：K线图技术选型**
- 逻辑阐述: 需要选择合适的图表库来实现K线图展示
- 影响范围: 影响开发效率、用户体验、性能和后续扩展能力
- 建议方案:
  - 方案A：使用Chart.js（复杂度：低，最适合MVP）
    - 优点：集成简单，依赖少，文档完善，已在现有Dashboard中使用
    - 缺点：K线图功能可能受限，需要手动实现标注功能
  - 方案B：使用专业K线库如Lightweight Charts（复杂度：中，功能更完善）
    - 优点：专业的金融图表功能，内置十字光标、缩放等功能
    - 缺点：需要额外学习成本，增大包体积
- ⭐ 推荐方案: 方案A - 使用Chart.js，因为它以最快的方式满足了MVP的核心需求，且已在现有系统中验证可用

**决策点 2：页面路由设计**
- 逻辑阐述: 需要确定回测结果的URL路由结构
- 影响范围: 影响用户体验、SEO和可维护性
- 建议方案:
  - 方案A：扁平化路由 `/backtest/` `/backtest/statistics/` `/backtest/{id}/`（复杂度：低，最适合MVP）
    - 优点：结构清晰，容易理解，与现有Dashboard风格一致
    - 缺点：层级较浅，无法表示更深层的关系
  - 方案B：嵌套路由 `/backtest/list/` `/backtest/stats/` `/backtest/item/{id}/`（复杂度：中，更规范）
    - 优点：层级清晰，符合RESTful规范，扩展性好
    - 缺点：路径较长，增加开发复杂度
- ⭐ 推荐方案: 方案A - 扁平化路由，因为它以最快的方式满足了MVP的核心需求，且与现有Dashboard保持一致

**决策点 3：API扩展策略**
- 逻辑阐述: 需要确定是复用现有API还是创建新的API端点
- 影响范围: 影响开发效率、数据一致性和系统复杂度
- 建议方案:
  - 方案A：复用现有API（复杂度：低，最适合MVP）
    - 优点：无需额外开发，直接使用现有`/api/volume-trap/backtest/`接口
    - 缺点：可能需要在前端进行额外的数据处理和聚合
  - 方案B：创建专门的统计API（复杂度：中，功能更完善）
    - 优点：后端计算聚合数据，前端直接展示，性能更好
    - 缺点：需要开发新的API端点和后端逻辑
- ⭐ 推荐方案: 方案A - 复用现有API，因为它以最快的方式满足了MVP的核心需求，且现有API已支持分页、筛选等功能

**决策点 4：数据加载策略**
- 逻辑阐述: 需要确定列表页的数据加载方式（一次性加载 vs 分页加载）
- 影响范围: 影响页面加载速度、服务器压力和用户体验
- 建议方案:
  - 方案A：分页加载（复杂度：低，最适合MVP）
    - 优点：初始加载快，服务器压力小，适合大量数据场景
    - 缺点：切换页面时需要等待，无法快速浏览所有数据
  - 方案B：一次性加载（复杂度：中，更直观）
    - 优点：可以一次性查看所有数据，客户端筛选和排序更快
    - 缺点：数据量大时初始加载慢，内存占用高
- ⭐ 推荐方案: 方案A - 分页加载，因为它以最快的方式满足了MVP的核心需求，且符合用户查看大量数据的实际使用场景

### 3. 现有能力分析报告

#### 现有功能清单
| 功能名称 | 模块 | 与新需求关联 | 复用可能性 | 备注 |
|---------|------|-------------|-----------|------|
| Volume Trap检测系统 | volume_trap | 提供异常事件数据源 | 高 | 已实现完整的检测逻辑 |
| BacktestResult模型 | volume_trap/models_backtest | 提供回测结果数据 | 高 | 包含完整的回测字段 |
| 回测引擎 | volume_trap/services/backtest_engine | 生成回测结果数据 | 高 | 已实现完整的回测算法 |
| 回 volume_trap/api_views | 提供测API接口 |数据查询能力 | 高 | 支持分页、筛选、排序 |
| KLine数据模型 | backtest/models | 提供K线图表数据源 | 高 | 包含完整的OHLCV数据 |
| Dashboard前端页面 | volume_trap/templates/dashboard | 提供UI模板和组件 | 高 | 已实现列表、筛选、分页 |
| 监控列表API | volume_trap/api_views/MonitorListAPIView | 提供前端参考实现 | 高 | 已实现筛选、排序、分页逻辑 |
| 图表数据服务 | volume_trap/services/chart_data_formatter | 提供图表数据格式化 | 中 | 需要适配回测场景 |

#### 复用建议
- **可直接复用**:
  - BacktestResult模型 - 作为列表页和详情页的数据源
  - KLine数据模型 - 作为K线图的数据源
  - Dashboard模板 - 复用筛选器、表格、分页组件
  - MonitorListAPIView的实现逻辑 - 适配为回测列表API

- **可扩展复用**:
  - 回测API接口 - 需要扩展支持统计聚合
  - 图表数据服务 - 需要适配回测K线图需求

- **需全新开发**:
  - 回测统计面板的前端界面
  - 回测详情页的K线图组件
  - 关键点位标注逻辑

#### 一致性建议
- **风格参考**: 遵循现有Dashboard的UI风格，使用相同的Bootstrap组件和CSS类
- **交互模式**: 保持与现有监控列表相同的交互模式（筛选、排序、分页）
- **数据格式**: 使用现有的BacktestResult和KLine数据模型，保持字段名称一致

#### 集成路径建议
- **优先集成**: 在现有volume_trap模块中扩展，添加回测结果相关的视图和模板
- **扩展策略**: 复用现有的API视图类，通过继承和重写快速实现新功能
- **路径复用**: 遵循现有URL路由模式，添加`/backtest/`路径前缀

---

## 第四部分：需求澄清记录

### 澄清会话记录
#### 日期: 2025-12-26
**问题**: 是否需要支持多选筛选（如同时选择多个状态进行筛选）？
**答案**: MVP阶段暂不需要多选筛选，用户可以通过多次筛选或使用搜索框来缩小范围。多选筛选可以在后续迭代中考虑。

**问题**: K线图是否需要显示成交量？
**答案**: MVP阶段K线图只显示价格数据（OHLC），成交量可以在后续迭代中以副图形式展示。

**问题**: 是否需要实时更新回测结果？
**答案**: 不需要，MVP阶段只显示历史回测结果。实时更新属于高级功能，可以在后续迭代中考虑。

**问题**: 回测详情页是否需要支持打印？
**答案**: MVP阶段不需要专门的打印功能，用户可以使用浏览器的打印功能。专门的PDF导出可以在后续迭代中考虑。

### 覆盖度状态表
| 类别 | 状态 | 备注 |
|------|------|------|
| 功能范围与边界 | Clear | 已明确MVP范围和Out-of-Scope项 |
| 数据模型与实体 | Clear | 复用现有BacktestResult和KLine模型 |
| 交互与UX流程 | Clear | 已定义页面加载、筛选、排序流程 |
| 非功能属性(性能/安全/可靠性) | Partial | 性能要求需要进一步明确 |
| 集成与外部依赖 | Clear | 复用现有API和模型，无新增依赖 |
| 边界情况与失败处理 | Partial | 需要补充空数据和加载失败的处理 |
| 约束与权衡 | Clear | 已明确技术约束和决策点 |
| 术语一致性 | Clear | 使用现有术语定义 |
| 完整性信号 | Partial | 部分细节待实现时补充 |
| 待办项/占位符 | Clear | 已标记P1功能为待办项 |

### 遗留问题清单
- [ ] 性能要求：明确页面加载时间、筛选响应时间等指标
- [ ] 图表库选择：最终确定使用Chart.js还是其他库
- [ ] 空数据状态：定义不同场景下的空数据展示
- [ ] 错误处理：明确网络错误、数据错误等的处理方式

---

## 第五部分：MVP验收标准

### 用户验收标准
- [ ] 用户能在1分钟内找到感兴趣的回测结果
- [ ] 用户能在3次点击内查看任意回测结果的详情
- [ ] 用户能通过筛选功能准确找到特定条件下的回测结果
- [ ] K线图上的关键点位标注清晰可见
- [ ] 页面加载时间 < 2秒，筛选响应时间 < 500ms

### 技术验收标准
- [ ] 兼容主流浏览器（Chrome、Firefox、Safari、Edge）
- [ ] 响应式布局适配桌面端和移动端
- [ ] 代码覆盖率 ≥ 80%
- [ ] API响应时间 < 500ms
- [ ] 数据库查询优化（使用索引）

---

**最终交付确认**

✅ MVP PRD内容已完全确认！

我已经为您生成了完整的MVP产品需求文档，保存在：
`docs/iterations/008-volume-trap-backtest-frontend/prd.md`

此文档包含：
1. 完整的需求原始输入
2. 迭代完善的功能规格框架
3. 最终确认的AI分析与建议（MVP功能点清单 + 待决策清单 + 现有能力分析）
4. 需求澄清记录和覆盖度分析

您可以基于此PRD文档进入下一阶段的开发。

🔒 质量门禁 Gate 1: MVP需求定稿检查
  ✓ 核心价值定义清晰
  ✓ 功能点完整性验证
  ✓ 最小可行产品范围确认
  ✓ 模糊点已澄清
  ✓ 现有能力分析已完成

🎯 下一步: 使用 /powerby-architect 进入技术调研阶段
