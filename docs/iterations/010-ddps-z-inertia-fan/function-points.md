# 功能点清单: DDPS-Z 惯性预测扇面系统

**迭代编号**: 010
**文档版本**: 1.1
**创建日期**: 2026-01-05

---

## ⚠️ 增量更新原则

| 类型 | 说明 | 标记 |
|------|------|------|
| **新增文件** | 完全新建的计算器/服务 | 🆕 |
| **扩展接口** | 在现有函数/API上新增参数或返回字段 | 📝 |
| **复用现有** | 直接调用，无任何修改 | ✅ |

**向后兼容承诺**：所有现有 DDPS-Z 功能（EMA、Z-Score、静态概率带）保持不变。

---

## MVP 功能点（P0 优先级）

### 模块 1: ADX 计算器（🆕 新增文件）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-001 | ADX 计算器实现 | 🆕 实现 14 周期 ADX 指标计算，包含 +DI、-DI、DX、ADX 完整计算链 | P0 | 无 |
| FP-010-002 | ADX 序列计算 | 🆕 支持返回完整 ADX 时间序列，用于图表展示 | P0 | FP-010-001 |
| FP-010-003 | ADX 边界处理 | 🆕 处理 K 线不足时的 ADX 计算（返回 None 或默认值） | P0 | FP-010-001 |

### 模块 2: 惯性计算器（🆕 新增文件）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-004 | 趋势斜率 β 计算 | 🆕 计算 EMA25 的变化率：β = EMA25[t] - EMA25[t-1] | P0 | ✅ 复用 EMA 计算 |
| FP-010-005 | 动态惯性周期 T_adj | 🆕 根据 ADX 计算动态周期：T_adj = T × (1 + ADX/100)，范围 [5, 10] | P0 | FP-010-001 |
| FP-010-006 | 预测中轴计算 | 🆕 计算未来 T 周期的 EMA 预测值：Ê(t+T) = EMA25_t + (β × T) | P0 | FP-010-004 |
| FP-010-007 | 扇面边界计算 | 🆕 计算 Upper/Lower 边界，使用 Z=1.645 和 √T 扩散 | P0 | FP-010-006, ✅ 复用 EWMA σ |
| FP-010-008 | 扇面点序列生成 | 🆕 生成未来 T 个周期的扇面坐标点序列 | P0 | FP-010-007 |

### 模块 3: 双重阈值信号引擎（🆕 新增信号类型，不替代现有）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-009 | 空间准则判断 | 🆕 判断价格是否突破静态 5%/95% 分位带 | P0 | ✅ 复用 Z-Score |
| FP-010-010 | 时间准则判断 | 🆕 判断价格是否突破动态扇面边界 | P0 | FP-010-007 |
| FP-010-011 | 双重阈值信号触发 | 🆕 仅当空间+时间准则同时满足时触发买入/卖出信号 | P0 | FP-010-009, FP-010-010 |
| FP-010-012 | 信号状态封装 | 🆕 返回结构化的信号状态（type, space_triggered, time_triggered） | P0 | FP-010-011 |

### 模块 4: 智能状态机（🆕 新增模块）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-013 | 惯性保护状态 | 🆕 识别价格在扇面内运行的状态 | P0 | FP-010-007 |
| FP-010-014 | 惯性衰减状态 | 🆕 识别价格接近扇面边缘的状态 | P0 | FP-010-007 |
| FP-010-015 | 状态标签生成 | 🆕 生成中文状态标签（惯性保护中/惯性衰减/信号触发） | P0 | FP-010-013, FP-010-014 |

### 模块 5: API 扩展（📝 扩展现有，新增字段）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-016 | calculate API 扩展 | 📝 在响应中**新增** inertia 字段（adx, beta, t_adj, fan, state），现有字段不变 | P0 | FP-010-005, FP-010-015 |
| FP-010-017 | chart API 扩展 | 📝 在响应中**新增** fan 字段（direction, points 序列），现有字段不变 | P0 | FP-010-008 |

### 模块 6: 前端可视化（📝 扩展现有，叠加新元素）

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-018 | 扇面填充区域 | 🆕 使用 AreaSeries **叠加**绘制向未来延伸的锥形填充区域 | P0 | FP-010-017 |
| FP-010-019 | 扇面边界线 | 🆕 使用 LineSeries **叠加**绘制中轴线和上下边界虚线 | P0 | FP-010-017 |
| FP-010-020 | 扇面颜色动态切换 | 🆕 根据 β 正负切换扇面颜色（绿色上涨/红色下跌） | P0 | FP-010-018 |
| FP-010-021 | HUD 信息面板 | 🆕 **新增**面板显示静态阈值、惯性预测值、状态、ADX、β 等信息 | P0 | FP-010-016 |
| FP-010-022 | 状态徽章显示 | 🆕 **新增**显示当前惯性状态的彩色徽章 | P0 | FP-010-016 |

---

## 后续优化功能点（P1 优先级）

### 模块 7: 信号修正逻辑

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-023 | 斜率变化监测 | 监测近 3 周期 β 绝对值变化趋势 | P1 | FP-010-004 |
| FP-010-024 | 动量衰减提前释放 | β 绝对值持续减小时提前触发信号 | P1 | FP-010-023 |
| FP-010-025 | 动量增强观察期 | β 绝对值持续增大时强制 1 根 K 线观察期 | P1 | FP-010-023 |
| FP-010-026 | 修正状态标记 | 在信号中标记 correction 类型（early/buffer） | P1 | FP-010-024, FP-010-025 |

### 模块 8: 历史信号回溯

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-027 | 历史信号计算 | 回溯计算历史 K 线上的信号触发点 | P1 | FP-010-011 |
| FP-010-028 | 信号标记渲染 | 在历史 K 线上显示买入/卖出信号标记 | P1 | FP-010-027 |

### 模块 9: 视觉优化

| ID | 功能点 | 描述 | 优先级 | 依赖 |
|----|--------|------|--------|------|
| FP-010-029 | 扇面动画效果 | 扇面更新时的平滑过渡动画 | P1 | FP-010-018 |
| FP-010-030 | 移动端适配 | HUD 面板在移动端的响应式布局 | P1 | FP-010-021 |

---

## 功能点统计

| 优先级 | 数量 | 状态 |
|--------|------|------|
| P0 (MVP) | 22 | 待开发 |
| P1 (后续) | 8 | 待规划 |
| **总计** | **30** | - |

---

## 与现有系统的关系

### 复用现有模块（不修改）

| 模块 | 文件 | 复用方式 |
|------|------|----------|
| EMA 计算 | `ema_calculator.py` | 直接调用 `calculate_ema_series()` |
| EWMA 计算 | `ewma_calculator.py` | 直接调用 `calculate()` 获取 σ_t |
| Z-Score 计算 | `zscore_calculator.py` | 直接调用获取分位带数据 |
| 静态概率带 | `chart_data_service.py` | 图表中保留现有概率带渲染 |

### 扩展现有模块（向后兼容）

| 模块 | 文件 | 扩展内容 |
|------|------|----------|
| 信号评估 | `signal_evaluator.py` | 新增 `evaluate_inertia_signal()` 方法 |
| DDPS 服务 | `ddps_service.py` | 在 `calculate()` 返回中新增 `inertia` 字段 |
| 图表服务 | `chart_data_service.py` | 在 `get_chart_data()` 返回中新增 `fan` 字段 |
| 详情页 | `detail.html` | 新增扇面渲染和 HUD 面板 |

---

## 验收检查清单

### MVP 验收（P0）

- [ ] 现有 DDPS-Z 功能完全正常（回归测试）
- [ ] ADX 计算结果与 TradingView 偏差 < 1%
- [ ] T_adj 在 [5, 10] 范围内正确计算
- [ ] 扇面坐标点序列正确生成
- [ ] 双重阈值逻辑正确实现
- [ ] API 响应包含完整 inertia 和 fan 数据
- [ ] 前端正确渲染扇面填充区域（叠加在现有图表上）
- [ ] HUD 面板正确显示所有指标
- [ ] 状态徽章正确切换颜色

### 后续验收（P1）

- [ ] 斜率修正逻辑正确触发
- [ ] 历史信号标记正确渲染
- [ ] 动画效果流畅无卡顿
- [ ] 移动端适配良好
