# PRD: DDPS-Z 惯性预测扇面系统 (Inertia Prediction Fan)

**迭代编号**: 010
**迭代名称**: DDPS-Z 惯性预测扇面系统
**文档版本**: 1.1
**创建日期**: 2026-01-05
**状态**: 需求定义

---

## ⚠️ 增量更新声明

**本迭代是增量更新，遵循以下原则：**

| 原则 | 说明 |
|------|------|
| **完全兼容** | 现有 DDPS-Z 所有功能保持不变（EMA、偏离率、Z-Score、静态概率带） |
| **功能叠加** | 动态扇形区间是**新增**功能，叠加在静态概率带之上 |
| **信号增强** | 双重阈值信号是**新增**信号类型，原有 Z-Score 信号保留 |
| **UI 扩展** | 前端新增扇形可视化和 HUD 面板，不修改现有图表元素 |

---

## 1. 概述

### 1.1 背景

现有 DDPS-Z 系统（迭代 009）提供了基于 Z-Score 的**静态概率带**分析，能够识别价格在历史波动分布中的相对位置。本迭代在此基础上**新增动态扇形区间**，解决以下问题：

1. **趋势惯性盲区**：静态带无法考虑当前趋势的延续性
2. **假信号问题**：单边行情中触及极端分位带后可能继续运动
3. **时机不精准**：缺乏"时间维度"验证

### 1.2 产品愿景

在**保持现有 DDPS-Z 功能完整**的前提下，**新增**惯性预测扇面：
- **动态预测扇面**：基于趋势斜率和波动率，投射未来 T 周期的价格区间（叠加在静态带上）
- **双重阈值信号**：空间准则（静态分位）+ 时间准则（动态扇面）双重验证（新增信号类型）
- **智能状态机**：实时显示"惯性保护中"或"惯性衰减"状态（新增状态显示）

### 1.3 目标用户

- 量化交易策略开发者
- 趋势跟踪型交易者
- 使用 DDPS-Z 系统的现有用户

---

## 2. 核心功能

### 2.1 惯性计算引擎

#### 2.1.1 动态锚点与标准化（✅ 复用现有，无修改）
- **价值中枢**：4h EMA25
- **偏离率**：$D_t = \frac{Price_t - EMA25_t}{EMA25_t}$
- **Z-Score**：$Z_t = \frac{D_t - \mu_t}{\sigma_t}$（EWMA 标准化）

#### 2.1.2 惯性参数计算（🆕 新增模块）
- **趋势斜率 β**：`β = EMA25[t] - EMA25[t-1]`
- **ADX 指标**：14 周期 ADX，用于调整惯性周期
- **动态惯性周期**：$T_{adj} = T \times (1 + \frac{ADX}{100})$，范围 [5, 10]

#### 2.1.3 动态扇面公式（🆕 新增模块）
```
预测中轴：Ê(t+T) = EMA25_t + (β × T)
上边界：Upper(t+T) = Ê(t+T) + (1.645 × σ_t × √T)
下边界：Lower(t+T) = Ê(t+T) + (-1.645 × σ_t × √T)
```

### 2.2 双重阈值信号引擎（🆕 新增模块，不替代现有信号）

> **注意**：这是**新增**的信号类型，与现有 Z-Score 信号**并存**，用户可同时参考两种信号。

#### 2.2.1 卖出信号 (Sell/Short)
**触发条件**（必须同时满足）：
1. **空间准则**：当前价格 > 静态 95% 分位带
2. **时间准则**：当前价格 > Upper(t+T)

#### 2.2.2 买入信号 (Buy/Long)
**触发条件**（必须同时满足）：
1. **空间准则**：当前价格 < 静态 5% 分位带
2. **时间准则**：当前价格 < Lower(t+T)

#### 2.2.3 信号修正逻辑
| 条件 | 行为 |
|------|------|
| β 绝对值连续 3 周期减小 | 动量衰减，提前释放信号 |
| β 绝对值连续增大 | 动量增强，进入 1 根 K 线观察期 |

### 2.3 智能状态机（🆕 新增模块）

| 状态 | 条件 | 显示 |
|------|------|------|
| **惯性保护中** | 价格在扇面内运行 | 绿色/红色背景（视趋势方向） |
| **惯性衰减** | 价格逼近/突破扇面边缘且斜率变平 | 黄色警告 |
| **信号触发** | 双重阈值同时满足 | 明确的买入/卖出提示 |

---

## 3. 可视化设计

### 3.1 动态预测扇面

**视觉形态**：
- 在最新 K 线右侧展示向未来延伸 5 根 K 线的**半透明锥形区域**
- 扇面由中轴线和上下边界组成

**配色方案**：
| 趋势方向 | 扇面颜色 | 边界线颜色 |
|----------|----------|------------|
| 上涨惯性 (β > 0) | 浅绿色填充 `rgba(40, 167, 69, 0.2)` | 绿色虚线 |
| 下跌惯性 (β < 0) | 浅红色填充 `rgba(220, 53, 69, 0.2)` | 红色虚线 |

### 3.2 HUD 信息面板

在图表右上角显示实时统计状态：

```
┌─────────────────────────────────┐
│  静态阈值 (Static)              │
│  ├ P95: $50,234.56              │
│  └ P5:  $48,123.45              │
├─────────────────────────────────┤
│  惯性预测 (T+5)                 │
│  ├ Upper: $51,456.78            │
│  ├ Mid:   $49,876.54            │
│  └ Lower: $48,296.30            │
├─────────────────────────────────┤
│  状态: [惯性保护中] 🟢          │
│  ADX: 45.2 | β: +0.12%          │
└─────────────────────────────────┘
```

### 3.3 信号标记

- **买入信号**：绿色向上箭头标记 + "BUY" 标签
- **卖出信号**：红色向下箭头标记 + "SELL" 标签
- **信号修正**：黄色感叹号标记 + "EARLY/BUFFER" 标签

---

## 4. 技术实现

### 4.1 系统架构

> 🔑 **增量原则**：仅新增文件和扩展接口，不修改现有计算逻辑

```
┌─────────────────────────────────────────────────────────────┐
│                  ddps_z 模块（增量扩展）                      │
├─────────────────────────────────────────────────────────────┤
│  calculators/                                               │
│  ├─ ema_calculator.py      (✅ 复用，不修改)                 │
│  ├─ ewma_calculator.py     (✅ 复用，不修改)                 │
│  ├─ zscore_calculator.py   (✅ 复用，不修改)                 │
│  ├─ adx_calculator.py      (🆕 新增文件)                     │
│  ├─ inertia_calculator.py  (🆕 新增文件)                     │
│  └─ signal_evaluator.py    (📝 扩展：新增 inertia_signal)    │
├─────────────────────────────────────────────────────────────┤
│  services/                                                  │
│  ├─ ddps_service.py        (📝 扩展：新增 inertia 计算调用)   │
│  └─ chart_data_service.py  (📝 扩展：新增 fan 数据格式化)     │
├─────────────────────────────────────────────────────────────┤
│  templates/                                                 │
│  └─ detail.html            (📝 扩展：新增扇面渲染和HUD)        │
└─────────────────────────────────────────────────────────────┘

图例：✅ 复用（不修改） | 🆕 新增 | 📝 扩展（向后兼容）
```

### 4.2 API 扩展

> 📝 **扩展原则**：在现有响应基础上**新增**字段，现有字段保持不变

**GET /ddps-z/api/calculate/** 响应扩展：
```json
{
  "data": {
    // ✅ 现有字段保持不变
    "current_price": 50000.0,
    "zscore": 1.5,
    "percentile": 93.32,
    "zone": "overbought",
    "signal": {...},  // 原有 Z-Score 信号

    // 🆕 新增 inertia 字段
    "inertia": {
      "adx": 45.2,
      "beta": 0.0012,
      "t_adj": 7.26,
      "fan": {
        "mid": 50234.56,
        "upper": 51456.78,
        "lower": 48296.30
      },
      "state": "protected",
      "state_label": "惯性保护中",
      "inertia_signal": {...}  // 新增双重阈值信号
    }
  }
}
```

**GET /ddps-z/api/chart/** 响应扩展：
```json
{
  "chart": {
    // ✅ 现有字段保持不变
    "candles": [...],
    "ema": [...],
    "bands": {...},    // 静态概率带
    "zscore": [...],
    "current": {...},

    // 🆕 新增 fan 字段
    "fan": {
      "direction": "up",
      "points": [
        {"t": 1736078400000, "mid": 50234.56, "upper": 51456.78, "lower": 48296.30},
        {"t": 1736092800000, "mid": 50345.67, "upper": 51567.89, "lower": 48407.41},
        ...
      ]
    }
  }
}
```

### 4.3 前端扩展

> 📝 **扩展原则**：在现有图表上**叠加**新元素，不修改现有渲染逻辑

- **TradingView Lightweight Charts** 扩展（新增系列，不修改现有）：
  - 🆕 使用 `AreaSeries` 绘制扇面填充区域（叠加在 K 线之上）
  - 🆕 使用 `LineSeries` 绘制中轴线和边界虚线
  - 扇面延伸到未来时间轴（K 线右侧空白区域）

- **HUD 面板**（新增组件）：
  - 🆕 Bootstrap Card 组件，固定在图表右上角
  - 不影响现有指标卡片布局

---

## 5. 验收标准

### 5.1 功能验收

| 功能点 | 验收标准 |
|--------|----------|
| ADX 计算 | 14 周期 ADX 值在 [0, 100] 范围内，与 TradingView 偏差 < 1% |
| 惯性周期 | T_adj 根据 ADX 动态调整，范围 [5, 10] |
| 扇面投影 | 正确绘制向未来延伸的锥形区域 |
| 双重阈值 | 信号仅在空间+时间准则同时满足时触发 |
| 状态机 | 正确识别并显示"惯性保护中"/"惯性衰减"状态 |
| 信号修正 | 斜率变化正确触发提前释放或观察期 |

### 5.2 性能指标

| 指标 | 目标值 |
|------|--------|
| 单币种计算延迟 | < 100ms |
| 扇面渲染帧率 | ≥ 30 FPS |
| 页面加载时间 | < 1s（含扇面） |

### 5.3 场景验证

| 场景 | 预期行为 |
|------|----------|
| 单边强势上涨 | 斜率陡峭，扇面上沿远高于价格，显示"惯性保护中"，不触发卖出 |
| 震荡阴跌转 V 反 | 斜率走平，扇面收敛，价格刺穿下边界时触发买入信号 |
| 高 ADX 趋势行情 | T_adj 延长至接近 10，扇面更宽 |
| 低 ADX 震荡行情 | T_adj 接近 5，扇面较窄 |

---

## 6. 排期建议

### 6.1 MVP 范围（P0 优先级）

1. ADX 计算器实现
2. 惯性计算器（β、T_adj、扇面公式）
3. 双重阈值信号引擎
4. API 响应扩展
5. 前端扇面可视化
6. HUD 信息面板

### 6.2 后续优化（P1 优先级）

1. 信号修正逻辑（动量衰减/增强）
2. 历史信号回溯标记
3. 扇面动画效果
4. 移动端适配

---

## 7. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| ADX 计算复杂度高 | 可能增加计算延迟 | 缓存中间结果，增量计算 |
| 扇面绘制性能 | 大量数据时可能卡顿 | 只绘制可视区域，限制精度 |
| 与现有系统冲突 | 可能影响已有功能 | 使用 feature flag 隔离 |

---

## 8. 附录

### 8.1 公式速查

| 名称 | 公式 |
|------|------|
| 偏离率 | $D_t = \frac{Price_t - EMA25_t}{EMA25_t}$ |
| Z-Score | $Z_t = \frac{D_t - \mu_t}{\sigma_t}$ |
| 趋势斜率 | $\beta = EMA25_t - EMA25_{t-1}$ |
| 动态惯性周期 | $T_{adj} = T \times (1 + \frac{ADX}{100})$，范围 [5, 10] |
| 预测中轴 | $\hat{E}_{t+T} = EMA25_t + (\beta \times T)$ |
| 扇面上边界 | $Upper(t+T) = \hat{E}_{t+T} + (1.645 \times \sigma_t \times \sqrt{T})$ |
| 扇面下边界 | $Lower(t+T) = \hat{E}_{t+T} + (-1.645 \times \sigma_t \times \sqrt{T})$ |

### 8.2 决策记录

| 决策点 | 选项 | 决策 | 理由 |
|--------|------|------|------|
| ADX 周期 | 14 / 25 | **14** | 经典周期，灵敏度适中 |
| σ_t 计算 | EWMA / ATR | **EWMA** | 复用现有计算逻辑 |
| 系统定位 | 扩展 / 独立 | **扩展现有 DDPS-Z** | 复用代码，降低维护成本 |
| 前端位置 | 扩展 / 独立 | **扩展详情页** | 统一用户体验 |
