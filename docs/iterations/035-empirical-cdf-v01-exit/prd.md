# PRD: Empirical CDF V01 止盈止损策略

**迭代编号**: 035
**迭代名称**: empirical_cdf_v01 止盈止损策略
**文档版本**: 1.0
**创建日期**: 2026-01-12
**状态**: P1完成

---

## 1. 概述

### 1.1 背景

现有 Empirical CDF 策略（迭代034）使用"概率回归"作为出场条件。为提升策略的适应性，基于 EMA 均线的相对关系定义市场状态，实现更精准的止盈止损控制。

### 1.2 产品愿景

在保持现有 Empirical CDF 入场逻辑不变的前提下，**替换**出场机制为基于 EMA 状态判断的动态止盈止损策略。

### 1.3 核心价值

一句话定义：**基于 EMA7/EMA25/EMA99 三线关系判断市场状态，实现状态自适应止盈和10%固定止损**

---

## 2. 功能需求

### 2.1 市场状态定义

根据 EMA 相对关系定义 4 种市场状态：

| 状态 | EMA 条件 | 中文 | 订单行为 |
|------|----------|------|----------|
| **Bull Strong** | `EMA7 >= EMA25 >= EMA99` | 强势上涨 | 持有至EMA7下穿EMA25触发止盈 |
| **Bear Strong** | `EMA7 <= EMA25 <= EMA99` | 强势下跌 | 持有至K线高点突破EMA25触发止盈 |
| **Consol Down** | `EMA25 < EMA99` | 震荡下跌 | 持有至K线高点突破EMA99触发止盈 |
| **Consol Up** | `EMA25 >= EMA99` 且不满足上述任一条件 | 震荡上涨 | 继续持有至状态变化 |

### 2.2 止盈规则

#### 2.2.1 强势上涨 (Bull Strong)
**触发条件**: `EMA7 >= EMA25 >= EMA99` 状态中，检测到第一根 `EMA7 <= EMA25` 的K线

**卖出时机**:
1. 在触发K线的 **收盘价** 位置记录止盈信号
2. 下一根K线 **开盘价** 实际卖出

#### 2.2.2 强势下跌 (Bear Strong)
**触发条件**: `EMA7 <= EMA25 <= EMA99` 状态中，K线 `high > EMA25`

**卖出时机**:
1. 在突破K线的 **收盘价** 位置记录止盈信号
2. 下一根K线 **开盘价** 实际卖出

#### 2.2.3 震荡下跌 (Consol Down)
**触发条件**: `EMA25 < EMA99` 状态中，K线 `high > EMA99`

**卖出时机**:
1. 在突破K线的 **收盘价** 位置记录止盈信号
2. 下一根K线 **开盘价** 实际卖出

#### 2.2.4 震荡上涨 (Consol Up)
**行为**: 继续持有，不触发止盈，直至状态变为上述三种之一

### 2.3 止损规则

#### 2.3.1 强制止损
**触发条件**: 持仓损失 ≥ 10%

**卖出时机**: 立即以当前K线 **收盘价** 卖出

---

## 3. 非功能需求

### 3.1 性能
- 回测执行延迟 < 10秒（1000根K线）
- 内存占用 < 100MB

### 3.2 兼容性
- 复用现有 `run_strategy_backtest` 命令
- 兼容 CSV 数据源
- 兼容 4h/1h/5m 等K线周期

---

## 4. 验收标准

| 功能点 | 验收标准 |
|--------|----------|
| 市场状态判断 | 正确识别4种EMA状态 |
| 强势上涨止盈 | EMA7下穿EMA25触发，收盘标记+开盘卖出 |
| 强势下跌止盈 | high突破EMA25触发，收盘标记+开盘卖出 |
| 震荡下跌止盈 | high突破EMA99触发，收盘标记+开盘卖出 |
| 震荡上涨持有 | 状态不变则不触发止盈 |
| 强制止损 | 亏损≥10%立即以收盘价卖出 |
| 回测支持 | run_strategy_backtest 命令可执行 |

---

## 5. 范围边界

### In-Scope
- [ ] EMA 状态判断逻辑实现
- [ ] 4 种市场状态的止盈规则
- [ ] 10% 强制止损
- [ ] strategy_empirical_cdf_v01.json 配置
- [ ] 回测验证

### Out-of-Scope
- 新的入场策略（复用现有）
- 实盘交易对接
- 前端界面改动

---

## 6. 依赖

| 依赖项 | 描述 |
|--------|------|
| 迭代034 | EmpiricalCDFStrategy 入场逻辑 |
| strategy_adapter | 策略框架和回测引擎 |
| CSV 数据源 | 4h K线数据 |

---

## 7. 风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| EMA 参数敏感性 | 不同参数可能效果差异大 | 通过配置支持参数调整 |
| 状态切换频繁 | 短周期K线可能频繁切换 | 4h 周期验证 |
