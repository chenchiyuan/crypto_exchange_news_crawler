# PRD: 策略15-分批止盈优化策略

## 文档信息
- **版本**: 1.0
- **创建日期**: 2026-01-11
- **迭代编号**: 031
- **状态**: P1完成
- **基础策略**: 策略14（迭代030）

## 1. 核心价值

**一句话定义**: 通过快速止损(3%)和分批止盈(2%~6%)机制，在控制下行风险的同时捕获更多趋势收益。

## 2. 需求背景

策略14使用固定2%止盈（单一价位限价卖单）和6%止损，存在以下问题：
- 止损过宽(6%)导致单笔亏损较大
- 固定止盈(2%)无法捕获大趋势行情
- 独立持仓管理导致相同价格的多笔订单分散处理

策略15通过优化止盈止损机制解决上述问题：
- 快速止损(3%)控制单笔最大亏损
- 分批止盈(2%~6%)兼顾确定性收益和趋势捕获
- 持仓合并简化订单管理

## 3. 功能规格

### 3.1 止损设置
- **止损比例**: 3%（快速止损）
- **触发条件**: low <= buy_price × (1 - 0.03)
- **执行方式**: 立即成交，价格为止损价

### 3.2 分批止盈设置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `tp_levels` | 5 | 止盈份数 |
| `first_tp_rate` | 0.02 | 首单止盈比例(2%) |
| `tp_interval` | 0.01 | 止盈间隔(1%) |

**止盈价格序列**:
| 档位 | 止盈比例 | 仓位比例 | 价格公式 |
|------|----------|----------|----------|
| 1    | 2%       | 20%      | buy_price × 1.02 |
| 2    | 3%       | 20%      | buy_price × 1.03 |
| 3    | 4%       | 20%      | buy_price × 1.04 |
| 4    | 5%       | 20%      | buy_price × 1.05 |
| 5    | 6%       | 20%      | buy_price × 1.06 |

**执行方式**: 限价卖单挂出
**成交判定**: 下根K线的 high >= 挂单价格

### 3.3 持仓合并规则

**合并时机**: 每根K线处理完买入成交后，统一合并同价持仓

**合并逻辑**:
- 相同买入价格的持仓订单合并为一个
- 合并后数量 = 各订单数量之和
- 合并后成本价 = 原买入价格（相同价格无需加权）
- 合并后的订单重新计算止盈档位

**示例**:
```
订单A: buy_price=1000, quantity=0.1
订单B: buy_price=1000, quantity=0.15
合并后: buy_price=1000, quantity=0.25, 每份止盈量=0.05
```

### 3.4 价格计算逻辑（沿用策略14）

| 档位 | 价格公式 | 示例(base=1000) |
|------|----------|-----------------|
| 第1档 | base_price × (1 - first_order_discount) | 980 |
| 第2档 | base_price × (1 - first_order_discount - first_gap) | 960 |
| 第3档 | base_price × (1 - first_order_discount - first_gap - interval) | 950 |
| 第4档 | base_price × (1 - first_order_discount - first_gap - 2×interval) | 940 |
| 第5档 | base_price × (1 - first_order_discount - first_gap - 3×interval) | 930 |

### 3.5 金额计算逻辑（沿用策略14）

| 档位 | 金额倍数 | 示例(base=100) |
|------|----------|----------------|
| 第1档 | 1× | 100 |
| 第2档 | 3× | 300 |
| 第3档 | 9× | 900 |
| 第4档 | 27× | 2700 |
| 第5档 | 剩余全部可用资金 | 动态计算 |

## 4. 范围边界

### In-Scope
- 止损比例改为3%
- 实现分批止盈机制（5档）
- 实现持仓合并逻辑
- 限价卖单挂出和成交判定
- 可配置的止盈参数

### Out-of-Scope
- 价格计算逻辑修改（沿用策略14）
- 金额分配逻辑修改（沿用策略14）
- 非均分止盈比例（MVP均分）
- 动态止盈间隔调整

## 5. 验收标准

| AC编号 | 验收标准 | 验证方法 |
|--------|----------|----------|
| AC-001 | 止损在3%时触发 | 单元测试 |
| AC-002 | 5档止盈价格正确(2%~6%) | 单元测试 |
| AC-003 | 每档止盈20%仓位 | 单元测试 |
| AC-004 | 同价持仓正确合并 | 单元测试 |
| AC-005 | 卖单成交判定：high>=挂单价 | 回测验证 |
| AC-006 | 回测输出正确的订单统计 | 回测命令 |
| AC-007 | 止盈参数可配置 | 配置文件验证 |

## 6. 技术约束

- 基于OptimizedEntryStrategy代码结构（策略14）
- 复用LimitOrderManager组件
- 新增分批止盈逻辑
- 新增持仓合并逻辑

## 7. 依赖关系

- 依赖策略14的基础架构
- 依赖现有的指标计算模块（P5, inertia_mid）
- 依赖LimitOrderManager、LimitOrderPriceCalculator

## 8. 配置参数

```json
{
  "entry": {
    "strategy_id": 15,
    "base_amount": 2000,
    "multiplier": 3.0,
    "order_count": 5,
    "first_order_discount": 0.02,
    "first_gap": 0.04,
    "interval": 0.01,
    "stop_loss_rate": 0.03,
    "tp_levels": 5,
    "first_tp_rate": 0.02,
    "tp_interval": 0.01
  }
}
```
