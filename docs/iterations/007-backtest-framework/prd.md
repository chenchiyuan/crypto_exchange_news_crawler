# Volume Trap 策略回测框架 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
Volume Trap 策略回测框架

### 1.2 项目背景
量化交易者需要科学分析Volume Trap策略中"弃盘"异常事件后的价格表现，以评估做空策略的有效性。现有的Volume Trap检测系统能发现异常事件，但缺乏对这些事件后续表现的分析工具。

### 1.3 目标用户
- **主要用户**: 量化交易者
- **使用场景**: 评估Volume Trap策略的做空表现，优化交易参数

### 1.4 核心价值
通过回测分析量化做空策略的风险和收益，为策略优化提供数据支撑。

## 2. 需求澄清

### 2.1 策略逻辑
- **入场时机**: 发现异常事件后，下一根K线收盘价入场
- **持仓周期**: 持续持仓（不做平仓）
- **出场方式**: 观察期内不主动平仓
- **策略方向**: 始终做空（基于"弃盘"假设）

### 2.2 分析维度
1. **单个事件分析**: 关注具体某个异常事件的完整表现
2. **整体策略分析**: 关注一批异常事件的聚合统计

### 2.3 关键指标定义

#### 单个事件指标
- **相对跌幅**: (入场价 - 最低价) / 入场价 × 100%
- **到达低点时间**: 从入场到最低点的K线数
- **反弹幅度**: (反弹最高价 - 最低价) / 最低价 × 100%（上涨超过20%视为显著反弹）
- **最大回撤**: 持仓期间做空策略的最大浮亏

#### 整体策略指标
- **胜率**: 盈利交易数 / 总交易数 × 100%
- **盈亏比**: 总盈利 / 总亏损
- **平均收益率**: 所有交易收益率的平均值
- **最大回撤**: 所有交易中最大的一次回撤

## 3. 功能需求

### 3.1 核心功能 (P0)

#### 3.1.1 单个事件回测分析
**功能描述**: 分析单个异常事件的后续价格表现

**输入参数**:
- 异常事件ID
- 观察期长度（可选，默认分析全部历史数据）

**输出指标**:
- 入场信息（时间、价格）
- 最低点信息（时间、价格、K线数）
- 最大盈利百分比
- 反弹信息（是否有反弹、反弹幅度）
- 最大回撤百分比
- 最终收益（时间、价格、收益率）

**验收标准**:
- 能正确计算所有关键指标
- 数据不足时给出明确提示
- 计算结果存储到数据库

#### 3.1.2 批量回测分析
**功能描述**: 对一批异常事件进行批量回测

**输入参数**:
- 异常事件筛选条件（状态、周期、日期范围等）
- 观察期长度（可选，默认分析全部历史数据）

**输出结果**:
- 成功回测数量
- 失败回测数量
- 错误详情列表

**验收标准**:
- 支持按各种条件筛选异常事件
- 遇到错误时可以选择跳过或停止
- 返回详细的执行报告
- 返回观察期信息（K线数或日期范围）

#### 3.1.3 整体统计指标
**功能描述**: 计算整体策略的聚合统计指标

**输入参数**:
- 回测结果筛选条件
- 统计维度（按周期、按状态等）

**输出指标**:
- 基础统计（总交易数、盈利数、亏损数、胜率）
- 收益统计（平均收益、最大收益、最小收益、总收益）
- 风险统计（平均回撤、最大回撤）
- 时间统计（平均到达最低点K线数）
- 风险调整收益（盈亏比、夏普比率）

**验收标准**:
- 统计指标计算准确
- 支持多维度统计
- 统计结果持久化存储

### 3.2 重要功能 (P1)

#### 3.2.1 回测结果查询API
**功能描述**: 提供REST API供前端调用

**API端点**:
- GET /api/volume-trap/backtest/{id}/ - 获取单个回测详情
- GET /api/volume-trap/backtest/ - 批量查询回测结果
- GET /api/volume-trap/statistics/ - 获取整体统计

**验收标准**:
- API响应格式统一
- 支持分页和排序
- 返回数据包含所有关键指标

#### 3.2.2 回测结果详情页
**功能描述**: 显示单个异常事件的完整回测分析

**页面元素**:
- 基本信息（交易对、周期、入场时间等）
- K线图表（标注入场点、最低点、反弹点）
- 关键指标面板（收益、回撤、时间等）
- 持仓期间价格数据表

**验收标准**:
- 图表清晰标注关键点位
- 指标展示直观易读
- 页面加载流畅

#### 3.2.3 整体统计面板
**功能描述**: 展示整体策略表现统计

**页面元素**:
- 关键指标卡片（胜率、盈亏比、平均收益等）
- 收益分布图表
- 回撤分析图表
- 按周期/状态分组统计表

**验收标准**:
- 数据展示层次清晰
- 支持数据导出
- 响应式设计

### 3.3 增强功能 (P2)

#### 3.3.1 回测参数优化
**功能描述**: 允许用户调整持仓周期等参数，观察不同参数下的表现

**验收标准**:
- 支持参数回测（不同持仓周期对比）
- 参数优化建议

#### 3.3.2 回测报告导出
**功能描述**: 导出详细的回测分析报告

**验收标准**:
- 支持PDF/Excel导出
- 包含图表和详细数据

## 4. 非功能需求

### 4.1 性能要求
- 单次回测分析响应时间 < 2秒
- 批量回测（1000条记录）完成时间 < 60秒
- 统计查询响应时间 < 1秒

### 4.2 可用性要求
- 支持增量更新（新增异常事件自动回测）
- 数据持久化存储
- 错误处理和日志记录

### 4.3 兼容性要求
- 与现有Volume Trap检测系统无缝集成
- 支持现有K线数据结构

## 5. 约束条件

### 5.1 技术约束
- 基于现有Django项目
- 使用现有KLine和VolumeTrapMonitor模型
- 不破坏现有系统架构

### 5.2 数据约束
- 需要充足的K线数据支撑回测
- 异常事件必须已进入"疑似弃盘"或"确定弃盘"状态

## 6. 验收标准

### 6.1 功能验收
- [ ] 所有P0功能测试通过
- [ ] API接口功能完整
- [ ] 页面展示正确

### 6.2 性能验收
- [ ] 性能指标满足要求
- [ ] 批量处理稳定可靠

### 6.3 集成验收
- [ ] 与现有系统集成无冲突
- [ ] 数据迁移顺利

## 7. 后续迭代

### 7.1 短期迭代 (v1.1)
- 参数优化功能
- 回测报告导出

### 7.2 长期迭代 (v2.0)
- 机器学习预测模型
- 实时回测监控
- 策略信号优化
