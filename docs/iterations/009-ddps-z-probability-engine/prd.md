# 产品需求文档 (PRD)：动态偏离概率空间 2.0 (DDPS-Z)

## 文档信息
| 属性 | 值 |
|------|-----|
| 版本 | v2.0 (Standardized Edition) |
| 迭代编号 | 009 |
| 创建日期 | 2025-01-05 |
| 状态 | 草稿 |
| 优先级 | P0 |

---

## 1. 产品概述

### 1.1 背景
在加密货币交易中，价格偏离均线的程度是判断超买/超卖的重要参考。然而，不同币种波动率差异巨大（如BTC vs. SOL），同一币种在不同市场周期的波动率也不同（牛市 vs. 震荡期）。传统的固定百分比阈值（如-5%超卖）无法适应这种多样性。

### 1.2 产品定位
**动态偏离概率空间系统 (DDPS-Z) 2.0** 是一个基于统计标准化的价格偏离分析工具，通过 Z-Score 将不同币种、不同时期的偏离度转化为统一的"统计罕见程度"，使交易信号在跨币种、跨周期场景下具有一致的稀缺性意义。

### 1.3 核心价值
- **波动率自适应**：在低波动环境下，-3%偏离可能是极端信号（Z < -2.5）；在高波动环境下，-3%可能只是常规波动（Z = -0.8）
- **跨币种可比**：ETH和SOL虽然波动率不同，但Z=-2的信号都代表"超越95%历史时刻"的统计罕见度
- **量价验证**：区分"真实换手"（强确认）与"流动性缺失"（噪声信号）

---

## 2. 目标用户

| 用户类型 | 使用场景 | 核心需求 |
|---------|---------|---------|
| 量化交易者 | 筛选统计意义上的超买/超卖标的 | 跨币种统一的Z-Score信号 |
| 趋势交易者 | 寻找回调买入/反弹卖出时机 | 概率分位带可视化 |
| 风控人员 | 识别价格异常偏离风险 | 实时Z-Score监控 |

---

## 3. 核心功能模块

### 3.1 概率引擎 (Probability Engine)

#### 3.1.1 波动率自适应标准化 (Z-Score Normalization)

**核心公式**：
```
D_t = (Price_t - EMA25_t) / EMA25_t    # 基础偏离率
μ_t = EWMA(D_t)                         # 动态均值
σ_t = EWMA((D_t - μ_t)²)^0.5            # 动态波动率
Z_t = (D_t - μ_t) / σ_t                 # 标准化偏离
```

**参数配置**：
| 参数 | 默认值 | 说明 |
|------|--------|-----|
| EMA周期 | 25 | 用于计算基础偏离的均线周期 |
| EWMA窗口N | 180 | α = 2/(N+1)，约30天4h K线 |
| K线周期 | 4h | 数据源K线周期 |

#### 3.1.2 稳健分位数带 (Quantile Bands)

**分位数边界**：
| 边界 | 分位数 | 含义 |
|------|--------|-----|
| 极度超卖 | 1% | Z ≈ -2.33 |
| 超卖区 | 5% | Z ≈ -1.64 |
| 下轨 | 10% | Z ≈ -1.28 |
| 中轴下 | 25% | Z ≈ -0.67 |
| 中轴 | 50% | Z ≈ 0 |
| 中轴上 | 75% | Z ≈ 0.67 |
| 上轨 | 90% | Z ≈ 1.28 |
| 超买区 | 95% | Z ≈ 1.64 |
| 极度超买 | 99% | Z ≈ 2.33 |

#### 3.1.3 量价验证 (Volume Validation)

**主从结构**：
- **主通道**：Z-Score偏离度（时间频率分布）
- **辅助通道**：成交量验证

**量价状态**：
| 状态 | 条件 | 解读 |
|------|------|-----|
| 强确认 | Z极端 + RVOL ≥ 2x | 真实换手，底部/顶部特征 |
| 弱信号 | Z极端 + RVOL < 2x | 流动性缺失，可能假突破 |
| 中性 | Z普通 | 正常波动范围 |

### 3.2 可视化Dashboard

#### 3.2.1 合约列表页
- 展示所有合约的当前Z-Score
- 按Z-Score排序（超买/超卖分组）
- 支持按状态筛选（极端超卖/超卖/中性/超买/极端超买）

#### 3.2.2 合约详情页
点击合约后展开：
- **K线图**：带分位数带覆盖
- **Z-Score仪表盘**：当前Z值+历史分位
- **量价状态**：强确认/弱信号指示

#### 3.2.3 分位数带渲染
- **呼吸效应**：带宽随σ_t自动扩张/收缩
- **分级渲染**：多层透明度（50%→80%→90%→99%）
- **颜色编码**：
  - 超卖区：绿色渐变
  - 中性区：灰色
  - 超买区：红色渐变

---

## 4. 交易信号逻辑

### 4.1 信号规则

| 信号类型 | 触发条件 | 置信度 |
|---------|---------|--------|
| 强买入 | Z ≤ -1.64 且 RVOL ≥ 2x | 高 |
| 弱买入 | Z ≤ -1.64 且 RVOL < 2x | 低 |
| 强卖出 | Z ≥ 1.64 且 RVOL ≥ 2x | 高 |
| 弱卖出 | Z ≥ 1.64 且 RVOL < 2x | 低 |

### 4.2 信号解读提示
根据Z值自动生成提示文本：
- Z = -2.8 → "当前偏离超越 99% 的历史时刻"
- Z = -1.7 → "当前偏离超越 95% 的历史时刻"
- Z = 0.5 → "当前处于正常波动范围"

---

## 5. 数据模型

### 5.1 DDPS计算结果表 (DDPSResult)

| 字段 | 类型 | 说明 |
|------|------|-----|
| id | BigInt | 主键 |
| symbol | String | 交易对 |
| interval | String | K线周期 |
| timestamp | DateTime | 计算时间 |
| price | Decimal | 当前价格 |
| ema25 | Decimal | EMA(25) |
| deviation_d | Decimal | 基础偏离率 D_t |
| ewma_mu | Decimal | 动态均值 μ_t |
| ewma_sigma | Decimal | 动态波动率 σ_t |
| z_score | Decimal | 标准化偏离 Z_t |
| percentile | Decimal | 历史分位数(0-100) |
| rvol | Decimal | 相对成交量倍数 |
| signal | String | 信号类型 |
| signal_strength | String | 信号强度(strong/weak/none) |

### 5.2 历史偏离序列 (DDPSDeviationHistory)

| 字段 | 类型 | 说明 |
|------|------|-----|
| id | BigInt | 主键 |
| symbol | String | 交易对 |
| interval | String | K线周期 |
| timestamp | DateTime | K线时间 |
| deviation_d | Decimal | 基础偏离率 |

> 用于EWMA计算时的历史数据回溯

---

## 6. MVP范围定义

### 6.1 P0 功能（必须实现）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| Z-Score计算引擎 | 实现完整的EWMA Z-Score算法 | P0 |
| EMA25计算 | 基于历史K线计算EMA | P0 |
| EWMA均值/波动率 | 计算μ_t和σ_t | P0 |
| 分位数带计算 | 5%/10%/50%/90%/95%边界 | P0 |
| RVOL计算 | 成交量相对强度 | P0 |
| 量价验证逻辑 | 强确认/弱信号判断 | P0 |
| 结果持久化 | DDPSResult表存储 | P0 |
| 批量计算命令 | Management Command扫描 | P0 |
| Dashboard列表页 | 展示Z-Score排序的合约 | P0 |
| 合约详情K线图 | 带分位数带的K线展示 | P0 |
| Z-Score仪表盘 | 当前值+文字提示 | P0 |

### 6.2 P1 功能（可延期）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| EWMA窗口可配置 | 支持N=90/180切换 | P1 |
| 多周期支持 | 1h/4h/1d切换 | P1 |
| 实时推送 | WebSocket推送信号 | P1 |
| 历史信号回测 | 验证信号准确率 | P1 |

---

## 7. 技术约束

### 7.1 性能要求
| 指标 | 目标值 |
|------|--------|
| 单币种计算 | < 100ms |
| 全量扫描(500+币种) | < 3分钟 |
| Dashboard加载 | < 2秒 |
| K线图渲染 | < 500ms |

### 7.2 数据依赖
- 复用现有 `backtest.models.KLine` 表
- 复用现有 `monitor.models.FuturesContract` 表
- EWMA计算需要至少180根K线历史数据

### 7.3 兼容性
- 与现有Volume Trap系统共存
- 不影响现有功能

---

## 8. 验收标准

### 8.1 功能验收
- [ ] 输入任意交易对，能正确计算Z-Score
- [ ] Z-Score范围合理（大多数在-3到+3之间）
- [ ] 分位数带能随波动率自动扩张/收缩
- [ ] 量价验证能正确区分强确认/弱信号
- [ ] Dashboard能按Z-Score排序展示合约
- [ ] K线图能正确渲染分位数带

### 8.2 性能验收
- [ ] 全量扫描时间 < 3分钟
- [ ] 单页面加载 < 2秒
- [ ] 内存使用合理（< 500MB）

---

## 9. 风险与假设

### 9.1 假设
1. K线数据已存在且足够（≥180根4h K线）
2. EMA25是合适的基础均线（可根据实际调整）
3. EWMA窗口N=180能覆盖足够的波动周期

### 9.2 风险
| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 历史数据不足 | Z-Score计算不准 | 提示"数据不足，需≥180根K线" |
| 极端行情 | 分位数带失效 | 设置最大带宽限制 |
| 计算性能 | 全量扫描超时 | 增量计算，仅计算新K线 |

---

## 附录

### A. 算法示例

**示例1：低波动环境**
```
价格: 3000, EMA25: 3100
D_t = -3.2%
μ_t = 0.1% (近期偏离中轴)
σ_t = 1.2% (低波动)
Z_t = (-3.2% - 0.1%) / 1.2% = -2.75

解读: 极度超卖，超越99%历史时刻
```

**示例2：高波动环境**
```
价格: 3000, EMA25: 3100
D_t = -3.2%
μ_t = -0.5% (近期偏离中轴偏空)
σ_t = 4.0% (高波动)
Z_t = (-3.2% - (-0.5%)) / 4.0% = -0.67

解读: 轻度偏空，处于正常波动范围
```

### B. 参考资料
- EWMA (Exponentially Weighted Moving Average)
- Z-Score 统计标准化
- 分位数 (Quantiles) 计算
