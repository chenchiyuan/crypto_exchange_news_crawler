# 功能点清单：动态偏离概率空间 2.0 (DDPS-Z)

## 文档信息
| 属性 | 值 |
|------|-----|
| 迭代编号 | 009 |
| 创建日期 | 2025-01-05 |
| PRD版本 | v2.0 |
| 功能点总数 | 22 |

---

## 功能点概览

| 优先级 | 数量 | 状态 |
|--------|------|------|
| P0（必须） | 16 | 待实现 |
| P1（延期） | 6 | 暂不实现 |

---

## P0 功能点（必须实现）

### 模块1：概率引擎核心

| ID | 功能点 | 描述 | 验收标准 | 依赖 |
|----|--------|------|---------|------|
| FP-001 | EMA25计算 | 计算25周期指数移动平均线 | 给定K线序列，计算结果误差<0.01% | K线数据 |
| FP-002 | 基础偏离率计算 | D_t = (Price - EMA25) / EMA25 | 偏离率计算准确，符号正确 | FP-001 |
| FP-003 | EWMA均值计算 | μ_t = EWMA(D_t)，α=2/(N+1) | N=180时α≈0.011，平滑效果明显 | FP-002 |
| FP-004 | EWMA波动率计算 | σ_t = sqrt(EWMA((D_t-μ_t)²)) | 波动率为正，响应市场变化 | FP-003 |
| FP-005 | Z-Score计算 | Z_t = (D_t - μ_t) / σ_t | Z值大部分在[-3, 3]范围内 | FP-003, FP-004 |
| FP-006 | 分位数计算 | 将Z值映射到历史分位数(0-100) | 正态假设下Z=-1.64对应5分位 | FP-005 |
| FP-007 | RVOL计算 | 相对成交量 = Vol / MA(Vol, 20) | 倍数准确，与现有系统一致 | K线数据 |
| FP-008 | 量价验证逻辑 | 判断强确认/弱信号/中性 | Z极端+RVOL≥2为强确认 | FP-005, FP-007 |

### 模块2：数据存储

| ID | 功能点 | 描述 | 验收标准 | 依赖 |
|----|--------|------|---------|------|
| FP-009 | DDPSResult模型 | 存储计算结果的数据库模型 | 包含所有必要字段，有唯一约束 | - |
| FP-010 | DDPSDeviationHistory模型 | 存储历史偏离序列 | 支持EWMA回溯计算 | - |
| FP-011 | 结果持久化服务 | 保存计算结果到数据库 | 支持批量写入，事务保护 | FP-009 |

### 模块3：批量计算

| ID | 功能点 | 描述 | 验收标准 | 依赖 |
|----|--------|------|---------|------|
| FP-012 | 批量扫描命令 | scan_ddps Management Command | 支持--symbol、--interval参数 | FP-001~008 |
| FP-013 | 全量扫描 | 扫描所有活跃合约 | 500+合约<3分钟完成 | FP-012 |
| FP-014 | 数据不足处理 | K线<180根时的降级处理 | 返回警告而非错误，标记为"数据不足" | FP-012 |

### 模块4：Dashboard前端

| ID | 功能点 | 描述 | 验收标准 | 依赖 |
|----|--------|------|---------|------|
| FP-015 | 合约列表页 | 展示所有合约的Z-Score | 支持排序、筛选，分页加载 | FP-011 |
| FP-016 | 合约详情K线图 | 点击展开带分位数带的K线 | 分位数带随波动率呼吸 | FP-006, K线数据 |

---

## P1 功能点（可延期）

| ID | 功能点 | 描述 | 延期原因 |
|----|--------|------|---------|
| FP-P1-001 | EWMA窗口可配置 | 支持N=90/180切换 | MVP使用固定N=180 |
| FP-P1-002 | 多周期支持 | 1h/4h/1d切换 | MVP使用固定4h |
| FP-P1-003 | Z-Score仪表盘组件 | 独立的仪表盘UI组件 | 可用简单文本替代 |
| FP-P1-004 | 实时WebSocket推送 | 推送极端信号 | MVP使用轮询 |
| FP-P1-005 | 历史信号回测 | 验证信号准确率 | 需先积累数据 |
| FP-P1-006 | 分位数带多层渲染 | 50%/80%/90%/99%四层透明度 | MVP使用单层 |

---

## 功能点依赖图

```
K线数据
    │
    ├──▶ FP-001 (EMA25)
    │       │
    │       └──▶ FP-002 (偏离率D_t)
    │               │
    │               ├──▶ FP-003 (EWMA均值μ_t)
    │               │       │
    │               │       └──▶ FP-005 (Z-Score)
    │               │               │
    │               │               ├──▶ FP-006 (分位数)
    │               │               │       │
    │               │               │       └──▶ FP-016 (K线图)
    │               │               │
    │               │               └──▶ FP-008 (量价验证)
    │               │                       │
    │               │                       └──▶ FP-015 (列表页)
    │               │
    │               └──▶ FP-004 (EWMA波动率σ_t)
    │                       │
    │                       └──▶ FP-005 (Z-Score)
    │
    └──▶ FP-007 (RVOL)
            │
            └──▶ FP-008 (量价验证)

FP-009, FP-010 (数据模型) ──▶ FP-011 (持久化) ──▶ FP-012 (批量命令)
                                                        │
                                                        └──▶ FP-013, FP-014
```

---

## 实现优先级排序

### 第一批（核心算法）
1. FP-009, FP-010 - 数据模型定义
2. FP-001 - EMA25计算
3. FP-002 - 偏离率计算
4. FP-003, FP-004 - EWMA均值/波动率
5. FP-005 - Z-Score计算

### 第二批（量价验证）
6. FP-007 - RVOL计算
7. FP-008 - 量价验证逻辑
8. FP-006 - 分位数计算

### 第三批（批量处理）
9. FP-011 - 结果持久化
10. FP-012 - 批量扫描命令
11. FP-013 - 全量扫描
12. FP-014 - 数据不足处理

### 第四批（前端展示）
13. FP-015 - 合约列表页
14. FP-016 - 合约详情K线图

---

## 测试覆盖要求

| 功能点 | 单元测试 | 集成测试 | 说明 |
|--------|---------|---------|------|
| FP-001 | ✓ | - | 与已知EMA值对比 |
| FP-002 | ✓ | - | 边界值测试 |
| FP-003 | ✓ | - | EWMA收敛性验证 |
| FP-004 | ✓ | - | 波动率为正验证 |
| FP-005 | ✓ | - | Z值范围验证 |
| FP-006 | ✓ | - | 分位数映射验证 |
| FP-007 | ✓ | - | 与现有RVOL对比 |
| FP-008 | ✓ | - | 各状态判断验证 |
| FP-012 | - | ✓ | 命令执行完整性 |
| FP-013 | - | ✓ | 性能测试 |
| FP-015 | - | ✓ | API响应验证 |
| FP-016 | - | ✓ | 图表数据准确性 |
