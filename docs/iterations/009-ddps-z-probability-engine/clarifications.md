# 需求澄清记录：动态偏离概率空间 2.0 (DDPS-Z)

## 文档信息
| 属性 | 值 |
|------|-----|
| 迭代编号 | 009 |
| 创建日期 | 2025-01-05 |
| 澄清轮次 | 1 |

---

## 澄清问题汇总

### Q1: EWMA窗口参数N应该使用多少？

**背景**：
PRD建议EWMA窗口参数N取180或90，两者各有优劣：
- N=180：更平滑，适合长期趋势识别，约30天4h K线
- N=90：更灵敏，侧重近期波动特征，约15天4h K线

**用户选择**：**N=180（推荐）**

**决策理由**：
- 更平滑的估计能减少噪声干扰
- 30天的历史窗口能覆盖至少一个完整的市场周期
- 对于4h K线周期，180根K线提供了足够的统计样本

**实现影响**：
- EWMA衰减因子 α = 2/(180+1) ≈ 0.011
- 初始计算需要至少180根K线
- 数据不足时显示警告提示

---

### Q2: 概率引擎的数据源应该使用哪个K线周期作为默认？

**背景**：
不同K线周期适用于不同交易风格：
- 1h：更灵敏，适合短周期交易
- 4h：平衡噪声过滤和信号灵敏度
- 1d：更平滑，适合长周期趋势判断

**用户选择**：**4h（推荐）**

**决策理由**：
- 与现有Volume Trap系统保持一致
- 平衡了信号灵敏度和噪声过滤
- 4h周期在加密货币交易中广泛使用

**实现影响**：
- 默认使用4h K线数据
- 复用现有K线数据源（backtest.models.KLine）
- MVP阶段不支持周期切换（P1功能）

---

### Q3: 量价验证中的"脉冲放量"阈值应该是多少？

**背景**：
PRD提到量价验证需要判断"成交量脉冲放大"，需要定义具体阈值：
- RVOL >= 2x MA：相对宽松，更多信号
- RVOL >= 3x MA：更严格，减少噪声
- 复用现有阈值：与Volume Trap系统一致（8x RVOL）

**用户选择**：**RVOL >= 2倍MA**

**决策理由**：
- DDPS-Z关注的是偏离度的统计意义，而非"巨量"信号
- 2倍阈值能捕捉到更多的有效信号
- 与学术研究中的标准一致

**实现影响**：
- 放量判断条件：RVOL >= 2.0
- 使用20周期成交量均值作为基准
- 与Volume Trap系统的RVOL计算逻辑可复用

---

### Q4: 前端展示应该集成到哪里？

**背景**：
需要决定DDPS-Z的可视化界面位置：
- 合约详情页：集成到现有页面，最小改动
- 独立Dashboard：创建专属页面，功能独立
- 两者都要：同时提供两种入口

**用户选择**：**独立Dashboard**

**决策理由**：
- DDPS-Z是独立的分析工具，有自己的使用场景
- 独立Dashboard便于后续功能扩展
- 避免与现有页面功能混淆

**实现影响**：
- 创建新的URL路由 `/ddps-z/`
- 创建独立的视图和模板
- 需要设计新的Dashboard布局

---

## 隐含假设确认

### 假设1：K线数据已存在且足够
**状态**：✅ 已确认

现有系统已有K线数据管理：
- 数据模型：`backtest.models.KLine`
- 更新命令：`update_klines`
- 数据源：Binance API

### 假设2：EMA25是合适的基础均线
**状态**：✅ 采用

EMA25是加密货币交易中常用的均线周期，能够：
- 过滤短期噪声
- 跟踪中期趋势
- 计算简单高效

### 假设3：正态分布假设适用于Z-Score分位映射
**状态**：⚠️ 需监控

金融数据通常呈现"肥尾"分布，实际分位数可能与正态假设有偏差。

**缓解措施**：
- 监控实际Z值分布
- P1阶段可考虑实现经验分位数

---

## 边界条件处理

### 场景1：新上线交易对（K线<180根）
**处理方式**：
- 返回计算结果但标记 `data_insufficient=True`
- 前端显示"数据不足"警告
- 不生成交易信号

### 场景2：成交量为0（流动性缺失）
**处理方式**：
- RVOL设为0
- 量价验证结果为"弱信号"
- 前端标记"流动性缺失"

### 场景3：极端Z值（|Z| > 4）
**处理方式**：
- 不做截断，保留原始值
- 分位数标记为 >99.99% 或 <0.01%
- 视为强信号，但提示"极端行情"

---

## 决策汇总

| 编号 | 决策项 | 决策结果 | 决策日期 |
|------|--------|---------|---------|
| D-001 | EWMA窗口N | N=180 | 2025-01-05 |
| D-002 | K线周期 | 4h | 2025-01-05 |
| D-003 | 放量阈值 | RVOL >= 2x | 2025-01-05 |
| D-004 | 前端位置 | 独立Dashboard | 2025-01-05 |
| D-005 | 基础均线 | EMA25 | 2025-01-05 |
| D-006 | 分位数方法 | 正态假设 | 2025-01-05 |

---

## 后续待确认事项

| 编号 | 事项 | 优先级 | 触发条件 |
|------|------|--------|---------|
| TBD-001 | 是否需要经验分位数替代正态假设 | P1 | 发现分布偏差显著 |
| TBD-002 | 是否需要支持多周期同时展示 | P1 | 用户反馈需求 |
| TBD-003 | 信号推送频率和渠道 | P1 | 进入推送功能开发 |
