# 需求澄清记录 - 策略7：动态周期自适应策略

**迭代编号**: 021
**策略编号**: 策略7
**文档版本**: v1.0.0
**创建日期**: 2026-01-07
**状态**: P1 - 需求澄清完成

---

## 一、澄清会话记录

### 会话日期：2026-01-07

#### 澄清问题 1：买入触发的周期前置条件

**问题背景**：
策略6仅在震荡期买入（`consolidation AND low <= P5`），但策略7的买入逻辑是"无条件`low <= P5`"还是"也仅在震荡期买入"？

**提出的选项**：
- **选项A**：仅震荡期买入（与策略6保持一致）
  - 优点：避免趋势期逆势买入风险，复用策略6代码
  - 缺点：信号较少
- **选项B**：任意周期买入（无周期前置条件）
  - 优点：信号更多，覆盖更多交易机会
  - 缺点：趋势期买入P5可能逆势，风险高

**我的建议**：选项B（仅震荡期买入）
**推荐理由**：
1. 与策略6逻辑一致，形成清晰的升级关系
2. 避免趋势期逆势买入风险
3. 复用策略6代码，实现最快

**✅ 用户确认**：
```
使用方案B，我的需求就是任何low <= p5时使用close买入
```

**最终决策**：**选项B** - 任意周期买入（`low <= P5`，无周期前置条件）

**影响范围**：
- 需要新建`_calculate_strategy7`方法，不能直接复用策略6
- 信号数量预期增加（相比策略6）
- 需要通过动态卖出策略来控制风险

---

#### 澄清问题 2：上涨期止盈的mid定义

**问题背景**：
用户提到上涨期止盈条件为`high >= (p95+mid)/2`，这里的`mid`需要明确定义。

**提出的选项**：
- **选项A**：`inertia_mid`（惯性预测中值）
  - 优点：与现有策略术语一致，动态跟踪趋势变化，已有现成计算逻辑
  - 缺点：依赖inertia_mid计算
- **选项B**：`(P5 + P95) / 2`（震荡区间中值）
  - 优点：计算简单，无额外依赖
  - 缺点：静态阈值，不能动态跟踪趋势，与现有策略术语不一致

**我的建议**：选项A（`inertia_mid`）
**推荐理由**：
1. 术语一致性：与策略2/4/6保持一致
2. 动态性：跟踪趋势变化，更贴合"自适应"定位
3. 复用性：已有计算逻辑，无需新开发

**✅ 用户确认**：
```
（接受推荐方案A）
```

**最终决策**：**选项A** - 使用`inertia_mid`

**公式**：
```
threshold = (P95 + inertia_mid) / 2
```

**影响范围**：
- ConsolidationMidTakeProfitExit需要从indicators中获取`inertia_mid`
- 回测时需要确保InertiaCalculator已计算inertia_mid

---

#### 澄清问题 3：周期状态的判断时机

**问题背景**：
卖出策略根据周期动态调整，需要明确是买入时固定周期状态，还是持仓期间实时获取周期状态。

**提出的选项**：
- **选项A**：买入时固定周期状态
  - 描述：买入时记录`cycle_phase`，持仓期间一直使用该状态
  - 优点：实现简单，状态稳定
  - 缺点：无法响应市场周期变化
- **选项B**：实时获取周期状态
  - 描述：每根K线实时获取当前`cycle_phase`，动态切换卖出条件
  - 优点：真正的"动态自适应"，响应市场周期变化，符合策略定位
  - 缺点：实现稍复杂，周期频繁切换可能导致策略不稳定

**我的建议**：选项B（实时获取周期状态）
**推荐理由**：
1. 策略核心价值：动态自适应是策略7与策略6的主要区别
2. 技术可行性：BetaCycleCalculator已支持逐K线计算
3. MVP优先：虽然实现复杂度稍高，但这是策略的核心逻辑，必须在MVP中实现

**✅ 用户确认**：
```
（接受推荐方案B）
```

**最终决策**：**选项B** - 实时获取周期状态

**实现方式**：
```python
# 每根K线计算cycle_phase
current_cycle_phase = cycle_phases[i]

# 根据current_cycle_phase选择Exit Condition
if current_cycle_phase == 'consolidation':
    exit_conditions = [P95TakeProfitExit(), StopLossExit(5)]
elif current_cycle_phase in ['bear_warning', 'bear_strong']:
    exit_conditions = [EmaReversionExit(25), StopLossExit(5)]
elif current_cycle_phase in ['bull_warning', 'bull_strong']:
    exit_conditions = [ConsolidationMidTakeProfitExit(), StopLossExit(5)]
```

**影响范围**：
- 需要扩展回测引擎，支持在每根K线传递cycle_phase到Exit Condition
- 需要确保BetaCycleCalculator在回测前计算完整的cycle_phases序列

---

## 二、需求对齐确认

### 2.1 买入逻辑确认

**原始描述**：
```
买入：kline['low'] <= P5
```

**理解确认**：
- ✅ 触发条件：K线最低价触及或跌破P5阈值
- ✅ 无周期前置条件：任意市场阶段均可触发
- ✅ 成交价格：使用K线收盘价（`kline['close']`）

**与策略6的差异**：
| 项目 | 策略6 | 策略7 |
|------|------|------|
| 触发条件 | `consolidation AND low <= P5` | `low <= P5` |
| 周期限制 | 仅震荡期 | 任意周期 |
| 信号数量 | 较少 | 较多 |

---

### 2.2 卖出逻辑确认

#### 震荡期卖出

**原始描述**：
```
震荡期间：
P95止盈 或 5%止损（5%可设置）
```

**理解确认**：
- ✅ 周期判断：`cycle_phase == 'consolidation'`
- ✅ 止盈条件：K线最高价触及P95（`kline['high'] >= P95`）
- ✅ 止盈成交价：K线收盘价（`kline['close']`）
- ✅ 止损条件：亏损率 >= 5%
- ✅ 止损成交价：K线收盘价（`kline['close']`）
- ✅ 优先级：P95止盈（priority=9） > 止损（priority=10）

**复用组件**：
- P95TakeProfitExit（策略6刚实现）
- StopLossExit（percentage=5）

---

#### 下跌期卖出

**原始描述**：
```
下跌期间：
Ema25止盈，或5%止损（5%可设置）
```

**理解确认**：
- ✅ 周期判断：`cycle_phase in ['bear_warning', 'bear_strong']`
- ✅ 止盈条件：K线触及EMA25（`kline['low'] <= EMA25 <= kline['high']`）
- ✅ 止盈成交价：EMA25值
- ✅ 止损条件：亏损率 >= 5%
- ✅ 止损成交价：K线收盘价（`kline['close']`）
- ✅ 优先级：EMA25回归（priority=5） > 止损（priority=10）

**复用组件**：
- EmaReversionExit（ema_period=25）
- StopLossExit（percentage=5）

---

#### 上涨期卖出

**原始描述**：
```
上涨期间：
high >= (p95+mid)/2 止盈，或5%止损
```

**理解确认**：
- ✅ 周期判断：`cycle_phase in ['bull_warning', 'bull_strong']`
- ✅ mid定义：`inertia_mid`（惯性预测中值）
- ✅ 止盈条件：K线最高价触及阈值（`kline['high'] >= (P95 + inertia_mid) / 2`）
- ✅ 止盈成交价：K线收盘价（`kline['close']`）
- ✅ 止损条件：亏损率 >= 5%
- ✅ 止损成交价：K线收盘价（`kline['close']`）
- ✅ 优先级：Mid止盈（priority=5） > 止损（priority=10）

**新增组件**：
- ConsolidationMidTakeProfitExit（需新建）

---

### 2.3 回测参数确认

**原始描述**：
```
回测2025-01-01至今的eth/usdt交易对
```

**理解确认**：
- ✅ 交易对：ETH/USDT
- ✅ 时间范围：2025-01-01 00:00:00 至 2026-01-07 23:59:59
- ✅ K线周期：4h（继承现有设置）
- ✅ 初始资金：10000 USDT（默认）
- ✅ 手续费率：0.1%（默认）
- ✅ 结果保存：`--save-to-db`参数保存到数据库

---

## 三、澄清结果总结

### 3.1 核心决策汇总

| 决策点 | 选择方案 | 关键理由 |
|--------|---------|---------|
| 买入周期限制 | 任意周期 | 用户明确需求，通过动态卖出控制风险 |
| 上涨期mid定义 | inertia_mid | 术语一致性，动态跟踪趋势 |
| 周期判断时机 | 实时获取 | 策略核心价值，真正的动态自适应 |

### 3.2 关键技术要点

1. **买入信号**：新建`_calculate_strategy7`方法，检查`low <= P5`（无周期前置条件）
2. **动态卖出**：每根K线实时获取cycle_phase，根据周期状态选择Exit Condition组合
3. **新增组件**：ConsolidationMidTakeProfitExit（上涨期止盈）
4. **回测引擎扩展**：支持传递cycle_phase到Exit Condition

### 3.3 预期效果

**相比策略6的改进**：
1. **信号数量**：预期增加（无周期限制）
2. **风险控制**：通过动态卖出适应不同市场环境
3. **收益优化**：在上涨期使用更高的止盈目标，在下跌期快速止盈

**潜在风险**：
1. 趋势期买入P5可能逆势（通过动态卖出缓解）
2. 周期频繁切换可能导致策略不稳定（通过回测验证）

---

## 四、需求覆盖度状态表

| 类别 | 状态 | 备注 |
|------|------|------|
| 功能范围与边界 | Clear ✅ | 动态周期自适应策略，买入P5，卖出根据周期动态调整 |
| 数据模型与实体 | Clear ✅ | 复用现有Order、Signal、BacktestResult模型 |
| 交互与UX流程 | Clear ✅ | 策略执行流程明确，动态切换逻辑清晰 |
| 非功能属性 | Clear ✅ | 性能复用现有回测系统，安全性无特殊要求 |
| 集成与外部依赖 | Clear ✅ | 依赖BetaCycleCalculator、P5/P95、EMA、InertiaCalculator |
| 边界情况与失败处理 | Clear ✅ | 每个周期都有止损保护，周期切换逻辑明确 |
| 约束与权衡 | Clear ✅ | MVP使用现有indicator默认参数，推迟参数优化 |
| 术语一致性 | Clear ✅ | 使用DDPS-Z术语体系（P5/P95/β宏观周期/inertia_mid） |
| 完整性信号 | Clear ✅ | 所有核心功能已定义，MVP范围明确 |
| 待办项/占位符 | Clear ✅ | 决策点已明确，用户已确认选择 |

---

## 五、遗留问题清单

### 5.1 技术实现问题

- [ ] **周期切换频率**：持仓期间周期可能频繁切换，需通过回测评估影响
- [ ] **Exit Condition接口扩展**：需要确保cycle_phase参数的传递不影响现有策略

### 5.2 参数调优问题

- [ ] **止损比例**：MVP统一使用5%，后续可根据周期动态调整
- [ ] **P5阈值**：无周期限制可能导致信号过多，后续可调整阈值或添加过滤条件

### 5.3 分析与优化问题

- [ ] **周期切换日志**：MVP不实现，后续可添加以分析周期切换对策略的影响
- [ ] **策略6/7对比**：回测完成后进行详细对比分析
- [ ] **DynamicExitManager提取**：MVP在回测引擎中直接实现，后续可提取为独立组件

---

## 六、文档修订历史

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|---------|--------|
| v1.0.0 | 2026-01-07 | 初始版本，完成3个关键决策点的澄清 | PowerBy Product Manager |

---

**文档状态**: ✅ 需求澄清完成
**下一步**: 基于澄清结果，进入实施阶段（P6）或技术调研阶段（P3）
