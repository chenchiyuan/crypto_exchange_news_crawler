# 验收清单 - 策略7：动态周期自适应策略

**迭代编号**: 021
**策略编号**: 策略7
**文档版本**: v1.0.0
**创建日期**: 2026-01-07
**生命周期阶段**: P5 - 开发规划
**关联文档**:
- PRD: `docs/iterations/021-adaptive-exit-strategy/prd.md`
- 架构设计: `docs/iterations/021-adaptive-exit-strategy/architecture.md`
- 任务计划: `docs/iterations/021-adaptive-exit-strategy/tasks.md`

---

## 第一部分：功能验收标准

### 1.1 ConsolidationMidTakeProfitExit验收

**任务**: TASK-021-001
**验收人**: _________
**验收日期**: _________

#### 功能完整性
- [ ] 类继承IExitCondition接口
- [ ] check方法实现完整
- [ ] get_priority方法返回5
- [ ] 包含完整的文档注释（类、方法、参数、返回值）
- [ ] 包含类型注解

#### 逻辑正确性
- [ ] 正确从indicators获取p95和inertia_mid
- [ ] 正确计算threshold = (p95 + inertia_mid) / 2
- [ ] 正确判断触发条件：kline['high'] >= threshold
- [ ] 使用kline['close']作为成交价格
- [ ] 返回ExitSignal格式正确

#### 异常处理
- [ ] 缺少p95时抛出KeyError
- [ ] 缺少inertia_mid时抛出KeyError
- [ ] p95或inertia_mid为NaN时返回None
- [ ] 异常信息包含清晰的上下文

#### 数据类型
- [ ] 价格使用Decimal类型
- [ ] 避免浮点数精度问题

#### 单元测试
- [ ] 测试：high等于threshold时触发
- [ ] 测试：high超过threshold时触发
- [ ] 测试：high低于threshold时不触发
- [ ] 测试：缺少p95时抛出KeyError
- [ ] 测试：缺少inertia_mid时抛出KeyError
- [ ] 测试：指标为NaN时返回None
- [ ] 测试：get_priority返回5
- [ ] 所有单元测试通过

---

### 1.2 _calculate_strategy7验收

**任务**: TASK-021-003, TASK-021-004
**验收人**: _________
**验收日期**: _________

#### 方法实现
- [ ] _calculate_strategy7方法实现完整
- [ ] 方法签名正确：`_calculate_strategy7(self, kline, p5) -> Dict[str, Any]`
- [ ] 包含完整的文档注释
- [ ] 包含类型注解

#### 触发逻辑
- [ ] 触发条件正确：kline['low'] <= p5
- [ ] 无周期前置条件（与策略6的关键差异）
- [ ] P5为NaN时返回triggered=False

#### 返回格式
- [ ] 返回字典包含'id': 'strategy_7'
- [ ] 返回字典包含'name': '动态周期自适应'
- [ ] 返回字典包含'triggered': bool
- [ ] triggered=True时包含'reason'字段
- [ ] triggered=True时包含'details'字段
- [ ] details包含：p5, current_low, buy_price

#### 集成验证
- [ ] calculate()方法中正确调用_calculate_strategy7
- [ ] 当7 in enabled_strategies时才调用
- [ ] long_triggered包含strategy7_result判断
- [ ] strategies列表包含strategy7_result
- [ ] 信号格式与策略1-6一致

#### 单元测试
- [ ] 测试：low等于p5时触发
- [ ] 测试：low低于p5时触发
- [ ] 测试：low高于p5时不触发
- [ ] 测试：p5为NaN时不触发
- [ ] 测试：返回格式正确
- [ ] 所有单元测试通过

---

### 1.3 IndicatorStateManager验收

**任务**: TASK-021-005
**验收人**: _________
**验收日期**: _________

#### 类实现
- [ ] IndicatorStateManager类实现完整
- [ ] __init__方法正确初始化所有Calculator
- [ ] calculate_indicators方法实现完整
- [ ] 包含完整的文档注释

#### 无状态设计
- [ ] 每次调用都从头计算（无状态）
- [ ] 重复调用返回一致结果
- [ ] 无内部状态变量（除Calculator实例）

#### 增量计算逻辑
- [ ] 正确提取价格序列
- [ ] 正确计算EMA25序列
- [ ] 正确计算P5/P95
- [ ] 正确计算beta（EMA斜率）
- [ ] 正确计算inertia_mid
- [ ] 正确计算cycle_phase
- [ ] 计算顺序正确（依赖关系明确）

#### 避免未来函数
- [ ] 仅使用historical_klines（历史+当前）
- [ ] 不访问未来数据
- [ ] 所有Calculator调用仅基于历史序列
- [ ] BetaCycleCalculator使用历史beta序列

#### 返回格式
- [ ] 返回字典包含ema25
- [ ] 返回字典包含p5
- [ ] 返回字典包含p95
- [ ] 返回字典包含beta
- [ ] 返回字典包含inertia_mid
- [ ] 返回字典包含cycle_phase
- [ ] 所有值类型正确

#### 边界处理
- [ ] 空历史时处理正确
- [ ] 单根K线时处理正确
- [ ] NaN值处理正确

#### 单元测试
- [ ] 测试：空历史计算
- [ ] 测试：单根K线计算
- [ ] 测试：完整历史计算
- [ ] 测试：重复调用一致性
- [ ] 测试：指标值准确性
- [ ] 所有单元测试通过

---

### 1.4 动态Exit Condition选择验收

**任务**: TASK-021-006
**验收人**: _________
**验收日期**: _________

#### _get_exit_conditions实现
- [ ] _get_exit_conditions方法实现完整
- [ ] 参数：cycle_phase: str
- [ ] 返回：List[IExitCondition]
- [ ] 包含完整的文档注释

#### 周期映射逻辑
- [ ] consolidation → P95TakeProfitExit + StopLossExit(5)
- [ ] bear_warning → EmaReversionExit(25) + StopLossExit(5)
- [ ] bear_strong → EmaReversionExit(25) + StopLossExit(5)
- [ ] bull_warning → ConsolidationMidTakeProfitExit + StopLossExit(5)
- [ ] bull_strong → ConsolidationMidTakeProfitExit + StopLossExit(5)
- [ ] 未知周期 → StopLossExit(5)

#### Exit Condition优先级
- [ ] Exit Condition按priority排序
- [ ] 止盈优先级高于止损
- [ ] 排序逻辑正确（升序：数字越小优先级越高）

#### 集成到BacktestEngine
- [ ] _check_exit_conditions中集成IndicatorStateManager
- [ ] 正确获取当前cycle_phase
- [ ] 正确调用_get_exit_conditions
- [ ] 按priority顺序检查Exit Condition
- [ ] 添加周期切换日志（debug级别）

#### 向后兼容性
- [ ] 现有策略（1-6）不受影响
- [ ] Exit Condition接口保持一致
- [ ] 回测引擎逻辑保持兼容

#### 单元测试
- [ ] 测试：consolidation选择P95Exit
- [ ] 测试：bear选择EMAExit
- [ ] 测试：bull选择MidExit
- [ ] 测试：未知周期选择StopLoss
- [ ] 测试：Exit Condition按priority排序
- [ ] 所有单元测试通过

---

### 1.5 DDPSZAdapter集成验收

**任务**: TASK-021-008
**验收人**: _________
**验收日期**: _________

#### 代码修改
- [ ] Line 172 guard clause已更新
  - 修改前：[1, 2, 6]
  - 修改后：[1, 2, 6, 7]
- [ ] Line 204 策略过滤已更新
  - 修改前：[1, 2, 6]
  - 修改后：[1, 2, 6, 7]
- [ ] 文档注释已更新
  - 添加策略7说明

#### 功能验证
- [ ] enabled_strategies包含7时，生成买入信号
- [ ] 策略7的买入信号格式正确
- [ ] long_strategies过滤包含策略7
- [ ] debug日志信息正确

#### 向后兼容
- [ ] 策略1-6不受影响
- [ ] 现有单元测试通过

---

### 1.6 配置文件验收

**任务**: TASK-021-007
**验收人**: _________
**验收日期**: _________

#### 文件存在性
- [ ] 文件路径正确：`strategy_adapter/configs/strategy7_adaptive_exit.json`
- [ ] JSON格式正确（无语法错误）

#### backtest_config
- [ ] symbol: "ETHUSDT"
- [ ] interval: "4h"
- [ ] market_type: "futures"
- [ ] start_date: "2025-01-01"
- [ ] end_date: "2026-01-07"
- [ ] initial_cash: 10000
- [ ] commission_rate: 0.001

#### capital_management
- [ ] mode: "shared"
- [ ] position_size_mode: "fixed"
- [ ] position_size: 100
- [ ] max_positions: 10

#### strategy配置
- [ ] id: "strategy_7"
- [ ] name: "动态周期自适应"
- [ ] type: "ddps-z"
- [ ] enabled: true
- [ ] entry.strategy_id: 7
- [ ] exits字段包含动态规则说明

#### 文档注释
- [ ] 包含项目名称和描述
- [ ] 包含版本和创建日期
- [ ] 包含迭代编号
- [ ] exits字段说明动态Exit逻辑

---

### 1.7 回测执行验收

**任务**: TASK-021-009
**验收人**: _________
**验收日期**: _________

#### 回测成功性
- [ ] 回测命令执行成功
- [ ] 无错误或异常
- [ ] 无警告（或警告已评估为可接受）

#### 买入信号
- [ ] 生成买入信号数量 > 0
- [ ] 买入信号时间戳合理
- [ ] 买入价格在合理范围内

#### 订单管理
- [ ] 所有订单已平仓
- [ ] 订单数量与买入信号匹配
- [ ] 订单平仓价格合理
- [ ] 订单盈亏计算正确

#### 周期分布
- [ ] 震荡期订单数量 > 0
- [ ] 下跌期订单数量 >= 0
- [ ] 上涨期订单数量 >= 0
- [ ] 周期切换日志记录清晰

#### Exit Condition验证
- [ ] 震荡期订单使用P95止盈或止损
- [ ] 下跌期订单使用EMA25回归或止损
- [ ] 上涨期订单使用Mid止盈或止损
- [ ] 所有订单都有止损保护

#### 数据库保存
- [ ] BacktestResult记录已创建
- [ ] BacktestResult包含正确的统计数据
- [ ] Order记录已创建
- [ ] Order记录包含完整的字段

#### 日志验证
- [ ] 日志包含买入信号信息
- [ ] 日志包含周期切换信息
- [ ] 日志包含Exit触发信息
- [ ] 日志级别合理

---

### 1.8 回测结果分析验收

**任务**: TASK-021-010
**验收人**: _________
**验收日期**: _________

#### 整体统计
- [ ] 总订单数已统计
- [ ] 胜率已计算
- [ ] 收益率已计算
- [ ] 最大盈利已记录
- [ ] 最大亏损已记录
- [ ] 平均盈亏率已计算

#### 周期分布分析
- [ ] 各周期订单数量已统计
- [ ] 各周期胜率已计算
- [ ] 周期分布合理性已评估

#### 止盈方式统计
- [ ] P95止盈触发次数已统计
- [ ] EMA25回归触发次数已统计
- [ ] Mid止盈触发次数已统计
- [ ] 止损触发次数已统计
- [ ] 各止盈方式平均盈利率已计算

#### 与策略6对比
- [ ] 信号数量对比已完成
- [ ] 收益率对比已完成
- [ ] 胜率对比已完成
- [ ] 最大回撤对比已完成
- [ ] 动态vs静态止盈效果差异已分析

#### 分析报告
- [ ] 分析报告已撰写
- [ ] 报告包含数据和图表
- [ ] 报告包含结论和建议
- [ ] 报告格式清晰易读

---

## 第二部分：质量检查清单

### 2.1 代码质量检查

#### 代码风格
- [ ] 遵循项目代码规范
- [ ] 变量命名清晰明确
- [ ] 函数命名符合语义
- [ ] 代码格式一致（使用formatter）

#### 文档注释
- [ ] 所有类包含文档注释
- [ ] 所有公共方法包含文档注释
- [ ] 文档注释包含参数说明
- [ ] 文档注释包含返回值说明
- [ ] 文档注释包含异常说明

#### 类型注解
- [ ] 所有方法参数包含类型注解
- [ ] 所有方法返回值包含类型注解
- [ ] 复杂类型使用typing模块

#### 异常处理
- [ ] 关键路径包含异常处理
- [ ] 异常信息清晰具体
- [ ] 异常类型选择合理
- [ ] 避免静默失败

#### 日志记录
- [ ] 关键操作包含日志
- [ ] 日志级别选择合理
- [ ] 日志信息清晰有用
- [ ] 避免过度日志

---

### 2.2 测试质量检查

#### 单元测试覆盖
- [ ] ConsolidationMidTakeProfitExit：7个测试
- [ ] _calculate_strategy7：5个测试
- [ ] IndicatorStateManager：5个测试
- [ ] 动态Exit选择：5个测试
- [ ] 总计：≥22个单元测试

#### 测试通过率
- [ ] 所有单元测试通过
- [ ] 无跳过的测试
- [ ] 无失败的测试

#### 测试覆盖率
- [ ] 代码覆盖率 ≥ 80%（新增代码）
- [ ] 关键路径覆盖率 = 100%
- [ ] 异常路径覆盖率 ≥ 60%

#### 集成测试
- [ ] 端到端回测测试通过
- [ ] 未来函数验证测试通过
- [ ] 回归测试通过（策略1-6）

---

### 2.3 性能检查

#### 回测性能
- [ ] 策略7回测时间 ≤ 30秒
- [ ] 内存占用合理（< 500MB）
- [ ] 无明显性能瓶颈

#### IndicatorStateManager性能
- [ ] 每根K线计算时间 ≤ 20ms
- [ ] 总回测时间可接受
- [ ] 无需立即优化

#### 数据库性能
- [ ] 结果保存时间 ≤ 5秒
- [ ] 查询性能合理

---

### 2.4 安全检查

#### 数据验证
- [ ] 输入数据验证充分
- [ ] 参数范围检查完整
- [ ] NaN/Inf值处理正确

#### 类型安全
- [ ] 使用Decimal避免浮点数问题
- [ ] 类型转换安全
- [ ] 无类型错误风险

#### 异常安全
- [ ] 异常处理充分
- [ ] 无未捕获异常
- [ ] 资源清理正确

---

## 第三部分：验证测试清单

### 3.1 未来函数验证

#### 验证方法1：逐K线回测对比
- [ ] 设计测试用例：修改未来K线数据
- [ ] 验证：修改不影响历史指标值
- [ ] 验证：历史买入信号不变
- [ ] 验证：历史平仓价格不变

#### 验证方法2：分段回测一致性
- [ ] 回测1：2025-01-01 至 2025-06-30
- [ ] 回测2：2025-01-01 至 2026-01-07
- [ ] 验证：前半段结果完全一致
- [ ] 验证：指标值一致

#### 验证方法3：人工审查
- [ ] 审查IndicatorStateManager逻辑
- [ ] 确认仅使用historical_klines
- [ ] 确认无向前引用
- [ ] 确认Calculator调用正确

---

### 3.2 动态Exit验证

#### 周期切换验证
- [ ] 选择典型订单（经历周期切换）
- [ ] 验证：周期切换日志正确
- [ ] 验证：Exit Condition正确切换
- [ ] 验证：平仓价格合理

#### Exit优先级验证
- [ ] 验证：止盈优先于止损
- [ ] 验证：priority数值小的先检查
- [ ] 验证：只触发第一个满足条件的Exit

#### 各周期Exit验证
- [ ] 震荡期订单：P95止盈或止损
- [ ] 下跌期订单：EMA25回归或止损
- [ ] 上涨期订单：Mid止盈或止损

---

### 3.3 回归验证

#### 策略1回归
- [ ] 运行策略1回测
- [ ] 对比历史结果
- [ ] 验证：结果一致

#### 策略2回归
- [ ] 运行策略2回测
- [ ] 对比历史结果
- [ ] 验证：结果一致

#### 策略6回归
- [ ] 运行策略6回测
- [ ] 对比历史结果
- [ ] 验证：结果一致

#### 现有单元测试
- [ ] 运行所有现有单元测试
- [ ] 验证：全部通过
- [ ] 验证：无新增失败

---

## 第四部分：文档验收清单

### 4.1 技术文档

#### 架构文档
- [ ] architecture.md已完成
- [ ] 包含完整的7个部分
- [ ] Mermaid图表正确渲染
- [ ] 代码示例正确

#### 任务计划
- [ ] tasks.md已完成
- [ ] 10个任务定义清晰
- [ ] 依赖关系明确
- [ ] 工作量估算合理

#### 验收清单
- [ ] acceptance.md已完成（当前文档）
- [ ] 验收标准明确
- [ ] 检查项完整

#### PRD文档
- [ ] prd.md已更新（如需要）
- [ ] 功能定义准确
- [ ] 验收标准清晰

---

### 4.2 代码文档

#### 类文档注释
- [ ] ConsolidationMidTakeProfitExit
- [ ] IndicatorStateManager
- [ ] 其他新增类

#### 方法文档注释
- [ ] _calculate_strategy7
- [ ] _get_exit_conditions
- [ ] calculate_indicators
- [ ] 其他新增方法

#### 配置文件注释
- [ ] strategy7_adaptive_exit.json
- [ ] 包含说明注释
- [ ] 易于理解

---

### 4.3 用户文档（可选）

#### README更新
- [ ] 添加策略7说明
- [ ] 更新策略列表
- [ ] 更新使用示例

#### 回测分析报告
- [ ] backtest-analysis.md已创建
- [ ] 包含完整分析
- [ ] 包含图表和结论

---

## 第五部分：最终验收签字

### 5.1 功能验收

**验收人**: _________
**验收日期**: _________

#### P0功能完成度
- [ ] TASK-021-001: ConsolidationMidTakeProfitExit ✓
- [ ] TASK-021-002: 注册Exit Factory ✓
- [ ] TASK-021-003: _calculate_strategy7 ✓
- [ ] TASK-021-004: 集成SignalCalculator ✓
- [ ] TASK-021-005: IndicatorStateManager ✓
- [ ] TASK-021-006: 动态Exit选择 ✓
- [ ] TASK-021-007: 配置文件 ✓
- [ ] TASK-021-008: 注册DDPSZAdapter ✓
- [ ] TASK-021-009: 执行回测 ✓
- [ ] TASK-021-010: 分析结果 ✓

#### 总体评估
- [ ] 所有P0功能已完成
- [ ] 所有验收标准已满足
- [ ] 所有测试已通过
- [ ] 文档已完整

**签字**: _________

---

### 5.2 质量验收

**验收人**: _________
**验收日期**: _________

#### 质量指标
- [ ] 单元测试通过率 = 100%
- [ ] 代码覆盖率 ≥ 80%
- [ ] 回测成功率 = 100%
- [ ] 无未来函数（已验证）

#### 性能指标
- [ ] 回测时间 ≤ 30秒
- [ ] 内存占用合理
- [ ] 无性能瓶颈

#### 代码质量
- [ ] 代码规范符合项目标准
- [ ] 文档注释完整
- [ ] 异常处理充分
- [ ] 日志记录合理

**签字**: _________

---

### 5.3 交付验收

**验收人**: _________
**验收日期**: _________

#### 交付物清单
- [ ] 代码文件（5个新增/修改）
- [ ] 配置文件（1个）
- [ ] 单元测试（≥22个）
- [ ] 技术文档（4个）
- [ ] 回测结果（数据库记录）

#### 部署检查
- [ ] 代码已提交到版本控制
- [ ] 数据库迁移已执行（如需要）
- [ ] 配置文件已部署
- [ ] 文档已归档

#### 最终确认
- [ ] 策略7功能完整
- [ ] 质量标准满足
- [ ] 文档完整清晰
- [ ] 可以进入生产环境（或下一阶段）

**签字**: _________

---

## 附录：验收备注

### 遗留问题（可选）
记录验收过程中发现的遗留问题（非阻塞性）：

1. _________________________________________
2. _________________________________________
3. _________________________________________

### 优化建议（可选）
记录未来可以优化的方向：

1. _________________________________________
2. _________________________________________
3. _________________________________________

### 其他备注
_________________________________________________
_________________________________________________
_________________________________________________

---

**文档状态**: ✅ 验收清单完成
**下一步**: 进入P6阶段（开发实施）
