# PRD: β宏观周期指标

**迭代编号**: 018
**创建时间**: 2026-01-07
**状态**: 需求定义中

---

## 1. 背景与目标

### 1.1 背景

DDPS-Z策略中的β值是EMA斜率的度量，反映价格趋势的强度和方向。基于数据分析发现：
- β > 600（前端显示值）时，往往预示上涨趋势开始
- β > 1000 时，确认强势上涨
- β <= 0 时，上涨周期结束

同理，下跌周期也有类似的β特征。目前页面缺少对宏观周期的直观标记，用户需要手动判断当前处于何种市场阶段。

### 1.2 目标

在 `/ddps-z/detail/<symbol>/` 页面中实现宏观周期标记功能：
- 每根K线标记其所属的宏观周期（强势上涨/强势下跌/震荡）
- 提供直观的视觉反馈（颜色/图标/标签）
- 支持动态调整阈值参数

---

## 2. 用户故事

**作为** 量化交易者
**我希望** 在K线图上直观看到当前所处的宏观周期阶段
**以便于** 快速判断市场状态，辅助交易决策

---

## 3. 功能需求

### 3.1 周期定义规则

#### 强势上涨周期
| 阶段 | 条件 | 说明 |
|------|------|------|
| 开始 | β > 600 且 β > prev_β | 走牛预警，进入候选上涨 |
| 确认 | β > 1000 | 确认强势上涨 |
| 结束 | β <= 0 | 周期结束 |

**注**: 只有经历"确认"阶段的周期才被标记为完整的强势上涨周期

#### 强势下跌周期
| 阶段 | 条件 | 说明 |
|------|------|------|
| 开始 | β < -600 且 β < prev_β | 走熊预警，进入候选下跌 |
| 确认 | β < -1000 | 确认强势下跌 |
| 结束 | β >= 0 | 周期结束 |

#### 震荡期
- 不满足上述条件的所有状态

### 3.2 阈值配置

默认阈值（前端显示值）：
```python
BETA_THRESHOLDS = {
    'bull_warning': 600,      # 上涨预警
    'bull_strong': 1000,      # 强势上涨确认
    'bear_warning': -600,     # 下跌预警
    'bear_strong': -1000,     # 强势下跌确认
    'cycle_end': 0,           # 周期结束
}
```

**要求**: 阈值可配置，不硬编码

### 3.3 K线周期标记

每根K线需要标记：
- `cycle_phase`: 周期阶段
  - `bull_warning`: 上涨预警（β > 600，尚未确认）
  - `bull_strong`: 强势上涨（已确认 β > 1000）
  - `bear_warning`: 下跌预警（β < -600，尚未确认）
  - `bear_strong`: 强势下跌（已确认 β < -1000）
  - `consolidation`: 震荡期

### 3.4 前端展示

1. **K线背景色**（可选）
   - 强势上涨: 淡绿色背景
   - 强势下跌: 淡红色背景
   - 震荡期: 无背景

2. **状态指示器**
   - 在页面顶部或HUD区域显示当前周期状态
   - 显示当前周期持续时间

3. **Hover信息**
   - 在K线hover时显示该K线的周期标记

---

## 4. 非功能需求

### 4.1 性能
- 周期计算应在后端完成，随chart数据一起返回
- 不增加明显的API响应延迟

### 4.2 可维护性
- 阈值参数可通过Django settings配置
- 支持未来扩展更多周期类型

---

## 5. 技术约束

### 5.1 现有架构
- 后端: `ddps_z/services/chart_data_service.py`
- 前端: `ddps_z/templates/ddps_z/detail.html`
- API: `/ddps-z/api/chart/`

### 5.2 数据流
```
ChartDataService.get_chart_data()
  └── _generate_fan_data() -> fan['kline_data'] 包含 beta 值
  └── 🆕 _calculate_cycle_phases() -> 计算周期标记
```

---

## 6. 验收标准

- [ ] 每根K线都有 `cycle_phase` 标记
- [ ] API返回数据包含周期信息
- [ ] 前端正确显示周期状态
- [ ] 阈值可通过配置调整
- [ ] Hover时显示周期信息

---

## 7. 排期建议

| 任务 | 优先级 |
|------|--------|
| 后端周期计算逻辑 | P0 |
| API返回周期数据 | P0 |
| 前端HUD显示当前周期 | P0 |
| K线背景色标记 | P1 |
| 阈值配置化 | P0 |

---

**创建人**: PowerBy Product
**最后更新**: 2026-01-07
