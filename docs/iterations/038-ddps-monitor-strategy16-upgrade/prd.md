# PRD: DDPS监控服务策略16升级

## 文档信息

| 属性 | 值 |
|------|-----|
| 迭代编号 | 038 |
| 创建日期 | 2026-01-12 |
| 状态 | 草稿 |
| 关联迭代 | 023(DDPS价格监控), 036(策略16), 037(策略16详情页) |

---

## 1. 背景与目标

### 1.1 背景

当前DDPS价格监控服务（`ddps_monitor`命令）使用策略7的信号检测逻辑：
- 买入条件：价格 <= P5
- 卖出条件：基于周期阶段的固定止盈

策略16已在迭代036中实现，具有更精准的入场和出场逻辑：
- 入场：P5限价挂单机制，避免后验偏差
- 出场：EMA状态自适应止盈

需要将监控服务升级为使用策略16，并扩展推送内容以展示更丰富的市场信息。

### 1.2 目标

1. **策略升级**：监控服务从策略7升级为策略16
2. **推送内容扩展**：增加挂单价格、周期详情、周期占比、持仓订单等信息
3. **数据一致性**：确保推送内容与策略16回测结果完全一致

---

## 2. 功能需求

### 2.1 推送消息格式升级

#### 2.1.1 标题格式（保持不变）

```
[市场/周期] MM-DD HH:MM: 买入(N) 卖出(N) 上涨预警(N) 下跌预警(N)
```

示例：
```
[crypto_futures/4h] 01-12 10:30: 买入(2) 卖出(0) 上涨预警(1) 下跌预警(0)
```

#### 2.1.2 内容格式升级

```
时间: YYYY-MM-DD HH:MM

买入信号 (N个):
  - ETHUSDT @ 3500.50 (上涨预警)
  - BTCUSDT @ 42000.00 (震荡期)

卖出信号 (N个):
  - 订单#xxx BTCUSDT: EMA状态止盈(强势上涨) @ 42500.00 (开仓40000.00, +6.25%)

上涨预警: ETHUSDT, SOLUSDT
下跌预警: XRPUSDT

价格状态:
  ETHUSDT: 3500.50 (上涨预警)
    P5=3400.00 P95=3700.00
    惯性范围: 3450.00~3550.00
    概率: P42
    挂单价格: 3380.12
    所处周期: 强势上涨 - ADX(30) - 贝塔(0.012) - 连续48小时
    最近42周期占比: 强势上涨(30%), 震荡(50%), 强势下跌(20%)
    持仓订单 (2个):
      01-10 08:00 @ 3200.00 → 持仓56小时
      01-08 16:00 @ 3100.00 → 持仓104小时

  BTCUSDT: 95000.00 (震荡期)
    ...
```

### 2.2 策略16集成

#### 2.2.1 买入信号检测

- **数据来源**：策略16对最新K线的入场条件检测
- **触发条件**：当前K线满足P5入场条件时生成买入信号
- **挂单价格计算**：`base_price = min(P5, close, (P5+mid)/2)`，`order_price = base_price × (1-0.1%)`

#### 2.2.2 卖出信号检测

- **数据来源**：策略16的EMA状态止盈检测
- **持仓来源**：策略16回测结果中的holdings（未平仓订单）
- **退出类型**：
  - 强势上涨：EMA7下穿EMA25
  - 强势下跌：High突破EMA25
  - 震荡下跌：High突破EMA99
  - 震荡上涨：2%限价止盈

### 2.3 新增数据字段

#### 2.3.1 PriceStatus扩展

| 字段 | 类型 | 描述 |
|------|------|------|
| order_price | Decimal | 策略16挂单价格 |
| adx | float | ADX指标值 |
| beta | float | 贝塔值 |
| cycle_duration_hours | float | 周期连续时长（小时） |
| cycle_distribution | Dict | 最近42周期各状态占比 |
| holdings | List | 持仓订单列表 |

#### 2.3.2 周期占比统计

统计最近42根K线的周期分布：
- 强势上涨 (bull_strong)
- 上涨预警 (bull_warning)
- 震荡 (consolidation)
- 下跌预警 (bear_warning)
- 强势下跌 (bear_strong)

---

## 3. 技术方案

### 3.1 架构变更

```
DDPSMonitorService (升级)
├── 依赖注入Strategy16Runner
├── monitor() → 使用策略16计算
├── get_buy_signals() → 策略16入场检测
├── get_exit_signals() → EMA状态止盈检测
├── get_price_status() → 扩展字段
└── format_push_message() → 新格式

Strategy16Runner (复用)
├── run() → 运行回测获取holdings
└── _fetch_klines_as_dataframe() → 获取K线数据
```

### 3.2 数据流

```
1. 加载K线数据 (KLineRepository)
2. 运行策略16回测 (Strategy16Runner)
   ├── 获取holdings（未平仓订单）
   ├── 获取pending_order（当前挂单）
   └── 获取statistics（统计数据）
3. 计算DDPS指标 (DDPSCalculator)
   ├── 周期占比统计（新增）
   └── ADX/Beta/周期时长
4. 生成监控结果 (DDPSMonitorResult)
5. 格式化推送消息 (format_push_message)
```

---

## 4. 验收标准

### 4.1 功能验收

- [ ] 买入信号来自策略16最新K线检测
- [ ] 卖出信号基于策略16 EMA状态止盈
- [ ] 持仓订单与策略16回测结果一致
- [ ] 挂单价格计算正确
- [ ] 周期占比统计准确（42根K线）
- [ ] 推送消息格式符合规范

### 4.2 一致性验收

- [ ] 监控服务持仓 = 策略16回测holdings
- [ ] 推送挂单价格 = detail页面HUD挂单价格
- [ ] 周期状态 = detail页面显示一致

---

## 5. 排期

| 任务 | 描述 | 优先级 |
|------|------|--------|
| TASK-038-001 | 扩展PriceStatus数据模型 | P0 |
| TASK-038-002 | 集成Strategy16Runner到监控服务 | P0 |
| TASK-038-003 | 实现周期占比统计 | P0 |
| TASK-038-004 | 升级format_push_message | P0 |
| TASK-038-005 | 更新ddps_monitor命令 | P0 |
| TASK-038-006 | 测试验证 | P0 |

---

## 6. 风险与依赖

### 6.1 依赖

- 策略16实现（迭代036）✅ 已完成
- Strategy16Runner服务（迭代037）✅ 已完成
- DDPSCalculator（迭代024）✅ 已完成

### 6.2 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 策略16回测耗时 | 推送延迟 | 限制回测K线数量 |
| 内存占用增加 | 服务稳定性 | 及时清理缓存 |
