# 验收清单: DDPS监控服务策略16升级

## 文档信息

| 属性 | 值 |
|------|-----|
| 迭代编号 | 038 |
| 创建日期 | 2026-01-12 |
| 任务计划 | tasks.md |

---

## 1. 功能验收

### 1.1 数据模型 (FP-038-001)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| HoldingInfo定义 | 包含order_id, buy_price, buy_timestamp, holding_hours字段 | 🔲 |
| PriceStatus扩展 | 包含order_price, adx, beta, cycle_duration_hours, cycle_distribution, holdings字段 | 🔲 |
| 向后兼容 | 新字段使用Optional，不影响现有代码 | 🔲 |

### 1.2 策略16集成 (FP-038-002)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| Strategy16Runner调用 | DDPSMonitorService正确调用Strategy16Runner | 🔲 |
| 时间范围限制 | 回测数据限制为最近3个月 | 🔲 |
| 数据返回 | 正确返回holdings和pending_order | 🔲 |

### 1.3 周期占比统计 (FP-038-003)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| 统计窗口 | 使用最近42根K线 | 🔲 |
| 周期类别 | 统计5种周期：bull_strong, bull_warning, consolidation, bear_warning, bear_strong | 🔲 |
| 占比计算 | 百分比为整数，总和为100% | 🔲 |

### 1.4 买入信号检测 (FP-038-004)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| 信号来源 | 来自策略16的pending_order | 🔲 |
| 信号格式 | 转换为BuySignal格式 | 🔲 |
| 挂单价格 | 包含策略16挂单价格信息 | 🔲 |

### 1.5 卖出信号检测 (FP-038-005)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| 检测逻辑 | 基于策略16 EMA状态止盈 | 🔲 |
| 退出类型 | 正确标注退出类型（强势上涨/强势下跌/震荡下跌/震荡上涨） | 🔲 |
| 盈亏计算 | 盈亏率计算正确 | 🔲 |

### 1.6 推送消息格式 (FP-038-006)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| 标题格式 | `[市场/周期] MM-DD HH:MM: 买入(N) 卖出(N) 上涨预警(N) 下跌预警(N)` | 🔲 |
| 挂单价格行 | 显示策略16挂单价格 | 🔲 |
| 周期详情行 | 显示`周期 - ADX(x) - 贝塔(x) - 连续x小时` | 🔲 |
| 周期占比行 | 显示42周期各状态占比 | 🔲 |
| 持仓订单列表 | 按时间倒序显示持仓订单 | 🔲 |

### 1.7 命令更新 (FP-038-007)

| 检查项 | 验收标准 | 状态 |
|--------|----------|------|
| 默认策略 | 默认使用策略16 | 🔲 |
| dry-run模式 | 显示完整新格式预览 | 🔲 |
| 推送成功 | 实际推送消息成功 | 🔲 |

---

## 2. 一致性验收

| 检查项 | 验收标准 | 验证方法 | 状态 |
|--------|----------|----------|------|
| 持仓一致性 | 监控服务holdings = 策略16回测holdings | 对比dry-run输出与detail页面 | 🔲 |
| 挂单价格一致性 | 推送挂单价格 = detail页面HUD挂单价格 | 对比同一时间的数据 | 🔲 |
| 周期状态一致性 | 推送周期状态 = detail页面显示 | 对比同一时间的数据 | 🔲 |

---

## 3. 质量检查

### 3.1 代码质量

| 检查项 | 标准 | 状态 |
|--------|------|------|
| 代码格式 | 符合项目代码规范 | 🔲 |
| 类型注解 | 所有新增方法有完整类型注解 | 🔲 |
| 文档字符串 | 所有新增方法有docstring | 🔲 |
| 错误处理 | 异常正确捕获和记录 | 🔲 |

### 3.2 性能检查

| 检查项 | 标准 | 状态 |
|--------|------|------|
| 回测耗时 | 单个交易对回测 < 10秒 | 🔲 |
| 总耗时 | 完整监控流程 < 2分钟（10个交易对） | 🔲 |
| 内存占用 | 无内存泄漏 | 🔲 |

---

## 4. 测试验收

### 4.1 单元测试

```bash
# 数据模型测试
python -c "from ddps_z.models import HoldingInfo, PriceStatus; print('OK')"
```

### 4.2 集成测试

```bash
# Dry-run测试
python manage.py ddps_monitor --dry-run --market crypto_futures --interval 4h
```

### 4.3 预期输出验证

**标题格式**:
```
[crypto_futures/4h] 01-12 18:00: 买入(2) 卖出(0) 上涨预警(1) 下跌预警(0)
```

**价格状态格式**:
```
价格状态:
  ETHUSDT: 3500.50 (上涨预警)
    P5=3400.00 P95=3700.00
    惯性范围: 3450.00~3550.00
    概率: P42
    挂单价格: 3380.12
    所处周期: 上涨预警 - ADX(30) - 贝塔(0.012) - 连续48小时
    最近42周期占比: 强势上涨(30%), 震荡(50%), 强势下跌(20%)
    持仓订单 (2个):
      01-10 08:00 @ 3200.00 → 持仓56小时
      01-08 16:00 @ 3100.00 → 持仓104小时
```

---

## 5. 最终验收

| 检查项 | 状态 |
|--------|------|
| 所有功能验收通过 | 🔲 |
| 一致性验收通过 | 🔲 |
| 质量检查通过 | 🔲 |
| 测试验收通过 | 🔲 |

**验收结果**: 🔲 待验收

**验收日期**: -

**验收人**: -

---

## 状态图例

- 🔲 待验收
- ✅ 已通过
- ❌ 未通过
