# 功能点清单: 多策略组合回测系统

> **迭代编号**: 017
> **创建时间**: 2026-01-07
> **关联PRD**: [prd.md](./prd.md)

---

## 1. 功能点总览

| 优先级 | 数量 | 说明 |
|--------|------|------|
| P0 | 18 | MVP必需功能 |
| P1 | 6 | 增强功能 |
| P2 | 4 | 未来扩展 |
| **总计** | **28** | |

---

## 2. P0 功能点（MVP必需）

### 2.1 JSON配置模块

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-001 | 配置文件结构定义 | 定义JSON配置文件Schema | Schema文档完整，包含所有必填/可选字段 |
| FP-017-002 | 项目基本信息解析 | 解析project_name, description, version | 正确提取项目元数据 |
| FP-017-003 | 回测配置解析 | 解析backtest_config节点 | 正确提取symbol, interval, dates等 |
| FP-017-004 | 资金管理配置解析 | 解析capital_management节点 | 正确提取position_size, max_positions |
| FP-017-005 | 策略列表解析 | 解析strategies数组 | 正确提取每个策略的entry和exits配置 |
| FP-017-006 | 配置文件加载器 | ProjectLoader类实现 | load(path) -> ProjectConfig |

### 2.2 卖出条件模块

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-007 | 卖出条件基类 | IExitCondition接口定义 | 定义check(order, kline, indicators) -> ExitSignal |
| FP-017-008 | EMA回归卖出 | EmaReversionExit实现 | K线触及EMA时触发，支持配置EMA周期 |
| FP-017-009 | 止损卖出 | StopLossExit实现 | 亏损达到百分比时触发，支持配置止损比例 |
| FP-017-010 | 止盈卖出 | TakeProfitExit实现 | 盈利达到百分比时触发，支持配置止盈比例 |
| FP-017-011 | 卖出条件组合器 | ExitConditionCombiner类 | 组合多个条件，返回最先触发的信号 |

### 2.3 多策略适配模块

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-012 | 策略工厂 | StrategyFactory类 | 根据type创建策略实例，支持ddps-z |
| FP-017-013 | 多策略适配器 | MultiStrategyAdapter类 | 编排多个策略，统一生成信号 |
| FP-017-014 | 信号合并排序 | 合并多策略信号并按时间排序 | 所有策略信号正确合并，时间升序 |
| FP-017-015 | 订单策略标记 | Order.strategy_id字段 | 每个订单记录触发策略ID |

### 2.4 资金管理模块

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-016 | 共享资金池 | SharedCapitalManager类 | 多策略共享资金，先到先得 |
| FP-017-017 | 最大持仓限制 | max_positions配置支持 | 持仓数达上限时跳过新订单 |

### 2.5 CLI扩展

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-018 | --config参数 | 支持配置文件路径参数 | `--config path/to/project.json` |

---

## 3. P1 功能点（增强功能）

| ID | 功能点 | 描述 | 验收标准 |
|----|--------|------|----------|
| FP-017-019 | JSON Schema验证 | 使用jsonschema库验证配置 | 格式错误时给出明确提示 |
| FP-017-020 | 策略启用/禁用 | 支持enabled字段控制 | enabled=false的策略不加载 |
| FP-017-021 | 配置继承 | 支持extends字段继承基础配置 | 子配置覆盖父配置 |
| FP-017-022 | 回测报告增强 | 按策略分组统计 | 输出每个策略的独立胜率、盈亏 |
| FP-017-023 | 配置模板生成 | `--generate-config`参数 | 生成示例配置文件 |
| FP-017-024 | 数据库保存增强 | 保存策略配置到BacktestResult | strategy_config JSON字段 |

---

## 4. P2 功能点（未来扩展）

| ID | 功能点 | 描述 | 备注 |
|----|--------|------|------|
| FP-017-025 | 移动止损 | TrailingStopExit实现 | 触发后跟踪最高点止损 |
| FP-017-026 | 时间止损 | TimeBasedExit实现 | 持仓超过N根K线后强制平仓 |
| FP-017-027 | 策略配额模式 | 每个策略独立资金上限 | capital_management.mode=quota |
| FP-017-028 | Web配置编辑器 | 可视化编辑JSON配置 | 前端页面 |

---

## 5. 功能点依赖关系

```
FP-017-001 (Schema定义)
    │
    ├── FP-017-002~005 (配置解析)
    │       │
    │       └── FP-017-006 (配置加载器)
    │               │
    │               └── FP-017-018 (CLI --config)
    │
FP-017-007 (卖出条件基类)
    │
    ├── FP-017-008 (EMA回归)
    ├── FP-017-009 (止损)
    └── FP-017-010 (止盈)
            │
            └── FP-017-011 (条件组合器)
                    │
FP-017-012 (策略工厂) ──┤
                        │
                        └── FP-017-013 (多策略适配器)
                                │
                                ├── FP-017-014 (信号合并)
                                ├── FP-017-015 (订单标记)
                                │
FP-017-016 (共享资金) ──────────┤
FP-017-017 (持仓限制) ──────────┘
```

---

## 6. 与现有模块的关系

| 现有模块 | 关系 | 变更类型 |
|----------|------|----------|
| `IStrategy` | 被复用 | 无变更 |
| `DDPSZStrategy` | 被复用 | 扩展：支持自定义exits |
| `StrategyAdapter` | 被继承 | 新增MultiStrategyAdapter子类 |
| `UnifiedOrderManager` | 被扩展 | 新增strategy_id字段 |
| `Order` | 被扩展 | 新增strategy_id字段 |
| `run_strategy_backtest` | 被扩展 | 新增--config参数 |

---

## 7. 测试覆盖要求

| 测试类型 | 覆盖范围 | 目标 |
|----------|----------|------|
| 单元测试 | 配置解析、卖出条件 | 100% |
| 集成测试 | 多策略回测流程 | 关键路径 |
| 回归测试 | 单策略模式兼容性 | 确保无--config时行为不变 |

---

## 8. 实现优先级排序

### Phase 1: 基础架构（FP-017-001~006, 007~011）
- JSON配置结构和解析
- 卖出条件模块

### Phase 2: 核心功能（FP-017-012~017）
- 多策略适配器
- 共享资金管理

### Phase 3: CLI集成（FP-017-018）
- 命令行参数支持
- 端到端测试

### Phase 4: 增强功能（FP-017-019~024）
- 配置验证
- 报告增强
