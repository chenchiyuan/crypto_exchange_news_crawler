# 需求澄清记录

**迭代编号**: 005
**迭代名称**: Discovery历史扫描优化
**版本**: v1.0.0
**创建日期**: 2025-12-25

---

## 1. AI待澄清事项清单

在生成PRD的过程中，AI识别出以下模糊点，需要在P1阶段内澄清：

### 1.1 日期格式规范
**问题**: 日期参数的格式标准是什么？
- 选项A: ISO 8601 (YYYY-MM-DD)，例如 "2025-11-26"
- 选项B: YYYYMMDD，例如 "20251126"
- 选项C: 其他格式

**AI建议**: 采用ISO 8601格式，符合国际标准，易于理解和解析。

---

### 1.2 默认行为定义
**问题**: 不指定日期范围时的默认行为是什么？
- 选项A: 扫描全部历史数据 (--start all)
- 选项B: 扫描最近30天数据
- 选项C: 扫描最近7天数据
- 选项D: 报错，必须指定日期范围

**AI建议**: 扫描全部历史数据 (--start all)，提供最大灵活性。

---

### 1.3 历史扫描结果处理
**问题**: 历史扫描发现的异常事件是否需要保存到数据库？
- 选项A: 保存，创建监控记录
- 选项B: 不保存，只输出到控制台
- 选项C: 可选，通过参数控制是否保存

**AI建议**: 保存到数据库，与实时扫描保持一致。

---

### 1.4 性能限制策略
**问题**: 大数据量场景下的性能限制是什么？
- 选项A: 硬限制：最多扫描1000个交易对
- 选项B: 软限制：扫描所有数据但分批处理
- 选项C: 用户可配置：通过参数指定限制

**AI建议**: 软限制，分批处理+进度提示，用户可通过参数控制批次大小。

---

### 1.5 错误处理策略
**问题**: 无效日期或日期范围错误的处理方式？
- 选项A: 严格验证，遇到错误立即退出
- 选项B: 宽松处理，自动修正或忽略错误部分
- 选项C: 交互式提示，让用户重新输入

**AI建议**: 严格验证，提供清晰的错误信息和建议。

---

## 2. 澄清执行记录

### 2.1 澄清-001: 日期格式
**状态**: ✅ 已澄清
**决定**: 采用ISO 8601格式 (YYYY-MM-DD)
**理由**: 国际标准，易于理解和解析，与Django常用格式一致

**确认**:
```
--start 2025-11-26  # 正确
--start 2025/11/26  # 错误
--start 20251126    # 错误
```

---

### 2.2 澄清-002: 默认行为
**状态**: ✅ 已澄清
**决定**: 不指定日期范围时，扫描全部历史数据
**理由**: 提供最大灵活性，用户可以通过参数限制范围

**确认**:
```
python manage.py scan_volume_traps --interval 4h  # 扫描全部历史
python manage.py scan_volume_traps --interval 4h --start all  # 等价于上述命令
```

---

### 2.3 澄清-003: 历史扫描结果处理
**状态**: ✅ 已澄清
**决定**: 保存到数据库，创建监控记录
**理由**: 与实时扫描保持一致，便于后续查询和分析

**确认**:
```
发现的历史异常事件将：
1. 创建VolumeTrapMonitor记录
2. 状态设置为 'pending'
3. 可通过API查询
4. 可进行后续确认和验证
```

---

### 2.4 澄清-004: 性能限制策略
**状态**: ✅ 已澄清
**决定**: 软限制，分批处理+进度提示，批次大小可配置
**理由**: 平衡性能和用户体验，避免系统资源耗尽

**确认**:
```
默认批次大小: 1000条记录
可配置参数: --batch-size N
进度提示: 显示当前扫描进度和剩余时间
```

---

### 2.5 澄清-005: 错误处理策略
**状态**: ✅ 已澄清
**决定**: 严格验证，提供清晰的错误信息和建议
**理由**: 避免数据错误，确保扫描结果的可靠性

**确认**:
```
错误示例：
- 无效日期格式: "错误：日期格式应为YYYY-MM-DD"
- 日期范围错误: "错误：开始日期不能大于结束日期"
- 日期超出范围: "错误：日期超出数据范围 (2023-01-01 到 2025-12-25)"
```

---

## 3. 最终确认

### 3.1 澄清总结
- ✅ 日期格式: ISO 8601 (YYYY-MM-DD)
- ✅ 默认行为: 扫描全部历史数据
- ✅ 结果处理: 保存到数据库
- ✅ 性能策略: 软限制，分批处理
- ✅ 错误处理: 严格验证

### 3.2 文档更新
所有澄清结果已更新到PRD文档和功能点清单中，确保文档无矛盾和无模糊描述。

---

**澄清记录版本**: v1.0.0
**澄清完成时间**: 2025-12-25
**状态**: ✅ 完成
