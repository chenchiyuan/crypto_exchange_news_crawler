# 产品需求文档 (PRD)

**迭代编号**: 005
**迭代名称**: Discovery历史扫描优化
**版本**: v1.0.0
**创建日期**: 2025-12-25

---

## 1. 产品概述

### 1.1 核心价值主张
让巨量诱多/弃盘检测系统具备历史回溯能力，能够扫描全历史时期的K线数据，发现遗漏的异常事件，提升策略的覆盖率和有效性。

### 1.2 产品目标
- **Primary**: Discovery阶段支持历史数据扫描
- **Secondary**: 提供灵活的日期范围筛选功能
- **Tertiary**: 优化批量扫描性能

---

## 2. 需求详情

### 2.1 P0核心功能

#### 功能1: Discovery历史扫描
**描述**: 修改Discovery阶段的检测逻辑，支持扫描全历史时期的K线数据

**业务规则**:
- 默认行为：扫描全部历史数据（参数: `--start all` 或不指定）
- 支持指定开始日期（参数: `--start YYYY-MM-DD`）
- 支持指定结束日期（参数: `--end YYYY-MM-DD`）
- 同时指定start和end：扫描指定范围
- 只指定start：扫描从start到最新
- 只指定end：扫描从最早到end

**验收标准**:
- [ ] 能够扫描全部历史K线数据
- [ ] 发现历史异常事件并创建监控记录
- [ ] 与实时扫描结果一致
- [ ] 不破坏现有功能

#### 功能2: scan_volume_traps命令增强
**描述**: 为scan_volume_traps命令添加日期范围筛选参数

**业务规则**:
- 新增参数：`--start` (可选，日期字符串)
- 新增参数：`--end` (可选，日期字符串)
- 默认值：`--start all` (全部历史)
- 日期格式：ISO 8601 (YYYY-MM-DD)
- 支持的组合：
  - `--start all --end all`: 全部历史（默认）
  - `--start 2025-11-01 --end 2025-11-30`: 指定范围
  - `--start 2025-11-01`: 从指定日期到最新
  - `--end 2025-11-30`: 从最早到指定日期

**验收标准**:
- [ ] 命令行参数正确解析
- [ ] 日期范围筛选正确执行
- [ ] 帮助信息完整显示
- [ ] 错误处理完善（无效日期、日期范围错误等）

#### 功能3: 性能优化
**描述**: 优化历史扫描的性能，避免数据库查询过慢

**业务规则**:
- 批量查询：每次查询N条记录（建议1000条）
- 分页处理：大数据量时分批处理
- 索引优化：利用KLine表的现有索引
- 进度提示：显示扫描进度

**验收标准**:
- [ ] 扫描1000个交易对的历史数据用时 < 5分钟
- [ ] 内存使用 < 500MB
- [ ] 数据库查询次数优化
- [ ] 进度信息实时显示

---

## 3. 技术约束

### 3.1 架构约束
- 基于现有VolumeTrapStateMachine架构
- 复用8个检测器的现有逻辑
- 保持与market_type参数的兼容性
- 不修改现有模型结构

### 3.2 性能约束
- 单次扫描操作时间 < 5分钟
- 内存使用 < 500MB
- 数据库查询次数最小化
- 支持大并发场景

### 3.3 兼容性约束
- 向后兼容：现有命令行为不变
- 数据兼容：现有数据保持完整
- API兼容：不修改现有API接口

---

## 4. 用户场景

### 4.1 场景1: 历史回溯扫描
**用户**: 量化研究员
**目标**: 扫描ALLO/USDT在2025年11月的异常事件
**操作**: `python manage.py scan_volume_traps --interval 4h --market-type spot --start 2025-11-01 --end 2025-11-30`
**期望**: 发现ALLO/USDT的弃盘事件并创建监控记录

### 4.2 场景2: 全量历史扫描
**用户**: 策略分析师
**目标**: 扫描所有现货交易对的历史异常事件
**操作**: `python manage.py scan_volume_traps --interval 4h --market-type spot`
**期望**: 发现所有历史异常事件，生成监控记录列表

### 4.3 场景3: 实时扫描
**用户**: 交易员
**目标**: 扫描最新的异常事件
**操作**: `python manage.py scan_volume_traps --interval 4h --market-type spot`
**期望**: 发现当前正在发生的异常事件

---

## 5. 验收标准

### 5.1 功能验收
- [ ] Discovery阶段能够扫描历史数据
- [ ] scan_volume_traps命令支持start/end参数
- [ ] 日期范围筛选正确执行
- [ ] 性能满足要求

### 5.2 非功能验收
- [ ] 向后兼容性100%
- [ ] 性能指标达标
- [ ] 错误处理完善
- [ ] 文档完整

---

## 6. 依赖关系

### 6.1 外部依赖
- Django ORM
- 现有KLine数据
- 现有检测器逻辑

### 6.2 内部依赖
- VolumeTrapStateMachine
- 8个检测器
- KLine模型

---

## 7. 风险评估

### 7.1 技术风险
- **风险**: 大数据量扫描导致性能问题
- **缓解**: 分批查询、索引优化、进度提示

### 7.2 业务风险
- **风险**: 历史扫描结果过多影响决策
- **缓解**: 提供筛选功能、结果分页

---

## 8. 成功指标

### 8.1 技术指标
- 扫描性能: < 5分钟/1000个交易对
- 内存使用: < 500MB
- 代码覆盖率: > 80%

### 8.2 业务指标
- 历史事件发现率: 100%
- 误报率: < 5%
- 用户满意度: > 90%

---

**PRD版本**: v1.0.0
**创建人**: Claude Code
**审核状态**: 待审核
