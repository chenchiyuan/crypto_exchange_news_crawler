# 做空网格挂单位置优化方案 v2.0

## 1. 问题重新定义

### 1.1 核心目标

**输入**：已筛选出的做空标的（VDR/KER/EMA等指标已合格）

**输出**：
1. **推荐挂单价格**（Entry Price）
2. **触发概率**（在未来24小时/72小时内触及该价格的概率）
3. **盈利空间评分**（从该价入场到止盈的空间）

**用户决策**：
- 如果触发概率高（>80%），可以挂更高的单（等待反弹）
- 如果触发概率低（<50%），可能需要降低挂单价或立即入场

---

## 2. 核心指标：RSI + ATR + 历史回测

### 2.1 为什么选择RSI？

**RSI（相对强弱指数）** 是最适合判断"反弹空间"的指标：

| RSI区间 | 市场状态 | 反弹空间预期 | 做空策略 |
|---------|---------|-------------|---------|
| **70-100** | 极度超买 | 0-2% | ✅ **立即挂单**（已在高位） |
| **50-70** | 偏强 | 2-5% | ⚠️ **等待反弹**（还有上涨空间） |
| **30-50** | 中性偏弱 | 5-10% | ⚠️ **谨慎等待**（可能继续下跌再反弹） |
| **0-30** | 超卖 | 10%+ | ❌ **不适合做空**（反弹动能强） |

**核心逻辑**：
- RSI越高 → 反弹空间越小 → 应该立即挂单
- RSI越低 → 反弹空间越大 → 可以挂更高的单等反弹

---

## 3. 挂单价格计算模型

### 3.1 基于RSI的动态挂单策略

```python
def calculate_recommended_entry(current_price, rsi_15m, ema99_slope, natr):
    """
    基于RSI和趋势计算推荐挂单价格

    核心思路：
    1. RSI越低，反弹空间越大，挂单价可以设得更高
    2. 趋势越弱（EMA99<0），反弹幅度受限，挂单价应保守
    3. 波动率（NATR）越大，反弹幅度越大
    """

    # Step 1: 基于RSI计算理论反弹空间
    if rsi_15m >= 70:
        # 已超买，反弹空间极小
        rebound_potential = 0.005  # 0.5%
    elif rsi_15m >= 60:
        rebound_potential = 0.01   # 1%
    elif rsi_15m >= 50:
        rebound_potential = 0.02   # 2%
    elif rsi_15m >= 40:
        rebound_potential = 0.03   # 3%
    else:
        # RSI<40，反弹空间较大但风险高
        rebound_potential = 0.05   # 5%

    # Step 2: 趋势修正系数
    if ema99_slope < -50:
        # 强下跌趋势，反弹受限
        trend_factor = 0.7
    elif ema99_slope < 0:
        # 弱下跌趋势
        trend_factor = 1.0
    elif ema99_slope < 30:
        # 弱上涨趋势
        trend_factor = 1.2
    else:
        # 强上涨趋势，反弹空间大但不建议做空
        trend_factor = 1.5

    # Step 3: 波动率修正系数
    if natr < 3:
        # 低波动，反弹幅度小
        volatility_factor = 0.8
    elif natr < 6:
        # 中等波动
        volatility_factor = 1.0
    else:
        # 高波动，反弹幅度大
        volatility_factor = 1.3

    # Step 4: 综合计算推荐挂单价
    adjusted_rebound = rebound_potential * trend_factor * volatility_factor
    recommended_entry = current_price * (1 + adjusted_rebound)

    return recommended_entry, adjusted_rebound
```

**示例1：BATUSDT**
```
当前价格: $0.2693
RSI(15m): 65（偏强，还有小幅上涨空间）
EMA99斜率: +18.61（弱上涨趋势）
NATR: 5.5（中等波动）

计算过程：
1. RSI=65 → 理论反弹空间 = 1%
2. EMA99=+18.61 → 趋势系数 = 1.2
3. NATR=5.5 → 波动系数 = 1.0
4. 调整后反弹 = 1% × 1.2 × 1.0 = 1.2%

→ 推荐挂单价: $0.2725 (当前价 × 1.012)
```

**示例2：极端情况对比**

| 场景 | 当前价 | RSI | EMA99 | NATR | 理论反弹 | 调整系数 | 推荐挂单价 | 反弹幅度 |
|------|-------|-----|-------|------|---------|---------|-----------|---------|
| **超买+下跌** | $1.00 | 72 | -60 | 4.0 | 0.5% | 0.7×0.8 | **$1.0028** | 0.28% |
| **中性+震荡** | $1.00 | 55 | -10 | 5.5 | 2% | 1.0×1.0 | **$1.0200** | 2.00% |
| **偏弱+上涨** | $1.00 | 45 | +25 | 7.0 | 3% | 1.2×1.3 | **$1.0468** | 4.68% |

---

## 4. 触发概率计算模型

### 4.1 方法一：基于历史K线统计（推荐）

```python
def calculate_trigger_probability(
    current_price,
    entry_price,
    klines_15m_history,  # 最近7天的15分钟K线（672根）
    time_window_hours=24
):
    """
    基于历史数据统计触发概率

    核心思路：
    统计过去7天内，价格从当前位置反弹到entry_price的频率
    """
    required_gain = (entry_price - current_price) / current_price

    # 统计过去每个时间点后24小时内的最高涨幅
    trigger_count = 0
    total_windows = 0

    # 24小时 = 96根15分钟K线
    bars_per_window = int(time_window_hours * 4)

    for i in range(len(klines_15m_history) - bars_per_window):
        base_close = klines_15m_history[i]['close']

        # 计算未来24小时内的最高涨幅
        future_highs = [k['high'] for k in klines_15m_history[i+1:i+1+bars_per_window]]
        max_gain = (max(future_highs) - base_close) / base_close

        if max_gain >= required_gain:
            trigger_count += 1
        total_windows += 1

    trigger_probability = trigger_count / total_windows if total_windows > 0 else 0

    return trigger_probability
```

**优点**：
- ✅ 基于真实历史数据，准确性高
- ✅ 考虑了币种自身的波动特性
- ✅ 可以区分24h/48h/72h不同时间窗口

**示例计算**：

假设BATUSDT过去7天（672根15分钟K线）：
- 推荐挂单价: $0.2725（+1.2%）
- 统计结果：672个时间窗口中，有540次在未来24h内涨幅≥1.2%
- **触发概率 = 540 / 672 = 80.4%**

---

### 4.2 方法二：基于正态分布估算（快速估算）

```python
def calculate_trigger_probability_gaussian(
    current_price,
    entry_price,
    natr,
    time_window_hours=24
):
    """
    假设价格波动符合正态分布（快速估算）

    核心思路：
    P(触发) = 1 - CDF(z)
    其中 z = required_gain / adjusted_volatility
    """
    from scipy.stats import norm

    required_gain = (entry_price - current_price) / current_price

    # 15分钟波动率 = 日波动率 / sqrt(96)
    # 24小时波动率 = 日波动率
    daily_vol = natr / 100
    hourly_vol = daily_vol / np.sqrt(6)
    window_vol = hourly_vol * np.sqrt(time_window_hours)

    # 标准化得分
    z_score = required_gain / window_vol

    # 触发概率（右尾）
    trigger_prob = 1 - norm.cdf(z_score)

    return trigger_prob
```

**对比**：

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **历史统计** | 准确，考虑币种特性 | 需要大量历史数据 | ✅ 主流币种，数据充足 |
| **正态分布** | 快速，无需历史数据 | 假设过强，可能不准 | ⚠️ 新上市币种，数据不足 |

**建议**：优先使用历史统计，数据不足时降级到正态分布。

---

## 5. 完整输出示例

### 5.1 输出格式

```json
{
  "symbol": "BATUSDT",
  "current_price": 0.2693,
  "market_state": {
    "rsi_15m": 65,
    "ema99_slope": 18.61,
    "ema20_slope": -27.75,
    "natr": 5.5,
    "interpretation": "偏强震荡，短期有小幅反弹空间"
  },
  "entry_recommendations": [
    {
      "level": "立即入场",
      "entry_price": 0.2693,
      "trigger_probability_24h": 1.0,
      "trigger_probability_72h": 1.0,
      "profit_potential": "25%",
      "expected_value": 0.25,
      "strategy": "不等反弹，立即挂单开仓"
    },
    {
      "level": "等待小幅反弹",
      "entry_price": 0.2725,
      "trigger_probability_24h": 0.804,
      "trigger_probability_72h": 0.92,
      "profit_potential": "27%",
      "expected_value": 0.217,
      "strategy": "等待1.2%反弹，24h触发概率80%"
    },
    {
      "level": "等待明显反弹",
      "entry_price": 0.2760,
      "trigger_probability_24h": 0.55,
      "trigger_probability_72h": 0.78,
      "expected_value": 0.148,
      "profit_potential": "29%",
      "strategy": "等待2.5%反弹，24h触发概率55%"
    }
  ],
  "recommended_choice": {
    "entry_price": 0.2725,
    "level": "等待小幅反弹",
    "reason": "期望收益最高（盈利空间×触发概率），平衡风险与收益"
  }
}
```

### 5.2 决策逻辑

**期望收益 = 盈利空间 × 触发概率**

| 方案 | 入场价 | 盈利空间 | 触发概率(24h) | 期望收益 | 排序 |
|------|-------|---------|-------------|---------|------|
| 立即入场 | $0.2693 | 25% | 100% | **0.250** | 🥈 第2 |
| 小幅反弹 | $0.2725 | 27% | 80.4% | **0.217** | 🥇 **推荐** |
| 明显反弹 | $0.2760 | 29% | 55% | **0.160** | 🥉 第3 |

**推荐逻辑**：
- 虽然"立即入场"期望最高（0.250），但优势不大
- "小幅反弹"方案在触发概率仍较高（80%）的情况下，获得了更好的入场位置
- 考虑到做空网格可以容忍小幅等待，**推荐"小幅反弹"方案**

---

## 6. 关键参数与调优

### 6.1 可调参数

| 参数 | 默认值 | 说明 | 建议范围 |
|------|-------|------|---------|
| **触发概率阈值** | 70% | 低于此值不推荐等待 | 60-80% |
| **时间窗口** | 24小时 | 计算触发概率的时间范围 | 24-72小时 |
| **历史回溯期** | 7天 | 统计历史数据的天数 | 5-14天 |
| **RSI周期** | 14 | RSI计算周期 | 14-21 |
| **期望收益权重** | α=0.5, β=0.5 | 盈利空间vs触发概率权重 | 自定义 |

### 6.2 不同风格的配置

| 风格 | 触发概率阈值 | 时间窗口 | 期望收益计算 | 特点 |
|------|------------|---------|-------------|------|
| **保守型** | 80% | 24小时 | α=0.3, β=0.7 | 优先确保触发，降低空仓风险 |
| **平衡型** | 70% | 48小时 | α=0.5, β=0.5 | 平衡收益与触发率 |
| **激进型** | 60% | 72小时 | α=0.7, β=0.3 | 追求更优入场位置，容忍更长等待 |

---

## 7. 边界情况处理

### 7.1 特殊场景

| 场景 | RSI | EMA99 | 处理策略 |
|------|-----|-------|---------|
| **极度超买** | >80 | 任意 | 立即入场（可能即将回调） |
| **极度超卖** | <20 | <0 | 等待反弹至RSI>40再考虑 |
| **强上涨趋势** | 任意 | >50 | ⚠️ 警告用户不建议做空 |
| **低波动** | 任意 | 任意且NATR<3 | 降低反弹预期，建议立即入场 |

### 7.2 数据不足时的降级策略

```
IF 历史K线数据 < 7天:
    使用正态分布估算触发概率
ELSE IF 历史K线数据 < 3天:
    仅推荐"立即入场"，不计算反弹方案
ELSE:
    使用完整的历史统计模型
```

---

## 8. 讨论要点

### 8.1 关键决策问题

**问题1：您更倾向于哪种风格？**
- A. 保守型（触发概率>80%，少等待）
- B. 平衡型（触发概率>70%，适度等待）← 推荐
- C. 激进型（触发概率>60%，更长等待）

**问题2：触发概率的时间窗口？**
- A. 24小时（短期，适合日内波动大的币种）
- B. 48小时（中期）← 推荐
- C. 72小时（长期，容忍更久等待）

**问题3：如何处理"未触发"的订单？**
- A. 保持挂单，直到触发
- B. 24小时后自动调整到当前价（动态降价）
- C. 48小时后取消，不再入场

**问题4：是否考虑分批挂单？**
- A. 单一最优价挂单（100%仓位）
- B. 分批挂单（例如：50%立即 + 50%等待反弹）← 可降低风险
- C. 三档挂单（30%立即 + 40%小反弹 + 30%大反弹）

### 8.2 技术实施相关

**问题5：RSI和触发概率哪个权重更高？**
- 当前方案是综合考虑RSI（判断反弹空间）+ 历史统计（计算触发概率）
- 您是否希望某个因素有更大影响力？

**问题6：是否需要实时更新挂单价？**
- 市场变化后（例如RSI从60变到70），是否需要重新计算推荐价格？
- 这涉及到是否需要后台定时任务监控

---

## 9. 预期交互流程

### 用户视角的完整流程

```
1. 用户访问筛选页面 → 看到排名靠前的做空标的

2. 点击某个标的（如BATUSDT） → 展开"挂单建议"面板

3. 系统显示：
   ┌─────────────────────────────────────────┐
   │ BATUSDT 挂单建议                         │
   ├─────────────────────────────────────────┤
   │ 当前价格: $0.2693                        │
   │ 市场状态: RSI(65) 偏强震荡               │
   │                                         │
   │ 推荐方案：                              │
   │ ✅ 小幅反弹 $0.2725 (+1.2%)            │
   │    24h触发概率: 80% ████████░░         │
   │    盈利空间: 27% 止盈@$0.1868           │
   │    期望收益: 21.7%                      │
   │                                         │
   │ 其他方案：                              │
   │ • 立即入场 $0.2693 (触发100%, 盈利25%) │
   │ • 明显反弹 $0.2760 (触发55%, 盈利29%)  │
   └─────────────────────────────────────────┘

4. 用户根据触发概率和盈利空间做决策：
   - 如果觉得80%触发概率可接受 → 挂单$0.2725
   - 如果希望100%触发 → 挂单$0.2693（立即入场）
```

---

## 10. 方案总结

### 核心改进点

✅ **明确输出触发概率**：用户清楚知道挂单被触发的可能性
✅ **基于真实历史数据**：不是拍脑袋，而是统计过去7天的实际波动
✅ **多方案对比**：给出2-3个候选价，让用户根据风险偏好选择
✅ **期望收益量化**：通过"盈利空间×触发概率"给出最优建议
✅ **可调参数**：支持保守/平衡/激进不同风格

### 与v1.0的区别

| 维度 | v1.0（旧方案） | v2.0（新方案） |
|------|--------------|--------------|
| **目标** | 寻找最优入场价 | 给出挂单价+触发概率 |
| **复杂度** | 较高（布林带、综合评分） | 中等（RSI+历史统计） |
| **输出** | 单一最优价 | 多方案对比 |
| **触发概率** | 理论估算 | **真实历史统计** ✅ |
| **用户决策** | 较少参与 | **充分参与** ✅ |

---

**方案状态**：v2.0（待讨论）
**创建时间**：2025-12-04
**下一步**：等待您的反馈和决策
