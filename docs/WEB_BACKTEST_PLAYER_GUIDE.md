# Grid Strategy V2 回测播放器使用指南

## 📋 功能概述

回测播放器是一个交互式Web可视化工具，允许您逐K线查看Grid Strategy V2的完整执行过程。

### ✨ 核心功能

1. **K线图展示** - ECharts双轴图表展示价格走势和账户价值变化
2. **事件标记** - 在图表上标记所有买入/卖出/止损事件
3. **快照查看** - 点击任意K线查看当时的完整状态
4. **网格层级** - 显示动态计算的S2/S1/R1/R2支撑压力位
5. **持仓详情** - 查看每个仓位的买入价、止损价、止盈目标
6. **时间轴导航** - 通过时间轴快速跳转到任意K线

## 🚀 快速开始

### 1. 启动服务器

```bash
cd /Users/chenchiyuan/projects/crypto_exchange_news_crawler
python manage.py runserver 0.0.0.0:8001
```

### 2. 访问播放器

打开浏览器访问：
```
http://127.0.0.1:8001/backtest/player/
```

### 3. 选择回测

- 页面会自动加载最新的回测记录
- 可通过下拉菜单切换不同的回测

## 📊 界面说明

### 主图表区域

**价格走势图**（左Y轴）：
- 蓝色区域曲线：价格走势
- 绿色向上箭头 ↑：买入事件
- 橙色向下箭头 ↓：卖出事件
- 红色叉号 ×：止损事件

**账户价值曲线**（右Y轴）：
- 绿色线条：账户总价值随时间变化

### 右侧详情面板

点击任意K线后显示：

1. **K线快照信息**
   - 时间戳
   - 当前价格
   - 现金余额
   - 账户总价值

2. **网格层级**
   - R2 压力位2（红色）
   - R1 压力位1（红色）
   - S1 支撑位1（绿色）
   - S2 支撑位2（绿色）
   - 每个层级显示中心价格和区间范围

3. **持仓列表**
   - 仓位ID和状态
   - 买入价格和买入层级
   - 止损价格
   - R1目标价格和已卖出比例
   - R2目标价格和已卖出比例
   - 当前盈亏（PnL）

4. **当前事件**
   - 如果该K线有交易事件，会显示详细信息
   - 买入：显示仓位ID、层级、价格、成本
   - 卖出：显示仓位ID、目标区间、价格、收入
   - 止损：显示平仓仓位数量、价格、总收入

### 时间轴控制

- 底部时间轴显示当前进度
- 点击时间轴可快速跳转到指定K线
- 显示"当前K线 / 总K线数"

## 🔍 典型使用场景

### 场景1: 验证策略执行

**目标**: 检查策略是否按照设计逻辑执行

**步骤**:
1. 访问播放器页面
2. 查看事件标记位置
3. 点击买入事件对应的K线
4. 验证：
   - 买入价格是否在S1或S2支撑位区间内
   - 网格层级计算是否正确
   - 仓位的止损价和止盈价是否合理

**示例**:
```
K线 #104: 2025-11-18 12:00
- 价格: $3106.87
- 网格S1区间: [$3236.50 ~ $3243.62]
- 买入事件: 仓位#18, support_1, 成本$210.80
✅ 验证通过：价格在S1区间内，触发买入
```

### 场景2: 分析止损触发

**目标**: 了解止损何时触发，原因是什么

**步骤**:
1. 在图表上找到红色×标记（止损事件）
2. 点击该K线查看详情
3. 检查：
   - 当前价格 vs 止损价格
   - 止损涉及的仓位数量
   - 止损收入金额

**示例**:
```
K线 #109: 2025-11-21 20:00
- 当前价格: $2765.85
- 止损事件: 1个仓位（仓位#18）
- 仓位#18止损价: $3008.18
- 收入: $187.29
✅ 分析：价格跌破止损线，触发多头止损保护
```

### 场景3: 追踪仓位盈亏

**目标**: 跟踪某个仓位从开仓到平仓的完整过程

**步骤**:
1. 找到买入事件（绿色↑），记下仓位ID
2. 依次点击后续K线
3. 观察该仓位的：
   - PnL变化
   - R1/R2卖出进度
   - 最终是止盈还是止损平仓

**示例**:
```
仓位#18的生命周期:
- K线#104: 买入@$3106.87, PnL=$0
- K线#105: 价格下跌, PnL=-$5.12
- K线#106: 价格下跌, PnL=-$12.35
- ...
- K线#109: 触发止损@$2765.85, 最终PnL=-$23.51
```

### 场景4: 理解网格动态调整

**目标**: 观察网格层级如何随市场变化而调整

**步骤**:
1. 连续点击多个K线
2. 对比不同时刻的网格层级
3. 理解：
   - S2/S1/R1/R2如何根据成交量分布重新计算
   - 区间宽度如何变化
   - 支撑压力位如何跟随市场移动

**示例**:
```
市场上涨阶段:
- K线#0: R1=$4241, S1=$3635
- K线#20: R1=$4310, S1=$3702 (整体抬升)
- K线#40: R1=$4089, S1=$3244 (市场回调，网格下移)
```

## 📈 数据解读

### 账户价值曲线

**上升趋势**:
- 策略盈利，卖出价格高于买入价格
- 或虽有浮亏但持仓价值增加

**下降趋势**:
- 持仓出现浮亏
- 止损平仓导致亏损

**平稳波动**:
- 现金为主，未持仓或持仓较轻
- 市场震荡但策略未触发交易

### 事件密度

**事件密集区域**:
- 市场波动剧烈
- 价格频繁触及支撑压力位
- 可能是最佳交易时机或风险区域

**事件稀疏区域**:
- 市场单边趋势
- 价格远离网格层级
- 策略处于观望状态

## 🛠️ API接口

播放器使用以下API接口（可用于自定义开发）：

### 1. 获取回测列表
```http
GET /backtest/api/backtests/

Response:
{
  "success": true,
  "backtests": [
    {
      "id": 83,
      "name": "Grid V2 - ETHUSDT 4h",
      "symbol": "ETHUSDT",
      "interval": "4h",
      "total_return": 0.002,
      "total_trades": 2,
      "win_rate": 0.0,
      "created_at": "2025-12-01T02:08:14.654484+00:00"
    }
  ],
  "total": 1
}
```

### 2. 获取回测详情
```http
GET /backtest/api/backtests/{id}/

Response: 包含完整回测统计信息
```

### 3. 获取所有快照
```http
GET /backtest/api/backtests/{id}/snapshots/

Response:
{
  "success": true,
  "backtest_id": 83,
  "klines": [
    {"time": "...", "price": 3860.84, "cash": 10000.0, "value": 10000.0, "index": 0},
    ...
  ],
  "events": [
    {"time": "...", "index": 104, "type": "buy", "position_id": 18, ...},
    ...
  ],
  "total_snapshots": 115
}
```

### 4. 获取特定K线详情
```http
GET /backtest/api/backtests/{id}/snapshots/{kline_index}/

Response: 包含网格层级、持仓列表、事件详情
```

## 💡 最佳实践

### 1. 策略验证流程

```
① 先看整体 → 查看价格曲线和账户价值曲线
② 找关键点 → 定位买入/卖出/止损事件
③ 逐点分析 → 点击每个事件查看详细状态
④ 验证逻辑 → 确认是否符合策略设计
```

### 2. 问题排查

**问题**: 为什么没有在支撑位买入？
- 检查当时的现金余额是否充足
- 检查是否已有该层级的持仓（避免重复建仓）

**问题**: 为什么在压力位没有卖出？
- 检查是否有持仓
- 检查价格是否真的在R1/R2区间内

**问题**: 止损为何触发？
- 对比当前价格和止损价格
- 回溯之前的K线，观察价格下跌过程

### 3. 性能优化建议

**快照数量较大时**（>500个）：
- 使用时间轴跳转而非逐K线点击
- 关注关键事件发生的时间点
- 可以只分析局部时间段

## 🎯 高级功能（未来扩展）

- [ ] 播放/暂停自动播放功能
- [ ] 可调速度的时间轴自动前进
- [ ] 导出特定时间段的交易记录
- [ ] 多策略对比模式
- [ ] 自定义网格参数实时回测

## ❓ 常见问题

**Q: 为什么有些K线没有事件？**
A: 大部分K线只是记录状态，不一定有交易发生。只有价格触及网格层级时才会触发买入/卖出。

**Q: 如何找到最大回撤发生的位置？**
A: 观察账户价值曲线（绿线），找到最高点后的最低点，点击查看详情。

**Q: 网格层级为什么会跳变？**
A: Grid V2使用动态计算，每根K线都基于最新的成交量分布重新计算网格，因此会随市场变化调整。

**Q: 如何重新运行回测生成新快照？**
A: 使用命令行工具：
```bash
python manage.py run_backtest --symbol ETHUSDT --interval 4h --strategy grid_v2 --days 30
```

## 📞 技术支持

遇到问题请检查：
1. Django服务器是否正常运行
2. 数据库中是否有回测记录和快照数据
3. 浏览器控制台是否有错误信息

---

**版本**: v1.0
**最后更新**: 2025-12-01
**作者**: Grid Strategy V2 Team
