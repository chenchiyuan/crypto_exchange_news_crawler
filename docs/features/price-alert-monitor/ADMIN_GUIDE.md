# Django Admin 使用指南

## 🎯 监控合约管理

### 访问路径

```
http://localhost:8000/admin/grid_trading/monitoredcontract/
```

### 功能概览

Django Admin 提供了完整的监控合约管理功能：

1. ✅ **单个添加合约** - 点击"新增监控合约"按钮
2. ✅ **批量添加合约** - 点击"批量添加合约"按钮
3. ✅ **查看合约列表** - 支持筛选、搜索
4. ✅ **修改合约状态** - 启用/暂停/移除
5. ✅ **批量操作** - 批量启用/暂停/移除

## 📝 添加监控合约

### 方式1: 单个添加

1. 访问监控合约列表页
2. 点击右上角 **"新增监控合约"** 按钮
3. 填写表单：
   - **合约代码 (symbol)**: 输入合约代码，如 `BTCUSDT`
   - **来源 (source)**: 选择 `manual - 手动添加`
   - **监控状态 (status)**: 选择 `enabled - 启用`
4. 点击 **"保存"** 按钮

**表单验证**:
- 合约代码会自动转换为大写
- 必须以 `USDT` 结尾
- 长度至少5个字符
- 不能添加重复的合约

**提示信息**:
- ✓ 成功添加合约 BTCUSDT 到监控列表
- ✗ 合约代码 BTC 必须以USDT结尾

### 方式2: 批量添加

1. 访问监控合约列表页
2. 点击右上角 **"批量添加合约"** 按钮
3. 在文本框中输入合约代码，支持以下格式：

**格式1 - 每行一个:**
```
BTCUSDT
ETHUSDT
BNBUSDT
ADAUSDT
```

**格式2 - 逗号分隔:**
```
BTCUSDT, ETHUSDT, BNBUSDT, ADAUSDT
```

**格式3 - 空格分隔:**
```
BTCUSDT ETHUSDT BNBUSDT ADAUSDT
```

**格式4 - 混合:**
```
BTCUSDT ETHUSDT
BNBUSDT, ADAUSDT
SOLUSDT
```

4. 点击 **"批量添加"** 按钮

**批量添加结果**:
```
✓ 成功添加 3 个合约: BTCUSDT, ETHUSDT, BNBUSDT
⚠ 跳过 1 个已存在的合约: ADAUSDT
✗ 1 个合约添加失败:
  BTC: 必须以USDT结尾
```

## 🔍 查询与筛选

### 搜索合约

在列表页右上角的搜索框中输入合约代码（支持模糊匹配）：

```
搜索: BTC
```

会匹配: `BTCUSDT`, `1000BTCUSDT` 等

### 筛选器

右侧筛选栏支持以下筛选条件：

1. **按来源筛选**:
   - 全部
   - manual (手动添加)
   - auto (自动筛选)

2. **按状态筛选**:
   - 全部
   - enabled (启用)
   - disabled (禁用)
   - expired (已过期)

3. **按添加时间筛选**:
   - 今天
   - 过去7天
   - 本月
   - 本年

### 列表显示

| 字段 | 说明 | 示例 |
|------|------|------|
| 合约代码 | 交易对符号 | BTCUSDT |
| 来源 | 添加方式 | 🔵 手动添加 / 🟢 自动筛选 |
| 监控状态 | 当前状态 | ● 启用 / ● 暂停 / ● 已过期 |
| 最后筛选出现日期 | 仅自动合约 | 2025-12-08 |
| 最后数据更新时间 | K线数据更新时间 | 2025-12-08 10:30:00 |
| 添加时间 | 创建时间 | 2025-12-08 09:00:00 |

## ✏️ 修改合约

### 编辑单个合约

1. 点击合约代码进入详情页
2. 修改字段（通常只修改 `status` 字段）
3. 点击 **"保存"** 按钮

**可修改字段**:
- `source`: 来源（不建议修改自动合约）
- `status`: 监控状态（可随时修改）

**只读字段**:
- `symbol`: 合约代码（主键，不可修改）
- `created_at`: 添加时间
- `last_screening_date`: 最后筛选日期
- `last_data_update_at`: 最后数据更新时间

### 批量修改状态

1. 在列表页勾选要修改的合约
2. 从"操作"下拉菜单选择操作：
   - **启用监控** - 将状态改为 `enabled`
   - **暂停监控** - 将状态改为 `disabled`
   - **移除监控** - 将状态改为 `expired`
3. 点击 **"执行"** 按钮
4. 确认操作

**批量操作结果**:
```
成功启用 5 个合约的监控
```

## 🗑️ 删除合约

### 软删除（推荐）

使用 **"移除监控"** 操作，将合约状态改为 `expired`，合约记录保留但不再监控。

### 硬删除（不推荐）

1. 进入合约详情页
2. 点击左下角 **"删除"** 按钮
3. 确认删除

**注意**: 硬删除会永久删除合约记录，包括历史触发日志（如果有外键关联）。

## 📊 其他管理功能

### 价格触发规则管理

访问: `http://localhost:8000/admin/grid_trading/pricealertrule/`

功能:
- ✅ 查看5种预设规则
- ✅ 启用/禁用规则
- ✅ 修改规则参数

**示例: 修改MA20触发阈值**

1. 点击"规则3: 价格触及MA20"
2. 修改"规则参数" JSON:
   ```json
   {"ma_threshold": 1.0}
   ```
3. 保存

### 触发日志查询

访问: `http://localhost:8000/admin/grid_trading/alerttriggerlog/`

功能:
- ✅ 查看所有触发日志
- ✅ 按合约/规则/时间筛选
- ✅ 查看推送状态和详细信息

### 数据更新日志

访问: `http://localhost:8000/admin/grid_trading/dataupdatelog/`

功能:
- ✅ 查看数据更新执行历史
- ✅ 查看执行耗时和统计
- ✅ 查看失败原因

### 系统配置管理

访问: `http://localhost:8000/admin/grid_trading/systemconfig/`

功能:
- ✅ 查看所有系统配置
- ✅ 修改配置值（如防重复间隔）

**常用配置修改**:

1. **防重复推送间隔** (`duplicate_suppress_minutes`)
   - 默认: 60分钟
   - 修改为120分钟: 将 `value` 改为 `120`

2. **最大监控合约数** (`max_monitored_contracts`)
   - 默认: 500
   - 修改为1000: 将 `value` 改为 `1000`

## 💡 使用技巧

### 1. 快速添加热门合约

使用批量添加功能，一次性添加所有主流币种:

```
BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, ADAUSDT,
XRPUSDT, DOGEUSDT, DOTUSDT, MATICUSDT, AVAXUSDT
```

### 2. 定期清理过期合约

1. 筛选 `status = expired` 的合约
2. 批量选择
3. 使用"删除"操作永久删除

### 3. 监控自动同步效果

1. 筛选 `source = auto` 的合约
2. 查看 `last_screening_date` 字段
3. 确认每天10:30自动同步是否正常

### 4. 暂停监控而不删除

如果临时不想监控某个合约:
1. 将状态改为 `disabled`
2. 需要时再改回 `enabled`

### 5. 查看监控统计

在Django Admin首页可以看到:
- 监控合约总数
- 今日新增数量
- 最近修改记录

## ⚠️ 注意事项

### 1. 不要修改自动合约的来源

自动同步的合约（`source = auto`）不要手动改为 `manual`，否则会影响自动同步逻辑。

### 2. 合约代码格式

- 必须以 `USDT` 结尾
- 会自动转换为大写
- 不支持其他币种（如BTC/ETH）

### 3. 状态说明

| 状态 | 说明 | 数据更新 | 价格检测 |
|------|------|----------|----------|
| enabled | 启用 | ✓ | ✓ |
| disabled | 暂停 | ✓ | ✗ |
| expired | 已过期 | ✗ | ✗ |

### 4. 批量操作限制

- 单次批量添加建议不超过100个合约
- 批量操作不会触发实时数据更新，需等待定时任务

## 🔗 相关链接

- [完整运行指南](RUN_GUIDE.md)
- [API接口文档](contracts/api.yaml)
- [系统架构文档](plan.md)

## 🆘 常见问题

### Q1: 添加合约后多久开始监控？

A: 立即生效。下次数据更新任务（每5分钟）会自动获取该合约的K线数据，下次价格检测任务会开始检测规则。

### Q2: 批量添加失败怎么办？

A: 查看错误信息，常见原因:
- 合约代码格式不正确
- 合约代码长度不足
- 合约已存在（会自动跳过）

### Q3: 如何确认合约已被监控？

A: 查看合约详情页的 `last_data_update_at` 字段，如果有时间戳说明已开始更新数据。

### Q4: 可以添加非USDT交易对吗？

A: 目前只支持USDT交易对（如BTCUSDT）。

### Q5: 手动添加的合约会被自动同步覆盖吗？

A: 不会。自动同步只操作 `source = auto` 的合约，不会影响 `source = manual` 的合约。
