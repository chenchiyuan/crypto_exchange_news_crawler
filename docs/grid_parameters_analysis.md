# 做空网格参数计算方法详解

## 1. 核心算法总览

### 1.1 计算公式

网格参数计算基于**ATR（Average True Range，平均真实波幅）**指标，具体公式如下：

```
网格上限 = 当前价格 + 2 × ATR_daily
网格下限 = 当前价格 - 3 × ATR_daily
网格步长 = 0.5 × ATR_hourly
网格数量 = (网格上限 - 网格下限) / 网格步长 + 1
```

### 1.2 代码实现位置

**文件**: `grid_trading/models/screening_result.py`

```python
def calculate_grid_parameters(
    current_price: Decimal, atr_daily: float, atr_hourly: float
) -> tuple:
    """
    计算推荐网格参数 (FR-030)

    Args:
        current_price: 当前价格
        atr_daily: 日线ATR (基于24小时K线, period=14)
        atr_hourly: 小时线ATR (基于1小时K线, period=14)

    Returns:
        (upper_limit, lower_limit, grid_count)
    """
    upper = current_price + Decimal(str(2 * atr_daily))
    lower = current_price - Decimal(str(3 * atr_daily))
    grid_step = 0.5 * atr_hourly
    grid_count = int((float(upper - lower) / grid_step)) + 1

    return upper, lower, grid_count
```

---

## 2. ATR指标详解

### 2.1 什么是ATR？

**ATR（Average True Range）** 是衡量市场波动性的技术指标，由J. Welles Wilder Jr.于1978年提出。

### 2.2 ATR计算步骤

#### 第1步：计算真实波幅（True Range, TR）

对于每根K线，TR取以下三者的最大值：

```
TR = max(
    H - L,              # 当前K线最高价 - 最低价
    |H - C_prev|,       # 当前最高价 - 前一根收盘价（向上跳空）
    |L - C_prev|        # 当前最低价 - 前一根收盘价（向下跳空）
)
```

**为什么用3个值的最大值？**
- `H - L`: 捕捉日内波动
- `|H - C_prev|`: 捕捉向上跳空缺口
- `|L - C_prev|`: 捕捉向下跳空缺口

#### 第2步：计算ATR（指数移动平均）

```
k = 2 / (period + 1)  # period默认为14
ATR_0 = TR_0  # 初值
ATR_t = k × TR_t + (1 - k) × ATR_{t-1}  # 递推计算
```

使用EMA（指数移动平均）而非SMA的原因：
- 对近期波动更敏感
- 平滑效果更好
- 符合市场动态特性

#### 第3步：归一化ATR（NATR）

```
NATR = (ATR / Close) × 100  # 百分比形式
```

归一化后，不同价格水平的币种可以进行横向对比。

### 2.3 代码实现

**文件**: `grid_trading/services/indicator_calculator.py`

```python
def calculate_natr(klines: List[Dict[str, Any]], period: int = 14) -> float:
    """计算归一化ATR"""
    highs = np.array([k["high"] for k in klines])
    lows = np.array([k["low"] for k in klines])
    closes = np.array([k["close"] for k in klines])

    # 计算TR
    hl = highs - lows
    hc = np.abs(highs[1:] - closes[:-1])
    lc = np.abs(lows[1:] - closes[:-1])
    tr = np.maximum(hl[1:], np.maximum(hc, lc))

    # EMA计算ATR
    alpha = 2 / (period + 1)
    atr = np.zeros_like(tr)
    atr[0] = tr[0]
    for i in range(1, len(tr)):
        atr[i] = alpha * tr[i] + (1 - alpha) * atr[i - 1]

    # 归一化
    natr = (atr[-1] / closes[-1]) * 100
    return float(natr)
```

### 2.4 为什么用两种ATR？

| ATR类型 | K线周期 | 用途 | 原因 |
|---------|---------|------|------|
| **ATR_daily** | 1天（1d） | 计算网格边界 | 反映长期波动，适合确定网格整体范围 |
| **ATR_hourly** | 1小时（1h） | 计算网格步长 | 反映短期波动，适合确定订单密度 |

**设计理念**：
- 网格边界要**稳定**（不能频繁突破）→ 用日线ATR（长期波动）
- 网格步长要**灵活**（适应短期波动）→ 用小时ATR（短期波动）

---

## 3. 网格参数设计原理

### 3.1 为什么上限用 +2×ATR，下限用 -3×ATR？

#### **非对称设计的核心思想**：偏向做空方向

| 参数 | 公式 | 含义 | 设计意图 |
|------|------|------|----------|
| **网格上限** | 价格 + 2×ATR_daily | 止损边界 | 价格突破时止损，较小范围保护本金 |
| **网格下限** | 价格 - 3×ATR_daily | 止盈边界 | 价格下跌时获利，较大范围提高收益空间 |

**为什么下限范围更大？**
1. **做空网格的盈利方向是下跌**：给价格下跌更大空间
2. **风险不对称**：上涨风险（止损）需要控制，下跌风险（止盈）可以放宽
3. **符合统计规律**：基于ATR的1.5-3倍是波动率统计中的常见置信区间

#### **统计学依据**：

假设价格波动符合正态分布（近似），ATR约等于1个标准差（σ）：

- **2×ATR ≈ 95.4%置信区间** → 上限很少被突破（止损触发概率低）
- **3×ATR ≈ 99.7%置信区间** → 下限极少被触及（止盈空间充足）

### 3.2 为什么网格步长用 0.5×ATR_hourly？

#### **步长设计权衡**：

| 步长倍数 | 网格密度 | 优点 | 缺点 |
|----------|----------|------|------|
| 0.3×ATR | 密集 | 成交频繁，收益积累快 | 资金占用高，手续费多 |
| **0.5×ATR** | **适中** | **平衡频率与成本** | **推荐值** |
| 1.0×ATR | 稀疏 | 资金占用低，手续费少 | 成交不频繁，错过小波动 |

**0.5×ATR的合理性**：
1. **捕捉主要波动**：小时级别ATR反映短期波动，0.5倍确保每次小波动至少触发1-2个网格
2. **避免过密交易**：不会因为微小波动频繁开平仓，降低手续费成本
3. **资金效率**：在整个网格区间内，网格数量适中（通常30-100层）

---

## 4. 实际案例分析

### 4.1 案例1：AIAUSDT（高波动币种）

**市场数据**：
- 当前价格：$0.3276
- 波动性：VDR=17.33（震荡性强），KER=0.038（趋势性弱）
- EMA99斜率=-113.06（强下跌趋势）

**计算过程**：

假设：
- ATR_daily = 0.316（基于1d K线，period=14）
- ATR_hourly = 0.0042（基于1h K线，period=14）

```
网格上限 = 0.3276 + 2 × 0.316 = 0.9596 USDT
网格下限 = 0.3276 - 3 × 0.316 = -0.6209 USDT → 修正为 0.0001 USDT（价格不能为负）
网格步长 = 0.5 × 0.0042 = 0.0021 USDT
网格数量 = (0.9596 - 0.0001) / 0.0021 + 1 ≈ 377层
```

**特点分析**：
- ✅ **高波动 → 网格密集**：377层网格覆盖宽幅区间
- ✅ **做空有利**：强下跌趋势（EMA99斜率<0），年化资金费率+87.96%
- ⚠️ **风险**：价格波动极大，需要更高保证金

---

### 4.2 案例2：CYBERUSDT（中等波动币种）

**市场数据**：
- 当前价格：$0.8742
- 波动性：VDR=43.14（极强震荡），KER=0.081（震荡为主）
- EMA99斜率=+9.47（轻微上涨趋势）

**计算过程**：

假设：
- ATR_daily = 0.0817（基于1d K线）
- ATR_hourly = 0.0066（基于1h K线）

```
网格上限 = 0.8742 + 2 × 0.0817 = 1.0377 USDT
网格下限 = 0.8742 - 3 × 0.0817 = 0.6289 USDT
网格步长 = 0.5 × 0.0066 = 0.0033 USDT
网格数量 = (1.0377 - 0.6289) / 0.0033 + 1 ≈ 62层
```

**特点分析**：
- ✅ **震荡性极强**：VDR=43.14，完美震荡标的
- ⚠️ **轻微上涨趋势**：EMA99斜率>0，需要谨慎（但值很小可接受）
- ❌ **资金费率为负**：-52.44%，做空需要支付资金费（不利）

---

### 4.3 案例3：BANDUSDT（标准波动币种）

**市场数据**：
- 当前价格：$0.433
- 波动性：VDR=15.82（震荡较强），KER=0.085（震荡为主）
- EMA99斜率=+18.83（明显上涨趋势）

**计算过程**：

假设：
- ATR_daily = 0.039（基于1d K线）
- ATR_hourly = 0.0026（基于1h K线）

```
网格上限 = 0.433 + 2 × 0.039 = 0.5111 USDT
网格下限 = 0.433 - 3 × 0.039 = 0.3159 USDT
网格步长 = 0.5 × 0.0026 = 0.0013 USDT
网格数量 = (0.5111 - 0.3159) / 0.0013 + 1 ≈ 76层
```

**特点分析**：
- ✅ **震荡性适中**：VDR=15.82，KER=0.085
- ⚠️ **上涨趋势明显**：EMA99斜率=+18.83（风险较高）
- ❌ **资金费率为负**：-70.91%（做空不利）

**结论**：虽然震荡性合格，但上涨趋势+负资金费率使其不适合做空网格。

---

## 5. 网格参数与波动性的关系

### 5.1 网格密度对比

| 币种 | 价格 | ATR_daily | ATR_hourly | 网格数量 | 波动特征 |
|------|------|-----------|------------|----------|----------|
| AIAUSDT | $0.33 | 0.316 | 0.0042 | **377层** | 极高波动 |
| CYBERUSDT | $0.87 | 0.082 | 0.0066 | **62层** | 中等波动 |
| BANDUSDT | $0.43 | 0.039 | 0.0026 | **76层** | 标准波动 |

**规律总结**：
- **高波动币种** → ATR大 → 网格区间宽 → 网格数量多（但步长也大，不会过密）
- **低波动币种** → ATR小 → 网格区间窄 → 网格数量少（步长小，密度适中）

### 5.2 自适应特性

ATR作为基础的好处：**自动适应不同币种的波动特性**

- **高波动币**（如AIAUSDT）：ATR大 → 网格区间自动放宽 → 不容易触发止损
- **低波动币**（如稳定币对）：ATR小 → 网格区间自动收窄 → 充分利用小波动

---

## 6. 止盈止损设计

### 6.1 做空网格的止盈止损逻辑

对于**做空网格**：
- **止损价格 = 网格上限**（价格突破上限时止损）
- **止盈价格 = 网格下限**（价格触及下限时止盈）

### 6.2 止盈止损百分比计算

```python
# 做空策略
stop_loss_pct = (网格上限 - 当前价格) / 当前价格 × 100
take_profit_pct = (当前价格 - 网格下限) / 当前价格 × 100
```

#### 实际案例：

| 币种 | 当前价格 | 网格上限 | 网格下限 | 止损% | 止盈% |
|------|----------|----------|----------|-------|-------|
| AIAUSDT | $0.3276 | $0.9599 | $0.0001 | **+193%** | **+289%** |
| CYBERUSDT | $0.8742 | $1.0377 | $0.6289 | **+18.7%** | **+28.1%** |
| BANDUSDT | $0.4330 | $0.5111 | $0.3159 | **+18.0%** | **+27.1%** |

**观察**：
- AIAUSDT的止盈/止损比例极大（异常高波动）
- CYBERUSDT和BANDUSDT的止盈止损比例接近 **1.5:1** 的理想比例（符合3×ATR vs 2×ATR的设计）

---

## 7. 优势与局限性

### 7.1 设计优势

✅ **自适应性强**：基于ATR，自动适应不同币种和市场状态
✅ **统计学基础**：2σ和3σ置信区间，有理论依据
✅ **多时间框架**：日线ATR定边界，小时ATR定步长，兼顾稳定性和灵活性
✅ **非对称设计**：符合做空网格的盈利特性（下跌空间大于上涨风险）

### 7.2 潜在局限

⚠️ **历史数据依赖**：ATR基于过去14根K线，对突发事件（黑天鹅）反应滞后
⚠️ **极端波动处理**：如AIAUSDT，ATR过大导致网格下限为负数，需要修正逻辑
⚠️ **固定倍数参数**：2×, 3×, 0.5× 是经验值，未必对所有市场状态最优
⚠️ **未考虑趋势强度**：即使EMA99斜率为正（上涨趋势），网格参数仍按震荡逻辑计算

### 7.3 改进方向建议

1. **动态倍数调整**：
   - 根据EMA斜率调整上下限倍数
   - 下跌趋势：下限扩大到4×ATR，上限缩小到1.5×ATR
   - 上涨趋势：下限缩小到2×ATR，上限扩大到3×ATR（或不做空）

2. **极端波动保护**：
   - 设置网格下限最小值（如当前价格的30%）
   - 设置网格数量上限（如最多150层，避免资金过度分散）

3. **波动率预测**：
   - 结合GARCH模型预测未来波动率
   - 动态调整ATR周期（市场平静时用更长周期，市场波动时用更短周期）

4. **资金费率集成**：
   - 当年化资金费率>50%时，下限可适当放宽（做空收益增加）
   - 当年化资金费率<-50%时，网格区间整体缩小（做空成本高）

---

## 8. 总结

### 核心公式回顾

```
网格上限 = 价格 + 2×ATR_daily
网格下限 = 价格 - 3×ATR_daily
网格步长 = 0.5×ATR_hourly
网格数量 = (上限 - 下限) / 步长 + 1
```

### 设计哲学

1. **基于波动率（ATR）而非固定百分比**：适应不同市场环境
2. **非对称风险收益**：做空网格偏向下跌方向（3×ATR vs 2×ATR）
3. **多时间框架结合**：长期稳定（日线）+ 短期灵活（小时）
4. **统计学支撑**：2σ和3σ置信区间，理论基础扎实

### 适用场景

✅ **最适合**：震荡币种（VDR>10, KER<0.3）+ 下跌或横盘趋势（EMA99≤0）
✅ **可接受**：震荡性强但轻微上涨趋势（EMA99略>0但<20）
❌ **不适合**：强上涨趋势（EMA99>50）或极低波动币种（VDR<5）

---

**文档生成时间**：2025-12-04
**版本**：v1.0
**相关代码**：
- `grid_trading/models/screening_result.py`: calculate_grid_parameters()
- `grid_trading/services/indicator_calculator.py`: calculate_natr()
