<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†é€‰å¸Dashboard Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* ========== Design Tokens ========== */
        :root {
            --bg-body: #0b0e11;
            --bg-card: #15181f;
            --bg-header: #15181f;
            --bg-hover: #1e232d;
            --bg-input: #0b0e11;
            --border-color: #2b313a;
            --border-light: #363c4a;

            --text-main: #e1e7ef;
            --text-sub: #8492a6;
            --text-muted: #5e6e82;

            --primary: #2962ff;
            --primary-dim: rgba(41, 98, 255, 0.15);
            --success: #00c853;
            --success-dim: rgba(0, 200, 83, 0.15);
            --warning: #ffd600;
            --danger: #ff1744;
            --danger-dim: rgba(255, 23, 68, 0.15);

            --radius: 6px;
            --font-base: 'Inter', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;

            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-float: 0 4px 12px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-base);
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #363c4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5160; }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ========== Header ========== */
        .header {
            flex: 0 0 auto;
            padding: 12px 24px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; gap: 12px; }

        .btn {
            padding: 6px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: var(--bg-hover); border-color: var(--text-sub); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
        .btn-primary:hover { background: #1e4bd8; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        /* ========== Layout: Sidebar & Main ========== */
        .layout-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar: Dates */
        .sidebar {
            width: 260px;
            background: var(--bg-body);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex: 0 0 260px;
        }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .date-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .date-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .date-item:hover { background: var(--bg-hover); }
        .date-item.active {
            background: var(--primary-dim);
            border-color: var(--primary);
        }
        .date-main-text { font-family: var(--font-mono); font-weight: 600; font-size: 14px; }
        .date-sub-text { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; margin-top: 4px; }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-card);
        }

        /* Toolbar / Filters */
        .toolbar {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        .toolbar-top { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .filter-group label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
        .input-wrapper { position: relative; }
        .input-wrapper input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-family: var(--font-mono);
            transition: border-color 0.2s;
        }
        .input-wrapper input:focus { border-color: var(--primary); outline: none; }
        .input-unit {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 11px; color: var(--text-sub); pointer-events: none;
        }

        /* ========== Table Area ========== */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }

        thead th {
            background: var(--bg-header);
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-sub);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        thead th:hover { color: var(--text-main); background: var(--bg-hover); }
        th::after {
            content: 'â†•';
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.3;
        }
        th.asc::after { content: 'â†‘'; opacity: 1; color: var(--primary); }
        th.desc::after { content: 'â†“'; opacity: 1; color: var(--primary); }

        tbody td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-main);
        }
        tbody tr:hover { background-color: var(--bg-hover); }

        /* Sticky Columns */
        th.sticky-col, td.sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
        }
        tbody tr:hover td.sticky-col { background: var(--bg-hover); }

        th.sticky-col-2, td.sticky-col-2 {
            position: sticky;
            left: 50px;
            z-index: 10;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        tbody tr:hover td.sticky-col-2 { background: var(--bg-hover); }

        /* Cell Styling */
        .font-mono { font-family: var(--font-mono); }
        .text-right { text-align: right; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-dim { color: var(--text-sub); }

        .symbol-link { color: var(--primary); text-decoration: none; font-weight: 600; }
        .symbol-link:hover { text-decoration: underline; }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
        }
        .badge-spot { color: var(--success); border-color: var(--success-dim); background: var(--success-dim); }

        /* Strategy Tooltip */
        .strategy-cell { position: relative; cursor: help; }
        .strategy-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 12px;
            background: var(--primary-dim); border: 1px solid rgba(41, 98, 255, 0.2);
            color: #fff; font-size: 11px;
        }
        .tooltip-content {
            display: none;
            position: absolute;
            right: 100%; top: 50%; transform: translateY(-50%) translateX(-10px);
            background: #1e232d;
            border: 1px solid var(--border-light);
            padding: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-float);
            width: 220px;
            z-index: 100;
        }
        .strategy-cell:hover .tooltip-content { display: block; }

        .status-bar {
            padding: 8px 16px;
            background: var(--bg-input);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
        }

        /* Loading */
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(11, 14, 17, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; display: none;
        }
        .loading-overlay.show { display: flex; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>
            <span style="font-size: 20px;">ğŸ“…</span>
            æ—¥å†é€‰å¸ç»ˆç«¯ <span style="font-size:12px; background:var(--bg-hover); padding:2px 6px; border-radius:4px; color:var(--text-sub);">PRO</span>
        </h1>
        <div class="header-actions">
            <a href="/screening/" class="btn">âš¡ å®æ—¶ç­›é€‰</a>
            <a href="/grids/" class="btn">ğŸ•¸ï¸ ç½‘æ ¼ç®¡ç†</a>
        </div>
    </header>

    <div class="layout-body">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 style="font-size: 13px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px;">å†å²å¿«ç…§</h3>
            </div>
            <div id="dateList" class="date-list">
                <div style="padding:20px; text-align:center; color:var(--text-sub); font-size:12px;">åŠ è½½ä¸­...</div>
            </div>
        </aside>

        <main class="main-content">
            <!-- 7å¤©é«˜é¢‘åˆçº¦å›ºå®šæ  -->
            <div id="topFrequentSection" style="margin-bottom: 16px; background: linear-gradient(135deg, #1a1f28 0%, #15181f 100%); border: 1px solid var(--primary); border-radius: var(--radius); padding: 16px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                    <h3 style="font-size: 15px; font-weight: 600; color: var(--primary);">ğŸ”¥ æœ€è¿‘7å¤©é«˜é¢‘åˆçº¦ Top 20</h3>
                    <span id="topFrequentCount" style="font-size: 12px; color: var(--text-sub);"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table id="topFrequentTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 8px; text-align: left; color: var(--text-sub); font-weight: 600;">åˆçº¦</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">ä»·æ ¼</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">FDV</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">å‡ºç°æ¬¡æ•°</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">15må¹³å‡æŒ¯å¹…</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">é«˜ç‚¹å›è½</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-sub); font-weight: 600;">ç­–ç•¥</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-sub); font-weight: 600;">ç½‘æ ¼åŒºé—´</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-sub); font-weight: 600;">ä»·æ ¼åˆ†ä½</th>
                            </tr>
                        </thead>
                        <tbody id="topFrequentTableBody">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="toolbar">
                <div class="toolbar-top">
                    <div>
                        <h2 id="resultsTitle" style="font-size: 16px; font-weight: 600;">è¯·é€‰æ‹©æ—¥æœŸ</h2>
                        <div id="resultsMeta" style="font-size: 12px; color: var(--text-sub);"></div>
                    </div>
                    <div>
                        <button id="resetFilters" class="btn btn-sm">â†º é‡ç½®æ¡ä»¶</button>
                    </div>
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label>VDR (æ³¢åŠ¨ç‡/å›æ’¤) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinVdr" step="0.1" placeholder="é»˜è®¤">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>15m æŒ¯å¹… â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinAmplitude" step="1" placeholder="é»˜è®¤">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>EMA99 æ–œç‡ â‰¤</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMaxMa99Slope" step="1" placeholder="é»˜è®¤">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>å¹´åŒ–èµ„è´¹ â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinFundingRate" step="1" placeholder="é»˜è®¤">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>æŒä»“é‡ OI (M) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinOI" step="0.1" placeholder="é»˜è®¤">
                            <span class="input-unit">M</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>24h æˆäº¤é¢ (M) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinVolume" step="1" placeholder="é»˜è®¤">
                            <span class="input-unit">M</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <div id="loadingOverlay" class="loading-overlay">
                    <div style="color: white;">æ•°æ®åŠ è½½ä¸­...</div>
                </div>
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th class="sticky-col" style="width: 120px;" data-key="symbol">åˆçº¦</th>

                            <th class="text-right" data-key="price">ä»·æ ¼</th>
                            <th class="text-right" data-key="fdv" title="Fully Diluted Valuation - å…¨ç¨€é‡Šä¼°å€¼">FDV</th>
                            <th class="text-right" data-key="price_change" style="min-width: 100px;">å˜åŒ–</th>
                            <th class="text-right" data-key="vdr" title="Volatility Drawdown Ratio">VDR</th>
                            <th class="text-right" data-key="amplitude_sum_15m">15mæŒ¯å¹…</th>
                            <th class="text-right" data-key="ma99_slope">EMA99æ–œç‡</th>
                            <th class="text-right" data-key="drawdown_from_high_pct">é«˜ç‚¹å›è½</th>
                            <th class="text-right" data-key="annual_funding_rate">å¹´åŒ–èµ„è´¹</th>
                            <th class="text-right" data-key="volume_24h_calculated">24hé‡</th>
                            <th class="text-right" data-key="open_interest" title="æŒä»“é‡">OI</th>
                            <th class="text-right" data-key="vol_oi_ratio">Vol/OI</th>
                            <th class="text-right" data-key="money_flow_large_net" title="24å°æ—¶å¤§å•å‡€æµå…¥">ğŸ’° å¤§å•å‡€æµå…¥</th>
                            <th style="min-width: 140px;">ç­–ç•¥å»ºè®®</th>
                            <th class="text-right" data-key="grid_count" style="min-width: 140px;">ç½‘æ ¼åŒºé—´</th>
                            <th class="text-right" data-key="price_percentile_100">ä»·æ ¼åˆ†ä½</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="16" style="text-align: center; padding: 40px; color: var(--text-sub);">â† è¯·ä»å·¦ä¾§é€‰æ‹©å†å²æ—¥æœŸ</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="status-bar" id="statusBar">
                <span>Ready</span>
                <span>æ˜¾ç¤º 0 æ¡è®°å½•</span>
            </div>
        </main>
    </div>
</div>

<script>
    // State Management
    const state = {
        currentDate: null,
        rawDateData: [],
        filteredData: [],
        sortBy: 'amplitude_sum_15m',
        sortOrder: 'desc',
        filters: {
            minVdr: 6,
            minAmplitude: 50,
            maxMa99Slope: -10,
            minFundingRate: -10,
            minOI: 5,
            minVolume: 8
        }
    };

    // DOM Elements
    const els = {
        dateList: document.getElementById('dateList'),
        tbody: document.getElementById('resultsBody'),
        loading: document.getElementById('loadingOverlay'),
        title: document.getElementById('resultsTitle'),
        meta: document.getElementById('resultsMeta'),
        status: document.getElementById('statusBar'),
        inputs: {
            vdr: document.getElementById('filterMinVdr'),
            amp: document.getElementById('filterMinAmplitude'),
            slope: document.getElementById('filterMaxMa99Slope'),
            funding: document.getElementById('filterMinFundingRate'),
            oi: document.getElementById('filterMinOI'),
            vol: document.getElementById('filterMinVolume')
        }
    };

    // Init
    init();

    function init() {
        els.inputs.vdr.value = state.filters.minVdr;
        els.inputs.amp.value = state.filters.minAmplitude;
        els.inputs.slope.value = state.filters.maxMa99Slope;
        els.inputs.funding.value = state.filters.minFundingRate;
        els.inputs.oi.value = state.filters.minOI;
        els.inputs.vol.value = state.filters.minVolume;

        bindEvents();
        loadDates();
        loadTopFrequentContracts(); // åŠ è½½7å¤©é«˜é¢‘åˆçº¦
    }

    function bindEvents() {
        document.querySelectorAll('th[data-key]').forEach(th => {
            th.addEventListener('click', () => handleSort(th.dataset.key));
        });

        const handleFilterChange = debounce(() => {
            updateFiltersFromDOM();
            processData();
        }, 300);

        Object.values(els.inputs).forEach(input => {
            input.addEventListener('input', handleFilterChange);
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            state.filters = { minVdr: 6, minAmplitude: 50, maxMa99Slope: -10, minFundingRate: -10, minOI: 5, minVolume: 8 };
            els.inputs.vdr.value = state.filters.minVdr;
            els.inputs.amp.value = state.filters.minAmplitude;
            els.inputs.slope.value = state.filters.maxMa99Slope;
            els.inputs.funding.value = state.filters.minFundingRate;
            els.inputs.oi.value = state.filters.minOI;
            els.inputs.vol.value = state.filters.minVolume;
            processData();
        });
    }

    async function loadDates() {
        try {
            const response = await fetch('/screening/daily/api/dates/');
            const data = await response.json();
            renderDateList(data.dates);
            if (data.dates.length > 0) selectDate(data.dates[0].date);
        } catch (e) {
            console.error(e);
            els.dateList.innerHTML = '<div style="padding:12px;color:var(--danger)">åŠ è½½å¤±è´¥</div>';
        }
    }

    // åŠ è½½7å¤©é«˜é¢‘åˆçº¦
    async function loadTopFrequentContracts() {
        try {
            const response = await fetch('/screening/daily/api/top-frequent/?days=7&limit=20');
            const data = await response.json();

            if (data.contracts && data.contracts.length > 0) {
                renderTopFrequentContracts(data.contracts);
                document.getElementById('topFrequentSection').style.display = 'block';
                document.getElementById('topFrequentCount').textContent = `å…± ${data.contracts.length} ä¸ªåˆçº¦`;
            }
        } catch (e) {
            console.error('åŠ è½½é«˜é¢‘åˆçº¦å¤±è´¥:', e);
        }
    }

    // æ¸²æŸ“é«˜é¢‘åˆçº¦è¡¨æ ¼
    function renderTopFrequentContracts(contracts) {
        const tbody = document.getElementById('topFrequentTableBody');
        tbody.innerHTML = contracts.map((c, idx) => `
            <tr style="border-bottom: 1px solid rgba(43, 49, 58, 0.3);">
                <td style="padding: 10px; font-weight: 700; color: var(--text-main);">${c.symbol}</td>
                <td style="padding: 10px; text-align: right; color: var(--primary); font-weight: 600;">$${c.current_price.toFixed(6)}</td>
                <td style="padding: 10px; text-align: right;">${c.fdv ? '$' + c.fdv.toLocaleString() : '-'}</td>
                <td style="padding: 10px; text-align: right;">
                    <span style="display: inline-block; padding: 2px 8px; background: rgba(41, 98, 255, 0.15); border-radius: 10px; color: var(--primary); font-weight: 600; font-size: 11px;">
                        ${c.appearance_count}æ¬¡
                    </span>
                </td>
                <td style="padding: 10px; text-align: right; color: var(--success); font-weight: 600;">${c.avg_amplitude_15m.toFixed(2)}%</td>
                <td style="padding: 10px; text-align: right;">${c.latest_drawdown.toFixed(2)}%</td>
                <td style="padding: 10px;">${c.latest_strategy}</td>
                <td style="padding: 10px; font-size: 11px; font-family: var(--font-mono);">${c.latest_grid_range}</td>
                <td style="padding: 10px; text-align: right;">${c.latest_price_percentile.toFixed(2)}%</td>
            </tr>
        `).join('');
    }

    function renderDateList(dates) {
        if (!dates.length) {
            els.dateList.innerHTML = '<div style="padding:12px;color:var(--text-sub)">æ— æ•°æ®</div>';
            return;
        }
        els.dateList.innerHTML = dates.map(d => `
            <div class="date-item" data-date="${d.date}" onclick="selectDate('${d.date}')">
                <div class="date-main-text">${d.date}</div>
                <div class="date-sub-text">
                    <span>${d.filtered_candidates}/${d.total_candidates} æ ‡çš„</span>
                    <span>${d.execution_time}s</span>
                </div>
            </div>
        `).join('');
    }

    async function selectDate(date) {
        if (state.currentDate === date) return;
        state.currentDate = date;

        document.querySelectorAll('.date-item').forEach(el => {
            el.classList.toggle('active', el.dataset.date === date);
        });
        els.title.innerText = `${date} åˆ†ææŠ¥å‘Š`;
        els.loading.classList.add('show');

        try {
            const params = new URLSearchParams({
                sort_by: 'rank',
                sort_order: 'asc'
            });
            const res = await fetch(`/screening/daily/api/${date}/?${params}`);
            const json = await res.json();

            state.rawDateData = json.results;

            if(json.record) {
                 els.meta.innerHTML = `VDRæƒé‡: ${(json.record.weights.vdr*100).toFixed(0)}% | KERæƒé‡: ${(json.record.weights.ker*100).toFixed(0)}%`;
            }

            processData();
        } catch (e) {
            console.error(e);
            els.tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
        } finally {
            els.loading.classList.remove('show');
        }
    }

    function processData() {
        let data = [...state.rawDateData];

        const f = state.filters;
        data = data.filter(item => {
            const oiM = (item.open_interest || 0) / 1000000;
            const volM = (item.volume_24h_calculated || 0) / 1000000;

            if (f.minVdr !== '' && item.vdr < parseFloat(f.minVdr)) return false;
            if (f.minAmplitude !== '' && item.amplitude_sum_15m < parseFloat(f.minAmplitude)) return false;
            if (f.maxMa99Slope !== '' && item.ma99_slope > parseFloat(f.maxMa99Slope)) return false;
            if (f.minFundingRate !== '' && item.annual_funding_rate < parseFloat(f.minFundingRate)) return false;
            if (f.minOI !== '' && oiM < parseFloat(f.minOI)) return false;
            if (f.minVolume !== '' && volM < parseFloat(f.minVolume)) return false;
            return true;
        });

        const key = state.sortBy;
        const order = state.sortOrder === 'asc' ? 1 : -1;

        data.sort((a, b) => {
            let valA, valB;

            // ç‰¹æ®Šå¤„ç†ä»·æ ¼å˜åŒ–æ’åº
            if (key === 'price_change') {
                valA = a.price_change ? a.price_change.change_pct : -999999;
                valB = b.price_change ? b.price_change.change_pct : -999999;
            } else {
                valA = a[key] !== undefined ? a[key] : -999999;
                valB = b[key] !== undefined ? b[key] : -999999;
            }

            if (valA === null) valA = -999999;
            if (valB === null) valB = -999999;

            if (valA < valB) return -1 * order;
            if (valA > valB) return 1 * order;
            return 0;
        });

        state.filteredData = data;
        renderTable();
        updateHeaderUI();
        updateCurrentDateCount();  // â­ æ–°å¢ï¼šæ›´æ–°å½“å‰æ—¥æœŸçš„æ˜¾ç¤ºæ•°é‡
    }

    function renderTable() {
        const data = state.filteredData;
        els.status.innerHTML = `<span>æ€»æ ‡çš„: ${state.rawDateData.length}</span> <span>å½“å‰æ˜¾ç¤º: <strong>${data.length}</strong></span>`;

        if (data.length === 0) {
            els.tbody.innerHTML = '<tr><td colspan="15" style="text-align:center; padding:20px; color:var(--text-sub)">æ— ç¬¦åˆæ¡ä»¶çš„æ ‡çš„ï¼Œè¯·æ”¾å®½ç­›é€‰æ¡ä»¶ã€‚</td></tr>';
            return;
        }

        els.tbody.innerHTML = data.map(r => {
            const volM = ((r.volume_24h_calculated || 0) / 1000000).toFixed(1);

            // ç­–ç•¥å»ºè®®ï¼šä¼˜å…ˆæ˜¾ç¤º"ä¿å®ˆåå¼¹"
            let entry = null;
            if (r.entry_candidates && r.entry_candidates.length > 0) {
                // æŸ¥æ‰¾"ä¿å®ˆåå¼¹"ç­–ç•¥
                entry = r.entry_candidates.find(c => c.label && c.label.includes('ä¿å®ˆåå¼¹'));
                // å¦‚æœæ²¡æœ‰ä¿å®ˆåå¼¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªç­–ç•¥
                if (!entry) entry = r.entry_candidates[0];
            }

            let strategyTooltip = '';
            if (r.entry_candidates && r.entry_candidates.length > 0) {
                strategyTooltip = r.entry_candidates.map(c => `
                    <div style="margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;">
                        <div style="color:#fff; font-weight:600;">${c.label} @ ${fmtPrice(c.entry_price)}</div>
                        <div style="font-size:10px; color:var(--text-sub);">è§¦å‘ç‡: ${(c.trigger_prob_24h*100).toFixed(0)}% | è€—æ—¶: ${c.avg_trigger_time.toFixed(1)}h</div>
                    </div>
                `).join('');
            } else {
                strategyTooltip = 'æ— å¼€ä»“å»ºè®®';
            }

            return `
            <tr>
                <td class="sticky-col font-mono">
                    <a href="https://www.binance.com/zh-CN/futures/${r.symbol}" target="_blank" class="symbol-link">${r.symbol}</a>
                    ${r.has_spot && r.amplitude_sum_15m > 100 && (r.volume_24h_calculated / 1000000) > 10 ? '<span style="margin-left:4px;">ğŸ‘‘</span>' : ''}
                    ${r.has_spot ? '<span class="badge badge-spot">ç°</span>' : ''}
                </td>
                <td class="text-right font-mono">
                    <a href="/screening/daily/${state.currentDate}/${r.symbol}/" class="symbol-link">${fmtPrice(r.price)}</a>
                </td>
                <td class="text-right font-mono" style="font-size: 11px;">
                    ${fmtFDV(r.fdv)}
                </td>
                <td class="text-right font-mono" style="font-size: 11px;">
                    ${r.price_change ? `
                        <div style="color: ${r.price_change.change_pct >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                            ${r.price_change.change_pct >= 0 ? '+' : ''}${r.price_change.change_pct.toFixed(2)}%
                        </div>
                        <div style="color: var(--text-sub); font-size: 10px;">vs ${r.price_change.previous_date}</div>
                    ` : '<span style="color: var(--text-muted);">-</span>'}
                </td>
                <td class="text-right font-mono" style="color:${getColor(r.vdr, 10, 3)}">${fmtNum(r.vdr, 1)}</td>
                <td class="text-right font-mono">${fmtNum(r.amplitude_sum_15m, 1)}%</td>
                <td class="text-right font-mono ${r.ma99_slope > 0 ? 'text-green' : 'text-red'}">${fmtNum(r.ma99_slope, 1)}</td>
                <td class="text-right font-mono" style="color:${r.drawdown_from_high_pct < -20 ? 'var(--success)' : ''}">${fmtNum(r.drawdown_from_high_pct, 1)}%</td>
                <td class="text-right font-mono ${r.annual_funding_rate >= 0 ? 'text-green' : 'text-red'}">${fmtNum(r.annual_funding_rate, 1)}%</td>
                <td class="text-right font-mono text-dim">${volM}M</td>
                <td class="text-right font-mono text-dim">${((r.open_interest || 0) / 1000000).toFixed(1)}M</td>
                <td class="text-right font-mono" style="font-weight:600; color:${r.vol_oi_ratio > 1.5 ? 'var(--success)' : ''}">${fmtNum(r.vol_oi_ratio, 2)}</td>

                <td class="text-right font-mono ${r.money_flow_large_net >= 0 ? 'text-green' : 'text-red'}" style="font-weight:500;">
                    ${r.money_flow_large_net >= 0 ? '+' : ''}${(r.money_flow_large_net / 1000000).toFixed(1)}M
                </td>

                <td class="strategy-cell">
                    ${entry ? `
                        <div class="strategy-pill">
                            <span>${entry.label}</span>
                            <span>${fmtPrice(entry.entry_price)}</span>
                        </div>
                        <div class="tooltip-content">${strategyTooltip}</div>
                    ` : '<span style="color:var(--text-sub); font-size:11px;">-</span>'}
                </td>

                <td class="text-right font-mono" style="font-size: 11px;">
                    <div>${fmtPrice(r.grid_lower)}~${fmtPrice(r.grid_upper)}</div>
                    <div style="color:${r.grid_count > 100 ? 'var(--danger)' : 'var(--text-sub)'}; font-size: 10px;">${r.grid_count}æ¡£</div>
                </td>
                <td class="text-right font-mono" style="font-weight:bold; ${getPercentileColor(r.price_percentile_100)}">${fmtNum(r.price_percentile_100, 1)}%</td>
            </tr>
            `;
        }).join('');
    }

    function handleSort(key) {
        if (state.sortBy === key) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortBy = key;
            state.sortOrder = 'desc';
        }
        processData();
    }

    function updateHeaderUI() {
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.key === state.sortBy) {
                th.classList.add(state.sortOrder);
            }
        });
    }

    function updateCurrentDateCount() {
        // æ›´æ–°å½“å‰æ—¥æœŸçš„æ˜¾ç¤ºæ•°é‡ï¼ˆæ ¹æ®å‰ç«¯ç­›é€‰æ¡ä»¶ï¼‰
        if (!state.currentDate) return;

        const activeItem = document.querySelector(`.date-item[data-date="${state.currentDate}"]`);
        if (activeItem) {
            const subTextSpan = activeItem.querySelector('.date-sub-text span:first-child');
            if (subTextSpan) {
                const filteredCount = state.filteredData.length;
                const totalCount = state.rawDateData.length;
                subTextSpan.textContent = `${filteredCount}/${totalCount} æ ‡çš„`;
            }
        }
    }

    function updateFiltersFromDOM() {
        state.filters.minVdr = els.inputs.vdr.value;
        state.filters.minAmplitude = els.inputs.amp.value;
        state.filters.maxMa99Slope = els.inputs.slope.value;
        state.filters.minFundingRate = els.inputs.funding.value;
        state.filters.minOI = els.inputs.oi.value;
        state.filters.minVolume = els.inputs.vol.value;
    }

    function fmtPrice(p) {
        p = parseFloat(p);
        if (p < 1) return p.toFixed(4);
        if (p < 10) return p.toFixed(3);
        return p.toFixed(2);
    }
    function fmtNum(n, d) { return parseFloat(n).toFixed(d); }
    function fmtFDV(fdv) {
        if (!fdv || fdv === null) return '<span style="color: var(--text-muted);">-</span>';
        const billion = fdv / 1e9;
        const million = fdv / 1e6;
        if (billion >= 1) return `$${billion.toFixed(2)}B`;
        if (million >= 1) return `$${million.toFixed(1)}M`;
        return `$${(fdv / 1e3).toFixed(0)}K`;
    }
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    function getColor(val, high, low) {
        if (val >= high) return 'var(--success)';
        if (val <= low) return 'var(--text-sub)';
        return 'var(--text-main)';
    }
    function getPercentileColor(percentile) {
        // ä»·æ ¼åˆ†ä½: 0%=æœ€ä½ç‚¹(æå¼±åŠ¿), 100%=æœ€é«˜ç‚¹(æå¼ºåŠ¿)
        // é¢œè‰²æ–¹æ¡ˆ: çº¢è‰²(0-20%) -> æµ…çº¢(20-40%) -> ç™½è‰²(40-60%) -> æµ…ç»¿(60-80%) -> ç»¿è‰²(80-100%)
        if (percentile >= 80) return 'color: var(--success)';  // ç»¿è‰²: æ¥è¿‘é«˜ç‚¹
        if (percentile >= 60) return 'color: #4ade80';  // æµ…ç»¿è‰²
        if (percentile >= 40) return 'color: var(--text-main)';  // ç™½è‰²: ä¸­é—´ä½ç½®
        if (percentile >= 20) return 'color: #fb923c';  // æµ…çº¢è‰²
        return 'color: var(--danger)';  // çº¢è‰²: æ¥è¿‘ä½ç‚¹
    }
</script>
</body>
</html>
