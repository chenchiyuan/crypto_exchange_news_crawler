<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†é€‰å¸Dashboard Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* ========== Design Tokens ========== */
        :root {
            --bg-body: #0b0e11;
            --bg-card: #15181f;
            --bg-header: #15181f;
            --bg-hover: #1e232d;
            --bg-input: #0b0e11;
            --border-color: #2b313a;
            --border-light: #363c4a;

            --text-main: #e1e7ef;
            --text-sub: #8492a6;
            --text-muted: #5e6e82;

            --primary: #2962ff;
            --primary-dim: rgba(41, 98, 255, 0.15);
            --success: #00c853;
            --success-dim: rgba(0, 200, 83, 0.15);
            --warning: #ffd600;
            --danger: #ff1744;
            --danger-dim: rgba(255, 23, 68, 0.15);

            --radius: 6px;
            --font-base: 'Inter', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;

            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-float: 0 4px 12px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-base);
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #363c4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5160; }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ========== Header ========== */
        .header {
            flex: 0 0 auto;
            padding: 12px 24px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; gap: 12px; }

        .btn {
            padding: 6px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: var(--bg-hover); border-color: var(--text-sub); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
        .btn-primary:hover { background: #1e4bd8; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        /* ========== Layout: Sidebar & Main ========== */
        .layout-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar: Dates */
        .sidebar {
            width: 260px;
            background: var(--bg-body);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex: 0 0 260px;
        }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .date-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .date-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .date-item:hover { background: var(--bg-hover); }
        .date-item.active {
            background: var(--primary-dim);
            border-color: var(--primary);
        }
        .date-main-text { font-family: var(--font-mono); font-weight: 600; font-size: 14px; }
        .date-sub-text { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; margin-top: 4px; }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-card);
        }

        /* Toolbar / Filters */
        .toolbar {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        .toolbar-top { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .filter-group label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
        .input-wrapper { position: relative; }
        .input-wrapper input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-family: var(--font-mono);
            transition: border-color 0.2s;
        }
        .input-wrapper input:focus { border-color: var(--primary); outline: none; }
        .input-unit {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 11px; color: var(--text-sub); pointer-events: none;
        }

        /* ========== Table Area ========== */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }

        thead th {
            background: var(--bg-header);
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-sub);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        thead th:hover { color: var(--text-main); background: var(--bg-hover); }
        th::after {
            content: 'â†•';
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.3;
        }
        th.asc::after { content: 'â†‘'; opacity: 1; color: var(--primary); }
        th.desc::after { content: 'â†“'; opacity: 1; color: var(--primary); }

        tbody td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-main);
        }
        tbody tr:hover { background-color: var(--bg-hover); }

        /* Sticky Columns */
        th.sticky-col, td.sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
        }
        tbody tr:hover td.sticky-col { background: var(--bg-hover); }

        th.sticky-col-2, td.sticky-col-2 {
            position: sticky;
            left: 50px;
            z-index: 10;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        tbody tr:hover td.sticky-col-2 { background: var(--bg-hover); }

        /* Cell Styling */
        .font-mono { font-family: var(--font-mono); }
        .text-right { text-align: right; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-dim { color: var(--text-sub); }

        .symbol-link { color: var(--primary); text-decoration: none; font-weight: 600; }
        .symbol-link:hover { text-decoration: underline; }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
        }
        .badge-spot { color: var(--success); border-color: var(--success-dim); background: var(--success-dim); }

        /* Strategy Tooltip */
        .strategy-cell { position: relative; cursor: help; }
        .strategy-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 12px;
            background: var(--primary-dim); border: 1px solid rgba(41, 98, 255, 0.2);
            color: #fff; font-size: 11px;
        }
        .tooltip-content {
            display: none;
            position: absolute;
            right: 100%; top: 50%; transform: translateY(-50%) translateX(-10px);
            background: #1e232d;
            border: 1px solid var(--border-light);
            padding: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-float);
            width: 220px;
            z-index: 100;
        }
        .strategy-cell:hover .tooltip-content { display: block; }

        .status-bar {
            padding: 8px 16px;
            background: var(--bg-input);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
        }

        /* Loading */
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(11, 14, 17, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; display: none;
        }
        .loading-overlay.show { display: flex; }

        /* ========== Mobile Responsive Design ========== */

        /* ç§»åŠ¨ç«¯æ±‰å ¡èœå•æŒ‰é’® */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            box-shadow: var(--shadow-float);
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-main);
        }

        /* ç§»åŠ¨ç«¯é®ç½©å±‚ */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .mobile-overlay.show {
            display: block;
        }

        @media (max-width: 768px) {
            /* æ˜¾ç¤ºç§»åŠ¨ç«¯èœå•æŒ‰é’® */
            .mobile-menu-btn {
                display: flex;
            }

            /* Header ä¼˜åŒ– */
            .header {
                padding: 10px 16px;
            }

            .header h1 {
                font-size: 16px;
            }

            .header-actions {
                gap: 8px;
            }

            .btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            /* ä¾§è¾¹æ æ”¹ä¸ºæŠ½å±‰å¼ */
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1001;
                transition: left 0.3s ease;
                box-shadow: var(--shadow-float);
            }

            .sidebar.show {
                left: 0;
            }

            /* ä¸»å†…å®¹åŒºå æ»¡å±å¹• */
            .main-content {
                width: 100%;
            }

            /* Toolbar ä¼˜åŒ– */
            .toolbar {
                padding: 10px 12px;
            }

            .toolbar-top {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }

            #resultsTitle {
                font-size: 14px !important;
            }

            #resultsMeta {
                font-size: 11px !important;
            }

            /* ç­›é€‰æ¡ä»¶æ  - å¯æŠ˜å  */
            .filter-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .filter-group {
                font-size: 11px;
            }

            .filter-group label {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .filter-group input {
                font-size: 12px;
                padding: 6px 8px;
            }

            .input-unit {
                font-size: 11px;
            }

            /* é‡ç½®ç­›é€‰æŒ‰é’® */
            #resetFilters {
                width: 100%;
                margin-top: 8px;
            }

            /* è¡¨æ ¼å®¹å™¨ */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* è¡¨æ ¼ä¼˜åŒ– - åªæ˜¾ç¤ºæ ¸å¿ƒåˆ— */
            table {
                font-size: 11px;
            }

            /* éšè—éæ ¸å¿ƒåˆ— */
            th[data-key="fdv"],
            th[data-key="price_change"],
            th[data-key="vdr"],
            th[data-key="ma99_slope"],
            th[data-key="drawdown_from_high_pct"],
            th[data-key="annual_funding_rate"],
            th[data-key="volume_24h_calculated"],
            th[data-key="open_interest"],
            th[data-key="vol_oi_ratio"],
            th[data-key="money_flow_large_net"],
            th[data-key="price_percentile_100"],
            td:nth-child(3),  /* FDV */
            td:nth-child(4),  /* ä»·æ ¼å˜åŒ– */
            td:nth-child(5),  /* VDR */
            td:nth-child(8),  /* EMA99æ–œç‡ */
            td:nth-child(9),  /* é«˜ç‚¹å›è½ */
            td:nth-child(10), /* å¹´åŒ–èµ„è´¹ */
            td:nth-child(11), /* 24hé‡ */
            td:nth-child(12), /* OI */
            td:nth-child(13), /* Vol/OI */
            td:nth-child(14), /* å¤§å•å‡€æµå…¥ */
            td:nth-child(17)  /* ä»·æ ¼åˆ†ä½ */
            {
                display: none;
            }

            /* ä¿ç•™æ ¸å¿ƒåˆ— */
            /* 1. åˆçº¦ (symbol) */
            /* 2. ä»·æ ¼ (price) */
            /* 6. 15mæŒ¯å¹… (amplitude_sum_15m) */
            /* 7. å‡ºç°æ¬¡æ•° (appearance_count) - ä»…7å¤©ç´¯è®¡æ˜¾ç¤º */
            /* 8. 15må¹³å‡æŒ¯å¹… (avg_amplitude_15m) - ä»…7å¤©ç´¯è®¡æ˜¾ç¤º */
            /* 15. ç­–ç•¥å»ºè®® */
            /* 16. ç½‘æ ¼åŒºé—´ (grid_count) - é‡è¦ï¼Œä¿ç•™æ˜¾ç¤º */

            th, td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .sticky-col {
                font-size: 11px;
                min-width: 80px !important;
            }

            .symbol-link {
                font-size: 11px;
            }

            /* çŠ¶æ€æ  */
            .status-bar {
                padding: 6px 12px;
                font-size: 11px;
                flex-direction: column;
                gap: 4px;
            }

            /* æ—¥æœŸé¡¹ä¼˜åŒ– */
            .date-item {
                padding: 8px 10px;
            }

            .date-main-text {
                font-size: 13px;
            }

            .date-sub-text {
                font-size: 10px;
            }
        }

        /* å°å±æ‰‹æœº (<480px) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 14px;
            }

            .filter-grid {
                grid-template-columns: 1fr !important;
            }

            .sidebar {
                width: 260px;
                left: -270px;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 6px 4px;
                font-size: 10px;
            }

            .sticky-col {
                min-width: 70px !important;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>

<!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- ç§»åŠ¨ç«¯æ±‰å ¡èœå•æŒ‰é’® -->
<button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="æ‰“å¼€èœå•">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
</button>

<div class="container">
    <header class="header">
        <h1>
            <span style="font-size: 20px;">ğŸ“…</span>
            æ—¥å†é€‰å¸ç»ˆç«¯ <span style="font-size:12px; background:var(--bg-hover); padding:2px 6px; border-radius:4px; color:var(--text-sub);">PRO</span>
        </h1>
        <div class="header-actions">
            <a href="/screening/" class="btn">âš¡ å®æ—¶ç­›é€‰</a>
            <a href="/grids/" class="btn">ğŸ•¸ï¸ ç½‘æ ¼ç®¡ç†</a>
        </div>
    </header>

    <div class="layout-body">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 style="font-size: 13px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px;">å†å²å¿«ç…§</h3>
            </div>
            <div id="dateList" class="date-list">
                <div style="padding:20px; text-align:center; color:var(--text-sub); font-size:12px;">åŠ è½½ä¸­...</div>
            </div>
        </aside>

        <main class="main-content">
            <div class="toolbar">
                <div class="toolbar-top">
                    <div>
                        <h2 id="resultsTitle" style="font-size: 16px; font-weight: 600;">è¯·é€‰æ‹©æ—¥æœŸ</h2>
                        <div id="resultsMeta" style="font-size: 12px; color: var(--text-sub);"></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                        <button id="resetFilters" class="btn btn-sm">â†º é‡ç½®ç­›é€‰</button>
                        <div id="filterHint" style="font-size: 11px; color: var(--text-sub); display: none;">
                            æç¤ºï¼šè¾“å…¥æ›´ä¸¥æ ¼çš„æ¡ä»¶å¯è¿›ä¸€æ­¥ç­›é€‰
                        </div>
                    </div>
                </div>

                <div id="backendFilterInfo" style="padding: 8px 12px; background: rgba(41, 98, 255, 0.08); border-left: 3px solid var(--primary); border-radius: 4px; margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--text-main); display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                        <span style="font-weight: 600;">ğŸ“‹ åç«¯é»˜è®¤ç­›é€‰:</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">VDRâ‰¥6</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">æŒ¯å¹…â‰¥50%</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">EMA99â‰¤-10</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">èµ„è´¹â‰¥-10%</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">OIâ‰¥5M</span>
                        <span style="background: var(--bg-hover); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px;">Volâ‰¥8M</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-sub); margin-top: 6px;">
                        ğŸ’¡ ä¸‹æ–¹è¾“å…¥æ¡†å¯è¿›ä¸€æ­¥ç­›é€‰ï¼ˆè¾“å…¥æ›´ä¸¥æ ¼çš„æ¡ä»¶ï¼‰
                    </div>
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label>VDR (æ³¢åŠ¨ç‡/å›æ’¤) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinVdr" step="0.1" placeholder="åç«¯å·²ç­›é€‰â‰¥6">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>15m æŒ¯å¹… â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinAmplitude" step="1" placeholder="åç«¯å·²ç­›é€‰â‰¥50">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>EMA99 æ–œç‡ â‰¤</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMaxMa99Slope" step="1" placeholder="åç«¯å·²ç­›é€‰â‰¤-10">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>å¹´åŒ–èµ„è´¹ â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinFundingRate" step="1" placeholder="åç«¯å·²ç­›é€‰â‰¥-10">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>æŒä»“é‡ OI (M) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinOI" step="0.1" placeholder="åç«¯å·²ç­›é€‰â‰¥5">
                            <span class="input-unit">M</span>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>24h æˆäº¤é¢ (M) â‰¥</label>
                        <div class="input-wrapper">
                            <input type="number" id="filterMinVolume" step="1" placeholder="åç«¯å·²ç­›é€‰â‰¥8">
                            <span class="input-unit">M</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <div id="loadingOverlay" class="loading-overlay">
                    <div style="color: white;">æ•°æ®åŠ è½½ä¸­...</div>
                </div>
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th class="sticky-col" style="width: 120px;" data-key="symbol">åˆçº¦</th>

                            <th class="text-right" data-key="price">ä»·æ ¼</th>
                            <th class="text-right" data-key="fdv" title="Fully Diluted Valuation - å…¨ç¨€é‡Šä¼°å€¼">FDV</th>
                            <th class="text-right" data-key="price_change" style="min-width: 100px;">å˜åŒ–</th>
                            <th class="text-right" data-key="vdr" title="Volatility Drawdown Ratio">VDR</th>
                            <th class="text-right" data-key="amplitude_sum_15m">15mæŒ¯å¹…</th>
                            <th class="text-right" data-key="appearance_count" style="min-width: 80px;">å‡ºç°æ¬¡æ•°</th>
                            <th class="text-right" data-key="avg_amplitude_15m" style="min-width: 100px;">15må¹³å‡æŒ¯å¹…</th>
                            <th class="text-right" data-key="ma99_slope">EMA99æ–œç‡</th>
                            <th class="text-right" data-key="drawdown_from_high_pct">é«˜ç‚¹å›è½</th>
                            <th class="text-right" data-key="annual_funding_rate">å¹´åŒ–èµ„è´¹</th>
                            <th class="text-right" data-key="volume_24h_calculated">24hé‡</th>
                            <th class="text-right" data-key="open_interest" title="æŒä»“é‡">OI</th>
                            <th class="text-right" data-key="vol_oi_ratio">Vol/OI</th>
                            <th class="text-right" data-key="money_flow_large_net" title="24å°æ—¶å¤§å•å‡€æµå…¥">ğŸ’° å¤§å•å‡€æµå…¥</th>
                            <th style="min-width: 140px;">ç­–ç•¥å»ºè®®</th>
                            <th class="text-right" data-key="grid_count" style="min-width: 140px;">ç½‘æ ¼åŒºé—´</th>
                            <th class="text-right" data-key="price_percentile_100">ä»·æ ¼åˆ†ä½</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="18" style="text-align: center; padding: 40px; color: var(--text-sub);">â† è¯·ä»å·¦ä¾§é€‰æ‹©å†å²æ—¥æœŸ</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="status-bar" id="statusBar">
                <span>Ready</span>
                <span>æ˜¾ç¤º 0 æ¡è®°å½•</span>
            </div>
        </main>
    </div>
</div>

<script>
    // State Management
    const state = {
        currentDate: null,
        rawDateData: [],
        filteredData: [],
        sortBy: 'amplitude_sum_15m',
        sortOrder: 'desc',
        filters: {
            minVdr: '',      // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼6ï¼‰
            minAmplitude: '', // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼50ï¼‰
            maxMa99Slope: '', // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼-10ï¼‰
            minFundingRate: '', // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼-10ï¼‰
            minOI: '',       // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼5Mï¼‰
            minVolume: ''    // ç©ºå€¼è¡¨ç¤ºä¸è¿‡æ»¤ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤å€¼8Mï¼‰
        }
    };

    // DOM Elements
    const els = {
        dateList: document.getElementById('dateList'),
        tbody: document.getElementById('resultsBody'),
        loading: document.getElementById('loadingOverlay'),
        title: document.getElementById('resultsTitle'),
        meta: document.getElementById('resultsMeta'),
        status: document.getElementById('statusBar'),
        inputs: {
            vdr: document.getElementById('filterMinVdr'),
            amp: document.getElementById('filterMinAmplitude'),
            slope: document.getElementById('filterMaxMa99Slope'),
            funding: document.getElementById('filterMinFundingRate'),
            oi: document.getElementById('filterMinOI'),
            vol: document.getElementById('filterMinVolume')
        }
    };

    // Init
    init();

    function init() {
        els.inputs.vdr.value = state.filters.minVdr;
        els.inputs.amp.value = state.filters.minAmplitude;
        els.inputs.slope.value = state.filters.maxMa99Slope;
        els.inputs.funding.value = state.filters.minFundingRate;
        els.inputs.oi.value = state.filters.minOI;
        els.inputs.vol.value = state.filters.minVolume;

        bindEvents();
        loadDates();
    }

    function bindEvents() {
        document.querySelectorAll('th[data-key]').forEach(th => {
            th.addEventListener('click', () => handleSort(th.dataset.key));
        });

        const handleFilterChange = debounce(() => {
            updateFiltersFromDOM();
            processData();

            // æ˜¾ç¤ºç­›é€‰æç¤º
            const hasAnyFilter = Object.values(state.filters).some(v => v !== '');
            const filterHint = document.getElementById('filterHint');
            if (hasAnyFilter) {
                filterHint.style.display = 'block';
                filterHint.style.color = 'var(--primary)';
                filterHint.textContent = `å·²åº”ç”¨ ${Object.values(state.filters).filter(v => v !== '').length} ä¸ªé¢å¤–ç­›é€‰æ¡ä»¶`;
            } else {
                filterHint.style.display = 'none';
            }
        }, 300);

        Object.values(els.inputs).forEach(input => {
            input.addEventListener('input', handleFilterChange);
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            // é‡ç½®ä¸ºç©ºå€¼ï¼ˆåç«¯å·²åº”ç”¨é»˜è®¤ç­›é€‰æ¡ä»¶ï¼‰
            state.filters = { minVdr: '', minAmplitude: '', maxMa99Slope: '', minFundingRate: '', minOI: '', minVolume: '' };
            els.inputs.vdr.value = state.filters.minVdr;
            els.inputs.amp.value = state.filters.minAmplitude;
            els.inputs.slope.value = state.filters.maxMa99Slope;
            els.inputs.funding.value = state.filters.minFundingRate;
            els.inputs.oi.value = state.filters.minOI;
            els.inputs.vol.value = state.filters.minVolume;

            // éšè—ç­›é€‰æç¤º
            const filterHint = document.getElementById('filterHint');
            filterHint.style.display = 'none';

            processData();
        });

        // ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶
        bindMobileMenuEvents();
    }

    function bindMobileMenuEvents() {
        const menuBtn = document.getElementById('mobileMenuBtn');
        const overlay = document.getElementById('mobileOverlay');
        const sidebar = document.querySelector('.sidebar');

        if (!menuBtn || !overlay || !sidebar) return;

        // æ‰“å¼€ä¾§è¾¹æ 
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('show');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        });

        // å…³é—­ä¾§è¾¹æ 
        const closeSidebar = () => {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        };

        overlay.addEventListener('click', closeSidebar);

        // é€‰æ‹©æ—¥æœŸåè‡ªåŠ¨å…³é—­ï¼ˆç§»åŠ¨ç«¯ï¼‰
        const originalSelectDate = window.selectDate;
        window.selectDate = function(date) {
            originalSelectDate.call(this, date);
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        };
    }

    async function loadDates() {
        try {
            const response = await fetch('/screening/daily/api/dates/');
            const data = await response.json();
            renderDateList(data.dates);
            if (data.dates.length > 0) selectDate(data.dates[0].date);
        } catch (e) {
            console.error(e);
            els.dateList.innerHTML = '<div style="padding:12px;color:var(--danger)">åŠ è½½å¤±è´¥</div>';
        }
    }

    function renderDateList(dates) {
        if (!dates.length) {
            els.dateList.innerHTML = '<div style="padding:12px;color:var(--text-sub)">æ— æ•°æ®</div>';
            return;
        }

        // åœ¨é¡¶éƒ¨æ·»åŠ "7å¤©åˆçº¦ç´¯è®¡"é€‰é¡¹
        const aggregateItem = `
            <div class="date-item" data-date="7day-aggregate" onclick="selectDate('7day-aggregate')" style="border-bottom: 2px solid var(--border-color); margin-bottom: 8px;">
                <div class="date-main-text" style="color: var(--primary);">ğŸ”¥ 7å¤©åˆçº¦ç´¯è®¡</div>
                <div class="date-sub-text">
                    <span>é«˜é¢‘åˆçº¦ç»Ÿè®¡</span>
                </div>
            </div>
        `;

        const dateItems = dates.map(d => `
            <div class="date-item" data-date="${d.date}" onclick="selectDate('${d.date}')">
                <div class="date-main-text">${d.date}</div>
                <div class="date-sub-text">
                    <span>${d.filtered_candidates}/${d.total_candidates} æ ‡çš„</span>
                    <span>${d.execution_time}s</span>
                </div>
            </div>
        `).join('');

        els.dateList.innerHTML = aggregateItem + dateItems;
    }

    async function selectDate(date) {
        if (state.currentDate === date) return;
        state.currentDate = date;

        document.querySelectorAll('.date-item').forEach(el => {
            el.classList.toggle('active', el.dataset.date === date);
        });

        // ç‰¹æ®Šå¤„ç†ï¼š7å¤©åˆçº¦ç´¯è®¡
        if (date === '7day-aggregate') {
            els.title.innerText = 'ğŸ”¥ 7å¤©åˆçº¦ç´¯è®¡ åˆ†ææŠ¥å‘Š';
            // è®¾ç½®é»˜è®¤æ’åºä¸ºå‡ºç°æ¬¡æ•°é™åº
            state.sortBy = 'appearance_count';
            state.sortOrder = 'desc';
        } else {
            els.title.innerText = `${date} åˆ†ææŠ¥å‘Š`;
            // æ¢å¤é»˜è®¤æ’åº
            state.sortBy = 'rank';
            state.sortOrder = 'asc';
        }

        els.loading.classList.add('show');

        try {
            let apiUrl;
            const params = new URLSearchParams({
                sort_by: 'rank',
                sort_order: 'asc'
            });

            // æ ¹æ®dateç±»å‹é€‰æ‹©ä¸åŒçš„API
            if (date === '7day-aggregate') {
                apiUrl = `/screening/daily/api/top-frequent/?${params}`;
            } else {
                apiUrl = `/screening/daily/api/${date}/?${params}`;
            }

            const res = await fetch(apiUrl);
            const json = await res.json();

            state.rawDateData = json.results;

            if(json.record) {
                 if (date === '7day-aggregate') {
                     // 7å¤©ç´¯è®¡æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                     els.meta.innerHTML = json.record.notes || 'æœ€è¿‘7å¤©é«˜é¢‘åˆçº¦ç»Ÿè®¡';
                 } else {
                     els.meta.innerHTML = `VDRæƒé‡: ${(json.record.weights.vdr*100).toFixed(0)}% | KERæƒé‡: ${(json.record.weights.ker*100).toFixed(0)}%`;
                 }
            }

            processData();
        } catch (e) {
            console.error(e);
            els.tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
        } finally {
            els.loading.classList.remove('show');
        }
    }

    function processData() {
        let data = [...state.rawDateData];

        const f = state.filters;
        data = data.filter(item => {
            const oiM = (item.open_interest || 0) / 1000000;
            const volM = (item.volume_24h_calculated || 0) / 1000000;

            if (f.minVdr !== '' && item.vdr < parseFloat(f.minVdr)) return false;
            if (f.minAmplitude !== '' && item.amplitude_sum_15m < parseFloat(f.minAmplitude)) return false;
            if (f.maxMa99Slope !== '' && item.ma99_slope > parseFloat(f.maxMa99Slope)) return false;
            if (f.minFundingRate !== '' && item.annual_funding_rate < parseFloat(f.minFundingRate)) return false;
            if (f.minOI !== '' && oiM < parseFloat(f.minOI)) return false;
            if (f.minVolume !== '' && volM < parseFloat(f.minVolume)) return false;
            return true;
        });

        const key = state.sortBy;
        const order = state.sortOrder === 'asc' ? 1 : -1;

        data.sort((a, b) => {
            let valA, valB;

            // ç‰¹æ®Šå¤„ç†ï¼šappearance_countæ’åºéœ€è¦åŒå­—æ®µæ’åº
            if (key === 'appearance_count') {
                // å…ˆæŒ‰å‡ºç°æ¬¡æ•°æ’åº
                const countA = a.appearance_count !== undefined ? a.appearance_count : -999999;
                const countB = b.appearance_count !== undefined ? b.appearance_count : -999999;

                if (countA !== countB) {
                    return countA < countB ? -1 * order : 1 * order;
                }

                // å‡ºç°æ¬¡æ•°ç›¸åŒï¼Œå†æŒ‰å¹³å‡æŒ¯å¹…æ’åº
                const ampA = a.avg_amplitude_15m !== undefined ? a.avg_amplitude_15m : -999999;
                const ampB = b.avg_amplitude_15m !== undefined ? b.avg_amplitude_15m : -999999;

                return ampA < ampB ? -1 * order : 1 * order;
            }

            // ç‰¹æ®Šå¤„ç†ä»·æ ¼å˜åŒ–æ’åº
            if (key === 'price_change') {
                valA = a.price_change ? a.price_change.change_pct : -999999;
                valB = b.price_change ? b.price_change.change_pct : -999999;
            } else {
                valA = a[key] !== undefined ? a[key] : -999999;
                valB = b[key] !== undefined ? b[key] : -999999;
            }

            if (valA === null) valA = -999999;
            if (valB === null) valB = -999999;

            if (valA < valB) return -1 * order;
            if (valA > valB) return 1 * order;
            return 0;
        });

        state.filteredData = data;
        renderTable();
        updateHeaderUI();
        updateCurrentDateCount();  // â­ æ–°å¢ï¼šæ›´æ–°å½“å‰æ—¥æœŸçš„æ˜¾ç¤ºæ•°é‡
    }

    function renderTable() {
        const data = state.filteredData;
        els.status.innerHTML = `<span>æ€»æ ‡çš„: ${state.rawDateData.length}</span> <span>å½“å‰æ˜¾ç¤º: <strong>${data.length}</strong></span>`;

        if (data.length === 0) {
            els.tbody.innerHTML = '<tr><td colspan="18" style="text-align:center; padding:20px; color:var(--text-sub)">æ— ç¬¦åˆæ¡ä»¶çš„æ ‡çš„ï¼Œè¯·æ”¾å®½ç­›é€‰æ¡ä»¶ã€‚</td></tr>';
            return;
        }

        els.tbody.innerHTML = data.map(r => {
            const volM = ((r.volume_24h_calculated || 0) / 1000000).toFixed(1);

            // ç­–ç•¥å»ºè®®ï¼šä¼˜å…ˆæ˜¾ç¤º"ä¿å®ˆåå¼¹"
            let entry = null;
            if (r.entry_candidates && r.entry_candidates.length > 0) {
                // æŸ¥æ‰¾"ä¿å®ˆåå¼¹"ç­–ç•¥
                entry = r.entry_candidates.find(c => c.label && c.label.includes('ä¿å®ˆåå¼¹'));
                // å¦‚æœæ²¡æœ‰ä¿å®ˆåå¼¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªç­–ç•¥
                if (!entry) entry = r.entry_candidates[0];
            }

            let strategyTooltip = '';
            if (r.entry_candidates && r.entry_candidates.length > 0) {
                strategyTooltip = r.entry_candidates.map(c => `
                    <div style="margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;">
                        <div style="color:#fff; font-weight:600;">${c.label} @ ${fmtPrice(c.entry_price)}</div>
                        <div style="font-size:10px; color:var(--text-sub);">è§¦å‘ç‡: ${(c.trigger_prob_24h*100).toFixed(0)}% | è€—æ—¶: ${c.avg_trigger_time.toFixed(1)}h</div>
                    </div>
                `).join('');
            } else {
                strategyTooltip = 'æ— å¼€ä»“å»ºè®®';
            }

            return `
            <tr>
                <td class="sticky-col font-mono">
                    <a href="https://www.binance.com/zh-CN/futures/${r.symbol}" target="_blank" class="symbol-link">${r.symbol}</a>
                    ${r.has_spot && r.amplitude_sum_15m > 100 && (r.volume_24h_calculated / 1000000) > 10 ? '<span style="margin-left:4px;">ğŸ‘‘</span>' : ''}
                    ${r.has_spot ? '<span class="badge badge-spot">ç°</span>' : ''}
                </td>
                <td class="text-right font-mono">
                    <a href="/screening/daily/${state.currentDate}/${r.symbol}/" class="symbol-link">${fmtPrice(r.price)}</a>
                </td>
                <td class="text-right font-mono" style="font-size: 11px;">
                    ${fmtFDV(r.fdv)}
                </td>
                <td class="text-right font-mono" style="font-size: 11px;">
                    ${r.price_change ? `
                        <div style="color: ${r.price_change.change_pct >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                            ${r.price_change.change_pct >= 0 ? '+' : ''}${r.price_change.change_pct.toFixed(2)}%
                        </div>
                        <div style="color: var(--text-sub); font-size: 10px;">vs ${r.price_change.previous_date}</div>
                    ` : '<span style="color: var(--text-muted);">-</span>'}
                </td>
                <td class="text-right font-mono" style="color:${getColor(r.vdr, 10, 3)}">${fmtNum(r.vdr, 1)}</td>
                <td class="text-right font-mono">${fmtNum(r.amplitude_sum_15m, 1)}%</td>
                <td class="text-right font-mono" style="color: var(--primary); font-weight: 600;">
                    ${r.appearance_count ? `<span style="display: inline-block; padding: 2px 8px; background: rgba(41, 98, 255, 0.15); border-radius: 10px; font-size: 11px;">${r.appearance_count}æ¬¡</span>` : '-'}
                </td>
                <td class="text-right font-mono" style="color: var(--success); font-weight: 600;">
                    ${r.avg_amplitude_15m ? `${fmtNum(r.avg_amplitude_15m, 2)}%` : '-'}
                </td>
                <td class="text-right font-mono ${r.ma99_slope > 0 ? 'text-green' : 'text-red'}">${fmtNum(r.ma99_slope, 1)}</td>
                <td class="text-right font-mono" style="color:${r.drawdown_from_high_pct < -20 ? 'var(--success)' : ''}">${fmtNum(r.drawdown_from_high_pct, 1)}%</td>
                <td class="text-right font-mono ${r.annual_funding_rate >= 0 ? 'text-green' : 'text-red'}">${fmtNum(r.annual_funding_rate, 1)}%</td>
                <td class="text-right font-mono text-dim">${volM}M</td>
                <td class="text-right font-mono text-dim">${((r.open_interest || 0) / 1000000).toFixed(1)}M</td>
                <td class="text-right font-mono" style="font-weight:600; color:${r.vol_oi_ratio > 1.5 ? 'var(--success)' : ''}">${fmtNum(r.vol_oi_ratio, 2)}</td>

                <td class="text-right font-mono ${r.money_flow_large_net >= 0 ? 'text-green' : 'text-red'}" style="font-weight:500;">
                    ${r.money_flow_large_net >= 0 ? '+' : ''}${(r.money_flow_large_net / 1000000).toFixed(1)}M
                </td>

                <td class="strategy-cell">
                    ${entry ? `
                        <div class="strategy-pill">
                            <span>${entry.label}</span>
                            <span>${fmtPrice(entry.entry_price)}</span>
                        </div>
                        <div class="tooltip-content">${strategyTooltip}</div>
                    ` : '<span style="color:var(--text-sub); font-size:11px;">-</span>'}
                </td>

                <td class="text-right font-mono" style="font-size: 11px;">
                    <div>${fmtPrice(r.grid_lower)}~${fmtPrice(r.grid_upper)}</div>
                    <div style="color:${r.grid_count > 100 ? 'var(--danger)' : 'var(--text-sub)'}; font-size: 10px;">${r.grid_count}æ¡£</div>
                </td>
                <td class="text-right font-mono" style="font-weight:bold; ${getPercentileColor(r.price_percentile_100)}">${fmtNum(r.price_percentile_100, 1)}%</td>
            </tr>
            `;
        }).join('');
    }

    function handleSort(key) {
        if (state.sortBy === key) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortBy = key;
            state.sortOrder = 'desc';
        }
        processData();
    }

    function updateHeaderUI() {
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.key === state.sortBy) {
                th.classList.add(state.sortOrder);
            }
        });
    }

    function updateCurrentDateCount() {
        // æ›´æ–°å½“å‰æ—¥æœŸçš„æ˜¾ç¤ºæ•°é‡ï¼ˆæ ¹æ®å‰ç«¯ç­›é€‰æ¡ä»¶ï¼‰
        if (!state.currentDate) return;

        const activeItem = document.querySelector(`.date-item[data-date="${state.currentDate}"]`);
        if (activeItem) {
            const subTextSpan = activeItem.querySelector('.date-sub-text span:first-child');
            if (subTextSpan) {
                const filteredCount = state.filteredData.length;
                const totalCount = state.rawDateData.length;
                subTextSpan.textContent = `${filteredCount}/${totalCount} æ ‡çš„`;
            }
        }
    }

    function updateFiltersFromDOM() {
        state.filters.minVdr = els.inputs.vdr.value;
        state.filters.minAmplitude = els.inputs.amp.value;
        state.filters.maxMa99Slope = els.inputs.slope.value;
        state.filters.minFundingRate = els.inputs.funding.value;
        state.filters.minOI = els.inputs.oi.value;
        state.filters.minVolume = els.inputs.vol.value;
    }

    function fmtPrice(p) {
        p = parseFloat(p);
        if (p < 1) return p.toFixed(4);
        if (p < 10) return p.toFixed(3);
        return p.toFixed(2);
    }
    function fmtNum(n, d) { return parseFloat(n).toFixed(d); }
    function fmtFDV(fdv) {
        if (!fdv || fdv === null) return '<span style="color: var(--text-muted);">-</span>';
        const billion = fdv / 1e9;
        const million = fdv / 1e6;
        if (billion >= 1) return `$${billion.toFixed(2)}B`;
        if (million >= 1) return `$${million.toFixed(1)}M`;
        return `$${(fdv / 1e3).toFixed(0)}K`;
    }
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    function getColor(val, high, low) {
        if (val >= high) return 'var(--success)';
        if (val <= low) return 'var(--text-sub)';
        return 'var(--text-main)';
    }
    function getPercentileColor(percentile) {
        // ä»·æ ¼åˆ†ä½: 0%=æœ€ä½ç‚¹(æå¼±åŠ¿), 100%=æœ€é«˜ç‚¹(æå¼ºåŠ¿)
        // é¢œè‰²æ–¹æ¡ˆ: çº¢è‰²(0-20%) -> æµ…çº¢(20-40%) -> ç™½è‰²(40-60%) -> æµ…ç»¿(60-80%) -> ç»¿è‰²(80-100%)
        if (percentile >= 80) return 'color: var(--success)';  // ç»¿è‰²: æ¥è¿‘é«˜ç‚¹
        if (percentile >= 60) return 'color: #4ade80';  // æµ…ç»¿è‰²
        if (percentile >= 40) return 'color: var(--text-main)';  // ç™½è‰²: ä¸­é—´ä½ç½®
        if (percentile >= 20) return 'color: #fb923c';  // æµ…çº¢è‰²
        return 'color: var(--danger)';  // çº¢è‰²: æ¥è¿‘ä½ç‚¹
    }
</script>
</body>
</html>
